MapExpress={Controls:{},Service:{},Geo:{},Layers:{},Utils:{Promise:{}},Mapping:{},Tools:{}},"undefined"!=typeof window&&window.L&&(window.MapExpress=MapExpress),MapExpress.Layers.GeoJSONServiceLayer=L.GeoJSON.extend({options:{useVectorTile:!1,replaceDataOnReset:!1,crossOrigin:!0},initialize:function(a,b){L.GeoJSON.prototype.initialize.call(this,null,b),this._dataPovider=a,this._prevMapView={},this._first=!0},onAdd:function(a){L.GeoJSON.prototype.onAdd.call(this,a),a.on("moveend",this._updateData,this),this._updateData()},onRemove:function(a){this.clearLayers(),L.GeoJSON.prototype.onRemove.call(this,a),a.off("moveend",this._updateData,this),this._first=!0},_updateData:function(){var a=this._map.getBounds(),b=this._map.getZoom();return b>this.options.maxZoom||b<this.options.minZoom?void this.clearLayers():(this.options.useVectorTile?this._updateVectorTileData(a,b):(this.options.replaceDataOnReset&&this._updateVectorDataInBounds(a,b),!this.options.replaceDataOnReset&&this._first&&this._addVectorData()),void this._storeMapView())},_addVectorData:function(){var a=this;this._dataPovider.getDataAsync().then(function(b){a._replaceData(b)},function(){a.clearLayers()})},_updateVectorDataInBounds:function(a,b){var c=this;this._dataPovider.getDataInBoundsAsync(a,b).then(function(a){c._replaceData(a)},function(){c.clearLayers()})},_updateVectorTileData:function(a,b){var c=[];if(this.options.replaceDataOnReset)this.clearLayers(),c=this._dataPovider._getTileCoordRangeByMapBounds(a,b);else if(c=this._dataPovider._getAddedTileCoordRangeByMapBounds(this._prevMapView.bounds,this._prevMapView.zoom,a,b),this._map.getZoom()!==this._prevMapView.zoom)this.clearLayers();else for(var d=this._dataPovider._getRemovedTileCoordRangeByMapBounds(this._prevMapView.bounds,this._prevMapView.zoom,a,b),e=0;e<d.length;e++)this._removeVectorTile(d[e]);for(var f=0;f<c.length;f++)this._addVectorTile(c[f])},_addVectorTile:function(a){var b=this;this._dataPovider.getDataByTileAsync(a).then(function(c){if(c){var d=b.addData(c);for(var e in d._layers)d._layers[e]._tileCoordKey||(d._layers[e]._tileCoordKey=b._dataPovider._tileCoordsToKey(a))}})},_removeVectorTile:function(a){for(var b in this._layers){var c=this._layers[b];c._tileCoordKey&&c._tileCoordKey===this._dataPovider._tileCoordsToKey(a)&&this.removeLayer(c)}},_replaceData:function(a){this.clearLayers(),a&&(this.addData(a),this._first=!1)},_storeMapView:function(){this._prevMapView.zoom=this._map.getZoom(),this._prevMapView.bounds=this._map.getBounds(),this._prevMapView.center=this._map.getCenter()},_getFeaturesAtPoint:function(a,b,c,d,e){var f=this,g=Q.defer();try{var h=[];for(var i in f._layers){var j=f._layers[i];j._containsPoint&&j._containsPoint(b)&&h.push(j.feature)}g.resolve(h)}catch(k){k.layer=f,g.reject(k)}return g.promise}}),MapExpress.Layers.geoJSONServiceLayer=function(a,b){return new MapExpress.Layers.GeoJSONServiceLayer(a,b)},MapExpress.Layers.ImageOverlayLayer=L.ImageOverlay.extend({options:{crossOrigin:!0},initialize:function(a,b){this._dataPovider=a,L.setOptions(this,b)},onAdd:function(a){a.on("moveend",this._reset,this),L.ImageOverlay.prototype.onAdd.call(this,a)},onRemove:function(a){L.ImageOverlay.prototype.onRemove.call(this,a),a.off("moveend",this._reset,this)},_reset:function(){this._updateData(),L.ImageOverlay.prototype._reset.call(this)},_updateData:function(){var a=this._map.getZoom();if(a>this.options.maxZoom||a<this.options.minZoom)return void this._removeData();this._bounds=this._map.getBounds();var b=this._dataPovider.getDataUrlByBounds(this._bounds,this._map.getSize());b!==this._url&&(this._url=b,this._removeData(),this._initImage(),this.options.opacity<1&&this._updateOpacity(),this.options.interactive&&(L.DomUtil.addClass(this._image,"leaflet-interactive"),this.addInteractiveTarget(this._image)),this.getPane().appendChild(this._image))},_removeData:function(){L.DomUtil.remove(this._image),this.options.interactive&&this.removeInteractiveTarget(this._image)}}),MapExpress.Layers.imageOverlayLayer=function(a,b){return new MapExpress.Layers.ImageOverlayLayer(a,b)},MapExpress.Layers.TileServiceLayer=L.TileLayer.extend({options:{crossOrigin:!0},initialize:function(a,b){L.TileLayer.prototype.initialize.call(this,null,b),this._dataPovider=a},onAdd:function(a){L.TileLayer.prototype.onAdd.call(this,a)},onRemove:function(a){L.TileLayer.prototype.onRemove.call(this,a)},createTile:function(a,b){var c=document.createElement("img");return L.DomEvent.on(c,"load",L.bind(this._tileOnLoad,this,b,c)),L.DomEvent.on(c,"error",L.bind(this._tileOnError,this,b,c)),this.options.crossOrigin&&(c.crossOrigin=""),c.alt="",c.src=this._dataPovider.getDataUrlByTile(a),c}}),MapExpress.Layers.tileServiceLayer=function(a,b){return new MapExpress.Layers.TileServiceLayer(a,b)},MapExpress.Mapping.MapLoader=L.Class.extend({initialize:function(a,b){this._map=a,L.setOptions(this,b)},loadMap:function(a){var b=this;return this._layers=[],this._map.id=a.id,this._map.name=a.name,this._map.displayName=a.displayName,this._map.description=a.description,L.setOptions(this._map,a.options),a.layers&&a.layers.length>0&&a.layers.forEach(function(a){var c=b._createLayer(a);c&&(b._layers.push(c),c.visible&&c.addTo(b._map))}),this._map},_getLayers:function(){return this._layers},_getBaseLayers:function(){return this._layers.filter(function(a){return"base"===a.type})},_getOverlayLayers:function(){return this._layers.filter(function(a){return"overlay"===a.type})},_createLayer:function(a){var b,c=this._createProvider(a.dataProviderClass.constructor,a.dataProviderClass.args);if(c){switch(L.setOptions(c,a.dataProviderClass.options),a.layerClass.args.splice(0,0,c),a.layerClass.constructor){case"MapExpress.Layers.GeoJSONServiceLayer":b=this._applyToConstructor(MapExpress.Layers.GeoJSONServiceLayer,a.layerClass.args);break;case"MapExpress.Layers.ImageOverlayLayer":b=this._applyToConstructor(MapExpress.Layers.ImageOverlayLayer,a.layerClass.args);break;case"MapExpress.Layers.TileServiceLayer":b=this._applyToConstructor(MapExpress.Layers.TileServiceLayer,a.layerClass.args)}b&&(b.id=a.id,b.displayName=a.displayName,b.visible=a.visible,b.type=a.type,b.minZoom=a.minZoom,b.maxZoom=a.maxZoom,b.selectable=a.selectable,b.queryable=a.queryable,L.setOptions(b,a.layerClass.options))}return b},_createProvider:function(a,b){var c;switch(a){case"MapExpress.Service.TileProvider":c=this._applyToConstructor(MapExpress.Service.TileProvider,b);break;case"MapExpress.Service.GeoJSONProvider":c=this._applyToConstructor(MapExpress.Service.GeoJSONProvider,b);break;case"MapExpress.Service.MapServiceAgsProvider":c=this._applyToConstructor(MapExpress.Service.MapServiceAgsProvider,b);break;case"MapExpress.Service.FeatureServiceAgsProvider":c=this._applyToConstructor(MapExpress.Service.FeatureServiceAgsProvider,b);break;case"MapExpress.Service.WmsProvider":c=this._applyToConstructor(MapExpress.Service.WmsProvider,b)}return c},_applyToConstructor:function(a,b){var c=[null].concat(b),d=a.bind.apply(a,c);return new d}}),MapExpress.Mapping.mapLoader=function(a,b){return new MapExpress.Mapping.MapLoader(a,b)},MapExpress.Mapping.MapManager=L.Class.extend({initialize:function(a,b,c){this._map=a,L.setOptions(this,c),this._layers=[],this._mapLoader=b?b:MapExpress.Mapping.mapLoader(a,c)},renderMap:function(a){this._mapLoader.loadMap(a)},getLayerById:function(a){function b(a,b){return a.filter(function(a){return a.id===b})}var c=this._mapLoader._getLayers();if(c){var d=b(c,a);return d.length>0?d[0]:"undefined"}},getLayers:function(){return this._mapLoader._getLayers()},getBaseLayers:function(){return this._mapLoader._getBaseLayers()},getOverlayLayers:function(){return this._mapLoader._getOverlayLayers()},_getBaseObj:function(){var a=this.getBaseLayers(),b={};return a.forEach(function(a){b[a.displayName]=a}),b},_getOverlayObj:function(){var a=this.getOverlayLayers(),b={};return a.forEach(function(a){b[a.displayName]=a}),b}}),function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.geojsonvt=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";function d(a,b,c,d,g,h,i,j){if(c/=b,d/=b,i>=c&&d>=j)return a;if(i>d||c>j)return null;for(var k=[],l=0;l<a.length;l++){var m,n,o=a[l],p=o.geometry,q=o.type;if(m=o.min[g],n=o.max[g],m>=c&&d>=n)k.push(o);else if(!(m>d||c>n)){var r=1===q?e(p,c,d,g):f(p,c,d,g,h,3===q);r.length&&k.push({geometry:r,type:q,tags:a[l].tags||null,min:o.min,max:o.max})}}return k.length?k:null}function e(a,b,c,d){for(var e=[],f=0;f<a.length;f++){var g=a[f],h=g[d];h>=b&&c>=h&&e.push(g)}return e}function f(a,b,c,d,e,f){for(var h=[],i=0;i<a.length;i++){var j,k,l,m=0,n=0,o=null,p=a[i],q=p.area,r=p.dist,s=p.length,t=[];for(k=0;s-1>k;k++)j=o||p[k],o=p[k+1],m=n||j[d],n=o[d],b>m?n>c?(t.push(e(j,o,b),e(j,o,c)),f||(t=g(h,t,q,r))):n>=b&&t.push(e(j,o,b)):m>c?b>n?(t.push(e(j,o,c),e(j,o,b)),f||(t=g(h,t,q,r))):c>=n&&t.push(e(j,o,c)):(t.push(j),b>n?(t.push(e(j,o,b)),f||(t=g(h,t,q,r))):n>c&&(t.push(e(j,o,c)),f||(t=g(h,t,q,r))));j=p[s-1],m=j[d],m>=b&&c>=m&&t.push(j),l=t[t.length-1],f&&l&&(t[0][0]!==l[0]||t[0][1]!==l[1])&&t.push(t[0]),g(h,t,q,r)}return h}function g(a,b,c,d){return b.length&&(b.area=c,b.dist=d,a.push(b)),[]}b.exports=d},{}],2:[function(a,b,c){"use strict";function d(a,b){var c=[];if("FeatureCollection"===a.type)for(var d=0;d<a.features.length;d++)e(c,a.features[d],b);else"Feature"===a.type?e(c,a,b):e(c,{geometry:a},b);return c}function e(a,b,c){var d,i,j,k=b.geometry,l=k.type,m=k.coordinates,n=b.properties;if("Point"===l)a.push(f(n,1,[h(m)]));else if("MultiPoint"===l)a.push(f(n,1,g(m)));else if("LineString"===l)a.push(f(n,2,[g(m,c)]));else if("MultiLineString"===l||"Polygon"===l){for(j=[],d=0;d<m.length;d++)j.push(g(m[d],c));a.push(f(n,"Polygon"===l?3:2,j))}else if("MultiPolygon"===l){for(j=[],d=0;d<m.length;d++)for(i=0;i<m[d].length;i++)j.push(g(m[d][i],c));a.push(f(n,3,j))}else{if("GeometryCollection"!==l)throw new Error("Input data is not a valid GeoJSON object.");for(d=0;d<k.geometries.length;d++)e(a,{geometry:k.geometries[d],properties:n},c)}}function f(a,b,c){var d={geometry:c,type:b,tags:a||null,min:[2,1],max:[-1,0]};return j(d),d}function g(a,b){for(var c=[],d=0;d<a.length;d++)c.push(h(a[d]));return b&&(l(c,b),i(c)),c}function h(a){var b=Math.sin(a[1]*Math.PI/180),c=a[0]/360+.5,d=.5-.25*Math.log((1+b)/(1-b))/Math.PI;return d=-1>d?-1:d>1?1:d,[c,d,0]}function i(a){for(var b,c,d=0,e=0,f=0;f<a.length-1;f++)b=c||a[f],c=a[f+1],d+=b[0]*c[1]-c[0]*b[1],e+=Math.abs(c[0]-b[0])+Math.abs(c[1]-b[1]);a.area=Math.abs(d/2),a.dist=e}function j(a){var b=a.geometry,c=a.min,d=a.max;if(1===a.type)k(c,d,b);else for(var e=0;e<b.length;e++)k(c,d,b[e]);return a}function k(a,b,c){for(var d,e=0;e<c.length;e++)d=c[e],a[0]=Math.min(d[0],a[0]),b[0]=Math.max(d[0],b[0]),a[1]=Math.min(d[1],a[1]),b[1]=Math.max(d[1],b[1])}b.exports=d;var l=a("./simplify")},{"./simplify":4}],3:[function(a,b,c){"use strict";function d(a,b){return new e(a,b)}function e(a,b){b=this.options=i(Object.create(this.options),b);var c=b.debug;c&&console.time("preprocess data");var d=1<<b.maxZoom,e=k(a,b.tolerance/(d*b.extent));this.tiles={},this.tileCoords=[],c&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",b.indexMaxZoom,b.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),e=n(e,b.buffer/b.extent,g),e.length&&this.splitTile(e,0,0,0),c&&(e.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function f(a,b,c){return 32*((1<<a)*c+b)+a}function g(a,b,c){return[c,(c-a[0])*(b[1]-a[1])/(b[0]-a[0])+a[1],1]}function h(a,b,c){return[(c-a[1])*(b[0]-a[0])/(b[1]-a[1])+a[0],c,1]}function i(a,b){for(var c in b)a[c]=b[c];return a}function j(a,b,c){var d=a.source;if(1!==d.length)return!1;var e=d[0];if(3!==e.type||e.geometry.length>1)return!1;var f=e.geometry[0].length;if(5!==f)return!1;for(var g=0;f>g;g++){var h=l.point(e.geometry[0][g],b,a.z2,a.x,a.y);if(h[0]!==-c&&h[0]!==b+c||h[1]!==-c&&h[1]!==b+c)return!1}return!0}b.exports=d;var k=a("./convert"),l=a("./transform"),m=a("./clip"),n=a("./wrap"),o=a("./tile");e.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,solidChildren:!1,tolerance:3,extent:4096,buffer:64,debug:0},e.prototype.splitTile=function(a,b,c,d,e,i,k){for(var l=[a,b,c,d],n=this.options,p=n.debug;l.length;){d=l.pop(),c=l.pop(),b=l.pop(),a=l.pop();var q=1<<b,r=f(b,c,d),s=this.tiles[r],t=b===n.maxZoom?0:n.tolerance/(q*n.extent);if(!s&&(p>1&&console.time("creation"),s=this.tiles[r]=o(a,q,c,d,t,b===n.maxZoom),this.tileCoords.push({z:b,x:c,y:d}),p)){p>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",b,c,d,s.numFeatures,s.numPoints,s.numSimplified),console.timeEnd("creation"));var u="z"+b;this.stats[u]=(this.stats[u]||0)+1,this.total++}if(s.source=a,n.solidChildren||!j(s,n.extent,n.buffer)){if(e){if(b===n.maxZoom||b===e)continue;var v=1<<e-b;if(c!==Math.floor(i/v)||d!==Math.floor(k/v))continue}else if(b===n.indexMaxZoom||s.numPoints<=n.indexMaxPoints)continue;s.source=null,p>1&&console.time("clipping");var w,x,y,z,A,B,C=.5*n.buffer/n.extent,D=.5-C,E=.5+C,F=1+C;w=x=y=z=null,A=m(a,q,c-C,c+E,0,g,s.min[0],s.max[0]),B=m(a,q,c+D,c+F,0,g,s.min[0],s.max[0]),A&&(w=m(A,q,d-C,d+E,1,h,s.min[1],s.max[1]),x=m(A,q,d+D,d+F,1,h,s.min[1],s.max[1])),B&&(y=m(B,q,d-C,d+E,1,h,s.min[1],s.max[1]),z=m(B,q,d+D,d+F,1,h,s.min[1],s.max[1])),p>1&&console.timeEnd("clipping"),w&&l.push(w,b+1,2*c,2*d),x&&l.push(x,b+1,2*c,2*d+1),y&&l.push(y,b+1,2*c+1,2*d),z&&l.push(z,b+1,2*c+1,2*d+1)}}},e.prototype.getTile=function(a,b,c){var d=this.options,e=d.extent,g=d.debug,h=1<<a;b=(b%h+h)%h;var i=f(a,b,c);if(this.tiles[i])return l.tile(this.tiles[i],e);g>1&&console.log("drilling down to z%d-%d-%d",a,b,c);for(var k,m=a,n=b,o=c;!k&&m>0;)m--,n=Math.floor(n/2),o=Math.floor(o/2),k=this.tiles[f(m,n,o)];if(!k)return null;if(g>1&&console.log("found parent tile z%d-%d-%d",m,n,o),k.source){if(j(k,e,d.buffer))return l.tile(k,e);g>1&&console.time("drilling down"),this.splitTile(k.source,m,n,o,a,b,c),g>1&&console.timeEnd("drilling down")}return this.tiles[i]?l.tile(this.tiles[i],e):null}},{"./clip":1,"./convert":2,"./tile":5,"./transform":6,"./wrap":7}],4:[function(a,b,c){"use strict";function d(a,b){var c,d,f,g,h=b*b,i=a.length,j=0,k=i-1,l=[];for(a[j][2]=1,a[k][2]=1;k;){for(d=0,c=j+1;k>c;c++)f=e(a[c],a[j],a[k]),f>d&&(g=c,d=f);d>h?(a[g][2]=d,l.push(j),l.push(g),j=g):(k=l.pop(),j=l.pop())}}function e(a,b,c){var d=b[0],e=b[1],f=c[0],g=c[1],h=a[0],i=a[1],j=f-d,k=g-e;if(0!==j||0!==k){var l=((h-d)*j+(i-e)*k)/(j*j+k*k);l>1?(d=f,e=g):l>0&&(d+=j*l,e+=k*l)}return j=h-d,k=i-e,j*j+k*k}b.exports=d},{}],5:[function(a,b,c){"use strict";function d(a,b,c,d,f,g){for(var h={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:c,y:d,z2:b,transformed:!1,min:[2,1],max:[-1,0]},i=0;i<a.length;i++){h.numFeatures++,e(h,a[i],f,g);var j=a[i].min,k=a[i].max;j[0]<h.min[0]&&(h.min[0]=j[0]),j[1]<h.min[1]&&(h.min[1]=j[1]),k[0]>h.max[0]&&(h.max[0]=k[0]),k[1]>h.max[1]&&(h.max[1]=k[1])}return h}function e(a,b,c,d){var e,f,g,h,i=b.geometry,j=b.type,k=[],l=c*c;if(1===j)for(e=0;e<i.length;e++)k.push(i[e]),a.numPoints++,a.numSimplified++;else for(e=0;e<i.length;e++)if(g=i[e],d||!(2===j&&g.dist<c||3===j&&g.area<l)){var m=[];for(f=0;f<g.length;f++)h=g[f],(d||h[2]>l)&&(m.push(h),a.numSimplified++),a.numPoints++;k.push(m)}else a.numPoints+=g.length;k.length&&a.features.push({geometry:k,type:j,tags:b.tags||null})}b.exports=d},{}],6:[function(a,b,c){"use strict";function d(a,b){if(a.transformed)return a;var c,d,f,g=a.z2,h=a.x,i=a.y;for(c=0;c<a.features.length;c++){var j=a.features[c],k=j.geometry,l=j.type;if(1===l)for(d=0;d<k.length;d++)k[d]=e(k[d],b,g,h,i);else for(d=0;d<k.length;d++){var m=k[d];for(f=0;f<m.length;f++)m[f]=e(m[f],b,g,h,i)}}return a.transformed=!0,a}function e(a,b,c,d,e){var f=Math.round(b*(a[0]*c-d)),g=Math.round(b*(a[1]*c-e));return[f,g]}c.tile=d,c.point=e},{}],7:[function(a,b,c){"use strict";function d(a,b,c){var d=a,f=g(a,1,-1-b,b,0,c,-1,2),h=g(a,1,1-b,2+b,0,c,-1,2);return(f||h)&&(d=g(a,1,-b,1+b,0,c,-1,2),f&&(d=e(f,1).concat(d)),h&&(d=d.concat(e(h,-1)))),d}function e(a,b){for(var c=[],d=0;d<a.length;d++){var e,g=a[d],h=g.type;if(1===h)e=f(g.geometry,b);else{e=[];for(var i=0;i<g.geometry.length;i++)e.push(f(g.geometry[i],b))}c.push({geometry:e,type:h,tags:g.tags,min:[g.min[0]+b,g.min[1]],max:[g.max[0]+b,g.max[1]]})}return c}function f(a,b){var c=[];c.area=a.area,c.dist=a.dist;for(var d=0;d<a.length;d++)c.push([a[d][0]+b,a[d][1],a[d][2]]);return c}var g=a("./clip");b.exports=d},{"./clip":1}]},{},[3])(3)}),function(){"use strict";function a(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;e-1>d;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function b(){function b(b){var c,d,e,f,g,h,i;if(b){if((b.x&&"NaN"!==b.x||0===b.x)&&(b.y&&"NaN"!==b.y||0===b.y))f="Point",e=[b.x,b.y];else if(b.points&&b.points.length)f="MultiPoint",e=b.points;else if(b.paths&&b.paths.length)g=b.paths,1===g.length?(f="LineString",e=g[0]):(f="MultiLineString",e=g);else if(b.rings&&b.rings.length){for(h=[],g=b.rings,d=0;d<g.length;d++)i=g[d],a(i)?h.push([i]):h.length>0&&h[h.length-1].push(i);h.length>1?(e=h,f="MultiPolygon"):(e=h.pop(),f="Polygon")}return c=e&&f?{type:f,coordinates:e}:null}return c}function c(a){var c,d,e,f=null;if(a&&(f={type:"Feature"},a.geometry&&(f.geometry=b(a.geometry)),a.attributes)){d={},e=a.attributes;for(c in a.attributes)d[c]=a.attributes[c];f.properties=d}return f}var d={};return d.toGeoJson=function(a){var d,e,f,g;if(a)if(a.features)for(d={type:"FeatureCollection",features:[]},f=a.features,e=0;e<f.length;e++)g=c(f[e]),g&&d.features.push(g);else d=a.geometry?c(a):b(a);return d},d}function c(){function b(a,b){var c=!1;return("esriGeometryPoint"!==a&&"esriGeometryMultipoint"!==a||"Point"!==b&&"MultiPoint"!==b)&&("esriGeometryPolyline"!==a||"LineString"!==b&&"MultiLineString"!==b)?"esriGeometryPolygon"!==a||"Polygon"!==b&&"MultiPolygon"!==b||(c=!0):c=!0,c}function c(a){var b,c;return"Point"===a?b="esriGeometryPoint":"MultiPoint"===a?(b="esriGeometryMultipoint",c="points"):"LineString"===a||"MultiLineString"===a?(b="esriGeometryPolyline",c="paths"):("Polygon"===a||"MultiPolygon"===a)&&(b="esriGeometryPolygon",c="rings"),{type:b,geomHolder:c}}function d(b){var c,d,e,f=[];for(c=0,d=b.length;d>c;c++)e=b[c],0===c!==a(e)&&(e=e.reverse()),f.push(e);return f}function e(a){var b,c,e;if("MultiPoint"===a.type||"MultiLineString"===a.type)e=a.coordinates||[];else if("Point"===a.type||"LineString"===a.type)e=a.coordinates?[a.coordinates]:[];else if("Polygon"===a.type)e=[],a.coordinates&&(e=d(a.coordinates));else if("MultiPolygon"===a.type&&(e=[],a.coordinates))for(b=0,c=a.coordinates.length;c>b;b++)e.push(d(a.coordinates[b]));return e}function f(a){var d,f,g,h,i,j;if("GeometryCollection"===a.type){var k=a.geometries[0];for(g=[],f=c(k.type),h=0;h<a.geometries.length;h++)b(f.type,a.geometries[h].type)&&g.push(a.geometries[h])}else f=c(a.type),g=[a];if("esriGeometryPoint"===f.type&&g.length>1&&(f=c("MultiPoint")),d={spatialReference:{wkid:4326}},"esriGeometryPoint"===f.type)g[0]&&g[0].coordinates&&0!==g[0].coordinates.length?(d.x=g[0].coordinates[0],d.y=g[0].coordinates[1]):d.x=null;else for(d[f.geomHolder]=[],h=0;h<g.length;h++)for(j=e(g[h]),i=0;i<j.length;i++)d[f.geomHolder].push(j[i]);return d}function g(a){var b,c,d;if(a&&(b={},a.geometry&&(b.geometry=f(a.geometry)),a.properties)){d={};for(c in a.properties)d[c]=a.properties[c];b.attributes=d}return b}var h={};return h.toEsri=function(a){var b,c,d,e;if(a)if("FeatureCollection"===a.type)for(b={features:[]},d=a.features,c=0;c<d.length;c++)e=g(d[c]),e&&b.features.push(e);else b="Feature"===a.type?g(a):f(a);return b},h}var d;if(d="undefined"!=typeof exports&&null!==exports?exports:this,"function"==typeof define){var e={esriConverter:b,geoJsonConverter:c};define([],function(){return e})}else d.esriConverter=b,d.geoJsonConverter=c}.call(this),MapExpress.Service.BaseDataProvider=L.Class.extend({statics:{},options:{tileSize:256,subdomains:"abc",useQuadkey:!1,maxZoom:23,uppercase:!1,crs:L.CRS.EPSG3857,identifyFormat:"text/html",identifyLayersId:""},initialize:function(a){"string"==typeof this.options.subdomains&&(this.options.subdomains=this.options.subdomains.split(""))},getDataAsync:function(){},getDataUrl:function(){},getDataInBoundsAsync:function(a,b){var c=this.getDataUrlByBounds(a,b),d=new MapExpress.Utils.Promise.QImage(c);return d},getDataUrlByBounds:function(a,b){},getDataByTileAsync:function(a){},getDataUrlByTile:function(a){return this._dataUrl?this.options.useQuadkey?L.Util.template(this._dataUrl,L.extend({r:this.options.tileCoord&&L.Browser.retina&&this.options.maxZoom>0?"@2x":"",s:this._getSubdomain(a),q:this._tileCoordsToQuadkey(a)},this.options)):L.Util.template(this._dataUrl,L.extend({r:this.options.tileCoord&&L.Browser.retina&&this.options.maxZoom>0?"@2x":"",s:this._getSubdomain(a),x:a.x,y:a.y,z:a.z},this.options)):void 0},getFeatureInfoAsync:function(a,b,c,d,e){var f=this.getFeatureInfoUrl(a,b,c,d,e);if(f){var g="json"===this.options.identifyFormat||"pjson"===this.options.identifyFormat?!0:!1;return MapExpress.Utils.Promise.qAjax(f,!g)}},getFeatureInfoUrl:function(a,b,c,d,e){},_tileCoordToBounds:function(a){var b=this.options.tileSize,c=L.CRS.EPSG3857,d=new L.Point(a.x*b,a.y*b),e=new L.Point(d.x+b,d.y+b),f=c.pointToLatLng(d,a.z),g=c.pointToLatLng(e,a.z),h=c.wrapLatLng(f),i=c.wrapLatLng(g);return new L.LatLngBounds(h,i)},_getTileCoordRangeByMapBounds:function(a,b){var c=[];if(void 0===a)return c;for(var d=a.getNorthWest(),e=a.getSouthEast(),f=this._getTileCoordByLatLng(d,b),g=this._getTileCoordByLatLng(e,b),h=f.y;h<=g.y;h++)for(var i=f.x;i<=g.x;i++){var j=new L.Point(i,h);j.z=b,c.push(j)}return c},_getAddedTileCoordRangeByMapBounds:function(a,b,c,d){return this._getAddedAndRemovedTileCoordRangeByMapBounds(a,b,c,d).Added},_getRemovedTileCoordRangeByMapBounds:function(a,b,c,d){return this._getAddedAndRemovedTileCoordRangeByMapBounds(a,b,c,d).Removed},_getAddedAndRemovedTileCoordRangeByMapBounds:function(a,b,c,d){var e={},f=function(a,b){for(var c=0;c<a.length;c++)if(a[c].x===b.x&&a[c].y===b.y&&a[c].z===b.z)return!0;return!1},g=this._getTileCoordRangeByMapBounds(c,d),h=this._getTileCoordRangeByMapBounds(a,b);if(b!==d)return e.Added=g,e.Removed=h,e;var i=g.filter(function(a){return!f(h,a)}),j=h.filter(function(a){return!f(g,a)});return e.Added=i,e.Removed=j,e},_getTileCoordByLatLng:function(a,b){var c=(this.options.tileSize,L.CRS.EPSG3857),d=c.latLngToPoint(a,b);return this._pixelPointToTileCoord(d,b)},_pixelPointToTileCoord:function(a,b){var c=this.options.tileSize,d=Math.ceil(a.x/c)-1,e=Math.ceil(a.y/c)-1,f=new L.Point(d,e);return f.z=b,f},_tileCoordsToQuadkey:function(a){for(var b="",c=a.z;c>0;c--){var d=0,e=1<<c-1;0!==(a.x&e)&&d++,0!==(a.y&e)&&(d++,d++),b+=d}return b},_tileCoordsToKey:function(a){return a.x+":"+a.y+":"+a.z},_getSubdomain:function(a){var b=Math.abs(a.x+a.y)%this.options.subdomains.length;return this.options.subdomains[b]},_boundsEquals:function(a,b,c){var d=b.getNorthEast(),e=a.getNorthEast(),f=a.getSouthWest(),g=b.getSouthWest(),h=Math.max(Math.abs(e.lat-d.lat),Math.abs(e.lng-d.lng)),i=Math.max(Math.abs(f.lat-g.lat),Math.abs(f.lng-g.lng)),j=(void 0===c?0:c)>=h,k=(void 0===c?0:c)>=i;return j&&k}}),MapExpress.Service.baseDataProvider=function(a){return new MapExpress.Service.BaseDataProvider(a)},MapExpress.Service.EsriBaseProvider=MapExpress.Service.BaseDataProvider.extend({options:{tileSize:256,crs:L.CRS.EPSG3857,identifyUrl:"",identifyFormat:"json",identifyTolerance:1},initialize:function(a,b){MapExpress.Service.BaseDataProvider.prototype.initialize.call(this,b),this._dataUrl=a,L.setOptions(this,b)},getDataByTileAsync:function(a){var b=this._tileCoordToBounds(a),c=new L.Point(this.options.tileSize,this.options.tileSize);return this.getDataInBoundsAsync(b,c)},getDataUrlByTile:function(a){var b=this._tileCoordToBounds(a),c=new L.Point(this.options.tileSize,this.options.tileSize);return this.getDataUrlByBounds(b,c)},getFeatureInfoUrl:function(a,b,c,d,e){var f=this.options.identifyLayersId?"visible:"+this.options.identifyLayersId:"top",g={geometryType:"esriGeometryPoint",sr:"4326",layers:f,tolerance:this.options.identifyTolerance,imageDisplay:[d.x,d.y,"96"].join(","),returnGeometry:!1,f:this.options.identifyFormat,geometry:[a.lng,a.lat].join(","),mapExtent:[c._northEast.lng,c._northEast.lat,c._southWest.lng,c._southWest.lat].join(",")},h=this.options.uppercase||!1,i=this.options.identifyUrl?this.options.identifyUrl:this._dataUrl;return i+"/identify"+L.Util.getParamString(g,i,h)}}),MapExpress.Service.esriBaseProvider=function(a,b){return new MapExpress.Service.EsriBaseProvider(a,b)},MapExpress.Service.FeatureServiceAgsProvider=MapExpress.Service.EsriBaseProvider.extend({defaultFeatureServiceParams:{where:"",text:"",objectIds:"",time:"",geometryType:"esriGeometryEnvelope",inSR:"",spatialRel:"esriSpatialRelIntersects",relationParam:"",outFields:"*",returnGeometry:!0,maxAllowableOffset:"",geometryPrecision:"",returnIdsOnly:!1,orderByFields:"",groupByFieldsForStatistics:"",outStatistics:"",returnZ:!1,returnM:!1,gdbVersion:"",returnDistinctValues:!1,f:"json"},options:{layerId:""},initialize:function(a,b){MapExpress.Service.EsriBaseProvider.prototype.initialize.call(this,b),this._dataUrl=a,this.esriConverter=esriConverter();var c=L.extend({},this.defaultFeatureServiceParams);for(var d in b)d in this.options||(c[d]=b[d]);L.setOptions(this,b),this.defaultFeatureServiceParams=c},getDataInBoundsAsync:function(a,b){var c=this,d=this.getDataUrlByBounds(a,b);return MapExpress.Utils.Promise.qAjax(d).then(function(a){return a?c.esriConverter.toGeoJson(a):void 0})},getDataUrlByBounds:function(a,b){var c=this.options.crs,d=c.project(a.getNorthWest()),e=c.project(a.getSouthEast()),f={};f.inSR=c.code,f.outSR="4326",f.geometry=L.Util.template("{xmin: {0}, ymin: {1}, xmax: {2}, ymax: {3}}",{0:d.x,1:e.y,2:e.x,3:d.y}),L.extend(this.defaultFeatureServiceParams,f);var g=this.options.uppercase||!1,h=L.Util.getParamString(this.defaultFeatureServiceParams,this._dataUrl,g);return this._dataUrl+"/"+this.options.layerId+"/query"+h}}),MapExpress.Service.featureServiceAgsProvider=function(a,b){return new MapExpress.Service.FeatureServiceAgsProvider(a,b)},MapExpress.Service.GeoJSONProvider=MapExpress.Service.BaseDataProvider.extend({options:{useTileIndex:!1,identifyFormat:"json"},initialize:function(a,b){MapExpress.Service.BaseDataProvider.prototype.initialize.call(this,b),L.setOptions(this,b),this._dataUrl=a,this._dataUrl&&this._loadDataAsync()},getDataAsync:function(){return MapExpress.Utils.Promise.qAjax(this._dataUrl)},getDataInBoundsAsync:function(a,b){var c=this.getDataUrlByBounds(a,b);return MapExpress.Utils.Promise.qAjax(c)},getDataByTileAsync:function(a){if(this.options.useTileIndex)return this._getVectorTileIndexPromise(a);var b=this.getDataUrlByTile(a);return MapExpress.Utils.Promise.qAjax(b)},getFeatureInfoAsync:function(a,b,c,d,e){},_loadDataAsync:function(){var a=this;this.getDataAsync().then(function(b){a.geoJson=b,a.options.useTileIndex&&(a.tileIndex=geojsonvt(b))})},_getVectorTileIndexPromise:function(a){var b=Q.defer();try{var c=this.tileIndex.getTile(a.z,a.x,a.y);b.resolve(c)}catch(d){d.tileCoord=a,b.reject(d)}return b.promise}}),MapExpress.Service.geoJSONProvider=function(a,b){return new MapExpress.Service.GeoJSONProvider(a,b)},MapExpress.Service.MapServiceAgsProvider=MapExpress.Service.EsriBaseProvider.extend({defaultParams:{size:"256,256",bboxSR:3857,imageSR:3857,dpi:96,f:"image",format:"png32",transparent:!0,layersId:""},initialize:function(a,b){MapExpress.Service.EsriBaseProvider.prototype.initialize.call(this,b),this._dataUrl=a;var c=L.extend({},this.defaultParams);for(var d in b)d in this.options||(c[d]=b[d]);L.setOptions(this,b),this.mapServiceParams=c},getDataUrlByBounds:function(a,b){var c=this.options.crs,d=c.project(a.getNorthWest()),e=c.project(a.getSouthEast()),f={};f.bbox=[d.x,e.y,e.x,d.y].join(","),f.layers="visible:"+this.options.layersId,L.extend(this.mapServiceParams,f);var g=this.options.uppercase||!1,h=L.Util.getParamString(this.mapServiceParams,this._url,g);return this._dataUrl+"/export"+h}}),MapExpress.Service.mapServiceAgsProvider=function(a,b){return new MapExpress.Service.MapServiceAgsProvider(a,b)},MapExpress.Service.TileProvider=MapExpress.Service.BaseDataProvider.extend({initialize:function(a,b){MapExpress.Service.BaseDataProvider.prototype.initialize.call(this,b),L.setOptions(this,b),this._dataUrl=a},getDataByTileAsync:function(a){var b=this.getDataUrlByTile(a),c=new MapExpress.Utils.Promise.QImage(b);return c},getFeatureInfoAsync:function(a,b,c,d,e){}}),MapExpress.Service.tileProvider=function(a,b){return new MapExpress.Service.TileProvider(a,b)},MapExpress.Service.WmsProvider=MapExpress.Service.BaseDataProvider.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/png",transparent:!1,dpi:96},options:{},initialize:function(a,b){MapExpress.Service.BaseDataProvider.prototype.initialize.call(this,b),this._dataUrl=a;var c=L.extend({},this.defaultWmsParams);for(var d in b)d in this.options||(c[d]=b[d]);b=L.setOptions(this,b),c.width=c.height=b.tileSize*(b.detectRetina&&L.Browser.retina?2:1),this.wmsParams=c},getDataInBoundsAsync:function(a,b){var c=this.getDataUrlByBounds(a,b),d=new MapExpress.Utils.Promise.QImage(c);return d},getDataByTileAsync:function(a){var b=this._tileCoordToBounds(a),c=new L.Point(this.options.tileSize,this.options.tileSize);return this.getDataInBoundsAsync(b,c)},getDataUrlByBounds:function(a,b){var c=parseFloat(this.wmsParams.version),d=this.options.crs,e=c>=1.3?"crs":"srs",f=d.project(a.getNorthWest()),g=d.project(a.getSouthEast()),h={width:b.x,height:b.y};h[e]=d.code,h.bbox=(c>=1.3&&d===L.CRS.EPSG4326?[g.y,f.x,f.y,g.x]:[f.x,g.y,g.x,f.y]).join(","),L.extend(this.wmsParams,h);var i=this.options.uppercase||!1,j=L.Util.getParamString(this.wmsParams,this._dataUrl,i);return this._dataUrl+j},getDataUrlByTile:function(a){var b=this._tileCoordToBounds(a),c=new L.Point(this.options.tileSize,this.options.tileSize);return this.getDataUrlByBounds(b,c)},getFeatureInfoUrl:function(a,b,c,d,e){var f=parseFloat(this.wmsParams.version),g=this.options.identifyLayersId?this.options.identifyLayersId:this.wmsParams.layers,h={request:"GetFeatureInfo",service:"WMS",styles:this.wmsParams.styles,transparent:this.wmsParams.transparent,version:this.wmsParams.version,format:this.wmsParams.format,bbox:c.toBBoxString(),height:d.y,width:d.x,layers:g,query_layers:g,info_format:this.options.identifyFormat},i=f>=1.3?"crs":"srs";h[i]="EPSG:4326",h[f>=1.3?"i":"x"]=b.x,h[f>=1.3?"j":"y"]=b.y;var j=this.options.uppercase||!1;return this._dataUrl+L.Util.getParamString(h,this._url,j)}}),MapExpress.Service.wmsProvider=function(a,b){return new MapExpress.Service.WmsProvider(a,b)},MapExpress.Tools.BaseMapCommand=L.Class.extend({options:{},initialize:function(a,b){this._mapManager=a,L.setOptions(this,b)},createContent:function(){},activate:function(){},deactivate:function(){},doCommand:function(a){}}),MapExpress.Service.baseMapCommand=function(a,b){return new MapExpress.Tools.BaseMapCommand(a,b)},MapExpress.Tools.IdentifyMapCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"btn btn-default btn-sm text-center"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),
L.setOptions(this,b),this._active=!1},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a);L.DomUtil.create("i","fa fa-info fa-lg fa-fw",b);return b.setAttribute("data-toggle","tooltip"),b.setAttribute("data-placement","bottom"),b.setAttribute("title","Информация"),b},activate:function(){this._active||this._mapManager._map.on("click",this.doCommand,this),this._active=!0},deactivate:function(){this._mapManager._map.off("click",this.doCommand,this),this._active=!1},doCommand:function(a){var b=this,c=[],d=[],e=this._getQueryableLayers(),f=this._mapManager._map,g=a.latlng,h=a.layerPoint,i=f.getZoom(),j=f.getBounds(),k=f.getSize();d.latlng=g;for(var l=[],m=0;m<e.length;m++){var n=e[m],o=n._dataPovider;if(o){var p=o.getFeatureInfoAsync(g,h,j,k,i);!p&&n instanceof MapExpress.Layers.GeoJSONServiceLayer&&(p=n._getFeaturesAtPoint(g,h,j,k,i)),p&&(l.push(p),c.push(n))}}Q.allSettled(l).then(function(a){for(var e=0;e<a.length;e++){var f=a[e];if("fulfilled"===f.state){var g={};g.layer=c[e],g.data=f.value,d.push(g)}}b._showInfo(d)})},_getQueryableLayers:function(){var a=this._mapManager.getLayers();return a},_showInfo:function(a){var b="";a.forEach(function(a){if(a.data){var c,d=resultFormatter(),e=!0;a.layer._dataPovider&&a.layer._dataPovider.options.identifyFormat.indexOf("json")>-1;a.data.error&&(e=!1),e&&a.data.results&&a.data.results.length>0&&(c=d.formatGeoJSON(a.data.results[0]),e=!1),a.data.results&&0===a.data.results.length&&(e=!1),e&&L.Util.isArray(a.data)&&a.data.length>0&&(c=d.formatGeoJSON(a.data[0]),e=!1),L.Util.isArray(a.data)&&0===a.data.length&&(e=!1),e&&(c=a.data),c&&(b+="<h4>"+a.layer.displayName+"</h4>"+c)}}),b&&L.popup({maxWidth:600,maxHeight:600}).setLatLng(a.latlng).setContent(b).openOn(this._mapManager._map)}}),MapExpress.Service.identifyMapCommand=function(a,b){return new MapExpress.Tools.IdentifyMapCommand(a,b)},MapExpress.Tools.MapToolbar=L.Control.extend({options:{position:"topleft",containerClassName:"panel panel-default"},initialize:function(a,b){this._mapManager=a,L.setOptions(this,b),this._commands=[]},onAdd:function(){return this._createContainer()},addTo:function(){L.Control.prototype.addTo.call(this,this._mapManager._map)},addCommand:function(a){return this._commands.push(a),this},_createContainer:function(){this._container=L.DomUtil.create("div",this.options.containerClassName),this._container.style.padding="3px";var a=L.DomUtil.create("div","panel-body",this._container);a.style.padding="3px";for(var b=0;b<this._commands.length;b++)this._createCommandContent(this._commands[b],a);return this._container},_createCommandContent:function(a,b){var c=this,d=a.createContent(b);return d.command=a,L.DomEvent.addListener(d,"click",L.DomEvent.stopPropagation).addListener(d,"click",L.DomEvent.preventDefault).addListener(d,"click",function(){c._activeCommand&&c._activeCommand.deactivate(),c._activeCommand=d.command,d.command.activate()}),d}}),MapExpress.Service.mapToolbar=function(a,b){return new MapExpress.Tools.MapToolbar(a,b)},MapExpress.Tools.ShowLayerControlMapCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"btn btn-default btn-sm text-center"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b),this._active=!1},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a);L.DomUtil.create("i","fa fa-bars fa-lg fa-fw",b);return b.setAttribute("data-toggle","tooltip"),b.setAttribute("data-placement","bottom"),b.setAttribute("title","Слои"),b}}),MapExpress.Service.showLayerControlMapCommand=function(a,b){return new MapExpress.Tools.ShowLayerControlMapCommand(a,b)},function(){"use strict";function a(){function a(a){var b='<table class="table"> <tbody>';for(var c in a)b+="<tr>",b=b+"<td>"+c+"</td>",b=b+"<td>"+a[c]+"</td>",b+="</tr>";return b+"</tbody></table>"}var b={};return b.formatGeoJSON=function(b){return b.attributes?a(b.attributes):b.properties?a(b.properties):void 0},b}var b;if(b="undefined"!=typeof exports&&null!==exports?exports:this,"function"==typeof define){var c={resultFormatter:a};define([],function(){return c})}else b.resultFormatter=a}.call(this),function(a){"use strict";if("function"==typeof bootstrap)bootstrap("promise",a);else if("object"==typeof exports&&"object"==typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=a}else{if("undefined"==typeof window&&"undefined"==typeof self)throw new Error("This environment was not anticipated by Q. Please file a bug.");var b="undefined"!=typeof window?window:self,c=b.Q;b.Q=a(),b.Q.noConflict=function(){return b.Q=c,this}}}(function(){"use strict";function a(a){return function(){return W.apply(a,arguments)}}function b(a){return a===Object(a)}function c(a){return"[object StopIteration]"===ca(a)||a instanceof S}function d(a,b){if(P&&b.stack&&"object"==typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf(da)){for(var c=[],d=b;d;d=d.source)d.stack&&c.unshift(d.stack);c.unshift(a.stack);var f=c.join("\n"+da+"\n");a.stack=e(f)}}function e(a){for(var b=a.split("\n"),c=[],d=0;d<b.length;++d){var e=b[d];h(e)||f(e)||!e||c.push(e)}return c.join("\n")}function f(a){return-1!==a.indexOf("(module.js:")||-1!==a.indexOf("(node.js:")}function g(a){var b=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(a);if(b)return[b[1],Number(b[2])];var c=/at ([^ ]+):(\d+):(?:\d+)$/.exec(a);if(c)return[c[1],Number(c[2])];var d=/.*@(.+):(\d+)$/.exec(a);return d?[d[1],Number(d[2])]:void 0}function h(a){var b=g(a);if(!b)return!1;var c=b[0],d=b[1];return c===R&&d>=T&&ia>=d}function i(){if(P)try{throw new Error}catch(a){var b=a.stack.split("\n"),c=b[0].indexOf("@")>0?b[1]:b[2],d=g(c);if(!d)return;return R=d[0],d[1]}}function j(a,b,c){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(b+" is deprecated, use "+c+" instead.",new Error("").stack),a.apply(a,arguments)}}function k(a){return a instanceof o?a:s(a)?B(a):A(a)}function l(){function a(a){b=a,f.source=a,Y(c,function(b,c){k.nextTick(function(){a.promiseDispatch.apply(a,c)})},void 0),c=void 0,d=void 0}var b,c=[],d=[],e=_(l.prototype),f=_(o.prototype);if(f.promiseDispatch=function(a,e,f){var g=X(arguments);c?(c.push(g),"when"===e&&f[1]&&d.push(f[1])):k.nextTick(function(){b.promiseDispatch.apply(b,g)})},f.valueOf=function(){if(c)return f;var a=q(b);return r(a)&&(b=a),a},f.inspect=function(){return b?b.inspect():{state:"pending"}},k.longStackSupport&&P)try{throw new Error}catch(g){f.stack=g.stack.substring(g.stack.indexOf("\n")+1)}return e.promise=f,e.resolve=function(c){b||a(k(c))},e.fulfill=function(c){b||a(A(c))},e.reject=function(c){b||a(z(c))},e.notify=function(a){b||Y(d,function(b,c){k.nextTick(function(){c(a)})},void 0)},e}function m(a){if("function"!=typeof a)throw new TypeError("resolver must be a function.");var b=l();try{a(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}return b.promise}function n(a){return m(function(b,c){for(var d=0,e=a.length;e>d;d++)k(a[d]).then(b,c)})}function o(a,b,c){void 0===b&&(b=function(a){return z(new Error("Promise does not support operation: "+a))}),void 0===c&&(c=function(){return{state:"unknown"}});var d=_(o.prototype);if(d.promiseDispatch=function(c,e,f){var g;try{g=a[e]?a[e].apply(d,f):b.call(d,e,f)}catch(h){g=z(h)}c&&c(g)},d.inspect=c,c){var e=c();"rejected"===e.state&&(d.exception=e.reason),d.valueOf=function(){var a=c();return"pending"===a.state||"rejected"===a.state?d:a.value}}return d}function p(a,b,c,d){return k(a).then(b,c,d)}function q(a){if(r(a)){var b=a.inspect();if("fulfilled"===b.state)return b.value}return a}function r(a){return a instanceof o}function s(a){return b(a)&&"function"==typeof a.then}function t(a){return r(a)&&"pending"===a.inspect().state}function u(a){return!r(a)||"fulfilled"===a.inspect().state}function v(a){return r(a)&&"rejected"===a.inspect().state}function w(){ea.length=0,fa.length=0,ha||(ha=!0)}function x(a,b){ha&&("object"==typeof process&&"function"==typeof process.emit&&k.nextTick.runAfter(function(){-1!==Z(fa,a)&&(process.emit("unhandledRejection",b,a),ga.push(a))}),fa.push(a),b&&"undefined"!=typeof b.stack?ea.push(b.stack):ea.push("(no stack) "+b))}function y(a){if(ha){var b=Z(fa,a);-1!==b&&("object"==typeof process&&"function"==typeof process.emit&&k.nextTick.runAfter(function(){var c=Z(ga,a);-1!==c&&(process.emit("rejectionHandled",ea[b],a),ga.splice(c,1))}),fa.splice(b,1),ea.splice(b,1))}}function z(a){var b=o({when:function(b){return b&&y(this),b?b(a):this}},function(){return this},function(){return{state:"rejected",reason:a}});return x(b,a),b}function A(a){return o({when:function(){return a},get:function(b){return a[b]},set:function(b,c){a[b]=c},"delete":function(b){delete a[b]},post:function(b,c){return null===b||void 0===b?a.apply(void 0,c):a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},keys:function(){return ba(a)}},void 0,function(){return{state:"fulfilled",value:a}})}function B(a){var b=l();return k.nextTick(function(){try{a.then(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}}),b.promise}function C(a){return o({isDef:function(){}},function(b,c){return I(a,b,c)},function(){return k(a).inspect()})}function D(a,b,c){return k(a).spread(b,c)}function E(a){return function(){function b(a,b){var g;if("undefined"==typeof StopIteration){try{g=d[a](b)}catch(h){return z(h)}return g.done?k(g.value):p(g.value,e,f)}try{g=d[a](b)}catch(h){return c(h)?k(h.value):z(h)}return p(g,e,f)}var d=a.apply(this,arguments),e=b.bind(b,"next"),f=b.bind(b,"throw");return e()}}function F(a){k.done(k.async(a)())}function G(a){throw new S(a)}function H(a){return function(){return D([this,J(arguments)],function(b,c){return a.apply(b,c)})}}function I(a,b,c){return k(a).dispatch(b,c)}function J(a){return p(a,function(a){var b=0,c=l();return Y(a,function(d,e,f){var g;r(e)&&"fulfilled"===(g=e.inspect()).state?a[f]=g.value:(++b,p(e,function(d){a[f]=d,0===--b&&c.resolve(a)},c.reject,function(a){c.notify({index:f,value:a})}))},void 0),0===b&&c.resolve(a),c.promise})}function K(a){if(0===a.length)return k.resolve();var b=k.defer(),c=0;return Y(a,function(d,e,f){function g(a){b.resolve(a)}function h(){c--,0===c&&b.reject(new Error("Q can't get fulfillment value from any promise, all promises were rejected."))}function i(a){b.notify({index:f,value:a})}var j=a[f];c++,p(j,g,h,i)},void 0),b.promise}function L(a){return p(a,function(a){return a=$(a,k),p(J($(a,function(a){return p(a,U,U)})),function(){return a})})}function M(a){return k(a).allSettled()}function N(a,b){return k(a).then(void 0,void 0,b)}function O(a,b){return k(a).nodeify(b)}var P=!1;try{throw new Error}catch(Q){P=!!Q.stack}var R,S,T=i(),U=function(){},V=function(){function a(){for(var a,d;c.next;)c=c.next,a=c.task,c.task=void 0,d=c.domain,d&&(c.domain=void 0,d.enter()),b(a,d);for(;h.length;)a=h.pop(),b(a);e=!1}function b(b,c){try{b()}catch(d){if(g)throw c&&c.exit(),setTimeout(a,0),c&&c.enter(),d;setTimeout(function(){throw d},0)}c&&c.exit()}var c={task:void 0,next:null},d=c,e=!1,f=void 0,g=!1,h=[];if(V=function(a){d=d.next={task:a,domain:g&&process.domain,next:null},e||(e=!0,f())},"object"==typeof process&&"[object process]"===process.toString()&&process.nextTick)g=!0,f=function(){process.nextTick(a)};else if("function"==typeof setImmediate)f="undefined"!=typeof window?setImmediate.bind(window,a):function(){setImmediate(a)};else if("undefined"!=typeof MessageChannel){var i=new MessageChannel;i.port1.onmessage=function(){f=j,i.port1.onmessage=a,a()};var j=function(){i.port2.postMessage(0)};f=function(){setTimeout(a,0),j()}}else f=function(){setTimeout(a,0)};return V.runAfter=function(a){h.push(a),e||(e=!0,f())},V}(),W=Function.call,X=a(Array.prototype.slice),Y=a(Array.prototype.reduce||function(a,b){var c=0,d=this.length;if(1===arguments.length)for(;;){if(c in this){b=this[c++];break}if(++c>=d)throw new TypeError}for(;d>c;c++)c in this&&(b=a(b,this[c],c));return b}),Z=a(Array.prototype.indexOf||function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return b;return-1}),$=a(Array.prototype.map||function(a,b){var c=this,d=[];return Y(c,function(e,f,g){d.push(a.call(b,f,g,c))},void 0),d}),_=Object.create||function(a){function b(){}return b.prototype=a,new b},aa=a(Object.prototype.hasOwnProperty),ba=Object.keys||function(a){var b=[];for(var c in a)aa(a,c)&&b.push(c);return b},ca=a(Object.prototype.toString);S="undefined"!=typeof ReturnValue?ReturnValue:function(a){this.value=a};var da="From previous event:";k.resolve=k,k.nextTick=V,k.longStackSupport=!1,"object"==typeof process&&process&&process.env&&process.env.Q_DEBUG&&(k.longStackSupport=!0),k.defer=l,l.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):arguments.length>2?a.resolve(X(arguments,1)):a.resolve(c)}},k.Promise=m,k.promise=m,m.race=n,m.all=J,m.reject=z,m.resolve=k,k.passByCopy=function(a){return a},o.prototype.passByCopy=function(){return this},k.join=function(a,b){return k(a).join(b)},o.prototype.join=function(a){return k([this,a]).spread(function(a,b){if(a===b)return a;throw new Error("Q can't join: not the same: "+a+" "+b)})},k.race=n,o.prototype.race=function(){return this.then(k.race)},k.makePromise=o,o.prototype.toString=function(){return"[object Promise]"},o.prototype.then=function(a,b,c){function e(b){try{return"function"==typeof a?a(b):b}catch(c){return z(c)}}function f(a){if("function"==typeof b){d(a,h);try{return b(a)}catch(c){return z(c)}}return z(a)}function g(a){return"function"==typeof c?c(a):a}var h=this,i=l(),j=!1;return k.nextTick(function(){h.promiseDispatch(function(a){j||(j=!0,i.resolve(e(a)))},"when",[function(a){j||(j=!0,i.resolve(f(a)))}])}),h.promiseDispatch(void 0,"when",[void 0,function(a){var b,c=!1;try{b=g(a)}catch(d){if(c=!0,!k.onerror)throw d;k.onerror(d)}c||i.notify(b)}]),i.promise},k.tap=function(a,b){return k(a).tap(b)},o.prototype.tap=function(a){return a=k(a),this.then(function(b){return a.fcall(b).thenResolve(b)})},k.when=p,o.prototype.thenResolve=function(a){return this.then(function(){return a})},k.thenResolve=function(a,b){return k(a).thenResolve(b)},o.prototype.thenReject=function(a){return this.then(function(){throw a})},k.thenReject=function(a,b){return k(a).thenReject(b)},k.nearer=q,k.isPromise=r,k.isPromiseAlike=s,k.isPending=t,o.prototype.isPending=function(){return"pending"===this.inspect().state},k.isFulfilled=u,o.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},k.isRejected=v,o.prototype.isRejected=function(){return"rejected"===this.inspect().state};var ea=[],fa=[],ga=[],ha=!0;k.resetUnhandledRejections=w,k.getUnhandledReasons=function(){return ea.slice()},k.stopUnhandledRejectionTracking=function(){w(),ha=!1},w(),k.reject=z,k.fulfill=A,k.master=C,k.spread=D,o.prototype.spread=function(a,b){return this.all().then(function(b){return a.apply(void 0,b)},b)},k.async=E,k.spawn=F,k["return"]=G,k.promised=H,k.dispatch=I,o.prototype.dispatch=function(a,b){var c=this,d=l();return k.nextTick(function(){c.promiseDispatch(d.resolve,a,b)}),d.promise},k.get=function(a,b){return k(a).dispatch("get",[b])},o.prototype.get=function(a){return this.dispatch("get",[a])},k.set=function(a,b,c){return k(a).dispatch("set",[b,c])},o.prototype.set=function(a,b){return this.dispatch("set",[a,b])},k.del=k["delete"]=function(a,b){return k(a).dispatch("delete",[b])},o.prototype.del=o.prototype["delete"]=function(a){return this.dispatch("delete",[a])},k.mapply=k.post=function(a,b,c){return k(a).dispatch("post",[b,c])},o.prototype.mapply=o.prototype.post=function(a,b){return this.dispatch("post",[a,b])},k.send=k.mcall=k.invoke=function(a,b){return k(a).dispatch("post",[b,X(arguments,2)])},o.prototype.send=o.prototype.mcall=o.prototype.invoke=function(a){return this.dispatch("post",[a,X(arguments,1)])},k.fapply=function(a,b){return k(a).dispatch("apply",[void 0,b])},o.prototype.fapply=function(a){return this.dispatch("apply",[void 0,a])},k["try"]=k.fcall=function(a){return k(a).dispatch("apply",[void 0,X(arguments,1)])},o.prototype.fcall=function(){return this.dispatch("apply",[void 0,X(arguments)])},k.fbind=function(a){var b=k(a),c=X(arguments,1);return function(){return b.dispatch("apply",[this,c.concat(X(arguments))])}},o.prototype.fbind=function(){var a=this,b=X(arguments);return function(){return a.dispatch("apply",[this,b.concat(X(arguments))])}},k.keys=function(a){return k(a).dispatch("keys",[])},o.prototype.keys=function(){return this.dispatch("keys",[])},k.all=J,o.prototype.all=function(){return J(this)},k.any=K,o.prototype.any=function(){return K(this)},k.allResolved=j(L,"allResolved","allSettled"),o.prototype.allResolved=function(){return L(this)},k.allSettled=M,o.prototype.allSettled=function(){return this.then(function(a){return J($(a,function(a){function b(){return a.inspect()}return a=k(a),a.then(b,b)}))})},k.fail=k["catch"]=function(a,b){return k(a).then(void 0,b)},o.prototype.fail=o.prototype["catch"]=function(a){return this.then(void 0,a)},k.progress=N,o.prototype.progress=function(a){return this.then(void 0,void 0,a)},k.fin=k["finally"]=function(a,b){return k(a)["finally"](b)},o.prototype.fin=o.prototype["finally"]=function(a){if(!a||"function"!=typeof a.apply)throw new Error("Q can't apply finally callback");return a=k(a),this.then(function(b){return a.fcall().then(function(){return b})},function(b){return a.fcall().then(function(){throw b})})},k.done=function(a,b,c,d){return k(a).done(b,c,d)},o.prototype.done=function(a,b,c){var e=function(a){k.nextTick(function(){if(d(a,f),!k.onerror)throw a;k.onerror(a)})},f=a||b||c?this.then(a,b,c):this;"object"==typeof process&&process&&process.domain&&(e=process.domain.bind(e)),f.then(void 0,e)},k.timeout=function(a,b,c){return k(a).timeout(b,c)},o.prototype.timeout=function(a,b){var c=l(),d=setTimeout(function(){b&&"string"!=typeof b||(b=new Error(b||"Timed out after "+a+" ms"),b.code="ETIMEDOUT"),c.reject(b)},a);return this.then(function(a){clearTimeout(d),c.resolve(a)},function(a){clearTimeout(d),c.reject(a)},c.notify),c.promise},k.delay=function(a,b){return void 0===b&&(b=a,a=void 0),k(a).delay(b)},o.prototype.delay=function(a){return this.then(function(b){var c=l();return setTimeout(function(){c.resolve(b)},a),c.promise})},k.nfapply=function(a,b){return k(a).nfapply(b)},o.prototype.nfapply=function(a){var b=l(),c=X(a);return c.push(b.makeNodeResolver()),this.fapply(c).fail(b.reject),b.promise},k.nfcall=function(a){var b=X(arguments,1);return k(a).nfapply(b)},o.prototype.nfcall=function(){var a=X(arguments),b=l();return a.push(b.makeNodeResolver()),this.fapply(a).fail(b.reject),b.promise},k.nfbind=k.denodeify=function(a){if(void 0===a)throw new Error("Q can't wrap an undefined function");var b=X(arguments,1);return function(){var c=b.concat(X(arguments)),d=l();return c.push(d.makeNodeResolver()),k(a).fapply(c).fail(d.reject),d.promise}},o.prototype.nfbind=o.prototype.denodeify=function(){var a=X(arguments);return a.unshift(this),k.denodeify.apply(void 0,a)},k.nbind=function(a,b){var c=X(arguments,2);return function(){function d(){return a.apply(b,arguments)}var e=c.concat(X(arguments)),f=l();return e.push(f.makeNodeResolver()),k(d).fapply(e).fail(f.reject),f.promise}},o.prototype.nbind=function(){var a=X(arguments,0);return a.unshift(this),k.nbind.apply(void 0,a)},k.nmapply=k.npost=function(a,b,c){return k(a).npost(b,c)},o.prototype.nmapply=o.prototype.npost=function(a,b){var c=X(b||[]),d=l();return c.push(d.makeNodeResolver()),this.dispatch("post",[a,c]).fail(d.reject),d.promise},k.nsend=k.nmcall=k.ninvoke=function(a,b){var c=X(arguments,2),d=l();return c.push(d.makeNodeResolver()),k(a).dispatch("post",[b,c]).fail(d.reject),d.promise},o.prototype.nsend=o.prototype.nmcall=o.prototype.ninvoke=function(a){var b=X(arguments,1),c=l();return b.push(c.makeNodeResolver()),this.dispatch("post",[a,b]).fail(c.reject),c.promise},k.nodeify=O,o.prototype.nodeify=function(a){return a?void this.then(function(b){k.nextTick(function(){a(null,b)})},function(b){k.nextTick(function(){a(b)})}):this},k.noConflict=function(){throw new Error("Q.noConflict only works when Q is used as a global")};var ia=i();return k}),function(a){"use strict";MapExpress.Utils.Promise.qAjax=function(b,c){var d=a.defer();return c?$.get(b).done(function(a){d.resolve(a)}).fail(function(a,c,e){var f=new Error("Ajax request failed"+b);f.textStatus=c,f.errorThrown=e,d.reject(f)}):$.getJSON(b).done(function(a){d.resolve(a)}).fail(function(a,c,e){var f=new Error("Ajax request failed"+b);f.textStatus=c,f.errorThrown=e,d.reject(f)}),d.promise}}(Q),function(a){"use strict";MapExpress.Utils.Promise.qImage=function(b,c){c=c||{};var d=new Image;c.crossOrigin&&(d.crossOrigin=c.crossOrigin,d.alt="");var e=a.defer();return d.onload=function(){e.resolve(d)},d.onabort=function(a){e.reject(d)},d.onerror=function(a){e.reject(d)},d.src=b,e.promise}}(Q);