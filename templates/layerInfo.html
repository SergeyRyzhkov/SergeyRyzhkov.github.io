<script>
$.views.helpers({
	layerInfoTemplateIdAfterRender: function(object, templateUrl) {
		function _modifyTabContent(tabulId, data, templId, notJSON) {
			var currntDiv = $('#data_content_' + tabulId);
			//для готового контента
			if (notJSON === true) {
				$(currntDiv.children()).html(data);
				return;
			}

			if (templId === 'layerInfo-NullObject-TemplateId') {
				var selected = false;
				if($('#tab_layernameid_' + tabulId).hasClass('tab_selected')){
					selected = true;
				}
				$('#tab_layernameid_' + tabulId).remove();
				$('#data_content_' + tabulId).remove();
				
				if(selected === true){
					if($("li[id*='tab_layernameid_']").length >0){
						$($("li[id*='tab_layernameid_']")[0]).addClass('tab_selected');
						$($("div[id*='data_content_']")[0]).addClass('active');
					}else{
						$('.scroll_tab_inner').parent().parent().html('Совсем ничего не найдено')
					}
				}
				selected = false;
				
			}
			//для рендера даты
			var tempDiv = document.createElement('div');
			document.body.appendChild(tempDiv);

			$(tempDiv).load(templateUrl, function() {
				var template = $.templates("#" + templId);
				if (template) {
					var content = '';
					if (data.multi) {
						try {
							for (var i = 0; i < data.multi.length; i++) {
								content += template.render(data.multi[i]);
							}
						} catch (error) {
							console.log(error);
						}
					} else {
						content = template.render(data);
					}

					$('#data_content_' + tabulId).html(content);
					$(tempDiv).remove();
					//дополняем во вкладки число полученных объектов.
					var counts;
					if (data !== undefined && data.multi) {
						counts = data.multi.length;
					} else if (Object.keys(data).length === 0 || data.length === 0) {
						counts = 0;
					} else {
						counts = 1;
					}

					if ($('#tab_layernameid_' + tabulId).length !== 0) {
						var currntTabLi = $('#tab_layernameid_' + tabulId);
						currntTabLi.html(currntTabLi.html() + ' (' + counts + ')');
					} else {
						var aElems = $(".mfs-options li");
						for (var o = 0; o < aElems.length; o++) {
							if ($(aElems[o]).children().attr('index').toString() === tabulId.toString()) {
								if ($(aElems[o]).attr('class') === 'mfs-option selected') {
									$('.mfs-selected-option').html($('.mfs-selected-option').html() + ' (' + counts + ')');
								}
								$(aElems[o]).children().html($(aElems[o]).children().html() + ' (' + counts + ')');
							}
						}
					}
				}
			});
		}

		function _renderData(response, divId) {
			switch (typeof(response)) {
				case 'object': //json
					var obj = {};
					obj.multi = [];
					if (L.Util.isArray(response) && response.length > 0) {
						for (var k = 0; k < response.length; k++) {
							obj.multi.push(response[k]);
						}
						_modifyTabContent(divId, obj, 'layerInfo-Object-TemplateId');
					} else if (L.Util.isArray(response) && response.length === 0) {
						_modifyTabContent(divId, {}, 'layerInfo-NullObject-TemplateId');
					} else if (response.features) {
						if (response.features.length === 0) {
							_modifyTabContent(divId, {}, 'layerInfo-NullObject-TemplateId');
						} else if (response.features.length === 1) {
							_modifyTabContent(divId, response.features[0], 'layerInfo-Object-TemplateId');
						} else if (response.features.length > 0) {
							for (var l = 0; l < response.features.length; l++) {
								obj.multi.push(response.features[l]);
							}
							_modifyTabContent(divId, obj, 'layerInfo-Object-TemplateId');
						}
					} else if ((response instanceof Array) === true && response.length > 0) {
						for (var m = 0; m < response.length; m++) {
							obj.multi.push(response[m]);
						}
						_modifyTabContent(divId, obj, 'layerInfo-Object-TemplateId');
					} else {
						_modifyTabContent(divId, response, 'layerInfo-Object-TemplateId');
					}
					break;
				case 'string': //готовый контент
					_modifyTabContent(divId, response, '', true);
					break;
				case 'undefined':
				case null:
					_modifyTabContent(divId, {}, 'layerInfo-NullObject-TemplateId');
					break;
			}
		}

		//проверка на наличие сторонненого template
		function _checkTemplatesAndRender(data, id, template) {
			if (data === undefined) {
				_modifyTabContent(id, {}, 'layerInfo-NullObject-TemplateId');
				return;
			}
			if (template !== null) {
				var currntDiv = $('#data_content_' + id).children();
				$.templates({
					tmpl: template[0]
				});
				$(currntDiv).html($.render.tmpl(data));
			} else {
				_renderData(data, id);
			}
		}

		function collectData(obj) {
			$.when.apply($, [obj.numberInList]).done(function() {
				var id = arguments[0];
				//obj.templatePromise - если у провайдера указан урл и id теплейта, то провайдер вернет промайз, который будет обрабатываться вместе с промайзом на data
				//если у провайдера не указаны урл и id, то вернется null, который так же будет обрабатываться совместно с data
				$.when.apply($, [obj.templatePromise, obj.dataPromise]).done(function() {
					var templatePromise = arguments[0];
					var data = arguments[1];
					//простой аякс MapExpress возвращает массив из даты и опций, которые в большинстве случаев пустые
					//для стороннего контента
					if ((data instanceof Array) === true && typeof(data[0]) === 'string' && data[1] === undefined) {
						data = data[0];
					}
					_checkTemplatesAndRender(data, id, templatePromise);
				}).fail(function() {
					_modifyTabContent(id, {}, 'layerInfo-NullObject-TemplateId');
				});
			});
		}
		
		function startFunction(object) {
			var identObj = object;
			for (var i = 0; i < identObj.identifiedResults.length; i++) {
				collectData(identObj.identifiedResults[i]);
			}
		}

		function _modifyTabsOrList() {
			if ($('#mapexpress-tabSet').hasClass('scroll_tabs_container')) {
				$('#mapexpress-tabSet').destroy();
			}
			$('#mapexpress-tabSet').scrollTabs();

			$(".scroll_tabs_container div.scroll_tab_inner li").on('click', function() {
				$(this).closest('div.tabs').find('div.tabs__content').removeClass('active').eq($(this).index()).addClass('active');
			});

			//$('.mapexpress-collapsibleLayerInfoMenu').collapsible({
       			accordion : true
   			//});
			//$('#mapexpress-formSet').mfs({
			//	'autoWidth': true
			//});
			//$(".mfs-options li a").on('click', function() {
			//	$(this).closest('div.dropdown-tabs').find('div.tabs__content').removeClass('active').eq($(this).parent().index()).addClass('active');
			//});
		}
		_modifyTabsOrList();
		startFunction(object);
	}
});
</script>



<script id="layerInfoTemplateId" type="text/x-jsrender">
	<div id="layerInfoMenu" class="tabs" style="margin:0px;overflow:hidden;min-width: 500.5px;height:524px;background-color: #f2f2f2; ">
		<div style="top:0;left:0;">
			<ul id = 'mapexpress-tabSet' class="tabSet scroll_tabs_theme_light" style="margin-top:0px;margin-bottom:0px; ">
				{{for identifiedResults}}
					{{if numberInList === 0}}
						<li id="tab_layernameid_{{:numberInList}}" style="font-size:13px;" class="tab_selected">{{:layerName}}</li>
					{{else}}
						<li id="tab_layernameid_{{:numberInList}}" style="font-size:13px;">{{:layerName}}</li>
					{{/if}}
				{{/for}}
 			</ul>
 		</div>
		{{for identifiedResults}}
			{{if numberInList === 0}}
				<div id="data_content_{{:numberInList}}" class="tabs__content active" style="padding:4px;overflow-y:auto;max-height:490px; ">
			{{else}}
				<div id="data_content_{{:numberInList}}" class="tabs__content" style="padding:4px;overflow-y:auto;max-height:490px; ">
			{{/if}}
					<div class="mapexpress-layer-info__data props" style="margin-bottom:2px;min-height:478px;padding-top:4px; ">
						<ul class="nav" style="font-size:13px;margin-left:10px;margin-bottom:10px;margin-right:10px;margin-top:0;list-style:none;padding:0px;overflow-y:auto; ">
							<li style="line-height: 1.8em; border-bottom: 1px solid #DDD;"><span style="color:#757575;font-weight: 500;">Поиск объектов ...</span></li>
						</ul>
					</div>	
				</div>					
		{{/for}}
	</div>
</script>


<script id="layerInfo-Object-TemplateId" type="text/x-jsrender">
	<div class="mapexpress-layer-info__data props" style="margin-bottom:2px;min-height:478px;padding-top:4px; ">
		<ul class="nav" style="font-size:13px;margin-left:10px;margin-bottom:10px;margin-right:10px;margin-top:0;list-style:none;padding:0px; ">
			{{props properties}}
				{{if key !=='G_AREA' && key !=='FullAddressId' && key !=='HasMunicipality2' && key !== 'wkb_geometry' && key !== 'geom' && key !=='style' && key !=='XMin' && key !=='XMax' && key !=='YMin' && key !=='YMax' && key !=='X_coord' && key !=='Y_coord' && key !=='SHAPE_Length' && key !=='SHAPE_Area' && key !=='X центра' && key !=='Y центра' && key !=='Экстент - X мин.' && key !=='Экстент - X макс.' && key !=='Экстент - Y мин.' && key !=='Экстент - Y макс.' && key !=='Объект обработан - можно удалять' && key !=='Shape_Length' && key !=='Shape_Area' && key !=='SHAPE'}}
					{{if prop === 'Null' ||  prop === 'null'||prop === 'undefined'}} 
						<li style="line-height: 1.8em; border-bottom: 1px solid #DDD;"><span style="color:#757575;">{{:key}}:</span>&nbsp&nbsp&nbsp-</li>
					{{else}}
						<li style="line-height: 1.8em; border-bottom: 1px solid #DDD;"><span style=";color:#757575;">{{:key}}:</span>&nbsp&nbsp&nbsp{{:prop}}</li>
					{{/if}}
				{{/if}}
			{{/props}}
		</ul>
	</div>
</script>

<script id="layerInfo-NullObject-TemplateId" type="text/x-jsrender">
	<div class="mapexpress-layer-info__data props" style="margin-bottom:2px;min-height:478px;padding-top: 4px; ">
		<ul class="nav" style="font-size:13px;margin-left:10px;margin-bottom:10px;margin-right:10px;margin-top:0;list-style:none;padding:0px; ">
			<li style="line-height: 1.8em; border-bottom: 1px solid #DDD;"><span style=""></span>Объектов не найдено</li>
		</ul>
	</div>
</script>




<script id="layerInfoTemplateIdAccordeon" type="text/x-jsrender">
    <div id="layerInfoMenu" style="margin:0px;overflow:hidden;min-width: 500.5px;height:524px;background-color: #f2f2f2; ">
       <ul class="mapexpress-collapsibleLayerInfoMenu" style="overflow-y:auto;max-height:490px;">
            {{for identifiedResults}} 
                <li>
             		<div id="tab_layernameid_{{:numberInList}}" class="collapsible-header">{{:layerName}}</div>
             	    <div id="data_content_{{:numberInList}}" class="collapsible-body" style="margin-top:6px;">
             			<div class="mapexpress-layer-info__data props" style="padding-top:4px; ">
        	           		<ul class="nav" style="font-size:13px;margin-left:10px;margin-bottom:10px;margin-right:10px;margin-top:0;list-style:none;padding:0px; ">
        	           		    <li style="line-height: 1.8em; border-bottom: 1px solid #DDD;"><span style="color:#757575;font-weight: 500;">Поиск объектов ...</span></li>
        	           		</ul>
        	       		</div>
        	        </div>
        	    </li>
            {{/for}}
       </ul>
    </div>
</script>