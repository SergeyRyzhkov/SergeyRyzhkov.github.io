function InitializeMap(a){var b=L.map(a,{zoomControl:!1,editable:!0,attributionControl:!1});b.touchZoom&&b.touchZoom.enable(),window.MapManager=new MapExpress.Mapping.MapManager(b),new VsmMapWorkspaceManager(onWorkspaceLoaded).loadWorkspace()}function onWorkspaceLoaded(){var a=(window.MapManager,window.MapManager._map);a.addControl(createSearchToolbar()),a.addControl(createStandartToolbar()),a.addControl(createMapStatusBar()),L.control.zoom({position:"topleft"}).addTo(a),a.touchZoom&&a.touchZoom.enable(),replaceRosreestrIdentifyFunc(),addFavoriteLayers(),window.vsmShowLegend(),addUserLayers(),addRasters(),setTimeout(_selectParcels,1100)}function createSearchToolbar(){var a=window.MapManager,b=new MapExpress.Tools.MapToolbar(a,{position:"topleft"});return b.addCommand(new MapExpress.Tools.ShowLayerControlMapCommandExt(a)),b.addControlFromTemplate("templates/vsmsearch.html","searchId"),b}function createStandartToolbar(){var a=window.MapManager,b=new MapExpress.Tools.MapToolbar(a,{position:"topright"});return b.addCommand(new MapExpress.Tools.IdentifyMapCommand(a)),b.addCommand(new MapExpress.Tools.LineMeasureCommand(a)),b.addCommand(new MapExpress.Tools.SqrtMeasureCommand(a)),b.addCommand(new MapExpress.Tools.ActiveViewMapExportCommand(a)),b.addCommand(new MapExpress.Tools.MapExportCommand(a)),b.addCommand(new MapExpress.Tools.ShowFavoriteLayersCommand(a)),b.addCommand(new MapExpress.Tools.SelectorBaseMapsCommand(a)),b}function replaceRosreestrIdentifyFunc(){function a(a,b,c,d,e){return null}function b(a,b,c,d,e){return MapExpress.Utils.CadastreUtils.getObjectListGeoJSONByLatLngAsyn(a,MapExpress.Utils.CadastreUtils.cadastreObjectType.PARCEL)}function c(a,b,c,d,e){return MapExpress.Utils.CadastreUtils.getObjectListGeoJSONByLatLngAsyn(a,MapExpress.Utils.CadastreUtils.cadastreObjectType.OKS)}function d(a,b,c,d,e){return MapExpress.Utils.CadastreUtils.getObjectListGeoJSONByLatLngAsyn(a,MapExpress.Utils.CadastreUtils.cadastreObjectType.ZOUT)}var e=window.MapManager.getMapModel().getLayersByOptionValue("displayName","Публичная кадастровая карта");if(e&&e.length>0){var f=[];window.MapManager.getMapModel()._fillAllLayers(e[0],f);for(var g=0;g<f.length;g++){var h=f[g];if(h.mapLayer&&h.mapLayer._dataPovider){if("Земельные участки"===h.options.displayName){h.mapLayer._dataPovider.getFeatureInfoAsync=b;continue}if("ОКС"===h.options.displayName){h.mapLayer._dataPovider.getFeatureInfoAsync=c;continue}if("ЗОУИТ"===h.options.displayName){h.mapLayer._dataPovider.getFeatureInfoAsync=d;continue}h.mapLayer._dataPovider.getFeatureInfoAsync=a}}}}function addFavoriteLayers(){var a=window.MapManager.getMapModel(),b=a.getFavoriteLayers(),c=a.getLayersByOptionValue("displayName","Слои ВСМ РЖД");c&&c.length>0&&(a._favoriteLayers=b.concat(c[0]._layers))}function createMapStatusBar(){var a=new MapExpress.Controls.MapStatusbarControl(window.MapManager);return a.addSection(new MapExpress.Controls.ZoomStandartStatusbarSection(window.MapManager)),a.addSection(new MapExpress.Controls.CoordinatesStandartStatusbarSection(window.MapManager)),a.addSection(new MapExpress.Controls.CurrentToolStatusbarSection(window.MapManager)),window.MapManager.mapStatusBar=a,a}function addUserLayers(){function a(a){var b=window.VSM_SITE_ROOT+"/Map/Map/GeoJsonData/?schema=user_layers&view="+a+"&geoColumn=wkb_geometry&idColumn=ogc_fid&bbox={xMin},{yMin},{xMax},{yMax}",c=new MapExpress.Service.GeoJSONProvider(b),d={useVectorTile:!1,dynamicData:!0,maxZoom:23,minZoom:4,queryable:!0},e=new MapExpress.Layers.GeoJSONServiceLayer(c,d),f={displayName:a,type:"overlay"},g=new MapExpress.Mapping.LayerModel(a,f);return g.mapLayer=e,g}var b=window.VSM_SITE_ROOT+"/Map/Map/UserLayers",c=new MapExpress.Mapping.LayerModel("Пользовательские слои",{displayName:"Пользовательские слои"});window.MapManager.getMapModel().addLayer(c),MapExpress.Utils.Promise.GetJSON(b).then(function(b){for(var d=0;d<b.length;d++){var e=b[d],f=a(e);f&&c.addLayer(f)}},function(a){console.log(a)})}function addRasters(){function a(a){function b(a){if(a.target){a.target.bringToFront();var b=a.target.getBounds();MapManager._map.fitBounds(b)}}var c=/[^.]*/.exec(a)[0],d=window.VSM_SITE_ROOT+"/Map/Map/RasterFileInfo?fileName="+c;MapExpress.Utils.Promise.GetJSON(d).then(function(c){var d=window.VSM_SITE_ROOT+"/Content/Raster/"+a,e=c.bbox,f=[[e[1][0],e[0][0]],[e[1][1],e[0][1]]],g=new MapExpress.Service.SingleImageProvider(d,{imageBounds:f}),h={maxZoom:23,minZoom:0,queryable:!1,visible:!1},i=new MapExpress.Layers.ImageOverlayLayer(g,h),j={displayName:a,type:"overlay"},k=new MapExpress.Mapping.LayerModel(a,j);k.mapLayer=i,window.MapManager.getMapModel().getLayerById("Каталог растров").addLayer(k),k.mapLayer.on("add",b)})}var b=window.VSM_SITE_ROOT+"/Map/Map/RasterFileNames",c=new MapExpress.Mapping.LayerModel("Каталог растров",{displayName:"Каталог растров"});window.MapManager.getMapModel().addLayer(c),MapExpress.Utils.Promise.GetJSON(b).then(function(b){for(var c=0;c<b.length;c++){var d=b[c];a(d)}},function(a){console.log(a)})}function _selectParcels(){void 0!==window.selectedObjectsId&&window.selectedObjectsId.length>0&&MapExpress.Tools.SelectParcelOnMap.selectParcelsByIds(window.VSM_SITE_ROOT+"/Map/Map/GeoJsonById/?view=land_geo&geoColumn=geom&idColumn=object_id&id={id}",window.selectedObjectsId)}function VsmMapWorkspaceManager(a){this.defaultMapModel="map_model.json",this.getUrl=window.VSM_SITE_ROOT+"/Map/Map/MapWorkspaceList",this.updateUrl=window.VSM_SITE_ROOT+"/Map/Map/UpdateMapWorkspace",this.onMapInitializedCallbak=a,this.getWorkspaces=function(){return MapExpress.Utils.Promise.GetJSON(this.getUrl)},this.saveWorkspace=function(a,b,c){var d={MAP_WORKSPACE_ID:a,MAP_WORKSPACE_NAME:b,MAP_WORKSPACE_BODY:c};$.ajax({type:"POST",url:this.updateUrl,data:d})},this.loadWorkspace=function(){function a(){b.onMapInitializedCallbak&&"function"==typeof b.onMapInitializedCallbak&&b.onMapInitializedCallbak()}var b=this;this.getWorkspaces().then(function(b){if(b&&b.length>0)try{for(var c=b.length-1;c>=0;c--){var d=b[c];try{var e=JSON.parse(d.MAP_WORKSPACE_BODY),f=window.MAP_WORKSPACE_ID?window.MAP_WORKSPACE_ID:"16";if(e&&e.id&&e.id.toString()===f){window.MapManager.renderMap(e),a();break}}catch(a){}}}catch(a){}},function(a){})}}function vsmShowLegend(){function a(a){e&&(e.off("mapcontrol:remove:after",c),e.hide());for(var d=a.target,g=f._layers,h=g.length-1;h>=0;h--){var i=g[h];d.options.id!==i.id&&window.MapManager.setLayerVisible(i.id,!1)}switch(d.options.id){case"Дней до завершения":b("land-thematic-day-control-view","Дней до завершения");break;case"Дней до завершения по БП":b("land-thematic-base-plan-view","Дней до завершения по БП");break;case"Статус актуальности СУПР":b("land-thematic-status-view","Статус актуальности СУПР");break;case"Тип кадастровых работ":b("land-thematic-work-type-view","Тип кадастровых работ");break;case"Минимальный активный Тип мероприятия":b("land-thematic-event-type-view","Минимальный активный Тип мероприятия");break;case"Состояние земельного участка":b("land-thematic-event-kind-view","Состояние земельного участка")}}function b(a,b){e&&(e.off("mapcontrol:remove:after",c),e.hide()),e=new MapExpress.Controls.MapControl(window.MapManager._map,{headerEnabled:!0,closeButtonEnabled:!0,resizeable:!0}).setTitle(b).setContentFromTemplate("templates/mapLegend.html",a).setPosition("bottomRight").show(),e.on("mapcontrol:remove:after",c)}function c(){for(var a=f._layers,b=a.length-1;b>=0;b--){var c=a[b];window.MapManager.setLayerVisible(c.id,!1)}}function d(b,c){var d=window.VSM_SITE_ROOT+"/Map/Map/GeoJsonData/?schema=vsm&view="+c+"&geoColumn=geom&idColumn=id&bbox={xMin},{yMin},{xMax},{yMax}",f=new MapExpress.Service.GeoJSONProvider(d),g={useVectorTile:!1,dynamicData:!0,maxZoom:23,minZoom:7,queryable:!0,visible:!1,visibleIndex:0,id:b},h=new MapExpress.Layers.GeoJSONServiceLayer(f,g);h.on("add",a,this),h.on("remove",function(){e&&e.hide()},this);var i={displayName:b,type:"overlay"},j=new MapExpress.Mapping.LayerModel(b,i);return j.mapLayer=h,j}var e=!1,f=new MapExpress.Mapping.LayerModel("Тематические карты",{displayName:"Тематические карты"});window.MapManager.getMapModel().addLayer(f);var g=d("Статус актуальности СУПР","land_thematic_status_view"),h=d("Дней до завершения по БП","land_thematic_base_plan_view"),i=d("Дней до завершения","land_thematic_event_day_control_view"),j=d("Состояние земельного участка","land_thematic_event_kind_view");f.addLayer(g),f.addLayer(h),f.addLayer(i),f.addLayer(j)}MapExpress.Tools.ShowLayerControlMapCommandExt=MapExpress.Tools.ShowLayerControlMapCommand.extend({createContent:function(a){this.options.template="templates/vsmMapSidebar.html";var b=MapExpress.Tools.ShowLayerControlMapCommand.prototype.createContent.call(this,a);MapExpress.Controls.MapControlUtils.setStyle(b,"float:left");var c=L.DomUtil.create("span","divider1",a);return MapExpress.Controls.MapControlUtils.setStyle(c,"float:left"),b}}),MapExpress.Tools.SelectParcelOnMap={_parecelSelectionLayerId:"parecelSelectionLayer",_selectedStyle:{weight:4,opacity:1,color:"red",dashArray:"3",fillOpacity:.3,fillColor:"#666666"},selectParcelsByIds:function(a,b){var c=this;this._dataUrl=a;var d=[];this._layer&&window.MapManager._map.removeLayer(this._layer),this._layer=new L.GeoJSON,this._layer.id=this._parecelSelectionLayerId,this._layer.displayName=this._parecelSelectionLayerId,this._layer.visible=!0,this._layer.type="overlay",this._layer.addTo(window.MapManager._map);for(var e=0;e<b.length;e++){var f=this._getParcelGeoJsonAsync(b[e]);d.push(f)}$.when.apply($,d).done(function(){if(arguments&&arguments.length>0){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(b.features)for(var d=0;d<b.features.length;d++){var e=b.features[d];void 0!==e&&c._layer.addData(e)}}var f=c._layer.getBounds().pad(1);c._layer.setStyle(c._selectedStyle),c._layer.bringToFront(),window.MapManager.moveOverlay(c._parecelSelectionLayerId,0),window.MapManager._map.fitBounds(f)}})},_getParcelGeoJsonAsync:function(a){var b=L.Util.template(this._dataUrl,{id:a});return MapExpress.Utils.Promise.GetJSON(b)}};