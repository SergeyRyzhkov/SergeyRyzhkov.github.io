MapExpress.Controls.LayerOrderControl=L.Control.extend({options:{position:"topright",className:"mapexpress-control-wrapper",layerItemClassName:"layer-order-item"},initialize:function(a,b){this._mapManager=a,L.setOptions(this,b)},onAdd:function(){return this._div=L.DomUtil.create("div",this.options.className),this._div.setAttribute("id","layer-order-control"),this._div},addTo:function(a){L.Control.prototype.addTo.call(this,this._mapManager._map),this.render(this._div)},render:function(a){function b(a){var b="images/visibility_y.png";f._mapManager.layerEnabled(a.getAttribute("id"))||(b="images/visibility_n.png"),a.setAttribute("src",b)}function c(a){var b="images/label_n.gif",c=f._mapManager._mapModel.getLayerById(a.getAttribute("id"));c&&c.mapLayer&&c.mapLayer.options&&c.mapLayer.options.labelEnabled&&(b="images/label_y.gif"),a.setAttribute("src",b)}function d(a){f._mapManager.toogleLayerVisible(a.target.getAttribute("id")),b(a.target)}function e(a){f._mapManager.toogleLabelLayer(a.target.getAttribute("id")),c(a.target)}var f=this,g=this._mapManager.getMapModel(),h=g.getOverlayLayers();g.sortLayersByVisibleIndex(h);var i=a?a:document.getElementById("layer-order-control");L.DomUtil.empty(i),MapExpress.Controls.MapControlUtils.stopMousePropagation(i);for(var j=0;j<h.length;j++){var k=h[j],l=L.DomUtil.create("div",this.options.layerItemClassName,i);if(l.setAttribute("id",k.id),this._mapManager.layerLabelingEnabledInZoom(k.id)){var m=L.DomUtil.create("img","",l);m.setAttribute("id",k.id),c(m),m.onclick=e}var n=this._mapManager.layerVisibleEnableInZoom(k.id);if(n){var o=L.DomUtil.create("img","",l);o.setAttribute("id",k.id),b(o),o.onclick=d}var p=n?"layer-order-item-text":"layer-order-item-text disabled",q=L.DomUtil.create("span",p,l);q.textContent=k.options.displayName}var r={onEnd:function(a){f._mapManager.moveOverlay(a.item.id,a.newIndex)},animation:100};Sortable.create(i,r)}}),MapExpress.Tools.ShowLayerControlMapCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button",buttonStyle:{"margin-right":"3px","margin-left":"1px","box-shadow":"none","border-radius":"0px;"},liClass:"fa fa-bars fa-lg fa-fw"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a);L.DomUtil.create("i",this.options.liClass,b);return b.setAttribute("title","Управление картой"),b.setAttribute("id","showLayerControlMapCommand"),MapExpress.Controls.MapControlUtils.setStyle(b,this.options.buttonStyle),b},activate:function(){function a(){b.options.templateHelpers="layerTreeMapSidebarAfterRendering",(b.options.templateHelpers&&void 0!==b.options.templateHelpers||b.options.templateHelpers&&null!==b.options.templateHelpers)&&$.views.helpers.layerTreeMapSidebarAfterRendering()}var b=this;this.popupWindow&&(this.popupWindow.hide(),delete this.popupWindow),b.popupWindow=new MapExpress.Controls.MapControl(b._mapManager._map,{closeOnLeave:!0}).showSidebar("./templates/mapSidebar.html","mapSidebarTemplateId",!1,a)}}),MapExpress.Controls.TreeLayerControl=L.Control.extend({options:{position:"topright",className:"mapexpress-control-wrapper"},initialize:function(a,b){this._mapManager=a,L.setOptions(this,b)},onAdd:function(){return this._div=L.DomUtil.create("div",this.options.className),this._div.setAttribute("id","treelayercontrol"),this._div},addTo:function(a){L.Control.prototype.addTo.call(this,this._mapManager._map),this.render(this._div)},render:function(a){var b=this,c=this._mapManager.getMapModel(),d={};d.id=c.id,d.text=c.options.displayName,this._processLayerModel(d,c._layers);var e={core:{data:d.children},plugins:["checkbox","wholerow"]};$.jstree.defaults.checkbox.keep_selected_style=!1,$.jstree.defaults.checkbox.tie_selection=!1;var f=a?a:document.getElementById("treelayercontrol");L.DomUtil.empty(f),MapExpress.Controls.MapControlUtils.stopMousePropagation(f),$.jstree.destroy();var g=$(f).jstree(e);g.on("check_node.jstree",function(a,c){c.node.parent&&"Базовые карты"===c.node.parent?b._mapManager.setActiveBaseMap(c.node.id):b._mapManager.setLayerVisible(c.node.id,!0)}),g.on("uncheck_node.jstree",function(a,c){c.node&&b._mapManager.setLayerVisible(c.node.id,!1)})},_processLayerModel:function(a,b){a.children=[];for(var c=0;c<b.length;c++){var d=b[c],e={};("base"!==d.options.type||"Базовые карты"===a.text)&&(e=this._createNode(d),a.children.push(e)),d.hasChildren()&&(e||(e=a),this._processLayerModel(e,d._layers))}},_createNode:function(a){var b={};return b.id=a.id,b.text=a.options.displayName,a.mapLayer&&(b.state={checked:a.mapLayer.options.visible}),b}});