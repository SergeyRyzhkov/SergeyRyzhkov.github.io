MapExpress.Tools.ActiveViewMapExportCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a),c=L.DomUtil.create("img",!1,b);return c.setAttribute("src","images/print.png"),b.setAttribute("title","Экспорт активного вида карты"),b.setAttribute("id","exportMapImage"),b},activate:function(){this.printer=new MapExpress.Utils.MapExporter,this.printer.on(this._getEvents(),this),this.printer.exportActiveMapView(this._mapManager._map)},deactivate:function(){this.printer&&this.printer.off(this._getEvents(),this),this.waitWindow&&this.waitWindow.hide(),delete this.waitWindow,delete this.printer},onRemoved:function(){this.waitWindow&&this.waitWindow.hide(),this.printWindow&&this.printWindow.hide(),this.deactivate()},_getEvents:function(){var a={"mapexport:export:start":this._onExportStart,"mapexport:html2canvas":this._onStartHtml2Canvas,"mapexport:export:end":this._onExportEnd};return a},_onExportStart:function(a){this.printWindow&&this.printWindow.hide(),this._showWait("Подготовка карты ")},_onStartHtml2Canvas:function(a){this._showWait("Формирование растра ")},_onExportEnd:function(a){if(this.onRemoved(),a.error)return void new MapExpress.Controls.MapControl(this._mapManager._map,{removalDelay:2e3}).setContent("Ошибка экспорта").show();var b=this._createLink("export.jpg",a.image,"Растр (export.jpg)"),c=MapExpress.Mapping.MapUtils.generateWldFileHref(a.bbox,a.imageSize),d=this._createLink("export.wld",c,"Файл привязки (export.wld)"),e=MapExpress.Mapping.MapUtils.generateMapInfoWldFileHref(a.bbox,a.imageSize,"export.jpg"),f=this._createLink("export.tab",e,"Файл привязки MapInfo (export.tab)"),g=new MapExpress.Controls.MapControl(this._mapManager._map,{headerEnabled:!0,closeButtonEnabled:!0});g.setControlStyle({"min-width":"250px"});var h=b+"</br>"+d+"</br>"+f;g.setContent(h),g.setTitle("Результат экспорта карты"),g.show()},_createLink:function(a,b,c){var d=document.createElement("div"),e=document.createElement("a");e.download=a,e.href=b,$(e).html(c),d.appendChild(e);var f=$(d).html();return $(d).remove(),f},_showWait:function(a){this.waitWindow||(this.waitWindow=new MapExpress.Controls.MapControl(this._mapManager._map)),this.waitWindow.showWaitControl(a)}}),MapExpress.Tools.MapExportCommand=MapExpress.Tools.ActiveViewMapExportCommand.extend({options:{buttonClassName:"map-toolbar-button"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a),c=L.DomUtil.create("img",!1,b);return c.setAttribute("src","images/print.png"),b.setAttribute("title","Экспорт карты"),b.setAttribute("id","exportMapImage"),b},activate:function(){this.waitWindow=new MapExpress.Controls.MapControl,this.printControl=new MapExpress.Controls.MapExportControl(this._mapManager._map),this.printer=this.printControl.printer,this.printWindow=new MapExpress.Controls.MapControl(this._mapManager._map,{position:"top",headerEnabled:!0,footerEnabled:!0,closeButtonEnabled:!0}),this.printWindow.setContent(this.printControl._createContent()),this.printWindow.setTitle("Экспорт карты "),this.printWindow.setFooterContent("Выберите область и укажите масштабный уровень карты"),this.printControl._setUpButtonHandlers(),this.printControl._activateAreaSelect(),this.printWindow.show(),this._updateFooterOnZoomChange(this.printControl),this._mapManager._map.on("map-print-control:removed",this.onRemoved,this),this.printWindow.on("mapcontrol:remove:after",function(){this.printControl.remove()},this),this.printer.on("mapexport:export:start",this._onExportStart,this),this.printer.on("mapexport:html2canvas:start",this._onStartHtml2Canvas,this),this.printer.on("mapexport:export:end",this._onExportEnd,this),this._mapManager._map.on("map-print-control:zoomUp",this._updateFooterOnZoomChange,this),this._mapManager._map.on("map-print-control:zoomDown",this._updateFooterOnZoomChange,this),this._mapManager._map.on("map-print-control:futuresize:changed",this._updateFooterOnZoomChange,this)},deactivate:function(){this.printer&&(this.printer.off("mapexport:export:start",this._onExportStart,this),this.printer.off("mapexport:html2canvas:start",this._onStartHtml2Canvas,this),this.printer.off("mapexport:export:end",this._onExportEnd,this)),this._mapManager._map.off("map-print-control:zoomUp",this._updateFooterOnZoomChange,this),this._mapManager._map.off("map-print-control:zoomDown",this._updateFooterOnZoomChange,this),this._mapManager._map.off("map-print-control:futuresize:changed",this._updateFooterOnZoomChange,this),delete this.printWindow,delete this.waitWindow,delete this.printControl,delete this.printer},_updateFooterOnZoomChange:function(a){var b="Размер изображения: "+a.futureSize.size+" px, W="+a.futureSize.width+" px , H="+a.futureSize.height+" px";this.printWindow.setFooterContent(b),this.printWindow.setFooterBarStyle("color:"+this.printControl._getWarningColor())}}),MapExpress.Controls.MapExportControl=L.Control.extend({options:{position:"topright"},futureSize:{width:0,height:0,size:0,zoom:0},initialize:function(a,b){this.map=a,L.setOptions(this,b),this.active=!1,this.futureSize.zoom=a.getZoom(),this.printer=MapExpress.Utils.mapExporter()},addTo:function(a){return this.map=a,L.Control.prototype.addTo.call(this,a),this._setUpButtonHandlers(),this._activateAreaSelect(),this},onAdd:function(a){return this._createContent()},remove:function(){L.Control.prototype.remove.call(this),this.areaSelect&&(this.areaSelect.off("change",this._areaSelectChanged,this),this.areaSelect.remove())},_areaSelectChanged:function(a){this.updateFutureSize()},_createContent:function(){return this.controlDiv=L.DomUtil.create("div","map-print-container"),this.controlDiv.setAttribute("id","map-print-container"),MapExpress.Controls.MapControlUtils.stopMousePropagation(this.controlDiv),$(this.controlDiv).append('<button id="mapprint-zoomDown"  class="btn btn-default btn-sm text-center" title="Уменьшить масштабный коэффициент карты">-</button>'),$(this.controlDiv).append('<button id="mapprint-zoomUp" class="btn btn-default btn-sm text-center" title="Увеличить масштабный коэффициент карты">+</button>'),$(this.controlDiv).append('<button id="mapprint-print" class="btn btn-default btn-sm text-center" title="Экспорт" value="Экспорт">Экспорт</button>'),$(this.controlDiv).append('<button id="mapprint-print-activemap" class="btn btn-default btn-sm text-center" title="Экспорт активного вида карты" value="активный вид карты">Активный вид</button>'),$(this.controlDiv).append('<button id="mapprint-remove" class="btn btn-default btn-sm text-center" title="Cбросить выбор территории" value="Отмена">Отмена</button>'),this.controlDiv},_activateAreaSelect:function(){var a=$(this.map.getContainer()).height(),b=$(this.map.getContainer()).width();this.areaSelect=MapExpress.Controls.areaSelect({width:.8*b,height:.8*a}).addTo(this.map),this.updateFutureSize(),this.areaSelect.on("change",this._areaSelectChanged,this)},_setUpButtonHandlers:function(){var a=this;$("#mapprint-print-activemap").click(function(b){a.map.fire("map-print-control:export-activemap",a),a.exportMap(!0)}),$("#mapprint-remove").click(function(b){a.remove(),a.map.fire("map-print-control:removed",a)}),$("#mapprint-zoomUp").click(function(){a.futureSize.zoom=a.futureSize.zoom+1,a.futureSize.zoom>20&&(a.futureSize.zoom=20),a.updateFutureSize(),a.map.fire("map-print-control:zoomUp",a)}),$("#mapprint-zoomDown").click(function(){a.futureSize.zoom=a.futureSize.zoom-1,a.updateFutureSize(),a.map.fire("map-print-control:zoomDown",a)}),$("#mapprint-print").click(function(){a.map.fire("map-print-control:export-click",a),a.exportMap()})},updateFutureSize:function(){var a=this.futureSize.zoom,b=(this.map.getCenter(),this.map.getPixelBounds(this.areaSelect.getBounds()._northEast,a)),c=this.map.getPixelBounds(this.areaSelect.getBounds()._southWest,a),d={x:null,y:null},e={x:null,y:null};d.x=b.min.x+this.map.getSize().x/2,d.y=b.min.y+this.map.getSize().y/2,e.x=c.min.x+this.map.getSize().x/2,e.y=c.min.y+this.map.getSize().y/2;var f=e.y-d.y,g=d.x-e.x;this.futureSize.width=g,this.futureSize.height=f,this.futureSize.size=g*f,this.map.fire("map-print-control:futuresize:changed",this)},_getWarningColor:function(){var a,b=this.futureSize.size;return 4e5>=b?a="#3CFF00":b>4e5&&6e5>=b?a="#A2FF00":b>6e5&&102e4>=b?a="#CDFF00":b>102e4&&14e5>=b?a="#E6FF00":b>14e5&&2e6>=b?a="#E7FF00":b>2e6&&243e4>=b?a="#FFD500":b>243e4&&35e5>=b?a="#FFAB00":b>35e5&&468e4>=b?a="#FF8000":b>468e4&&63e5>=b?a="#FF4D00":b>63e5&&8e6>=b?a="#FF3300":b>8e6&&(a="#FF0000"),a},exportMap:function(a){$(".leaflet-control-container, #map-print-container").attr("data-html2canvas-ignore","true"),$(".leaflet-control-container").attr("data-html2canvas-ignore","true"),this.areaSelect.off("change",this._resetChange,this),this.remove(),a&&a===!0?this.printer.exportActiveMapView(this.map):this.printer["export"](this.map,this.futureSize.width,this.futureSize.height,this.futureSize.zoom,this.futureSize.size)}}),MapExpress.Utils.MapExporter=L.Evented.extend({exportActiveMapView:function(a){var b=a.getSize(),c=b.x,d=b.y,e=c*d,f=a.getZoom();this["export"](a,c,d,f,e)},"export":function(a,b,c,d,e){this.map=a,this.fire("mapexport:export:start",this);var f=$(a.getContainer()),g=f.height(),h=f.width(),i=a.getZoom(),j=a.getCenter(),k=f.css("min-height");f.css("min-height","0%"),f.height(c).width(b),a.invalidateSize(!0),a.setView(j,d);var l=this;setTimeout(function(){try{l._prepareExport(a,g,h,i,j,k)}catch(b){var c=l._tryCatchExportResult(a,g,h,i,j,k);c.error=b,l.fire("mapexport:export:end",c)}},6e3)},_prepareExport:function(a,b,c,d,e,f){this.fire("mapexport:prepareexport:start",this);var g=$(a.getContainer()).clone(),h=g.find(".leaflet-map-pane")[0],i=h.style.transform.split(",");this.mapX=parseFloat(i[0].split("(")[1].replace("px","")),this.mapY=parseFloat(i[1].replace("px","")),this.fire("mapexport:prepareexport:mapPane",this);var j=document.createElement("canvas");j.className="screenShotTempCanvas",j.id="mainCanvas",j.width=a.getSize().x,j.height=a.getSize().y,j.style.left=-this.mapX,j.style.top=-this.mapY;var k=j.getContext("2d");this.on("mapexport:prepareexport:canvascreated",function(){this.drawtilesOnCanvas(a,g,k)},this),this.on("mapexport:prepareexport:alltilesloaded",function(){this.drawImageOverlaysOnCanvas(a,g,k)},this),this.on("mapexport:prepareexport:allmapimageoverlayloaded",function(){this.drawShadowIconsOnCanvas(a,g,k)},this),this.on("mapexport:prepareexport:allmapshadowiconsloaded",function(){this.drawSVGOnCanvas(a,g,k)},this),this.on("mapexport:prepareexport:canvaswithsvgready",function(){this.drawDivIconsOnCAnvas(a,g,k,j)},this),this.on("mapexport:prepareexport:allmapiconsdrawn",function(){this.exportCanvas(a,j,b,c,d,e,f)},this),this.on("mapexport:prepareexport:canvasexported",function(){this.fire("mapexport:prepareexport:end",this)},this),this.fire("mapexport:prepareexport:canvascreated",this)},drawtilesOnCanvas:function(a,b,c){function d(){var a=k.length,b=p+q;b===a&&(f.fire("mapexport:prepareexport:alltilesloaded"),delete k)}var e=b.find(".leaflet-tile-container"),f=this;if(e&&e[0]){var g;g=e.length>1?e[1]:e[0];for(var h=g.style.transform.split(","),i=parseFloat(h[0].split("(")[1].replace("px","")),j=parseFloat(h[1].replace("px","")),k=b.find("img.leaflet-tile"),l=[],m=[],n=[],o=[],p=0,q=0,r=0;r<k.length;r++){if(""!==k[r].style.left)l.push(parseFloat(k[r].style.left.replace("px",""))),m.push(parseFloat(k[r].style.top.replace("px",""))),o[r]="left";else if(""!==k[r].style.transform){var s=k[r].style.transform.split(",");l[r]=parseFloat(s[0].split("(")[1].replace("px","")),m[r]=parseFloat(s[1].replace("px","")),k[r].style.transform="",o[r]="transform"}else l[r]=0,n[r]=0,o[r]="neither";k[r].style.left=l[r]+"px",k[r].style.top=m[r]+"px";var t=new Image;t.setAttribute("crossOrigin","anonymous"),t.onload=function(a){return function(){c.drawImage(this,l[a]+f.mapX+i,m[a]+f.mapY+j),p+=1,d.call(f)}}(r),t.onerror=function(a){return function(){q+=1,d.call(f)}}(r),t.src=k[r].src}}else this.fire("mapexport:prepareexport:alltilesloaded")},drawImageOverlaysOnCanvas:function(a,b,c){function d(){var a=e.length,b=k+l;b===a&&(f.fire("mapexport:prepareexport:allmapimageoverlayloaded"),k=0,l=0)}var e=b.find("img.leaflet-image-layer"),f=this;if(!e||!e[0])return void this.fire("mapexport:prepareexport:allmapimageoverlayloaded");for(var g=[],h=[],i=[],j=[],k=0,l=0,m=[],n=[],o=0;o<e.length;o++){var p=e[o].style.width,q=e[o].style.height;if(m.push(p),n.push(q),""!==e[o].style.left)g.push(parseFloat(e[o].style.left.replace("px",""))),h.push(parseFloat(e[o].style.top.replace("px",""))),j[o]="left";else if(""!==e[o].style.transform){var r=e[o].style.transform.split(",");g[o]=parseFloat(r[0].split("(")[1].replace("px","")),h[o]=parseFloat(r[1].replace("px","")),e[o].style.transform="",j[o]="transform"}else g[o]=0,i[o]=0,j[o]="neither";e[o].style.left=g[o]+"px",e[o].style.top=h[o]+"px";var s=new Image;s.setAttribute("crossOrigin","anonymous"),s.onload=function(a){return function(){c.drawImage(this,g[a]+f.mapX,h[a]+f.mapY,parseFloat(m[a].replace("px","")),parseFloat(n[a].replace("px",""))),k+=1,d.call(f)}}(o),s.onerror=function(a){return function(){console.log("ошибка оверлея"+this.src),l+=1,d.call(f)}}(o),s.src=e[o].src}},drawSVGOnCanvas:function(a,b,c){var d=$(a.getPanes().overlayPane).attr("class"),e=b.find("."+d.replace(" ",".")).find("svg"),f=this;if(e&&void 0!==e[0]){var g,h=e[0],i=h.style.transform.split(","),j=parseFloat(i[0].split("(")[1].replace("px","")),k=parseFloat(i[1].replace("px",""));h.style.transform=" ",h.style.left=j+"px",h.style.top=k+"px";var l=document.createElement("canvas");l.className="screenShotTempCanvas",l.id="SvgToCanvas",l.width=a.getSize().x,l.height=a.getSize().y;l.getContext("2d");e.each(function(){L.DomUtil.getPosition(e),g=(new XMLSerializer).serializeToString(this),canvg(l,g)}),c.drawImage(l,j+f.mapX,k+f.mapY),this.fire("mapexport:prepareexport:canvaswithsvgready")}else this.fire("mapexport:prepareexport:canvaswithsvgready")},drawShadowIconsOnCanvas:function(a,b,c){function d(){var a=e.length,b=m+n;b===a&&f.fire("mapexport:prepareexport:allmapshadowiconsloaded")}var e=b.find("img.leaflet-marker-shadow"),f=this;if(e&&e[0])for(var g=[],h=[],i=[],j=[],k=[],l=[],m=0,n=0,o=0;o<e.length;o++){var p=e[o].style.transform,q=p.split(",");j.push(parseInt(e[o].style.marginTop.replace("px",""))),i.push(parseInt(e[o].style.marginLeft.replace("px",""))),g.push(parseFloat(q[0].split("(")[1].replace("px",""))),h.push(parseFloat(q[1].replace("px",""))),e[o].style.transform="",e[o].style.left=g[o]+"px",e[o].style.top=h[o]+"px",k.push(parseInt(e[o].style.width.replace("px",""))),l.push(parseInt(e[o].style.height.replace("px","")));var r=new Image;r.setAttribute("crossOrigin","anonymous"),r.src=e[o].src,r.onload=function(a){return function(){f.fire("mapexport:prepareexport:mapshadowiconloaded"),c.drawImage(this,g[a]+f.mapX+i[a],h[a]+f.mapY+j[a],k[a],l[a]),m+=1,d.call(f)}}(o),r.onerror=function(a){return function(){f.fire("mapexport:prepareexport:mapshadowiconserror"),n+=1,d.call(f)}}(o)}else this.fire("mapexport:prepareexport:allmapshadowiconsloaded")},drawDivIconsOnCAnvas:function(a,b,c,d){function e(){h.div===!0&&h.icons===!0&&(g.attr("class","tempopane"),document.body.appendChild(g[0]),html2canvas(g[0],{onrendered:function(a){c.drawImage(a,0,0),f.fire("mapexport:prepareexport:allmapiconsdrawn"),$(".tempopane").remove()},canvas:d}),h.div="",h.icons="")}var f=this,g=b.find(".leaflet-marker-pane"),h={div:"",icons:""};if(g&&g[0].children&&g[0].children.length>0){var i=b.find("div.leaflet-marker-icon");if(i&&i[0]){for(var j,k=[],l=[],m=[],n=[],o=0;o<i.length;o++){j=i[o].style;var p=j.transform,q=p.split(",");n.push(parseInt(j.marginTop.replace("px",""))),m.push(parseInt(j.marginLeft.replace("px",""))),k.push(parseFloat(q[0].split("(")[1].replace("px",""))),l.push(parseFloat(q[1].replace("px",""))),j.transform="",j.left=k[o]+f.mapX+"px",j.top=l[o]+f.mapY+"px"}h.div=!0,e.call(this)}else h.div=!0,e.call(this);var r=b.find("img.leaflet-marker-icon");if(r&&r[0]){for(var s,t=[],u=[],v=[],w=[],x=0;x<r.length;x++){s=r[x].style;var y=s.transform,z=y.split(",");w.push(parseInt(s.marginTop.replace("px",""))),v.push(parseInt(s.marginLeft.replace("px",""))),t.push(parseFloat(z[0].split("(")[1].replace("px",""))),u.push(parseFloat(z[1].replace("px",""))),s.transform="",s.left=t[x]+"px",s.top=u[x]+"px"}h.icons=!0,e.call(this)}else h.icons=!0,e.call(this)}else this.fire("mapexport:prepareexport:allmapiconsdrawn")},exportCanvas:function(a,b,c,d,e,f,g){var h=this._tryCatchExportResult(a,b,c,d,e,f,g);try{h.image=b.toDataURL("image/jpeg")}catch(i){h.error=i}this.fire("mapexport:export:end",h)},_tryCatchExportResult:function(a,b,c,d,e,f,g){var h=[L.CRS.EPSG3857.project(a.getBounds()._southWest),L.CRS.EPSG3857.project(a.getBounds()._northEast)],i={};i.width=a.getSize().x,i.height=a.getSize().y;var j=$(a.getContainer()),k={printer:this,image:!1,bbox:h,imageSize:i,map:a,error:!1,canvasWidth:b.width,canvasHeight:b.height,mapContainerHeight:j.height(),mapContainerWidth:j.width()};return this.fire("mapexport:prepareexport:canvasexported"),this.fire("mapexport:prepareexport:end",this),$(j).height(c).width(d),$(j).css("min-height",g),a.setView(f,e),a.invalidateSize(!0),$("[class^='Labels']").remove(),this.fire("mapexport:restorestate:end",this),k}}),MapExpress.Utils.mapExporter=function(a,b,c,d,e){return new MapExpress.Utils.MapExporter(a,b,c,d,e)};