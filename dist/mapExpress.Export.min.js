MapExpress.AreaSelect||(MapExpress.AreaSelect={}),MapExpress.AreaSelect.AreaSelectRectangle=L.Rectangle.extend({options:{className:"leaflet-interactive leaflet-area-select-rectangle"}}),MapExpress.AreaSelect.AreaSelectVertex=L.Editable.VertexMarker.extend({options:{className:"leaflet-div-icon leaflet-editing-icon leaflet-area-select-edge"},initialize:function(a,b,c,d){L.Editable.VertexMarker.prototype.initialize.call(this,a,b,c,d),this.on("drag",this.onVertexDrag)},onVertexDrag:function(a){a.target.editor.tools.vertexDrag(a)}}),MapExpress.Controls.AreaSelectEditable=L.Editable.extend({options:{vertexMarkerClass:MapExpress.AreaSelect.AreaSelectVertex,rectangleClass:MapExpress.AreaSelect.AreaSelectRectangle},initialize:function(a,b){L.Editable.prototype.initialize.call(this,a),L.setOptions(this,b),this.map=a,this.map.areaSelectEditable&&this.map.areaSelectEditable.remove(),this.map.areaSelectEditable=this,this.startRectangle()},_createBounds:function(){var a=.2*$(this.map.getContainer()).width(),b=.2*$(this.map.getContainer()).height(),c=.8*$(this.map.getContainer()).width(),d=.8*$(this.map.getContainer()).height(),e=this.map.containerPointToLatLng(new L.Point(a,b)),f=this.map.containerPointToLatLng(new L.Point(c,d));return L.latLngBounds(e,f)},startRectangle:function(){return this.area=L.Editable.prototype.createRectangle.call(this,this._createBounds()),this.area.addTo(this.featuresLayer),this.area.enableEdit(),this},getBounds:function(){return this.area.getBounds()},abortSelecting:function(){this.stopDrawing(),this.area.remove()},remove:function(){this.abortSelecting(),delete this.map.areaSelectEditable},vertexDrag:function(){this.fire("change")}}),MapExpress.Tools.ActiveViewMapExportCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button",title:"Экспорт карты"},initialize:function(a,b){if(MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b),!this.options.coordinatesSystems){var c=[],d=9e5;for(var e in window.CAD.DEFAULTS.projections)c.push(new L.Proj.CRS("EPSG:"+d,window.CAD.DEFAULTS.projections[e])),d++;this.options.coordinatesSystems=[L.CRS.EPSG3395,L.CRS.EPSG3857,L.CRS.EPSG4326].concat(c)}this.activeCoordinatesSystems=null},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a),c=L.DomUtil.create("img",!1,b);return c.setAttribute("src","images/print.png"),b.setAttribute("title","Экспорт активного вида карты"),b.setAttribute("id","exportMapImage"),b},activate:function(){this.printer=new MapExpress.Utils.MapExporter,this.printer.on(this._getEvents(),this),this.printer.exportActiveMapView(this._mapManager._map)},deactivate:function(){this.printer&&this.printer.off(this._getEvents(),this),this.waitWindow&&this.waitWindow.hide(),delete this.waitWindow,delete this.printer},onRemoved:function(){this.waitWindow&&this.waitWindow.hide(),this.printWindow&&this.printWindow.hide(),this.deactivate()},_getEvents:function(){var a={"mapexport:export:start":this._onExportStart,"mapexport:html2canvas":this._onStartHtml2Canvas,"mapexport:export:end":this._onExportEnd};return a},_onExportStart:function(a){this.printWindow&&this.printWindow.hide(),this._showWait("Подготовка карты ")},_onStartHtml2Canvas:function(a){this._showWait("Формирование растра ")},_onExportEnd:function(a){if(this.onRemoved(),a.error)return void new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow("Ошибка экспорта карты");this.result=a;var b=new MapExpress.Controls.MapControl(this._mapManager._map,{headerEnabled:!0,closeButtonEnabled:!0});b.setControlStyle({"min-width":"250px"});var c=this._createLink("export.jpg",this.result.image,"Растр (export.jpg)","mapexpress-export-raster"),d=c;b.setContent(d);var e=$('<div class="mapexpress-export-coordinates-systems">'),f=$('<i class="mapexpress-export-change-active-coordinates-system"></i>'),g=$('<input id="mapexpress-export-active-coordinates-system" readonly placeholder="Система координат"></input>'),h=$('<div><i class="mapexpress-export-hide-coordinates-system"></i><input id="mapexpress-export-avaliable-coordinates-system_autocomplete" placeholder="Поиск..."></input><ul id="mapexpress-export-avaliable-coordinates-system"></ul></div>');e.append(f).append(g).append(h),e.prependTo($(b._controlContent)),this._createCoordinatesSystems($(b._controlContent)),this._updateBBOXResultViaCoordsSystem($(b._controlContent)),b.setTitle("Результат экспорта карты в графический формат"),b.show(),this.crutchIE(this.result.image,"export.jpg")},_createLink:function(a,b,c,d){var e,f,g;return"download"in document.createElement("a")?(f=document.createElement("div"),g=document.createElement("a"),g.download=a,g.href=b,g.id=d,$(g).html(c),f.appendChild(g),e=$(f).html(),$(f).remove()):(f=document.createElement("div"),g=document.createElement("a"),$(g).html(c),$(g).attr("class","export-map"+a.split(".")[1]),g.id=d,f.appendChild(g),e=$(f).html(),$(f).remove()),e},crutchIE:function(a,b){var c,d;return"export.jpg"!==b?(a=a.replace("data:text/plain;charset=utf-8,",""),c=decodeURIComponent(a),d=new Blob([c],{type:"text/plain",endings:"native"})):d=a,$(".export-map"+b.split(".")[1]).click(function(){window.navigator.msSaveOrOpenBlob(d,b)}),this},_showWait:function(a){this.waitWindow||(this.waitWindow=new MapExpress.Controls.MapControl(this._mapManager._map)),this.waitWindow.showWaitControl(a)},_createCoordinatesSystems:function(a){for(var b=(a.find("#mapexpress-export-avaliable-coordinates-system").parent().hide(),0);b<this.options.coordinatesSystems.length;b++)if("EPSG:900000"!==this.options.coordinatesSystems[b].code){var c=$("<li/>");c.attr("id",this.options.coordinatesSystems[b].code),"EPSG:3395"===this.options.coordinatesSystems[b].code?this.options.coordinatesSystems[b].title="World Mercator на сфероиде":"EPSG:3857"===this.options.coordinatesSystems[b].code?this.options.coordinatesSystems[b].title="Pseudo-Mercator Сферический Меркатор":"EPSG:4326"===this.options.coordinatesSystems[b].code&&(this.options.coordinatesSystems[b].title="WGS 84"),c.html(this.options.coordinatesSystems[b].title||this.options.coordinatesSystems[b].projection._proj.title),$("#mapexpress-export-avaliable-coordinates-system").append(c)}this._initCRSContol(a)},setActiveCRS:function(a,b){for(var c=this.options.coordinatesSystems.length-1;c>=0;c--)this.options.coordinatesSystems[c].code===a&&(this.activeCoordinatesSystem=this.options.coordinatesSystems[c],$("#mapexpress-export-active-coordinates-system").val(this.options.coordinatesSystems[c].title||this.options.coordinatesSystems[c].projection._proj.title));this._updateBBOXResultViaCoordsSystem(b)},_updateBBOXResultViaCoordsSystem:function(a){$(".mapexpress-export-proj-files").remove();for(var b=$('<div class="mapexpress-export-proj-files">'),c=MapExpress.Mapping.RasterUtils.generateWldFileHref(this.result.bbox,this.result.imageSize,this.activeCoordinatesSystem),d=this._createLink("export.wld",c,"Файл привязки (export.wld)","mapexpress-export-wld"),e=MapExpress.Mapping.RasterUtils.generateMapInfoWldFileHref(this.result.bbox,this.result.imageSize,"export.jpg",this.activeCoordinatesSystem),f=this._createLink("export.tab",e,"Файл привязки MapInfo (export.tab)","mapexpress-export-tab"),g=$(".mapexpress-export-coordinates-systems").parent().find("a"),h=0;h<g.length;h++)"export.wld"===$(g[h]).attr("download")&&($(g[h]).next().remove(),$(g[h]).remove()),"export.tab"===$(g[h]).attr("download")&&$(g[h]).remove();b.append($(d)).append($("</br>")).append($(f)),a.append(b),this.crutchIE(c,"export.wld").crutchIE(e,"export.tab")},_initCRSContol:function(a){function b(a){var b=$(a.currentTarget).val();if($(e).show(),""!==b&&null!==b&&void 0!==b)for(var c=0;c<$(e).length;c++)-1===$(e[c]).html().toLowerCase().indexOf(b.toLowerCase())&&$(e[c]).hide()}var c=this,d=this._mapManager._map.options.crs.code;this.setActiveCRS(d,a);for(var e=$("#mapexpress-export-avaliable-coordinates-system").find("li"),f=e.length-1;f>=0;f--)$(e[f]).attr("id")===d&&$(e[f]).addClass("active");$("#mapexpress-export-active-coordinates-system").on("click",function(){$("#mapexpress-export-avaliable-coordinates-system").parent().show()}),$("#mapexpress-export-avaliable-coordinates-system").find("li").on("click",function(b){$("#mapexpress-export-avaliable-coordinates-system").find("li").removeClass("active"),c.setActiveCRS($(b.currentTarget).attr("id"),a),$(b.currentTarget).addClass("active"),$("#mapexpress-export-avaliable-coordinates-system").parent().hide()}),$(".mapexpress-export-hide-coordinates-system").on("click",function(){$("#mapexpress-export-avaliable-coordinates-system").parent().hide()}),$("#mapexpress-export-avaliable-coordinates-system_autocomplete").on("input",b)}}),MapExpress.Tools.MapExportCommand=MapExpress.Tools.ActiveViewMapExportCommand.extend({options:{buttonClassName:"map-toolbar-button"},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a),c=L.DomUtil.create("img",!1,b);return c.setAttribute("src","images/print.png"),b.setAttribute("title","Экспорт карты"),b.setAttribute("id","exportMapImage"),b},activate:function(){this.waitWindow=new MapExpress.Controls.MapControl,this.printControl=new MapExpress.Controls.MapExportControl(this._mapManager._map),this.printer=this.printControl.printer,this.printWindow=new MapExpress.Controls.MapControl(this._mapManager._map,{position:"top",headerEnabled:!0,footerEnabled:!0,closeButtonEnabled:!0}),this.printWindow.setContent(this.printControl._createContent()),this.printWindow.setTitle("Экспорт карты "),this.printWindow.setFooterContent("Выберите область и укажите масштабный уровень карты"),this.printControl._setUpButtonHandlers(),this.printControl._activateAreaSelect(),this.printWindow.show(),this._updateFooterOnZoomChange(this.printControl),this._mapManager._map.on("map-print-control:removed",this.onRemoved,this),this.printWindow.on("mapcontrol:remove:after",function(){this.printControl.remove()},this),this.printer.on("mapexport:export:start",this._onExportStart,this),this.printer.on("mapexport:html2canvas:start",this._onStartHtml2Canvas,this),this.printer.on("mapexport:export:end",this._onExportEnd,this),this._mapManager._map.on("map-print-control:zoomUp",this._updateFooterOnZoomChange,this),this._mapManager._map.on("map-print-control:zoomDown",this._updateFooterOnZoomChange,this),this._mapManager._map.on("map-print-control:futuresize:changed",this._updateFooterOnZoomChange,this)},deactivate:function(){this.printer&&(this.printer.off("mapexport:export:start",this._onExportStart,this),this.printer.off("mapexport:html2canvas:start",this._onStartHtml2Canvas,this),this.printer.off("mapexport:export:end",this._onExportEnd,this)),this._mapManager._map.off("map-print-control:zoomUp",this._updateFooterOnZoomChange,this),this._mapManager._map.off("map-print-control:zoomDown",this._updateFooterOnZoomChange,this),this._mapManager._map.off("map-print-control:futuresize:changed",this._updateFooterOnZoomChange,this),this.printWindow&&this.printWindow.destroy(),this.waitWindow&&this.waitWindow.destroy(),delete this.printWindow,delete this.waitWindow,delete this.printControl,delete this.printer},_updateFooterOnZoomChange:function(a){var b="Размер изображения: "+a.futureSize.size+" px, W="+a.futureSize.width+" px , H="+a.futureSize.height+" px";this.printWindow.setFooterContent(b),this.printWindow.setFooterBarStyle("color:"+this.printControl._getWarningColor())}}),MapExpress.Controls.MapExportControl=L.Control.extend({options:{position:"topright"},futureSize:{width:0,height:0,size:0,zoom:0},initialize:function(a,b){this.map=a,L.setOptions(this,b),this.active=!1,this.futureSize.zoom=a.getZoom(),this.printer=MapExpress.Utils.mapExporter()},addTo:function(a){return this.map=a,L.Control.prototype.addTo.call(this,a),this._setUpButtonHandlers(),this._activateAreaSelect(),this},onAdd:function(a){return this._createContent()},remove:function(){L.Control.prototype.remove.call(this),this.areaSelect&&(this.areaSelect.off("change",this._areaSelectChanged,this),this.areaSelect.remove())},_areaSelectChanged:function(a){this.updateFutureSize()},_createContent:function(){return this.controlDiv=L.DomUtil.create("div","map-print-container"),this.controlDiv.setAttribute("id","map-print-container"),MapExpress.Controls.MapControlUtils.stopMousePropagation(this.controlDiv),$(this.controlDiv).append('<button id="mapprint-zoomDown"  class="btn btn-default btn-sm text-center" title="Уменьшить масштабный коэффициент карты">-</button>'),$(this.controlDiv).append('<button id="mapprint-zoomUp" class="btn btn-default btn-sm text-center" title="Увеличить масштабный коэффициент карты">+</button>'),$(this.controlDiv).append('<button id="mapprint-print" class="btn btn-default btn-sm text-center" title="Экспорт" value="Экспорт">Экспорт</button>'),$(this.controlDiv).append('<button id="mapprint-print-activemap" class="btn btn-default btn-sm text-center" title="Экспорт активного вида карты" value="активный вид карты">Активный вид</button>'),$(this.controlDiv).append('<button id="mapprint-remove" class="btn btn-default btn-sm text-center" title="Cбросить выбор территории" value="Отмена">Отмена</button>'),this.controlDiv},_activateAreaSelect:function(){$(this.map.getContainer()).height(),$(this.map.getContainer()).width();this.areaSelect=new MapExpress.Controls.AreaSelectEditable(this.map),this.updateFutureSize(),this.areaSelect.on("change",this._areaSelectChanged,this)},_setUpButtonHandlers:function(){var a=this;$("#mapprint-print-activemap").click(function(b){a.map.fire("map-print-control:export-activemap",a),a.exportMap(!0)}),$("#mapprint-remove").click(function(b){a.remove(),a.map.fire("map-print-control:removed",a)}),$("#mapprint-zoomUp").click(function(){a.futureSize.zoom=a.futureSize.zoom+1,a.futureSize.zoom>20&&(a.futureSize.zoom=20),a.updateFutureSize(),a.map.fire("map-print-control:zoomUp",a)}),$("#mapprint-zoomDown").click(function(){a.futureSize.zoom=a.futureSize.zoom-1,a.updateFutureSize(),a.map.fire("map-print-control:zoomDown",a)}),$("#mapprint-print").click(function(){a.map.fire("map-print-control:export-click",a),a.exportMap()})},updateFutureSize:function(){var a=this.futureSize.zoom,b=(this.map.getCenter(),this.map.getPixelBounds(this.areaSelect.getBounds()._northEast,a)),c=this.map.getPixelBounds(this.areaSelect.getBounds()._southWest,a),d={x:null,y:null},e={x:null,y:null};d.x=b.min.x+this.map.getSize().x/2,d.y=b.min.y+this.map.getSize().y/2,e.x=c.min.x+this.map.getSize().x/2,e.y=c.min.y+this.map.getSize().y/2;var f=e.y-d.y,g=d.x-e.x;this.futureSize.width=g,this.futureSize.height=f,this.futureSize.size=g*f,this.map.fire("map-print-control:futuresize:changed",this)},_getWarningColor:function(){var a,b=this.futureSize.size;return 6e5>=b?a="#4CAF50":b>6e5&&9e5>=b?a="#8BC34A":b>9e5&&14e5>=b?a="#CDDC39":b>14e5&&2e6>=b?a="#FDD835":b>2e6&&28e5>=b?a="#FFC107":b>28e5&&39e5>=b?a="#FF9800":b>39e5&&6e6>=b?a="#FF5722":b>6e6&&8e6>=b?a="#F44336":b>8e6&&(a="#D50000"),a},exportMap:function(a){$(".leaflet-control-container, #map-print-container").attr("data-html2canvas-ignore","true"),$(".leaflet-control-container").attr("data-html2canvas-ignore","true"),this.areaSelect.off("change",this._resetChange,this),this.remove(),a&&a===!0?this.printer.exportActiveMapView(this.map):this.printer["export"](this.map,this.futureSize.width,this.futureSize.height,this.futureSize.zoom)}}),MapExpress.Utils.MapExporter=L.Evented.extend({exportActiveMapView:function(a,b){this["export"](a,null,null,null,!0)},"export":function(a,b,c,d,e){this.activeView=e,this.mapStyle=""+a.getContainer().style.cssText,this._export(a,b,c,d)},_export:function(a,b,c,d){this.map=a,this.fire("mapexport:export:start",this);var e=$(a.getContainer()),f=a.getZoom(),g=a.getCenter();this.activeView||($(document).height()>c?e.height(c):e.css("min-height",c+"px"),e.width(b),a.invalidateSize(!0,!0),a.setView(g,d));var h=this;setTimeout(function(){try{h._prepareExport(a,f,g)}catch(b){var c=h._tryCatchExportResult(a,f,g);c.error=b,h.fire("mapexport:export:end",c)}},5e3)},_prepareExport:function(a,b,c){this.fire("mapexport:prepareexport:start",this);var d=$(a.getContainer()).clone(),e=d.find(".leaflet-map-pane")[0],f=e.style.transform.split(",");this.mapX=parseFloat(f[0].split("(")[1].replace("px","")),this.mapY=parseFloat(f[1].replace("px","")),this.fire("mapexport:prepareexport:mapPane",this);var g=document.createElement("canvas");g.className="screenShotTempCanvas",g.id="mainCanvas",g.width=a.getSize().x,g.height=a.getSize().y,g.style.left=-this.mapX,g.style.top=-this.mapY;var h=g.getContext("2d");this.on("mapexport:prepareexport:canvascreated",function(){this.drawtilesOnCanvas(a,h)},this),this.on("mapexport:prepareexport:alltilesloaded",function(){this.drawImageOverlaysOnCanvas(a,d,h)},this),this.on("mapexport:prepareexport:allmapimageoverlayloaded",function(){this.drawShadowIconsOnCanvas(a,d,h)},this),this.on("mapexport:prepareexport:allmapshadowiconsloaded",function(){this.drawSVGOnCanvas(a,d,h)},this),this.on("mapexport:prepareexport:canvaswithsvgready",function(){this.drawDivIconsOnCAnvas(a,d,h,g)},this),this.on("mapexport:prepareexport:allmapiconsdrawn",function(){this.exportCanvas(a,g,b,c)},this),this.on("mapexport:prepareexport:canvasexported",function(){d.remove(),this.fire("mapexport:prepareexport:end",this)},this),this.fire("mapexport:prepareexport:canvascreated",this)},drawtilesOnCanvas:function(a,b){function c(){var a=o.length,b=t+u;b===a&&(j.fire("mapexport:prepareexport:alltilesloaded"),d.remove(),delete o)}var d=$(a.getContainer()).clone(),e=d.find(".leaflet-map-pane")[0],f=e.style.transform.split(","),g=parseFloat(f[0].split("(")[1].replace("px","")),h=parseFloat(f[1].replace("px","")),i=d.find(".leaflet-tile-container"),j=this;if(i&&i[0]){var k;k=i.length>1?i[1]:i[0];for(var l=k.style.transform.split(","),m=parseFloat(l[0].split("(")[1].replace("px","")),n=parseFloat(l[1].replace("px","")),o=d.find("img.leaflet-tile"),p=[],q=[],r=[],s=[],t=0,u=0,v=0;v<o.length;v++){if(""!==o[v].style.left)p.push(parseFloat(o[v].style.left.replace("px",""))),q.push(parseFloat(o[v].style.top.replace("px",""))),s[v]="left";else if(""!==o[v].style.transform){var w=o[v].style.transform.split(",");p[v]=parseFloat(w[0].split("(")[1].replace("px","")),q[v]=parseFloat(w[1].replace("px","")),o[v].style.transform="",s[v]="transform"}else p[v]=0,r[v]=0,s[v]="neither";o[v].style.left=p[v]+"px",o[v].style.top=q[v]+"px";var x=new Image;x.setAttribute("crossOrigin","anonymous"),x.onload=function(a){return function(){b.drawImage(this,p[a]+g+m,q[a]+h+n),t+=1,c.call(j)}}(v),x.onerror=function(a){return function(){u+=1,c.call(j)}}(v),x.src=o[v].src}}else d.remove(),this.fire("mapexport:prepareexport:alltilesloaded")},drawImageOverlaysOnCanvas:function(a,b,c){function d(){var a=e.length,b=k+l;b===a&&(f.fire("mapexport:prepareexport:allmapimageoverlayloaded"),k=0,l=0)}var e=b.find("img.leaflet-image-layer"),f=this;if(!e||!e[0])return void this.fire("mapexport:prepareexport:allmapimageoverlayloaded");for(var g=[],h=[],i=[],j=[],k=0,l=0,m=[],n=[],o=0;o<e.length;o++){var p=e[o].style.width,q=e[o].style.height;if(m.push(p),n.push(q),""!==e[o].style.left)g.push(parseFloat(e[o].style.left.replace("px",""))),h.push(parseFloat(e[o].style.top.replace("px",""))),j[o]="left";else if(""!==e[o].style.transform){var r=e[o].style.transform.split(",");g[o]=parseFloat(r[0].split("(")[1].replace("px","")),h[o]=parseFloat(r[1].replace("px","")),e[o].style.transform="",j[o]="transform"}else g[o]=0,i[o]=0,j[o]="neither";e[o].style.left=g[o]+"px",e[o].style.top=h[o]+"px";var s=new Image;s.setAttribute("crossOrigin","anonymous"),s.onload=function(a){return function(){c.drawImage(this,g[a]+f.mapX,h[a]+f.mapY,parseFloat(m[a].replace("px","")),parseFloat(n[a].replace("px",""))),k+=1,d.call(f)}}(o),s.onerror=function(a){return function(){console.log("Ошибка оверлея: "+this.src+"  "+a),l+=1,d.call(f)}}(o),s.src=e[o].src}},drawSVGOnCanvas:function(a,b,c){var d=$(a.getPanes().overlayPane).attr("class"),e=b.find("."+d.replace(" ",".")).find("svg"),f=this;if(e&&void 0!==e[0]){var g,h=e[0],i=h.style.transform.split(","),j=parseFloat(i[0].split("(")[1].replace("px","")),k=parseFloat(i[1].replace("px",""));h.style.transform="",h.style.left=j+"px",h.style.top=k+"px",e.each(function(){var b=document.createElement("canvas");b.className="screenShotTempCanvas",b.id="SvgToCanvas",b.width=a.getSize().x,b.height=a.getSize().y;b.getContext("2d");L.DomUtil.getPosition(e),g=(new XMLSerializer).serializeToString(this),canvg(b,g),c.drawImage(b,j+f.mapX,k+f.mapY)}),this.fire("mapexport:prepareexport:canvaswithsvgready")}else this.fire("mapexport:prepareexport:canvaswithsvgready")},drawShadowIconsOnCanvas:function(a,b,c){function d(){var a=e.length,b=m+n;b===a&&f.fire("mapexport:prepareexport:allmapshadowiconsloaded")}var e=b.find("img.leaflet-marker-shadow"),f=this;if(e&&e[0])for(var g=[],h=[],i=[],j=[],k=[],l=[],m=0,n=0,o=0;o<e.length;o++){var p=e[o].style.transform,q=p.split(",");j.push(parseInt(e[o].style.marginTop.replace("px",""))),i.push(parseInt(e[o].style.marginLeft.replace("px",""))),g.push(parseFloat(q[0].split("(")[1].replace("px",""))),h.push(parseFloat(q[1].replace("px",""))),e[o].style.transform="",e[o].style.left=g[o]+"px",e[o].style.top=h[o]+"px",k.push(parseInt(e[o].style.width.replace("px",""))),l.push(parseInt(e[o].style.height.replace("px","")));var r=new Image;r.setAttribute("crossOrigin","anonymous"),r.src=e[o].src,r.onload=function(a){return function(){f.fire("mapexport:prepareexport:mapshadowiconloaded"),c.drawImage(this,g[a]+f.mapX+i[a],h[a]+f.mapY+j[a],k[a],l[a]),m+=1,d.call(f)}}(o),r.onerror=function(a){return function(){f.fire("mapexport:prepareexport:mapshadowiconserror"),n+=1,d.call(f)}}(o)}else this.fire("mapexport:prepareexport:allmapshadowiconsloaded")},drawDivIconsOnCAnvas:function(a,b,c,d){function e(){h.div===!0&&h.icons===!0&&(g.attr("class","tempopane"),document.body.appendChild(g[0]),html2canvas(g[0],{onrendered:function(a){c.drawImage(a,0,0),f.fire("mapexport:prepareexport:allmapiconsdrawn"),$(".tempopane").remove()},canvas:d}),h.div="",h.icons="")}var f=this,g=b.find(".leaflet-marker-pane"),h={div:"",icons:""};if(g&&g[0].children&&g[0].children.length>0){var i=b.find("div.leaflet-marker-icon");if(i&&i[0]){for(var j,k=[],l=[],m=[],n=[],o=0;o<i.length;o++){j=i[o].style;var p=j.transform,q=p.split(",");n.push(parseInt(j.marginTop.replace("px",""))),m.push(parseInt(j.marginLeft.replace("px",""))),k.push(parseFloat(q[0].split("(")[1].replace("px",""))),l.push(parseFloat(q[1].replace("px",""))),j.transform="",j.left=k[o]+f.mapX+"px",j.top=l[o]+f.mapY+"px"}h.div=!0,e.call(this)}else h.div=!0,e.call(this);var r=b.find("img.leaflet-marker-icon");if(r&&r[0]){for(var s,t=[],u=[],v=[],w=[],x=0;x<r.length;x++){s=r[x].style;var y=s.transform,z=y.split(",");w.push(parseInt(s.marginTop.replace("px",""))),v.push(parseInt(s.marginLeft.replace("px",""))),t.push(parseFloat(z[0].split("(")[1].replace("px",""))),u.push(parseFloat(z[1].replace("px",""))),s.transform="",s.left=t[x]+"px",s.top=u[x]+"px"}h.icons=!0,e.call(this)}else h.icons=!0,e.call(this)}else this.fire("mapexport:prepareexport:allmapiconsdrawn")},exportCanvas:function(a,b,c,d){var e=this._tryCatchExportResult(a,b,c,d);try{b.msToBlob?e.image=b.msToBlob():e.image=b.toDataURL("image/jpeg")}catch(f){e.error=f}this.fire("mapexport:export:end",e)},_tryCatchExportResult:function(a,b,c,d){var e=[a.getBounds()._southWest,a.getBounds()._northEast],f=$(a.getContainer()),g={printer:this,image:!1,bbox:e,imageSize:{width:a.getSize().x,height:a.getSize().y},map:a,error:!1,canvasWidth:b.width,canvasHeight:b.height,mapContainerHeight:f.height(),mapContainerWidth:f.width()};return this.fire("mapexport:prepareexport:canvasexported"),this.fire("mapexport:prepareexport:end",this),this.activeView||(f[0].style.cssText=this.mapStyle,a.setView(d,c),a.invalidateSize(!0)),$("#mainCanvas").remove(),$("#SvgToCanvas").remove(),$("[class^='Labels']").remove(),this.fire("mapexport:restorestate:end",this),g}}),MapExpress.Utils.mapExporter=function(a,b,c,d){return new MapExpress.Utils.MapExporter(a,b,c,d)};