MapExpress={Controls:{},Service:{},Geo:{},Layers:{},Utils:{Promise:{}},Mapping:{},Tools:{},Styles:{},Search:{}},"undefined"!=typeof window&&window.L&&(window.MapExpress=MapExpress),MapExpress.Controls.AreaSelect=L.Class.extend({includes:L.Mixin.Events,options:{width:200,height:300,keepAspectRatio:!1},initialize:function(a){L.Util.setOptions(this,a),this._width=this.options.width,this._height=this.options.height},addTo:function(a){return this.map=a,this._createElements(),this._render(),this},getBounds:function(){var a=this.map.getSize(),b=new L.Point,c=new L.Point;c.x=Math.round((a.x-this._width)/2),b.y=Math.round((a.y-this._height)/2),b.x=a.x-c.x,c.y=a.y-b.y;var d=this.map.containerPointToLatLng(c),e=this.map.containerPointToLatLng(b);return new L.LatLngBounds(d,e)},getPixelBounds:function(){var a=this.map.getSize(),b=new L.Point,c=new L.Point;return b.x=Math.round((a.x-this._width)/2),b.y=Math.round((a.y-this._height)/2),c.x=a.x-b.x,c.y=a.y-b.y,[b,c]},remove:function(){this.map.off("moveend",this._onMapChange),this.map.off("zoomend",this._onMapChange),this.map.off("resize",this._onMapResize),this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container)},_createElements:function(){this._container||(this._container=L.DomUtil.create("div","leaflet-areaselect-container",this.map._controlContainer),this._topShade=L.DomUtil.create("div","leaflet-areaselect-shade",this._container),this._bottomShade=L.DomUtil.create("div","leaflet-areaselect-shade",this._container),this._leftShade=L.DomUtil.create("div","leaflet-areaselect-shade",this._container),this._rightShade=L.DomUtil.create("div","leaflet-areaselect-shade",this._container),this._nwHandle=L.DomUtil.create("div","leaflet-areaselect-handle",this._container),this._swHandle=L.DomUtil.create("div","leaflet-areaselect-handle",this._container),this._neHandle=L.DomUtil.create("div","leaflet-areaselect-handle",this._container),this._seHandle=L.DomUtil.create("div","leaflet-areaselect-handle",this._container),this._setUpHandlerEvents(this._nwHandle),this._setUpHandlerEvents(this._neHandle,-1,1),this._setUpHandlerEvents(this._swHandle,1,-1),this._setUpHandlerEvents(this._seHandle,-1,-1),this.map.on("moveend",this._onMapChange,this),this.map.on("zoomend",this._onMapChange,this),this.map.on("resize",this._onMapResize,this),this.fire("change"))},_setUpHandlerEvents:function(a,b,c){function d(f){function g(a){if(e.options.keepAspectRatio){var d=(e._height>=e._width?l.y:l.y*(1/k))-30;e._height+=2*(j-a.originalEvent.pageY)*c,e._height=Math.max(30,e._height),e._height=Math.min(d,e._height),e._width=e._height*k}else e._width+=2*(i-a.originalEvent.pageX)*b,e._height+=2*(j-a.originalEvent.pageY)*c,e._width=Math.max(30,e._width),e._height=Math.max(30,e._height),e._width=Math.min(l.x-30,e._width),e._height=Math.min(l.y-30,e._height);i=a.originalEvent.pageX,j=a.originalEvent.pageY,e._render()}function h(b){L.DomEvent.removeListener(e.map,"mouseup",h),L.DomEvent.removeListener(e.map,"mousemove",g),L.DomEvent.addListener(a,"mousedown",d),e.fire("change")}f.stopPropagation(),L.DomEvent.removeListener(this,"mousedown",d);var i=f.pageX,j=f.pageY,k=e._width/e._height,l=e.map.getSize();L.DomEvent.addListener(e.map,"mousemove",g),L.DomEvent.addListener(e.map,"mouseup",h)}b=b||1,c=c||1;var e=this;L.DomEvent.addListener(a,"mousedown",d)},_onMapResize:function(){this._render()},_onMapChange:function(){this.fire("change")},_render:function(){function a(a,b){a.style.width=b.width+"px",a.style.height=b.height+"px",a.style.top=b.top+"px",a.style.left=b.left+"px",a.style.bottom=b.bottom+"px",a.style.right=b.right+"px"}var b=this.map.getSize(),c=Math.round(this._nwHandle.offsetWidth/2),d=Math.round((b.y-this._height)/2),e=Math.round((b.x-this._width)/2);a(this._topShade,{width:b.x,height:d,top:0,left:0}),a(this._bottomShade,{width:b.x,height:d,bottom:0,left:0}),a(this._leftShade,{width:e,height:b.y-2*d,top:d,left:0}),a(this._rightShade,{width:e,height:b.y-2*d,top:d,right:0}),a(this._nwHandle,{left:e-c,top:d-7}),a(this._neHandle,{right:e-c,top:d-7}),a(this._swHandle,{left:e-c,bottom:d-7}),a(this._seHandle,{right:e-c,bottom:d-7})}}),MapExpress.Controls.areaSelect=function(a){return new MapExpress.Controls.AreaSelect(a)},MapExpress.Controls.MapControl=L.Evented.extend({options:{className:"",position:"center",modal:!1,titleText:!1,headerEnabled:!1,footerEnabled:!1,closeButtonEnabled:!0,draggable:!0,removalDelay:0,parentContainer:!1,closeOnLeave:!1},initialize:function(a,b){this._map=a,L.setOptions(this,b),this._initLayout()},show:function(){if(this._control||this._initLayout(),this._control){if(this.options.draggable&&this._controlHeaderBar){var a=new L.Draggable(this._control,this._controlHeaderBar);a.enable()}this.options.removalDelay>0&&setTimeout(this.hide.bind(this),this.options.removalDelay),this.setPosition(this.options.position),this._control.style.visibility="visible",this.options.closeOnLeave&&this.closeOnLeave(),MapExpress.Controls.MapControlUtils.stopMousePropagation(this._control)}return this},setPosition:function(a){return a&&(this.options.position=a,MapExpress.Controls.MapControlUtils.setPosition(this._getContainer(),this._control,this.options.position)),this},showSmallCircleWaitControl:function(){return this.options.headerEnabled=!1,this.show(),this.setControlStyle({height:"36px",width:"36px","border-radius":"50%",padding:"0px",margin:"0px"}),this.setContentStyle({padding:"6px"}),this.setContent(this.getPreloaderContent(24,12,10,4)),this._control&&$(this._control).attr("data-html2canvas-ignore","true"),this},showCircleWaitControl:function(){return this.options.headerEnabled=!1,this.show(),this.setControlStyle({height:"36px",width:"36px","border-radius":"50%",padding:"0px",margin:"0px"}),this.setContentStyle({padding:"0px"}),this.setContent(this.getPreloaderContent(36,18,14,5)),this._control&&$(this._control).attr("data-html2canvas-ignore","true"),this},showWaitControl:function(a){return this.options.headerEnabled=!1,this.setControlStyle({height:"36px","border-radius":"36px"}),this.setContentStyle({padding:"0px",margin:"0px"}),this.setContent(this.getPreloaderContent(36,18,14,5)+"<div class='noselect' style='margin-right:8px;margin-left:4px;float:right;font-size:13px;font-weight:500;display: inline-block;line-height: 36px;'>"+a+"</div>"),this._control&&$(this._control).attr("data-html2canvas-ignore","true"),this.show(),this},showSidebar:function(a,b,c,d){function e(a){g.html(a),g.addClass("active"),d&&"function"==typeof d&&d()}this.options.position=!1,this.hide();var f=this._getContainer();this._control=L.DomUtil.create("div",this.options.className+" mapexpress-sidebar-wrapper",f);var g=$(this._control);return g.attr("data-html2canvas-ignore","true"),g.attr("id","sidebar-"+b),this.options.closeOnLeave&&this.closeOnLeave(),MapExpress.Controls.MapControlUtils.stopMousePropagation(this._control),MapExpress.Controls.MapControlUtils.generateTemplate(a,b,c,e),this},hide:function(){this._control&&(this.fire("mapcontrol:remove:before",this),$(this._control).remove(),delete this._control,this.fire("mapcontrol:remove:after",this))},setContent:function(a){return this._controlContent&&$(this._controlContent).html(a),this.setPosition(this.options.position),this},setContentFromTemplate:function(a,b,c,d){function e(a){f.setContent(a),d&&"function"==typeof d&&d()}var f=this;return MapExpress.Controls.MapControlUtils.generateTemplate(a,b,c,e),this},setTitle:function(a){return this._controlTitle&&$(this._controlTitle).html(a),this},setFooterContent:function(a){return this._controlFooterBar&&$(this._controlFooterBar).html(a),this},setControlStyle:function(a){return MapExpress.Controls.MapControlUtils.setStyle(this._control,a),this},setContentStyle:function(a){return MapExpress.Controls.MapControlUtils.setStyle(this._controlContent,a),this},setHeaderBarStyle:function(a){return MapExpress.Controls.MapControlUtils.setStyle(this._controlHeaderBar,a),this},setTitleBarStyle:function(a){return MapExpress.Controls.MapControlUtils.setStyle(this._controlTitleBar,a),this},setTitleStyle:function(a){return MapExpress.Controls.MapControlUtils.setStyle(this._controlTitle,a),this},setCloseButtonStyle:function(a){return MapExpress.Controls.MapControlUtils.setStyle(this._closeButton,a),this},setFooterBarStyle:function(a){return MapExpress.Controls.MapControlUtils.setStyle(this._controlFooterBar,a),this},_initLayout:function(){if(!this._control){var a=this._getContainer();if(this._control=L.DomUtil.create("div",this.options.className+" mapexpress-control-wrapper",a),this._control.style.visibility="hidden",$(this._control).attr("data-html2canvas-ignore","true"),this.options.titleText&&(this.options.headerEnabled=!0),this.options.headerEnabled&&(this._controlHeaderBar=L.DomUtil.create("header","mapexpress-control-headerbar",this._control),this._controlTitleBar=L.DomUtil.create("div","mapexpress-control-titlebar",this._controlHeaderBar),this._controlTitle=L.DomUtil.create("div","mapexpress-control-title",this._controlTitleBar),this.options.titleText&&this.setTitle(this.options.titleText),this._controlToolbar=L.DomUtil.create("div","mapexpress-control-toolbar",this._controlHeaderBar),this.options.closeButtonEnabled)){this._closeButton=L.DomUtil.create("div","mapexpress-control-toolbar-btn",this._controlToolbar),$(this._closeButton).html("&#215");var b=this;$(this._closeButton).click(function(){b.hide()})}return this._controlContent=L.DomUtil.create("div","mapexpress-control-content",this._control),this.options.footerEnabled&&(this._controlFooterBar=L.DomUtil.create("footer","mapexpress-control-footerbar",this._control)),this.options.modal?(this._control.style.zIndex=7e3,this._control.style.position="fixed"):(this._control.style.zIndex=2e3,this._control.style.position="absolute"),this}},bringToFront:function(){return this._control&&L.DomUtil.toFront(this._control),this},closeOnLeave:function(){var a=this;$(document).on("click",function(b){var c=$(this._control);c.is(b.target)||0!==c.has(b.target).length||a.hide()})},getPreloaderContent:function(a,b,c,d){var e=".md-preloader{font-size:0;display:inline-block;-webkit-animation:outer 6600ms linear infinite;animation:outer 6600ms linear infinite}.md-preloader svg{-webkit-animation:inner 1320ms linear infinite;animation:inner 1320ms linear infinite}.md-preloader svg circle{fill:none;stroke:#3F51B5;stroke-linecap:square;-webkit-animation:arc 1320ms cubic-bezier(.8, 0, .4, .8) infinite;animation:arc 1320ms cubic-bezier(.8, 0, .4, .8) infinite}@-webkit-keyframes outer{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes outer{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-webkit-keyframes inner{0%{-webkit-transform:rotate(-100.8deg);transform:rotate(-100.8deg)}100%{-webkit-transform:rotate(0);transform:rotate(0)}}@keyframes inner{0%{-webkit-transform:rotate(-100.8deg);transform:rotate(-100.8deg)}100%{-webkit-transform:rotate(0);transform:rotate(0)}}@-webkit-keyframes arc{0%{stroke-dasharray:1 210.48670779px;stroke-dashoffset:0}40%{stroke-dasharray:151.55042961px,210.48670779px;stroke-dashoffset:0}100%{stroke-dasharray:1 210.48670779px;stroke-dashoffset:-151.55042961px}}@keyframes arc{0%{stroke-dasharray:1 210.48670779px;stroke-dashoffset:0}40%{stroke-dasharray:151.55042961px,210.48670779px;stroke-dashoffset:0}100%{stroke-dasharray:1 210.48670779px;stroke-dashoffset:-151.55042961px}}",f=document.createElement("style");f.styleSheet?f.styleSheet.cssText=e:f.appendChild(document.createTextNode(e)),this.preloaderStyleElement=document.getElementsByTagName("head")[0].appendChild(f);var g="<div class='md-preloader'><svg xmlns='http://www.w3.org/2000/svg' version='1.1' height='{size}' width='{size}' viewbox='0 0 {size} {size}'><circle cx='{cx}' cy='{cx}' r='{r}' stroke-width='{strokewidth}'/></svg></div>",h=L.Util.template(g,{size:a,cx:b,r:c,strokewidth:d});return h},_getContainer:function(){return!this._container&&this.options.parentContainer&&(this._container=this.options.parentContainer),!this._container&&this._map&&(this._container=this._map.getContainer()),this._container||(this._container=document.body),this._container}}),MapExpress.Controls.MapControlUtils={stopMousePropagation:function(a){if(a){var b=L.DomEvent.stopPropagation;L.DomEvent.addListener(a,"click",b).addListener(a,"dblclick",b).addListener(a,"onwheel",b).addListener(a,"wheel",b).addListener(a,"dragenter",b).addListener(a,"dragover",b).addListener(a,"mousedown",b).addListener(a,"touchstart",b).addListener(a,"mousewheel",b)}},setPosition:function(a,b,c){return window.onresize=function(){MapExpress.Controls.MapControlUtils.setPosition(a,b,c)},"center"===c?void this.setCenterPosition(a,b):"topLeft"===c?void this.setTopLeftPosition(a,b):"left"===c?void this.setLeftPosition(a,b):"bottomLeft"===c?void this.setBottomLeftPosition(a,b):"right"===c?void this.setRightPosition(a,b):"topRight"===c?void this.setTopRightPosition(a,b):"top"===c?void this.setTopPosition(a,b):"bottom"===c?void this.setBottomPosition(a,b):"bottomRight"===c?void this.setBottomRightPosition(a,b):void this.setCenterPosition(a,b)},setCenterPosition:function(a,b){var c=$(a),d=$(b);b.style.left=Math.round((c.width()-d.width())/2)+"px",b.style.top=Math.round((c.height()-d.height())/2)+"px"},setTopLeftPosition:function(a,b){b.style.marginLeft="10px",b.style.marginTop="10px"},setLeftPosition:function(a,b){var c=$(a),d=$(b);b.style.marginLeft="10px",b.style.top=Math.round((c.height()-d.height())/2)+"px"},setTopPosition:function(a,b){var c=$(a),d=$(b);b.style.left=Math.round((c.width()-d.width())/2)+"px",b.style.marginTop="10px"},setRightPosition:function(a,b){var c=$(a),d=$(b);b.style.right="0px",b.style.marginRight="10px",b.style.top=Math.round((c.height()-d.height())/2)+"px"},setTopRightPosition:function(a,b){b.style.top="0px",b.style.right="0px",b.style.marginRight="10px",b.style.marginTop="10px"},setBottomLeftPosition:function(a,b){b.style.bottom="0px",b.style.left="0px",b.style.marginLeft="10px",b.style.marginBottom="10px"},setBottomRightPosition:function(a,b){b.style.bottom="0px",b.style.right="0px",b.style.marginRight="10px",b.style.marginBottom="10px"},setBottomPosition:function(a,b){var c=$(a),d=$(b);b.style.bottom="0px",b.style.marginBottom="10px",b.style.left=Math.round((c.width()-d.width())/2)+"px"},setStyle:function(a,b){if(a){if(b&&"string"==typeof b&&b.length>0)return void(a.style.cssText=a.style.cssText+";"+b);if(b&&"object"==typeof b)for(var c in b)a.style[c]=b[c]}},generateTemplate:function(a,b,c,d){var e=document.createElement("div");document.body.appendChild(e),$(e).load(a,function(){var a=$.templates("#"+b);if(a){var f=a.render(c);$(e).remove(),d&&"function"==typeof d&&d(f)}})}},MapExpress.Controls.MapPopupControl=MapExpress.Controls.MapControl.extend({setPosition:function(a){return this},setLatLngPosition:function(a){return this._latlng=L.latLng(a),this._updatePosition()},hide:function(){return this._map&&this._map.off(this.getEvents(),this),MapExpress.Controls.MapControl.prototype.hide.call(this)},show:function(){return this._map&&this._map.on(this.getEvents(),this),MapExpress.Controls.MapControl.prototype.show.call(this)},_getContainer:function(){return this._container=this._map.getPane("mapPane"),this._container},_updatePosition:function(){if(this._map&&this._latlng){var a=$(this._control),b=this._map.latLngToLayerPoint(this._latlng),c=b.x-Math.round(a.width()/2),d=b.y-a.height()-12;this._control.style.top=d+"px",this._control.style.left=c+"px",this._adjustPan()}return this},getEvents:function(){var a={zoom:this._updatePosition};return this._map._zoomAnimated&&(a.zoomanim=this._updatePosition),a},_adjustPan:function(){var a=this;if(!this._map._panAnim||!this._map._panAnim._inProgress){var b=$(this._control),c=0,d=0,e=$(a._map.getContainer()).width(),f=$(a._map.getContainer()).offset(),g=f.left,h=f.top,i=b.offset().left-g,j=b.offset().top-h,k=b.width();i>0&&i+k>e?d=-(e-i-k-12):i>0&&i+k<e?i<12?d=-(12-i):e-(i+k)<12&&(d=e-(i+k)):i<0&&(d=i-12),j<12&&j>=0?c=12-j:j<0&&(c=j-12),0===c&&0===d||this._map.fire("autopanstart").panBy([d,c])}}}),MapExpress.Layers.GeoJSONServiceLayer=L.GeoJSON.extend({options:{dynamicData:!0,useVectorTile:!1},initialize:function(a,b){L.GeoJSON.prototype.initialize.call(this,null,b),L.setOptions(this,b),this.options.pointToLayer=this._pointToLayer,this._dataPovider=a,this._prevMapView={},this._singleDataLoaded=!1},onAdd:function(a){L.GeoJSON.prototype.onAdd.call(this,a),a.on("moveend",this._updateData,this),this._updateData()},onRemove:function(a){this.clearLayers(),L.GeoJSON.prototype.onRemove.call(this,a),a.off("moveend",this._updateData,this),this._prevMapView={},this._singleDataLoaded=!1},_pointToLayer:function(a,b){var c=new L.CircleMarker(b,{radius:4,fillColor:"gray",color:"black",weight:1,opacity:1,fillOpacity:.5});return c},_refreshData:function(){this._updateData(!1)},_updateData:function(a){var b=this._map.getBounds(),c=this._map.getZoom();return c>this.options.maxZoom||c<this.options.minZoom?(this.clearLayers(),void this._removeLabels()):"undefined"!==a&&a&&this._prevMapView&&this._prevMapView.bounds&&this._prevMapView.bounds.equals(b)?void this._storeMapView():(this._removeLabels(),this.options.dynamicData?this.options.useVectorTile?this._updateVectorTileData(b,c):this._updateVectorDataInBounds(b,c):this._singleDataLoaded||this._addVectorData(),void this._storeMapView())},_addVectorData:function(){var a=this;this._dataPovider.getDataAsync().then(function(b){a._replaceData(b),a._singleDataLoaded=!0},function(){a.clearLayers(),a._removeLabels()})},_updateVectorDataInBounds:function(a,b){var c=this;this._dataPovider.getDataInBoundsAsync(a,b).then(function(a){c._replaceData(a)},function(a){c.clearLayers(),c._removeLabels()})},_updateVectorTileData:function(a,b){var c=this._dataPovider._getAddedTileCoordRangeByMapBounds(this._prevMapView.bounds,this._prevMapView.zoom,a,b);if(this._map.getZoom()!==this._prevMapView.zoom)this.clearLayers(),this._removeLabels();else for(var d=this._dataPovider._getRemovedTileCoordRangeByMapBounds(this._prevMapView.bounds,this._prevMapView.zoom,a,b),e=0;e<d.length;e++)this._removeVectorTile(d[e]);for(var f=0;f<c.length;f++)this._addVectorTile(c[f])},_addVectorTile:function(a){var b=this;this._dataPovider.getDataByTileAsync(a).then(function(c){if(void 0!==c&&c.features&&c.features.length>0){var d=b.addData(c),e=b._dataPovider._tileCoordsToKey(a);for(var f in d._layers)d._layers[f]._tileCoordKey||(d._layers[f]._tileCoordKey=e);b._updateStyleAndLabels()}})},_removeVectorTile:function(a){var b=this._dataPovider._tileCoordsToKey(a);for(var c in this._layers){var d=this._layers[c];d._tileCoordKey&&d._tileCoordKey===b&&this.removeLayer(d)}},_replaceData:function(a){this.clearLayers(),this._removeLabels(),a&&(this.addData(a),this._updateStyleAndLabels())},_storeMapView:function(){this._prevMapView.zoom=this._map.getZoom(),this._prevMapView.bounds=this._map.getBounds(),this._prevMapView.center=this._map.getCenter()},_updateStyleAndLabels:function(){this.updateStyle(),this._labelLayer()},_getFeaturesAtPoint:function(a,b,c,d,e){var f=this,g=$.Deferred();try{var h=[];for(var i in f._layers){var j=f._layers[i];j instanceof L.Marker&&j._latlng?a.distanceTo(j._latlng)<2&&h.push(j.feature):j._containsPoint&&j._containsPoint(b)&&h.push(j.feature)}g.resolve(h)}catch(a){a.layer=f,g.reject(a)}return g.promise()},updateStyle:function(){var a=this._getStyleByZoom();a&&this.setStyle&&this.setStyle(a);for(var b in this._layers){var c=this._layers[b];if(c.setStyle){var d=this._getStyleByLayerProperties(c);d&&c.setStyle(d)}c instanceof L.Marker&&this._updateMarkerStyle(c,a)}},_updateMarkerStyle:function(a,b){b&&(a instanceof L.Marker&&a.options.icon&&(a.options.icon.options.html=b.markerDivInnerHtml,a.options.icon.options.className=b.markerDivClassName),a.setDivStyle&&a.setDivStyle(b.markerDivStyle))},_getStyleByZoom:function(){if(this._map&&this.styles&&this.styles.length>0)for(var a=this._map.getZoom(),b=0;b<this.styles.length;b++){var c=this.styles[b];if(a<=c.maxZoom&&a>=c.minZoom)return c}},_getStyleByLayerProperties:function(a){var b=null;return a&&a.feature&&a.feature.properties&&a.feature.properties.style&&(b="string"==typeof a.feature.properties.style?JSON.parse(a.feature.properties.style):a.feature.properties.style),b},_labelLayer:function(){if(this._removeLabels(),this._map&&this.options.labelEnabled){var a=this._getLabelLayerOptionsByZoom();if(a&&a.length>0){var b=a[0];b.repeat=!1,this.labelOverlay||(this.labelOverlay=new L.LabelOverlay(this,b,!1)),L.Util.setOptions(this.labelOverlay,a[0]),this.labelOverlay._resetLabels()}else this._removeLabels()}else this._removeLabels()},_removeLabels:function(){if(this.labelOverlay){var a=this._leaflet_id;this.labelOverlay._removeLabels(a),delete this.labelOverlay}},_getLabelLayerOptionsByZoom:function(){var a=[];if(this.labels&&this.labels.length>0&&this._map)for(var b=this._map.getZoom(),c=0;c<this.labels.length;c++){var d=this.labels[c];b<=d.maxZoom&&b>=d.minZoom&&a.push(d)}return a}}),MapExpress.Layers.geoJSONServiceLayer=function(a,b){return new MapExpress.Layers.GeoJSONServiceLayer(a,b)},MapExpress.Layers.ImageOverlayLayer=L.ImageOverlay.extend({initialize:function(a,b){if(this._dataPovider=a,L.setOptions(this,b),void 0!==this._dataPovider&&this._dataPovider instanceof MapExpress.Service.SingleImageProvider){var c=this._dataPovider.getDataUrl(),d=this._dataPovider.getImageBounds();L.ImageOverlay.prototype.initialize.call(this,c,d,this.options)}},onAdd:function(a){void 0===this._dataPovider||this._dataPovider instanceof MapExpress.Service.SingleImageProvider||(a.on("moveend",this._reset,this),this._bounds=this._map.getBounds()),L.ImageOverlay.prototype.onAdd.call(this,a)},onRemove:function(a){L.ImageOverlay.prototype.onRemove.call(this,a),a.off("moveend",this._reset,this)},_reset:function(){void 0===this._dataPovider||this._dataPovider instanceof MapExpress.Service.SingleImageProvider||this._updateData(),L.ImageOverlay.prototype._reset.call(this)},_updateData:function(){this.setUrl("");var a=this._map.getZoom();if(!(a>this.options.maxZoom||a<this.options.minZoom)){this._bounds=this._map.getBounds();var b=this._dataPovider.getDataUrlByBounds(this._bounds,this._map.getSize());this.setUrl(b)}}}),MapExpress.Layers.imageOverlayLayer=function(a,b){return new MapExpress.Layers.ImageOverlayLayer(a,b)},L.LabelOverlay=L.Class.extend({options:{minZoom:5,maxZoom:23,fieldToLabel:"layer.feature.properties.id",textAnchor:"middle",fontSize:"11px",textColor:"#800000",fontFamily:"Arial, Roboto",fontWeight:"normal",fontStyle:"normal",textDecoration:"none",opacity:1,dy:0,dx:0,markerLabelPlace:"right",halo:!0,haloWidth:"2px",haloColor:"white",haloOpacity:.8,typeOfLabel:"pointedAlong",repeat:!1,repeatOffset:500,simpleAlongPointPosition:"50%",rectangle:!1,ellipse:!1,circle:!1,autorecWidthHeight:!0,recWidth:5,recHeight:0,recFill:"#ccc",recFillOpacity:.2,recStroke:"#666",recStrokeWidth:"1px",recStrokeOpacity:.7},initialize:function(a,b,c){this.labelingLayer=a,L.Util.setOptions(this,b),this.options.maxZoom||(this.options.maxZoom=this.labelingLayer.options.maxZoom),this.options.minZoom||(this.options.minZoom=this.labelingLayer.options.minZoom),void 0!==c&&c===!0&&this.labelingLayer.on("add",this._onParentLayerAddToMap,this),this.labelingLayer.on("remove",this._onParentLayerRemoveFromMap,this),this.options.repeat=!1,this._correctOptions()},_correctOptions:function(){null===this.options.repeatOffset&&(this.options.repeatOffset=500),this.options.repeatOffset<0&&this.options.repeatOffset*-1,this.options.repeatOffset<20&&console.log("Возможно, выставлено слишком маленькое значение и сильно нагружает систему, т.к. значенеия выставлены в пикселах"),null===this.options.simpleAlongPointPosition&&(this.options.simpleAlongPointPosition="50%")},_onParentLayerAddToMap:function(){this.labelingLayer._mapToAdd&&this.labelingLayer._mapToAdd.on("moveend",this._resetLabels,this),this._resetLabels()},_onParentLayerRemoveFromMap:function(){this.labelingLayer._mapToAdd&&this.labelingLayer._mapToAdd.off("moveend",this._resetLabels,this),this._removeLabels()},_resetLabels:function(){var a=this.labelingLayer._leaflet_id;this._removeLabels(a);var b=this.labelingLayer._map.getZoom();b<this.options.minZoom||b>this.options.maxZoom||this.labelingLayer.eachLayer(function(b){if("Point"===b.feature.geometry.type)this._PointLabel(b,a);else if("LineString"===b.feature.geometry.type)this._LineLabel(b,a);else if("Polygon"===b.feature.geometry.type)this._PolygonLabel(b,a);else if("MultiPoint"===b.feature.geometry.type){var c=b.feature;b.eachLayer(function(b){b.feature=c,this._PointLabel(b,a)},this)}else"MultiLineString"===b.feature.geometry.type?this._LineLabel(b,a):"MultiPolygon"===b.feature.geometry.type?this._PolygonLabel(b,a):alert("Некорректные входящие данные!")},this)},_LineLabel:function(layer,nameForGroups){this._correctOptions();var options=this.options;layer._path.id="layer"+layer._leaflet_id;var group=d3.select("svg").append("g").attr("class","Labels"+nameForGroups).append("g").attr("class","lineLabels"),that=this;options.startLineOffset=-4,d3.selectAll("#layer"+layer._leaflet_id).each(function(d,i){var textEval=function(){var string=eval(options.fieldToLabel);return void 0!==string&&"undefined"!==string||(string=""),string};if("simpleAlong"===options.typeOfLabel){options.halo===!0&&that.haloPrototype.call(this,group,options).append("textPath").attr("xlink:href","#layer"+layer._leaflet_id).attr("startOffset",options.simpleAlongPointPosition).text(textEval);var text=that.textPrototype.call(this,group,options).append("textPath").attr("xlink:href","#layer"+layer._leaflet_id).attr("startOffset",options.simpleAlongPointPosition).text(textEval)}else if(options.repeat===!0){if("pointedAlong"===options.typeOfLabel){var lineLengthPointedAlong=d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getTotalLength(),start,end;switch(!0){case lineLengthPointedAlong<20:return;case lineLengthPointedAlong<50&&lineLengthPointedAlong>=20:start=10,end=10;break;case lineLengthPointedAlong<100&&lineLengthPointedAlong>=50:start=20,end=20;break;case lineLengthPointedAlong>=100:start=30,end=30}for(var i=start;i<lineLengthPointedAlong-end;i+=options.repeatOffset){var all=layer._parts,arrayOfPointOfParts=[];all.forEach(function(a,b,c){a.forEach(function(a,b,c){arrayOfPointOfParts.push(a)})});var ax=arrayOfPointOfParts[d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPathSegAtLength(i)].x,ay=arrayOfPointOfParts[d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPathSegAtLength(i)].y,bx=arrayOfPointOfParts[d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPathSegAtLength(i)-1].x,by=arrayOfPointOfParts[d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPathSegAtLength(i)-1].y,BC=ax-bx,AC=ay-by,angle;if(angle=ax<bx&&ay>by?270-180*Math.atan(BC/AC)/Math.PI:ax<bx&&ay<by?90-180*Math.atan(BC/AC)/Math.PI:ax>bx&&ay<by?270-180*Math.atan(BC/AC)/Math.PI:ax>bx&&ay>by?90-180*Math.atan(BC/AC)/Math.PI:0,options.circle===!0)var circle=group.append("circle");if(options.ellipse===!0)var ellipse=group.append("ellipse");if(options.rectangle===!0)var rectangle=group.append("rect");options.halo===!0&&that.haloPrototype.call(this,group,options).attr("x",d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).x).attr("y",d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).y).attr("transform","rotate("+angle+", "+d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).x+", "+d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).y+")").text(textEval);var text=that.textPrototype.call(this,group,options).attr("x",d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).x).attr("y",d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).y).attr("transform","rotate("+angle+", "+d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).x+", "+d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).y+")").text(textEval),bbox=text.node().getBBox(),centerX=d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).x,centerY=d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).y;if(options.rectangle===!0){var rectangleWidth,rectangleHeight;options.autorecWidthHeight===!0?(rectangleWidth=bbox.width,rectangleHeight=bbox.height):(rectangleWidth=0,rectangleHeight=0),that.rectangleProtype.call(this,rectangle,options).attr("x",bbox.x-2).attr("y",bbox.y).attr("width",rectangleWidth+options.recWidth).attr("height",rectangleHeight+options.recHeight).attr("transform","rotate("+angle+", "+centerX+", "+centerY+")")}if(options.circle===!0){var circleRad;circleRad=options.autorecWidthHeight===!0?bbox.width:0,that.circlePrototype.call(this,circle,options).attr("cx",bbox.x+bbox.width/2).attr("cy",bbox.y+bbox.height/2).attr("r",circleRad/2+options.recWidth).attr("transform","rotate("+angle+", "+centerX+", "+centerY+")")}if(options.ellipse===!0){var ellipceWidth,ellipceHeight;options.autorecWidthHeight===!0?(ellipceWidth=bbox.width,ellipceHeight=bbox.height):(ellipceWidth=0,ellipceHeight=0),that.ellipsePrototype.call(this,ellipse,options).attr("cx",bbox.x+bbox.width/2).attr("cy",bbox.y+bbox.height/2).attr("rx",ellipceWidth+options.recWidth).attr("ry",ellipceHeight+options.recHeight).attr("transform","rotate("+angle+", "+centerX+", "+centerY+")")}}}else if("pointedAlongGorisontal"===options.typeOfLabel){var lineLengthPointedAlongGorisontal=d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getTotalLength(),start,end;switch(!0){case lineLengthPointedAlongGorisontal<25:return;case lineLengthPointedAlongGorisontal<50&&lineLengthPointedAlongGorisontal>=20:start=10,end=10;break;case lineLengthPointedAlongGorisontal<100&&lineLengthPointedAlongGorisontal>=50:start=20,end=20;break;case lineLengthPointedAlongGorisontal>=100:start=30,end=30}for(var i=start;i<lineLengthPointedAlongGorisontal-end;i+=options.repeatOffset){if(options.circle===!0)var circle=group.append("circle");if(options.ellipse===!0)var ellipse=group.append("ellipse");if(options.rectangle===!0)var rectangle=group.append("rect");options.halo===!0&&that.haloPrototype.call(this,group,options).attr("x",d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).x).attr("y",d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).y).text(textEval);var text=that.textPrototype.call(this,group,options).attr("x",d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).x).attr("y",d3.selectAll("#layer"+layer._leaflet_id)._groups[0][0].getPointAtLength(i).y).text(textEval),bbox=text.node().getBBox();if(options.rectangle===!0){var rectangleWidth,rectangleHeight;options.autorecWidthHeight===!0?(rectangleWidth=bbox.width,rectangleHeight=bbox.height):(rectangleWidth=0,rectangleHeight=0),that.rectangleProtype.call(this,rectangle,options).attr("x",bbox.x-2).attr("y",bbox.y).attr("width",rectangleWidth+options.recWidth).attr("height",rectangleHeight+options.recHeight)}if(options.circle===!0){var circleRad;circleRad=options.autorecWidthHeight===!0?bbox.width:0,that.circlePrototype.call(this,circle,options).attr("cx",bbox.x+bbox.width/2).attr("cy",bbox.y+bbox.height/2).attr("r",circleRad/2+options.recWidth)}if(options.ellipse===!0){var ellipceWidth,ellipceHeight;options.autorecWidthHeight===!0?(ellipceWidth=bbox.width,ellipceHeight=bbox.height):(ellipceWidth=0,ellipceHeight=0),that.ellipsePrototype.call(this,ellipse,options).attr("cx",bbox.x+bbox.width/2).attr("cy",bbox.y+bbox.height/2).attr("rx",ellipceWidth+options.recWidth).attr("ry",ellipceHeight+options.recHeight)}}}}else if(options.repeat!==!0){var allParts=layer._parts,length=0;if(allParts.forEach(function(a,b,c){length+=Math.sqrt(Math.pow(a[b+1].y-a[b].y,2)+Math.pow(a[b+1].x-a[b].x,2))}),length<25)return;"pointedAlongGorisontal"===options.typeOfLabel?allParts.forEach(function(a,b,c){
function d(){if(options.rectangle===!0){var a,b;options.autorecWidthHeight===!0?(a=l.width,b=l.height):(a=0,b=0),that.rectangleProtype.call(this,j,options).attr("x",l.x-2).attr("y",l.y).attr("width",a+options.recWidth).attr("height",b+options.recHeight)}if(options.circle===!0){var c;c=options.autorecWidthHeight===!0?l.width:0,that.circlePrototype.call(this,h,options).attr("cx",l.x+l.width/2).attr("cy",l.y+l.height/2).attr("r",c/2+options.recWidth)}if(options.ellipse===!0){var d,e;options.autorecWidthHeight===!0?(d=l.width,e=l.height):(d=0,e=0),that.ellipsePrototype.call(this,i,options).attr("cx",l.x+l.width/2).attr("cy",l.y+l.height/2).attr("rx",d+options.recWidth).attr("ry",e+options.recHeight)}}if(a.length>2){var e=Math.float(a.length/2),f=(a[e].x+a[e+1].x)/2,g=(a[e].y+a[e+1].y)/2;if(options.circle===!0)var h=group.append("circle");if(options.ellipse===!0)var i=group.append("ellipse");if(options.rectangle===!0)var j=group.append("rect");options.halo===!0&&that.haloPrototype.call(this,group,options).attr("x",f).attr("y",g).text(textEval);var k=that.textPrototype.call(this,group,options).attr("x",f).attr("y",g).text(textEval),l=k.node().getBBox();d()}else{var f=(a[0].x+a[1].x)/2,g=(a[0].y+a[1].y)/2;if(options.circle===!0)var h=group.append("circle");if(options.ellipse===!0)var i=group.append("ellipse");if(options.rectangle===!0)var j=group.append("rect");options.halo===!0&&that.haloPrototype.call(this,group,options).attr("x",f).attr("y",g).text(textEval);var k=that.textPrototype.call(this,group,options).attr("x",f).attr("y",g).attr("fill-opacity",options.opacity).text(textEval),l=k.node().getBBox();d()}}):"pointedAlong"===options.typeOfLabel&&allParts.forEach(function(a,b,c){function d(){if(options.rectangle===!0){var a,b;options.autorecWidthHeight===!0?(a=o.width,b=o.height):(a=0,b=0),that.rectangleProtype.call(this,m,options).attr("x",o.x-3).attr("y",o.y).attr("width",a+options.recWidth).attr("height",b+options.recHeight).attr("transform","rotate("+e+", "+g+", "+h+")")}if(options.circle===!0){var c;c=options.autorecWidthHeight===!0?o.width:0,that.circlePrototype.call(this,k,options).attr("cx",o.x+o.width/2).attr("cy",o.y+o.height/2).attr("r",c/2+options.recWidth).attr("transform","rotate("+e+", "+g+", "+h+")")}if(options.ellipse===!0){var d,f;options.autorecWidthHeight===!0?(d=o.width,f=o.height):(d=0,f=0),that.ellipsePrototype.call(this,l,options).attr("cx",o.x+o.width/2).attr("cy",o.y+o.height/2).attr("rx",d+options.recWidth).attr("ry",f+options.recHeight).attr("transform","rotate("+e+", "+g+", "+h+")")}}if(a.length>2){var e,f=Math.float(a.length/2),g=(a[f].x+a[f+1].x)/2,h=(a[f].y+a[f+1].y)/2,i=a[f].x-a[f+1].x,j=a[f].y-a[f+1].y;if(e=a[f].x<a[f+1].x&&a[f].y>a[f+1].y?270-180*Math.atan(i/j)/Math.PI:a[f].x<a[f+1].x&&a[f].y<a[f+1].y?90-180*Math.atan(i/j)/Math.PI:a[f].x>a[f+1].x&&a[f].y<a[f+1].y?270-180*Math.atan(i/j)/Math.PI:a[f].x>a[f+1].x&&a[f].y>a[f+1].y?90-180*Math.atan(i/j)/Math.PI:0,options.circle===!0)var k=group.append("circle");if(options.ellipse===!0)var l=group.append("ellipse");if(options.rectangle===!0)var m=group.append("rect");options.halo===!0&&that.haloPrototype.call(this,group,options).attr("x",g).attr("y",h).attr("transform","rotate("+e+", "+g+", "+h+")").text(textEval);var n=that.textPrototype.call(this,group,options).attr("x",g).attr("y",h).attr("transform","rotate("+e+", "+g+", "+h+")").text(textEval),o=n.node().getBBox();d()}else{var e,g=(a[0].x+a[1].x)/2,h=(a[0].y+a[1].y)/2,i=a[0].x-a[1].x,j=a[0].y-a[1].y;if(e=a[0].x<a[1].x&&a[0].y>a[1].y?270-180*Math.atan(i/j)/Math.PI:a[0].x<a[1].x&&a[0].y<a[1].y?90-180*Math.atan(i/j)/Math.PI:a[0].x>a[1].x&&a[0].y<a[1].y?270-180*Math.atan(i/j)/Math.PI:a[0].x>a[1].x&&a[0].y>a[1].y?90-180*Math.atan(i/j)/Math.PI:0,options.circle===!0)var k=group.append("circle");if(options.ellipse===!0)var l=group.append("ellipse");if(options.rectangle===!0)var m=group.append("rect");options.halo===!0&&that.haloPrototype.call(this,group,options).attr("x",g).attr("y",h).attr("transform","rotate("+e+", "+g+", "+h+")").text(textEval);var n=that.textPrototype.call(this,group,options).attr("x",g).attr("y",h).attr("transform","rotate("+e+", "+g+", "+h+")").text(textEval),o=n.node().getBBox();d()}})}})},_PolygonLabel:function(layer,nameForGroups){var options=this.options;layer._path.id="layer"+layer._leaflet_id;var group=d3.select("svg").append("g").attr("class","Labels"+nameForGroups).append("g").attr("class","polygonLabels"),that=this;d3.selectAll("#layer"+layer._leaflet_id).each(function(d,i){var textEval=function(){var string=eval(options.fieldToLabel);return void 0!==string&&"undefined"!==string||(string=""),string},bounds=this.getBBox(),labelPositions={x:bounds.x+bounds.width/2,y:bounds.y+bounds.height/2};if(0!==labelPositions.x||0!==labelPositions.y){if(options.circle===!0)var circle=group.append("circle");if(options.ellipse===!0)var ellipse=group.append("ellipse");if(options.rectangle===!0)var rectangle=group.append("rect");options.halo===!0&&that.haloPrototype.call(this,group,options).attr("x",labelPositions.x).attr("y",labelPositions.y).text(textEval);var text=that.textPrototype.call(this,group,options).attr("x",labelPositions.x).attr("y",labelPositions.y).text(textEval),bbox=text.node().getBBox();if(options.rectangle===!0){var rectangleWidth,rectangleHeight;options.autorecWidthHeight===!0?(rectangleWidth=bbox.width,rectangleHeight=bbox.height):(rectangleWidth=0,rectangleHeight=0),that.rectangleProtype.call(this,rectangle,options).attr("x",bbox.x).attr("y",bbox.y).attr("width",rectangleWidth+options.recWidth).attr("height",rectangleHeight+options.recHeight)}if(options.circle===!0){var circleRad;circleRad=options.autorecWidthHeight===!0?bbox.width:0,that.circlePrototype.call(this,circle,options).attr("cx",bbox.x+bbox.width/2).attr("cy",bbox.y+bbox.height/2).attr("r",circleRad/2+options.recWidth)}if(options.ellipse===!0){var ellipceWidth,ellipceHeight;options.autorecWidthHeight===!0?(ellipceWidth=bbox.width,ellipceHeight=bbox.height):(ellipceWidth=0,ellipceHeight=0),that.ellipsePrototype.call(this,ellipse,options).attr("cx",bbox.x+bbox.width/2).attr("cy",bbox.y+bbox.height/2).attr("rx",ellipceWidth+options.recWidth).attr("ry",ellipceHeight+options.recHeight)}}})},_PointLabel:function(layer,nameForGroups){var options=this.options,icon=!0,imageWigth,imageHeight,iconX,iconY;if(void 0!==layer._icon?layer._icon.id="marker_"+layer._leaflet_id:(layer._path.id="marker_"+layer._leaflet_id,icon=!1),null!==d3.select("svg")._groups[0][0])var group=d3.select("svg").append("g").attr("class","Labels"+nameForGroups).append("g").attr("class","pointLabels");else var polygon=L.polygon([[0,-.1],[-.1,-.02],[-.02,0]],{color:"red",opacity:0,fillColor:"#f03",fillOpacity:0}).addTo(this.labelingLayer._map),group=d3.select("svg").append("g").attr("class","Labels"+nameForGroups).append("g").attr("class","pointLabels");var that=this;d3.selectAll("#marker_"+layer._leaflet_id).each(function(){var textEval=function(){var string=eval(options.fieldToLabel);return void 0!==string&&"undefined"!==string||(string=""),string};if(icon===!0)iconX=layer._icon._leaflet_pos.x,iconY=layer._icon._leaflet_pos.y;else{var bounds=this.getBBox();if(iconX=bounds.x+bounds.width/2,iconY=bounds.y+bounds.height/2,0===iconX&&0===iconY)return}if(options.circle===!0)var circle=group.append("circle");if(options.ellipse===!0)var ellipse=group.append("ellipse");if(options.rectangle===!0)var rectangle=group.append("rect");icon===!0?(imageWigth=parseInt(this.style.width,10),imageHeight=parseInt(this.style.height,10)):imageWigth=imageHeight=layer._radius;var labelPositions={};if(options.halo===!0)var halo=that.haloPrototype.call(this,group,options).text(textEval);var text=that.textPrototype.call(this,group,options).text(textEval),bbox=text.node().getBBox();if("top"===options.markerLabelPlace?(labelPositions.x=iconX,labelPositions.y=iconY-imageHeight/2):"bottom"===options.markerLabelPlace?(labelPositions.x=iconX,labelPositions.y=iconY+imageHeight/2+bbox.height):"left"===options.markerLabelPlace?(labelPositions.x=iconX-bbox.width/2-3-imageWigth/2,labelPositions.y=iconY+bbox.height/4):"right"===options.markerLabelPlace&&(labelPositions.x=iconX+bbox.width/2+3+imageWigth/2,labelPositions.y=iconY+bbox.height/4),0!==labelPositions.x||0!==labelPositions.y){options.halo===!0&&halo.attr("x",labelPositions.x).attr("y",labelPositions.y),text.attr("x",labelPositions.x).attr("y",labelPositions.y);var newBbox=text.node().getBBox();if(options.rectangle===!0){var rectangleWidth,rectangleHeight;options.autorecWidthHeight===!0?(rectangleWidth=newBbox.width,rectangleHeight=newBbox.height):(rectangleWidth=0,rectangleHeight=0),that.rectangleProtype.call(this,rectangle,options).attr("x",newBbox.x).attr("y",newBbox.y).attr("width",rectangleWidth+options.recWidth).attr("height",rectangleHeight+options.recHeight)}if(options.circle===!0){var circleRad;circleRad=options.autorecWidthHeight===!0?newBbox.width:0,that.circlePrototype.call(this,circle,options).attr("cx",newBbox.x+newBbox.width/2).attr("cy",newBbox.y+newBbox.height/2).attr("r",circleRad/2+options.recWidth)}if(options.ellipse===!0){var ellipceWidth,ellipceHeight;options.autorecWidthHeight===!0?(ellipceWidth=newBbox.width,ellipceHeight=newBbox.height):(ellipceWidth=0,ellipceHeight=0),that.ellipsePrototype.call(this,ellipse,options).attr("cx",newBbox.x+newBbox.width/2).attr("cy",newBbox.y+newBbox.height/2).attr("rx",ellipceWidth+options.recWidth).attr("ry",ellipceHeight+options.recHeight)}}})},haloPrototype:function(a,b){var c;c=b.startLineOffset&&void 0!==b.startLineOffset?b.startLineOffset:0;var d=a.append("text").attr("class","halo").attr("dx",b.dx).attr("dy",b.dy+c).style("stroke",b.haloColor).style("opacity",b.haloOpacity).style("stroke-width",b.haloWidth).style("text-anchor",b.textAnchor).style("font-size",b.fontSize).style("font-weight",b.fontWeight).style("font-style",b.fontStyle).style("text-decoration",b.textDecoration).style("font-family",b.fontFamily);return d},textPrototype:function(a,b){var c;c=b.startLineOffset&&void 0!==b.startLineOffset?b.startLineOffset:0;var d=a.append("text").attr("class","textpath").attr("dx",b.dx).attr("dy",b.dy+c).style("fill-opacity",b.opacity).style("text-anchor",b.textAnchor).style("font-size",b.fontSize).style("font-weight",b.fontWeight).style("font-style",b.fontStyle).style("text-decoration",b.textDecoration).style("fill",b.textColor).style("font-family",b.fontFamily);return d},circlePrototype:function(a,b){return a.style("fill",b.recFill).style("fill-opacity",b.recFillOpacity).style("stroke",b.recStroke).style("stroke-width",b.recStrokeWidth).style("stroke-opacity",b.recStrokeOpacity),a},ellipsePrototype:function(a,b){return a.style("fill",b.recFill).style("fill-opacity",b.recFillOpacity).style("stroke",b.recStroke).style("stroke-width",b.recStrokeWidth).style("stroke-opacity",b.recStrokeOpacity),a},rectangleProtype:function(a,b){return a.style("fill",b.recFill).style("fill-opacity",b.recFillOpacity).style("stroke",b.recStroke).style("stroke-width",b.recStrokeWidth).style("stroke-opacity",b.recStrokeOpacity),a},_removeLabels:function(a){var b=$(".Labels"+a);b&&b.remove()}}),MapExpress.Layers.TileServiceLayer=L.TileLayer.extend({initialize:function(a,b){L.TileLayer.prototype.initialize.call(this,null,b),L.setOptions(this,b),this._dataPovider=a},onAdd:function(a){L.TileLayer.prototype.onAdd.call(this,a)},onRemove:function(a){L.TileLayer.prototype.onRemove.call(this,a)},createTile:function(a,b){var c=document.createElement("img");return L.DomEvent.on(c,"load",L.bind(this._tileOnLoad,this,b,c)),L.DomEvent.on(c,"error",L.bind(this._tileOnError,this,b,c)),this.options.crossOrigin&&(c.crossOrigin=""),c.alt="",c.src=this._dataPovider.getDataUrlByTile(a),c}}),MapExpress.Layers.tileServiceLayer=function(a,b){return new MapExpress.Layers.TileServiceLayer(a,b)},MapExpress.Mapping.LayerModel=L.Class.extend({initialize:function(a,b){this.id=a,this._layers=[],L.setOptions(this,b)},addLayer:function(a){this._layers.push(a)},removeLayerById:function(a){var b=this.getLayerById(a);if(b){var c=this._findIndex(this._layers,function(b){return b.id===a});this._layers.splice(c,1)}},getLayerById:function(a){function b(a,b){return a.filter(function(a){return a.id===b})}var c=this.getAllLayers();if(c){var d=b(c,a);return d.length>0?d[0]:null}},getAllLayers:function(){return this._layers},hasChildren:function(){return this._layers.length>0},_arraymove:function(a,b,c){var d=a[b];a.splice(b,1),a.splice(c,0,d)},_findIndex:function(a,b){var c,d;for(c in a)if(d=a[c],b(d))return parseInt(c);return-1}}),MapExpress.Mapping.MapInitializerHelper={initializeFromURL:function(a,b,c,d){this._initialize(MapExpress.Mapping.MapWorkspaseLoader.getMapWorkspaceFromURLAsync(b),a,c,d)},initializeFromFile:function(a,b,c,d){this._initialize(MapExpress.Mapping.MapWorkspaseLoader.getMapWorkspaceFromFileAsync(b),a,c,d)},_initialize:function(a,b,c,d){var e=L.map(b,{zoomControl:!1,editable:!0});window.MapManager=new MapExpress.Mapping.MapManager(e),a.then(function(a){window.MapManager.renderMap(a),c&&"function"==typeof c&&c(e)},function(a){d&&"function"==typeof d?d(a):new MapExpress.Controls.MapControl(window.MapManager._map,{removalDelay:4e3}).setContent("Не удалось загрузить рабочий набор!").show()})}},MapExpress.Mapping.MapManager=L.Class.extend({initialize:function(a,b,c){this._map=a,L.setOptions(this,c),this._mapModelBuilder=b?b:new MapExpress.Mapping.MapModelBuilder(a,c),this.selections=[]},renderMap:function(a){this._mapModel=this._mapModelBuilder.createMapModel(a),L.setOptions(this._map,this._mapModel.options),this._map.setView(this._mapModel.options.center,this._mapModel.options.zoom);var b=this._mapModel.getBaseLayers();this._mapModel.sortLayersByVisibleIndex(b),this._mapModel._reorderLayersVisibleIndex(b);for(var c=b.length-1;c>=0;c--){var d=b[c];if(d.mapLayer.options.visible){d.mapLayer.addTo(this._map);break}}var e=this._mapModel.getOverlayLayers();this._mapModel.sortLayersByVisibleIndex(e),this._mapModel._reorderLayersVisibleIndex(e),this._mapModel.sortLayersByVisibleIndex(e);for(var f=e.length-1;f>=0;f--){var g=e[f];g.mapLayer.options.visible&&g.mapLayer&&g.mapLayer.addTo(this._map)}return this._map},setActiveBaseMap:function(a){var b=this._mapModel.getLayerById(a);if(b&&b.mapLayer){for(var c=this._mapModel.getBaseLayers(),d=c.length-1;d>=0;d--){var e=c[d];e.mapLayer&&(e.mapLayer.options.visible=!1,this._map.removeLayer(e.mapLayer))}b.mapLayer.options.visible=!0,b.mapLayer.addTo(this._map),b.mapLayer.bringToBack()}},getActiveBaseMap:function(){for(var a,b=window.MapManager.getMapModel().getBaseLayers(),c=0;c<b.length;c++)b[c].mapLayer&&b[c].mapLayer.options.visible===!0&&(a=b[c]);return a},removeLayerById:function(a){var b=this._mapModel.getLayerById(a);b&&b.mapLayer&&(b.mapLayer.off("add",this._reorderOverlays,this),this._map.removeLayer(b.mapLayer),this._mapModel.removeLayerById(a))},setLayerVisible:function(a,b){var c=this._mapModel.getLayerById(a);if(c&&c.mapLayer&&(b?(c.mapLayer.on("add",this._reorderOverlays,this),this._map.addLayer(c.mapLayer)):(c.mapLayer.off("add",this._reorderOverlays,this),this._map.removeLayer(c.mapLayer)),c.mapLayer.options.visible=b),c.hasChildren())for(var d=c._layers.length-1;d>=0;d--){var e=c._layers[d];this.setLayerVisible(e.id,b)}},toogleLayerVisible:function(a){var b=this._mapModel.getLayerById(a);b&&("base"===b.options.type?this.setActiveBaseMap(a):this.setLayerVisible(a,!b.mapLayer.options.visible))},moveOverlay:function(a,b){var c=this._mapModel.getLayerById(a);c&&c.mapLayer&&(this._mapModel.setLayerVisibleIndex(a,b),this._reorderOverlays())},toogleLabelLayer:function(a){if(this.layerLabelingEnabledInZoom(a)){var b=this._mapModel.getLayerById(a);b.mapLayer&&(b.mapLayer.options.labelEnabled=!b.mapLayer.options.labelEnabled,b.mapLayer._labelLayer())}},layerEnabled:function(a){var b=this._mapModel.getLayerById(a);return!!(b&&b.mapLayer&&b.mapLayer.options&&b.mapLayer.options.visible&&this.layerVisibleEnableInZoom(a))},layerVisibleEnableInZoom:function(a){var b=this._mapModel.getLayerById(a);if(b&&b.mapLayer&&b.mapLayer.options){var c=this._map.getZoom();if(c<=b.mapLayer.options.maxZoom&&c>=b.mapLayer.options.minZoom)return!0}return!1},layerLabelingEnabledInZoom:function(a){var b=this._mapModel.getLayerById(a);if(b&&b.mapLayer&&b.mapLayer.options){var c=b.mapLayer instanceof MapExpress.Layers.GeoJSONServiceLayer;if(c){var d=b.mapLayer._getLabelLayerOptionsByZoom();return d&&d.length>0}}return!1},_reorderOverlays:function(){var a=this._mapModel.getOverlayLayers();this._mapModel.sortLayersByVisibleIndex(a),this._mapModel._reorderLayersVisibleIndex(a),this._mapModel.sortLayersByVisibleIndex(a);for(var b=a.length-1;b>=0;b--){var c=a[b];c.mapLayer.bringToFront()}},getMapModel:function(){return this._mapModel},getSelection:function(a){var b=this._findIndex(this.selections,function(b){return b._layerId===a});if(b>-1)return this.selections[b];var c=new MapExpress.Mapping.Selection(a);return this.selections.push(c),c},addPulseMarker:function(a,b,c){return this.removePulseMarker(),c||(c={iconSize:[12,12],color:"blue"}),this.pulseMarker=new MapExpress.Styles.PulseMarker(a,c),this._map.addLayer(this.pulseMarker),b>0&&window.setTimeout(this.removePulseMarker.bind(this),b),this.pulseMarker},removePulseMarker:function(){this.pulseMarker&&(this._map.removeLayer(this.pulseMarker),delete this.pulseMarker)},_findIndex:function(a,b){var c,d;for(c in a)if(d=a[c],b(d))return parseInt(c);return-1}}),MapExpress.Mapping.MapModel=MapExpress.Mapping.LayerModel.extend({initialize:function(a,b){this.id=a,this._layers=[],this._favoriteLayers=[],L.setOptions(this,b)},getAllLayers:function(){var a=[];return this._fillAllLayers(this,a),a},getBaseLayers:function(){return this.getLayersByType("base")},getOverlayLayers:function(){return this.getLayersByType("overlay")},getLayersByType:function(a){return this.getLayersByOptionValue("type",a)},getVisibleLayers:function(){return this.getMapLayersByOptionValue("visible",!0)},getQueryableLayers:function(){return this.getMapLayersByOptionValue("queryable",!0)},getSelectableLayers:function(){return this.getMapLayersByOptionValue("selectable",!0)},getLayersByOptionValue:function(a,b){var c=this.getAllLayers(),d=c.filter(function(c){if(c.options.hasOwnProperty(a))return c.options[a]===b});return d},getFavoriteLayers:function(){return this._favoriteLayers},getMapLayersByOptionValue:function(a,b){var c=this.getAllLayers(),d=c.filter(function(b){if(b.mapLayer&&b.mapLayer.options&&b.mapLayer.options.hasOwnProperty(a))return"undefined"!==b.mapLayer.options[a]&&b.mapLayer.options[a]===!0});return d},_fillAllLayers:function(a,b){for(var c=a._layers.length-1;c>=0;c--){var d=a._layers[c];b.push(d),d.hasChildren()&&this._fillAllLayers(d,b)}},setLayerVisibleIndex:function(a,b){var c=this.getLayerById(a);if(c){c.mapLayer.options.visibleIndex=b;var d=this.getOverlayLayers();this.sortLayersByVisibleIndex(d);var e=this._findIndex(d,function(b){return b.id===a});this._arraymove(d,e,b),this.sortLayersByVisibleIndex(d),this._reorderLayersVisibleIndex(d)}},sortLayersByVisibleIndex:function(a){function b(a,b){try{return a.mapLayer&&b.mapLayer?a.mapLayer.options.visibleIndex-b.mapLayer.options.visibleIndex:-1}catch(c){console.log(a),console.log(b)}}a.sort(b)},_reorderLayersVisibleIndex:function(a){for(var b=a.length-1;b>=0;b--){var c=a[b];c.mapLayer&&(c.mapLayer.options.visibleIndex=b)}return a}}),MapExpress.Mapping.MapModelBuilder=L.Class.extend({initialize:function(a,b){this._map=a,L.setOptions(this,b)},createMapModel:function(a){var b=new MapExpress.Mapping.MapModel(a.id,a.options);if(this._jsonMapModel=a,a.layers&&a.layers.length>0)for(var c=0;c<a.layers.length;c++){var d=a.layers[c];this._processLayerModel(d,b)}return b},_processLayerModel:function(a,b){var c=new MapExpress.Mapping.LayerModel(a.id,a.options);if(c.mapLayer=this._createLayerClass(a),b.addLayer(c),a.layers&&a.layers.length>0)for(var d=0;d<a.layers.length;d++){var e=a.layers[d];this._processLayerModel(e,c)}},_createLayerClass:function(a){var b;if(a.dataProviderClass&&a.layerClass){var c=this._createProvider(a.dataProviderClass.constructor,a.dataProviderClass.args,a.dataProviderClass.options);if(c){switch(a.layerClass.args||(a.layerClass.args=[]),a.layerClass.args.splice(0,0,c),a.layerClass.constructor){case"MapExpress.Layers.GeoJSONServiceLayer":b=this._applyToConstructor(MapExpress.Layers.GeoJSONServiceLayer,a.layerClass.args,a.layerClass.options);break;case"MapExpress.Layers.ImageOverlayLayer":b=this._applyToConstructor(MapExpress.Layers.ImageOverlayLayer,a.layerClass.args,a.layerClass.options);break;case"MapExpress.Layers.TileServiceLayer":b=this._applyToConstructor(MapExpress.Layers.TileServiceLayer,a.layerClass.args,a.layerClass.options)}b&&(b.id=a.id,b.styles=a.layerClass.styles,b.labels=a.layerClass.labels)}}return b},_createProvider:function(a,b,c){var d;switch(a){case"MapExpress.Service.TileProvider":d=this._applyToConstructor(MapExpress.Service.TileProvider,b,c);break;case"MapExpress.Service.GeoJSONProvider":d=this._applyToConstructor(MapExpress.Service.GeoJSONProvider,b,c);break;case"MapExpress.Service.MapServiceAgsProvider":d=this._applyToConstructor(MapExpress.Service.MapServiceAgsProvider,b,c);break;case"MapExpress.Service.FeatureServiceAgsProvider":d=this._applyToConstructor(MapExpress.Service.FeatureServiceAgsProvider,b,c);break;case"MapExpress.Service.WmsProvider":d=this._applyToConstructor(MapExpress.Service.WmsProvider,b,c);break;case"MapExpress.Service.SingleImageProvider":d=this._applyToConstructor(MapExpress.Service.SingleImageProvider,b,c)}return d},_applyToConstructor:function(a,b,c){var d=[null].concat(b,c),e=a.bind.apply(a,d);return new e}}),MapExpress.Mapping.Selection=L.Class.extend({options:{selectionStyle:{color:"Red"}},initialize:function(a,b){this._layerId=a,this._selection=[],L.setOptions(this,b)},getSelections:function(){return this._selection},addSelection:function(a){a&&(a.setStyle(this.options.selectionStyle),this.isLayerSelected(a)||this._selection.push(a))},invertSelection:function(a){a&&(this.isLayerSelected(a)?this.removeSelection(a):this.addSelection(a))},removeSelection:function(a){if(a){var b=this._getLayerIndex(a);b>-1&&(this._resetLayerStyle(a),this._selection.splice(b,1))}},replaceSelection:function(a){},isLayerSelected:function(a){return this._getLayerIndex(a)>-1},_getLayerIndex:function(a){var b=this._findIndex(this._selection,function(b){return b._leaflet_id===a._leaflet_id});return b},_resetLayerStyle:function(a){if(a&&a.feature&&a.feature.properties&&a.feature.properties.style){var b=JSON.parse(a.feature.properties.style);b&&a.setStyle(b)}else a.setStyle(a.defaultOptions)},_findIndex:function(a,b){var c,d;for(c in a)if(d=a[c],b(d))return parseInt(c);return-1}}),MapExpress.Mapping.MapUtils={generateWldFileHref:function(a,b){var c,d;if(a[0].x?(c=this.getPixelSizeXY(a,b),d=this.getOPointXY(a)):a[0].lng&&(c=this.getPixelSizeLatLng(a,b),d=this.getOPointLatLng(a)),c&&d){var e=[c.x,0,0,c.y,d.x,d.y].toString();return"data:text/plain;charset=utf-8,"+encodeURIComponent(e.replace(new RegExp(",","g"),"\r\n"))}},getPixelSizeLatLng:function(a,b){var c={};return c.x=(a[1].lng-a[0].lng)/b.width,c.y=-(a[1].lat-a[0].lat)/b.height,c},getOPointLatLng:function(a){var b={};return b.x=a[0].lng,b.y=a[1].lat,b},getPixelSizeXY:function(a,b){var c={};return c.x=(a[1].x-a[0].x)/b.width,c.y=-(a[1].y-a[0].y)/b.height,c},getOPointXY:function(a){var b={};return b.x=a[0].x,b.y=a[1].y,b},generateMapInfoWldFileHref:function(a,b,c){var d,e,f,g,h="!Table  !version 300  !charset Neutral    Definition Table___",i=h.replace(new RegExp("  ","g"),"\r\n"),j=[];if(void 0===c&&(c="Export.jpg"),a[0].x?(j=[{x:a[0].x,y:a[1].y},{x:a[1].x,y:a[0].y},a[0],a[1]],d=';;File;"'+c+'",.,;;Type;"RASTER",.,;;('+j[0].x+",;"+j[0].y+');(0,0);Label;"Point;1",,.,;;('+j[1].x+",;"+j[1].y+");("+b.width+",;"+b.height+');Label;"Point;2",,.,;;('+j[2].x+",;"+j[2].y+");(0,;"+b.height+');Label;"Point;3",,.,;;('+j[3].x+",;"+j[3].y+");("+b.width+',;0);Label;"Point;4"___',e=d.replace(new RegExp(",.,","g"),"\r\n").replace(new RegExp(";","g")," "),f='CoordSys Earth Projection 10, 157, "m", 0___',g='Units "m"___'):a[0].lng&&(j=[{lat:a[1].lat,lng:a[0].lng},{lat:a[0].lat,lng:a[1].lng},a[0],a[1]],d=';;File;"'+c+'",.,;;Type;"RASTER",.,;;('+j[0].lng+",;"+j[0].lat+');(0,0);Label;"Point;1",,.,;;('+j[1].lng+",;"+j[1].lat+");("+b.width+",;"+b.height+');Label;"Point;2",,.,;;('+j[2].lng+",;"+j[2].lat+");(0,;"+b.height+');Label;"Point;3",,.,;;('+j[3].lng+",;"+j[3].lat+");("+b.width+',;0);Label;"Point;4"___',e=d.replace(new RegExp(",.,","g"),"\r\n").replace(new RegExp(";","g")," "),f=" CoordSys Earth Projection 10, 157___",g=' Units "degree"___'),void 0!==e){var k=i+e+f+g;return"data:text/plain;charset=utf-8,"+encodeURIComponent(k.replace(new RegExp("___","g"),"\r\n"))}}},MapExpress.Mapping.MapWorkspaseLoader={getMapWorkspaceFromURLAsync:function(a){return MapExpress.Utils.Promise.GetJSON(a)},getMapWorkspaceFromFileAsync:function(a){var b=$.Deferred();if(window.File&&window.FileReader&&window.FileList&&window.Blob){if("undefined"===a)return void b.reject("file === undefined");var c=new FileReader;c.readAsText(a),c.onload=function(a){var c=a.target.result,d=JSON.parse(c);b.resolve(d)},c.onerror=function(a){b.reject(a.target.error)}}return b.promise()}},MapExpress.Mapping.GeoUtil={findIntersectedLayersByBBox:function(a,b,c){this.map=c;var d=[],e=this;return a.eachLayer(function(a){var c=e._findIntersectedEachLayerByBBox(a,b);"within"!==c&&"overlaps"!==c||d.push(a)}),d},_findIntersectedEachLayerByBBox:function(a,b){var c,d,e;e=this._reFormBboxCords(b),d=a.feature.geometry,"Point"===d.type?c=this._isSinglePointInsideBBox(d.coordinates,e):"LineString"===d.type?c=this._isMultiPointInsideBBox(d.coordinates,e):"Polygon"===d.type?c=this._isMultiPointInsideBBox(d.coordinates[0],e):"MultiPoint"===d.type?c=this._isMultiPointInsideBBox(d.coordinates,e):"MultiLineString"===d.type?c=this._isMultiPointInsideBBox(d.coordinates,e):"MultiPolygon"===d.type&&(c=this._isMultiPointInsideBBox(d.coordinates[0],e));var f=this._intersectionByBBoxParseResult(c);if("no intersects"===f&&"Point"!==d.type&&"MultiPoint"!==d.type){var g={type:"Polygon",coordinates:[e]},h=this._crossCheck(g,a);h.length>0&&(f="overlaps")}return("no intersects"===f&&"Polygon"===d.type||"no intersects"===f&&"MultiPoint"===d.type)&&(f=this._intersectionByBBoxParseResult(this._isMultiPointInsideBBox(e,d.coordinates[0]))),f},_reFormBboxCords:function(a){var b=[];return a._southWest&&(b[0]=[a._southWest.lng,a._northEast.lat],b[1]=[a._northEast.lng,a._northEast.lat],b[2]=[a._northEast.lng,a._southWest.lat],b[3]=[a._southWest.lng,a._southWest.lat]),b},_isSinglePointInsideBBox:function(a,b){return this._pointIntersectionMath(a,b)},_isMultiPointInsideBBox:function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(this._pointIntersectionMath(a[d],b));return c},_pointIntersectionMath:function(a,b){for(var c=a[0],d=a[1],e=!1,f=0,g=b.length-1;f<b.length;g=f++){var h=b[f][0],i=b[f][1],j=b[g][0],k=b[g][1],l=i>d!=k>d&&c<(j-h)*(d-i)/(k-i)+h;l&&(e=!e)}return e},_intersectionByBBoxParseResult:function(a){return a===!0&&"boolean"==typeof a?"within":a===!1&&"boolean"==typeof a?"no intersects":a.constructor===Array?(a.sort(),a[0]===a[a.length-1]&&a[0]===!0?"within":a[0]===a[a.length-1]&&a[0]===!1?"no intersects":"overlaps"):void 0},_crossCheck:function(a,b){var c=b.toGeoJSON(),d=this._lineify(a),e=this._lineify(c),f=[];if(d&&e)for(var g in e.geometries)for(var h in d.geometries){var i=this._lineStringsIntersect(e.geometries[g],d.geometries[h]);if(i)for(var j in i)f.push(i[j])}return f},_lineify:function(a){var b,c={type:"GeometryCollection",geometries:[]};switch(a.type){case"GeometryCollection":for(var d in a.geometries)if(b=this._lineify(a.geometries[d]))for(var e in b.geometries)c.geometries.push(b.geometries[e]);else c=!1;break;case"Feature":if(b=this._lineify(a.geometry))for(var f in b.geometries)c.geometries.push(b.geometries[f]);else c=!1;break;case"FeatureCollection":for(var g in a.features)if(b=this._lineify(a.features[g].geometry))for(var h in b.geometries)c.geometries.push(b.geometries[h]);else c=!1;break;case"LineString":c.geometries.push(a);break;case"MultiLineString":case"Polygon":for(var i in a.coordinates)c.geometries.push({type:"LineString",coordinates:a.coordinates[i]});break;case"MultiPolygon":for(var j in a.coordinates)for(var k in a.coordinates[j])c.geometries.push({type:"LineString",coordinates:a.coordinates[j][k]});break;default:c=!1}return c},_lineStringsIntersect:function(a,b){for(var c=[],d=0;d<=a.coordinates.length-2;++d)for(var e=0;e<=b.coordinates.length-2;++e){var f=L.latLng(a.coordinates[d][1],a.coordinates[d][0]),g=L.latLng(a.coordinates[d+1][1],a.coordinates[d+1][0]),h=L.latLng(b.coordinates[e][1],b.coordinates[e][0]),i=L.latLng(b.coordinates[e+1][1],b.coordinates[e+1][0]),j=L.Projection.SphericalMercator.project(f),k=L.Projection.SphericalMercator.project(g),l=L.Projection.SphericalMercator.project(h),m=L.Projection.SphericalMercator.project(i),n=(m.x-l.x)*(j.y-l.y)-(m.y-l.y)*(j.x-l.x),o=(k.x-j.x)*(j.y-l.y)-(k.y-j.y)*(j.x-l.x),p=(m.y-l.y)*(k.x-j.x)-(m.x-l.x)*(k.y-j.y);if(0!==p){var q=n/p,r=o/p;if(0<=q&&q<=1&&0<=r&&r<=1){var s=j.x+q*(k.x-j.x),t=j.y+q*(k.y-j.y),u={x:s,y:t},v=L.Projection.SphericalMercator.unproject(u);c.push({intersection:new L.LatLng(v.lat,v.lng)})}}}return 0===c.length&&(c=!1),c},findIntersectedLayerByCircle:function(a,b,c,d){this.map=d;var e=[],f=this;return a.eachLayer(function(a){var d=f.findIntersectedEachLayerByCircle(b,c,a);"within"!==d&&"overlaps"!==d||e.push(a)}),e},_findIntersectedEachLayerByCircle:function(a,b,c){var d,e;e=c.feature.geometry;var f;if("Point"===e.type?d=this._isSinglePointInsideCircle(e.coordinates,a,b):"LineString"===e.type?d=this._isMultiPointInsideCircle(e.coordinates,a,b):"Polygon"===e.type?d=this._isMultiPointInsideCircle(e.coordinates[0],a,b):"MultiPoint"===e.type?d=this._isMultiPointInsideCircle(e.coordinates,a,b):"MultiLineString"===e.type?d=this._isMultiPointInsideCircle(e.coordinates,a,b):"MultiPolygon"===e.type&&(d=this._isMultiPointInsideCircle(e.coordinates[0],a,b)),f=this.parseResult(d),"no intersects"===f&&"Point"!==e.type){var g=this._circleCrossCheck(a,b,c);f=this._intersectionByCircleParseResult(g)}return f},_isSinglePointInsideCircle:function(a,b,c){var d=new L.LatLng(b[0],b[1]),e=d.distanceTo(new L.LatLng(a[1],a[0]));return e<c},_isMultiPointInsideCircle:function(a,b,c){for(var d=[],e=0;e<a.length;e++)d.push(this._isSinglePointInsideCircle(a[e],b,c));return d},_circleCrossCheck:function(a,b,c){var d=c.toGeoJSON(),e=this._lineify(d),f=[];if(a&&b&&e)for(var g=0;g<=e.geometries[0].coordinates.length-2;g++){var h=L.latLng(e.geometries[0].coordinates[g][1],e.geometries[0].coordinates[g][0]),i=L.latLng(e.geometries[0].coordinates[g+1][1],e.geometries[0].coordinates[g+1][0]),j=L.latLng(a[0],a[1]);f.push(this._getIntersectionsMathABCR(h,i,j,b).intersects)}return f},_getIntersectionsMathABCR:function(a,b,c,d){var e=this.map.getMaxZoom();e===1/0&&(e=this.map.getZoom());var f=this.map.project(c,e),g=this.map.project(a,e),h=this.map.project(b,e),i=L.LineUtil.closestPointOnSegment(f,g,h),j=this.map.unproject(f,e).distanceTo(this.map.unproject(i,e));if(j<d){var k=g.distanceTo(h,e),l=f.distanceTo(i,e),m=[(h.x-g.x)/k,(h.y-g.y)/k],n=m[0]*(f.x-g.x)+m[1]*(f.y-g.y),o=Math.sqrt(Math.pow(l/j*d,2)-Math.pow(l,2)),p={},q={};return p.x=(n-o)*m[0]+g.x,p.y=(n-o)*m[1]+g.y,q.x=(n+o)*m[0]+g.x,q.y=(n+o)*m[1]+g.y,{intersects:!0,nearestPoint:this.map.unproject(i,e),intersection1:this.map.unproject(new L.Point(p.x,p.y),e),intersection2:this.map.unproject(new L.Point(q.x,q.y),e)}}return j===d?{intersects:!0,nearestPoint:this.map.unproject(i,e),intersection1:this.map.unproject(i,e)}:{intersects:!1}},_intersectionByCircleParseResult:function(a){return a===!0&&"boolean"==typeof a?"within":a===!1&&"boolean"==typeof a?"no intersects":a.constructor===Array?(a.sort(),a[0]===a[a.length-1]&&a[0]===!0?"overlaps":a[0]===a[a.length-1]&&a[0]===!1?"no intersects":"overlaps"):void 0;
}},MapExpress.Service.BaseDataProvider=L.Class.extend({statics:{},options:{tileSize:256,subdomains:"abc",useQuadkey:!1,maxZoom:23,uppercase:!1,crs:L.CRS.EPSG3857,proj4:!1,crsCode:!1,identifyFormat:"json",identifyLayersId:""},initialize:function(a){"string"==typeof this.options.subdomains&&(this.options.subdomains=this.options.subdomains.split("")),L.setOptions(this,a),this.options.proj4!==!1&&this.options.crsCode!==!1&&"string"==typeof this.options.proj4&&"string"==typeof this.options.crsCode&&this.options.proj4.length>0&&this.options.crsCode.length>0&&(this.options.crs=new L.Proj.CRS(this.options.crsCode,this.options.proj4))},setOptions:function(a){L.setOptions(this,a)},getDataAsync:function(){},getDataUrl:function(){},getDataInBoundsAsync:function(a,b){},getDataUrlByBounds:function(a,b){if(this._dataUrl&&a){var c=a.getNorthWest(),d=a.getSouthEast(),e=L.Util.template(this._dataUrl,{xMin:c.lng,yMin:d.lat,xMax:d.lng,yMax:c.lat});return e}},getDataByTileAsync:function(a){},getDataUrlByTile:function(a){if(this._dataUrl)return this.options.useQuadkey?L.Util.template(this._dataUrl,L.extend({r:this.options.tileCoord&&L.Browser.retina&&this.options.maxZoom>0?"@2x":"",s:this._getSubdomain(a),q:this._tileCoordsToQuadkey(a)},this.options)):L.Util.template(this._dataUrl,L.extend({r:this.options.tileCoord&&L.Browser.retina&&this.options.maxZoom>0?"@2x":"",s:this._getSubdomain(a),x:a.x,y:a.y,z:a.z},this.options))},getFeatureInfoAsync:function(a,b,c,d,e){var f=this.getFeatureInfoUrl(a,b,c,d,e);if(f)return"json"===this.options.identifyFormat||"pjson"===this.options.identifyFormat?MapExpress.Utils.Promise.GetJSON(f):MapExpress.Utils.Promise.Ajax(f)},getFeatureInfoUrl:function(a,b,c,d,e){},_tileCoordToBounds:function(a){var b=this.options.tileSize,c=L.CRS.EPSG3857,d=new L.Point(a.x*b,a.y*b),e=new L.Point(d.x+b,d.y+b),f=c.pointToLatLng(d,a.z),g=c.pointToLatLng(e,a.z),h=c.wrapLatLng(f),i=c.wrapLatLng(g);return new L.LatLngBounds(h,i)},_getTileCoordRangeByMapBounds:function(a,b){var c=[];if(void 0===a)return c;for(var d=a.getNorthWest(),e=a.getSouthEast(),f=this._getTileCoordByLatLng(d,b),g=this._getTileCoordByLatLng(e,b),h=f.y;h<=g.y;h++)for(var i=f.x;i<=g.x;i++){var j=new L.Point(i,h);j.z=b,c.push(j)}return c},_getAddedTileCoordRangeByMapBounds:function(a,b,c,d){return this._getAddedAndRemovedTileCoordRangeByMapBounds(a,b,c,d).Added},_getRemovedTileCoordRangeByMapBounds:function(a,b,c,d){return this._getAddedAndRemovedTileCoordRangeByMapBounds(a,b,c,d).Removed},_getAddedAndRemovedTileCoordRangeByMapBounds:function(a,b,c,d){var e={},f=function(a,b){for(var c=0;c<a.length;c++)if(a[c].x===b.x&&a[c].y===b.y&&a[c].z===b.z)return!0;return!1},g=this._getTileCoordRangeByMapBounds(c,d),h=this._getTileCoordRangeByMapBounds(a,b);if(b!==d)return e.Added=g,e.Removed=h,e;var i=g.filter(function(a){return!f(h,a)}),j=h.filter(function(a){return!f(g,a)});return e.Added=i,e.Removed=j,e},_getTileCoordByLatLng:function(a,b){var c=(this.options.tileSize,L.CRS.EPSG3857),d=c.latLngToPoint(a,b);return this._pixelPointToTileCoord(d,b)},_pixelPointToTileCoord:function(a,b){var c=this.options.tileSize,d=Math.ceil(a.x/c)-1,e=Math.ceil(a.y/c)-1,f=new L.Point(d,e);return f.z=b,f},_tileCoordsToQuadkey:function(a){for(var b="",c=a.z;c>0;c--){var d=0,e=1<<c-1;0!==(a.x&e)&&d++,0!==(a.y&e)&&(d++,d++),b+=d}return b},_tileCoordsToKey:function(a){return a.x+":"+a.y+":"+a.z},_getSubdomain:function(a){var b=Math.abs(a.x+a.y)%this.options.subdomains.length;return this.options.subdomains[b]},_boundsEquals:function(a,b,c){var d=b.getNorthEast(),e=a.getNorthEast(),f=a.getSouthWest(),g=b.getSouthWest(),h=Math.max(Math.abs(e.lat-d.lat),Math.abs(e.lng-d.lng)),i=Math.max(Math.abs(f.lat-g.lat),Math.abs(f.lng-g.lng)),j=h<=(void 0===c?0:c),k=i<=(void 0===c?0:c);return j&&k},identifyTemplate:function(){if(this.options.templateId&&this.options.templateUrl&&"string"==typeof this.options.templateId&&"string"==typeof this.options.templateUrl){var a=this;return MapExpress.Utils.Promise.Ajax(a.options.templateUrl,{id:a.options.templateId})}return null}}),MapExpress.Service.baseDataProvider=function(a){return new MapExpress.Service.BaseDataProvider(a)},MapExpress.Service.EsriBaseProvider=MapExpress.Service.BaseDataProvider.extend({options:{tileSize:256,crs:L.CRS.EPSG3857,identifyUrl:"",identifyFormat:"json",identifyTolerance:5,layersId:""},initialize:function(a,b){MapExpress.Service.BaseDataProvider.prototype.initialize.call(this,b),this._dataUrl=a,L.setOptions(this,b),this.esriConvertor=MapExpress.Utils.GeoFormatConvertor.esri},getDataByTileAsync:function(a){var b=this._tileCoordToBounds(a),c=new L.Point(this.options.tileSize,this.options.tileSize);return this.getDataInBoundsAsync(b,c)},getDataUrlByTile:function(a){var b=this._tileCoordToBounds(a),c=new L.Point(this.options.tileSize,this.options.tileSize);return this.getDataUrlByBounds(b,c)},getFeatureInfoAsync:function(a,b,c,d,e){var f=this.getFeatureInfoUrl(a,b,c,d,e),g=this;if(f)return"json"===this.options.identifyFormat||"pjson"===this.options.identifyFormat?MapExpress.Utils.Promise.GetJSON(f).then(function(a){return g.esriConvertor.toGeoJSON(a)}):MapExpress.Utils.Promise.Ajax(f)},getFeatureInfoUrl:function(a,b,c,d,e){var f=null;this.options.identifyLayersId&&(f="visible:"+this.options.identifyLayersId),f||this.options.layersId&&(f="visible:"+this.options.layersId),f||(f="top");var g={geometryType:"esriGeometryPoint",sr:"4326",layers:f,tolerance:this.options.identifyTolerance,imageDisplay:[d.x,d.y,"96"].join(","),returnGeometry:!1,f:this.options.identifyFormat,geometry:[a.lng,a.lat].join(","),mapExtent:[c._northEast.lng,c._northEast.lat,c._southWest.lng,c._southWest.lat].join(",")},h=this.options.uppercase||!1,i=this.options.identifyUrl?this.options.identifyUrl:this._dataUrl;return i+"/identify"+L.Util.getParamString(g,i,h)}}),MapExpress.Service.esriBaseProvider=function(a,b){return new MapExpress.Service.EsriBaseProvider(a,b)},MapExpress.Service.FeatureServiceAgsProvider=MapExpress.Service.EsriBaseProvider.extend({defaultFeatureServiceParams:{where:"",text:"",objectIds:"",time:"",geometryType:"esriGeometryEnvelope",inSR:"",spatialRel:"esriSpatialRelIntersects",relationParam:"",outFields:"*",returnGeometry:!0,maxAllowableOffset:"",geometryPrecision:"",returnIdsOnly:!1,orderByFields:"",groupByFieldsForStatistics:"",outStatistics:"",returnZ:!1,returnM:!1,gdbVersion:"",returnDistinctValues:!1,f:"json"},options:{layerId:""},initialize:function(a,b){MapExpress.Service.EsriBaseProvider.prototype.initialize.call(this,b),this._dataUrl=a,this.esriConverter=MapExpress.Utils.GeoFormatConvertor.esri;var c=L.extend({},this.defaultFeatureServiceParams);for(var d in b)d in this.options||(c[d]=b[d]);L.setOptions(this,b),this.defaultFeatureServiceParams=c},getDataInBoundsAsync:function(a,b){var c=this,d=this.getDataUrlByBounds(a,b);return MapExpress.Utils.Promise.GetJSON(d).then(function(a){if(a)return c.esriConverter.toGeoJSON(a)})},getDataUrlByBounds:function(a,b){var c=this.options.crs,d=c.project(a.getNorthWest()),e=c.project(a.getSouthEast()),f={};f.inSR=c.code,f.outSR="4326",f.geometry=L.Util.template("{xmin: {0}, ymin: {1}, xmax: {2}, ymax: {3}}",{0:d.x,1:e.y,2:e.x,3:d.y}),L.extend(this.defaultFeatureServiceParams,f);var g=this.options.uppercase||!1,h=L.Util.getParamString(this.defaultFeatureServiceParams,this._dataUrl,g);return this._dataUrl+"/"+this.options.layerId+"/query"+h}}),MapExpress.Service.featureServiceAgsProvider=function(a,b){return new MapExpress.Service.FeatureServiceAgsProvider(a,b)},MapExpress.Service.GeoJSONProvider=MapExpress.Service.BaseDataProvider.extend({options:{identifyFormat:"json"},initialize:function(a,b){MapExpress.Service.BaseDataProvider.prototype.initialize.call(this,b),L.setOptions(this,b),this._dataUrl=a},getDataAsync:function(){return MapExpress.Utils.Promise.GetJSON(this._dataUrl)},getDataInBoundsAsync:function(a,b){var c=this.getDataUrlByBounds(a,b);return MapExpress.Utils.Promise.GetJSON(c)},getDataByTileAsync:function(a){var b=this.getDataUrlByTile(a);return MapExpress.Utils.Promise.GetJSON(b)},getDataUrlByTile:function(a){var b=this._tileCoordToBounds(a),c=new L.Point(this.options.tileSize,this.options.tileSize);return this.getDataUrlByBounds(b,c)},getFeatureInfoAsync:function(a,b,c,d,e){}}),MapExpress.Service.geoJSONProvider=function(a,b){return new MapExpress.Service.GeoJSONProvider(a,b)},MapExpress.Service.MapServiceAgsProvider=MapExpress.Service.EsriBaseProvider.extend({defaultParams:{bboxSR:3857,imageSR:3857,dpi:96,f:"image",format:"png32",transparent:!0},initialize:function(a,b){MapExpress.Service.EsriBaseProvider.prototype.initialize.call(this,b),this._dataUrl=a;var c=L.extend({},this.defaultParams);for(var d in b)d in this.options||(c[d]=b[d]);L.setOptions(this,b),this.mapServiceParams=c},getDataUrlByBounds:function(a,b){var c=this.options.crs,d=c.project(a.getNorthWest()),e=c.project(a.getSouthEast()),f={};f.bbox=[d.x,e.y,e.x,d.y].join(","),f.size=[b.x,b.y].join(","),this.options.layersId&&(f.layers="show:"+this.options.layersId),L.extend(this.mapServiceParams,f);var g=this.options.uppercase||!1,h=L.Util.getParamString(this.mapServiceParams,this._url,g);return this._dataUrl+"/export"+h}}),MapExpress.Service.mapServiceAgsProvider=function(a,b){return new MapExpress.Service.MapServiceAgsProvider(a,b)},MapExpress.Service.SingleImageProvider=MapExpress.Service.BaseDataProvider.extend({initialize:function(a,b){MapExpress.Service.BaseDataProvider.prototype.initialize.call(this,b),L.setOptions(this,b),this._dataUrl=a},getDataUrl:function(){return this._dataUrl},getImageBounds:function(){return this.options.imageBounds}}),MapExpress.Service.singleImageProvider=function(a,b){return new MapExpress.Service.SingleImageProvider(a,b)},MapExpress.Service.TileProvider=MapExpress.Service.BaseDataProvider.extend({initialize:function(a,b){MapExpress.Service.BaseDataProvider.prototype.initialize.call(this,b),L.setOptions(this,b),this._dataUrl=a},getDataByTileAsync:function(a){var b=this.getDataUrlByTile(a),c=new MapExpress.Utils.Promise.qImage(b);return c},getFeatureInfoAsync:function(a,b,c,d,e){}}),MapExpress.Service.tileProvider=function(a,b){return new MapExpress.Service.TileProvider(a,b)},MapExpress.Service.WFSProvider=MapExpress.Service.BaseDataProvider.extend({defaultWFSProviderParams:{service:"WFS",version:"1.1.0",typeNS:"gml",request:"GetFeature",crs:L.CRS.EPSG4326,typeName:""},options:{},initialize:function(a,b){MapExpress.Service.BaseDataProvider.prototype.initialize.call(this,b);var c=L.extend({},this.defaultWFSProviderParams);for(var d in b)d in this.options||(c[d]=b[d]);L.setOptions(this,b),this._dataUrl=a,this.gmlConverter=MapExpress.Utils.GeoFormatConvertor.gml,this.unionWFSProviderParams=c,this.unionWFSProviderParams.srsName=c.crs.code,delete this.unionWFSProviderParams.crs},getDataAsync:function(){var a=this;return MapExpress.Utils.Promise.Ajax(this.getDataUrl()).then(function(b){return a.gmlConverter.toGeoJSON(b)})},getDataUrl:function(){var a=L.Util.getParamString(this.unionWFSProviderParams,this._dataUrl);return this._dataUrl+a},getDataInBoundsAsync:function(a,b){var c=this;return MapExpress.Utils.Promise.Ajax(this.getDataUrlByBounds(a,b)).then(function(a){return c.gmlConverter.toGeoJSON(a)})},getDataUrlByBounds:function(a,b){var c=a.getNorthWest(),d=a.getSouthEast(),e={};"1.0.0"!==this.unionWFSProviderParams.version?e.bbox=[d.lat,c.lng,c.lat,d.lng].toString():e.bbox=[c.lng,d.lat,d.lng,c.lat].toString(),L.extend(this.unionWFSProviderParams,e);var f=this.options.uppercase||!1,g=L.Util.getParamString(this.unionWFSProviderParams,this._dataUrl,f);return this._dataUrl+g},getDataByTileAsync:function(a){var b=this._tileCoordToBounds(a),c=new L.Point(this.options.tileSize,this.options.tileSize);return this.getDataInBoundsAsync(b,c)}}),MapExpress.Service.wfsProvider=function(a,b){return new MapExpress.Service.WFSProvider(a,b)},MapExpress.Service.WmsProvider=MapExpress.Service.BaseDataProvider.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.3.0",layers:"",styles:"",format:"image/png",transparent:!0,dpi:96},initialize:function(a,b){MapExpress.Service.BaseDataProvider.prototype.initialize.call(this,b),this._dataUrl=a;var c=L.extend({},this.defaultWmsParams);for(var d in b)d in c&&(c[d]=b[d]);b=L.setOptions(this,b),c.width=c.height=b.tileSize*(b.detectRetina&&L.Browser.retina?2:1),this.wmsParams=c},getDataByTileAsync:function(a){var b=this._tileCoordToBounds(a),c=new L.Point(this.options.tileSize,this.options.tileSize);return this.getDataInBoundsAsync(b,c)},getDataUrlByBounds:function(a,b){var c=parseFloat(this.wmsParams.version),d=this.options.crs,e=c>=1.3?"crs":"srs",f=d.project(a.getNorthWest()),g=d.project(a.getSouthEast()),h={width:b.x,height:b.y};h[e]=d.code,h.bbox=(c>=1.3&&d===L.CRS.EPSG4326?[g.y,f.x,f.y,g.x]:[f.x,g.y,g.x,f.y]).join(","),L.extend(this.wmsParams,h);var i=this.options.uppercase||!1,j=L.Util.getParamString(this.wmsParams,this._dataUrl,i);return this._dataUrl+j},getDataUrlByTile:function(a){var b=this._tileCoordToBounds(a),c=new L.Point(this.options.tileSize,this.options.tileSize);return this.getDataUrlByBounds(b,c)},getFeatureInfoUrl:function(a,b,c,d,e){var f=parseFloat(this.wmsParams.version),g=this.options.identifyLayersId?this.options.identifyLayersId:this.wmsParams.layers,h={request:"GetFeatureInfo",service:"WMS",styles:this.wmsParams.styles,transparent:this.wmsParams.transparent,version:this.wmsParams.version,format:this.wmsParams.format,bbox:c.toBBoxString(),height:d.y,width:d.x,layers:g,query_layers:g,info_format:this.options.identifyFormat},i=f>=1.3?"crs":"srs";h[i]="EPSG:4326",h[f>=1.3?"i":"x"]=b.x,h[f>=1.3?"j":"y"]=b.y;var j=this.options.uppercase||!1;return this._dataUrl+L.Util.getParamString(h,this._url,j)}}),MapExpress.Service.wmsProvider=function(a,b){return new MapExpress.Service.WmsProvider(a,b)},MapExpress.Styles.PulseIcon=L.DivIcon.extend({options:{className:"",iconSize:[12,12],color:"red"},initialize:function(a){L.setOptions(this,a),L.DivIcon.prototype.initialize.call(this,a)},setStyle:function(a){L.setOptions(this,a);var b="lpi-"+(new Date).getTime()+"-"+Math.round(1e5*Math.random());this.options.className=this.options.className+" leaflet-pulsing-icon "+b;var c="."+b+"{background-color:"+this.options.color+";}";c+="."+b+":after{box-shadow: 0 0 6px 2px "+this.options.color+";}";var d=document.createElement("style");d.styleSheet?d.styleSheet.cssText=c:d.appendChild(document.createTextNode(c)),document.getElementsByTagName("head")[0].appendChild(d)}}),MapExpress.Styles.PulseMarker=L.Marker.extend({statics:{PULSE_ICON:new MapExpress.Styles.PulseIcon},initialize:function(a,b){b||(b={}),MapExpress.Styles.PulseMarker.PULSE_ICON.setStyle(b),b.icon=MapExpress.Styles.PulseMarker.PULSE_ICON,L.Marker.prototype.initialize.call(this,a,b)}}),MapExpress.Styles.StyleDivIcon=L.DivIcon.extend({options:{style:"width:8px;height:8px;border-radius:50%;border-width:1px;border-style: solid;border-color:black;margin-left:-4px;margin-top:-4px;",className:"mapexpress-empty-marker-style"},createIcon:function(a){var b=L.DivIcon.prototype.createIcon.call(this,a);return this._styleDivIcon=b,this.options.id&&(b.id=this.options.id),this.options.style&&this.setStyle(this.options.style),b},setStyle:function(a){this.options.style=a,MapExpress.Controls.MapControlUtils.setStyle(this._styleDivIcon,this.options.style)}}),MapExpress.Styles.StyleMarker=L.Marker.extend({initialize:function(a,b){b||(b={}),b.icon=new MapExpress.Styles.StyleDivIcon(b),L.Marker.prototype.initialize.call(this,a,b)},setDivStyle:function(a){a&&this.options.icon&&this.options.icon instanceof MapExpress.Styles.StyleDivIcon&&this.options.icon.setStyle(a)}}),MapExpress.Tools.BaseMapCommand=L.Class.extend({_active:!1,options:{},initialize:function(a,b){this._mapManager=a,L.setOptions(this,b)},createContent:function(){},activate:function(){},deactivate:function(){},doCommand:function(a){}}),MapExpress.Service.baseMapCommand=function(a,b){return new MapExpress.Tools.BaseMapCommand(a,b)},MapExpress.Tools.BoxZoom=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"btn btn-default btn-sm text-center"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a);L.DomUtil.create("i","fa fa-plus-square-o fa-lg fa-fw",b);return b.setAttribute("data-toggle","tooltip"),b.setAttribute("data-placement","bottom"),b.setAttribute("title","Увеличить"),b},activate:function(){if(!this._active){var a=this._mapManager._map,b=a.boxZoom._onMouseDown;a.boxZoom._onMouseDown=function(c){b.call(a.boxZoom,{clientX:c.clientX,clientY:c.clientY,which:1,shiftKey:!0})},a.dragging.disable(),a.boxZoom.addHooks(),a.on("boxzoomend",function(){a.dragging.enable(),a.boxZoom.removeHooks()})}},deactivate:function(){var a=this._mapManager._map;a.dragging.enable(),a.boxZoom.removeHooks(),a.off("boxzoomend",function(){a.dragging.enable(),a.boxZoom.removeHooks()})}}),MapExpress.Service.boxZoom=function(a,b){return new MapExpress.Tools.BoxZoom(a,b)},MapExpress.Tools.IdentifyMapCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button",templateUrl:"./templates/layerInfo.html",templateId:"layerInfoTemplateId",templateHelpers:"layerInfoTemplateIdAfterRender"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a);L.DomUtil.create("i","fa fa-info fa-lg fa-fw",b);return b.setAttribute("data-toggle","tooltip"),b.setAttribute("data-placement","bottom"),b.setAttribute("title","Информация"),b},activate:function(){this._active||(this._mapManager._map.on("click",this.doCommand,this),this._mapManager._map.doubleClickZoom.disable(),this._mapManager._map.on("dblclick",L.DomEvent.stop))},deactivate:function(){this._mapManager._map.off("click",this.doCommand,this),this._mapManager._map.doubleClickZoom.enable(),this._mapManager._map.off("dblclick",L.DomEvent.stop),this.popupWindow&&(this.popupWindow.hide(),delete this.popupWindow)},doCommand:function(a){function b(a,b){return a.mapLayer instanceof MapExpress.Layers.GeoJSONServiceLayer&&!(b.mapLayer instanceof MapExpress.Layers.GeoJSONServiceLayer)?-1:b.mapLayer instanceof MapExpress.Layers.GeoJSONServiceLayer&&!(a.mapLayer instanceof MapExpress.Layers.GeoJSONServiceLayer)?1:0}L.DomEvent.stopPropagation(a);var c=this,d=this._getQueryableLayers();d.sort(b);var e=this._mapManager._map,f=a.latlng,g=a.containerPoint,h=e.getZoom(),i=e.getBounds(),j=e.getSize(),k=0,l={};l.latlng=f,l.identifiedResults=[];for(var m=0;m<d.length;m++){var n=d[m],o=n.mapLayer._dataPovider;if(o){var p=o.getFeatureInfoAsync(f,g,i,j,h);if(!p&&n.mapLayer instanceof MapExpress.Layers.GeoJSONServiceLayer&&(p=n.mapLayer._getFeaturesAtPoint(f,a.layerPoint,i,j,h)),p){var q={};q.dataPromise=p,q.layerName=n.options.displayName,q.numberInList=k,o.identifyTemplate&&(q.templatePromise=o.identifyTemplate()),l.identifiedResults.push(q),k++}}}c._showInfo(l)},_getQueryableLayers:function(){for(var a=[],b=this._mapManager.getMapModel().getQueryableLayers(),c=b.length-1;c>=0;c--)this._mapManager.layerEnabled(b[c].id)&&a.push(b[c]);return a},_showInfo:function(a){function b(b){c.popupWindow&&(c.popupWindow.hide(),delete c.popupWindow),c.popupWindow=new MapExpress.Controls.MapPopupControl(c._mapManager._map,{headerEnabled:!0,closeButtonEnabled:!0,className:"mapexpress-layer-info-control"}).setTitle("Информация").setContent(b).setControlStyle({position:"absolute"}).setLatLngPosition(a.latlng).show().bringToFront(),(c.options.templateHelpers&&void 0!==c.options.templateHelpers||c.options.templateHelpers&&null!==c.options.templateHelpers)&&$.views.helpers[c.options.templateHelpers](a,c.options.templateUrl)}if(a&&0!==a.identifiedResults.length){this._mapManager.addPulseMarker(a.latlng,4e3);var c=this;return void 0===this.options.templateUrl||void 0===this.options.templateId?void new MapExpress.Controls.MapControl(window.MapManager._map,{removalDelay:3e3}).setContent("<b>Не задано представление</b>").show():void MapExpress.Controls.MapControlUtils.generateTemplate(this.options.templateUrl,this.options.templateId,a,b)}}}),MapExpress.Service.identifyMapCommand=function(a,b){return new MapExpress.Tools.IdentifyMapCommand(a,b)},MapExpress.Tools.MapToolbar=L.Control.extend({options:{position:"topleft",containerClassName:"map-toolbar"},divider:{createContent:function(a){return console.log("dfgdfgfdg"),L.DomUtil.create("span","divider1",a)}},initialize:function(a,b){this._mapManager=a,L.setOptions(this,b),this._commands=[]},onAdd:function(){return this._createContainer()},addTo:function(){L.Control.prototype.addTo.call(this,this._mapManager._map)},addCommand:function(a){return this._commands.push(a),this},addDivider:function(){},_createContainer:function(){this._container=L.DomUtil.create("div",this.options.containerClassName),this._container.style.padding="3px",this.panelBody=L.DomUtil.create("div","panel-body",this._container),this.panelBody.style.padding="3px";for(var a=0;a<this._commands.length;a++)this._createCommandContent(this._commands[a],this.panelBody);return MapExpress.Controls.MapControlUtils.stopMousePropagation(this._container),this._container},_createCommandContent:function(a){var b=this,c=a.createContent(this.panelBody);return c.command=a,MapExpress.Controls.MapControlUtils.stopMousePropagation(c),L.DomEvent.addListener(c,"click",function(){b._activeCommand&&(b._activeCommand.deactivate(),b._activeCommand._active=!1),b._activeCommand=c.command,c.command.activate(),c.command._active=!0}),c},addControlFromTemplate:function(a,b,c,d){function e(a){var b=$(f.panelBody);b.append(a),d&&"function"==typeof d&&d()}var f=this;MapExpress.Controls.MapControlUtils.generateTemplate(a,b,c,e)}}),MapExpress.Service.mapToolbar=function(a,b){return new MapExpress.Tools.MapToolbar(a,b)},MapExpress.Tools.OpenMapWorkspaceCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"btn btn-default btn-sm text-center"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a);L.DomUtil.create("i","fa fa-info fa-lg fa-fw",b);return b.setAttribute("data-toggle","tooltip"),b.setAttribute("data-placement","bottom"),b.setAttribute("title","Открыть рабочий набор"),b},activate:function(){},deactivate:function(){}}),MapExpress.Tools.OpenSideBarCommand=MapExpress.Tools.BaseMapCommand.extend({initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},activate:function(){function a(){(b.options.templateHelpers&&void 0!==b.options.templateHelpers||b.options.templateHelpers&&null!==b.options.templateHelpers)&&$.views.helpers[b.options.templateHelpers]()}var b=this;this.sideBar&&(this.sideBar.hide(),delete this.sideBar),this.sideBar=new MapExpress.Controls.MapControl(this._mapManager._map,{closeOnLeave:!0}).showSidebar(this.options.template,this.options.templateId,this.options.data,a)}}),MapExpress.Tools.SelectorBaseMapsCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button",templateUrl:"./templates/baseLayersPreview.html",templateId:"baseLayersPreviewPalleteMenu",templateHelpers:"baseLayersPreviewPalleteMenu"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a);b.setAttribute("title","Базовые карты");var c=L.DomUtil.create("img",!1,b);return c.setAttribute("src","images/BaseMap.png"),b.setAttribute("id","SelectorBaseMapsCommand"),b},activate:function(){this.doCommand()},doCommand:function(){for(var a=window.MapManager.getMapModel().getBaseLayers(),b={layers:[]},c=0;c<a.length;c++){var d=a[c].mapLayer._dataPovider._getTileCoordByLatLng(window.MapManager._map.getCenter(),window.MapManager._map.getZoom()),e={};e.singleBase=a[c],e.tileUrl=a[c].mapLayer._dataPovider.getDataUrlByTile(d),b.layers.push(e)}this._showInfo(b)},_showInfo:function(a){function b(a){c.form.setContent(a),(c.options.templateHelpers&&void 0!==c.options.templateHelpers||c.options.templateHelpers&&null!==c.options.templateHelpers)&&$.views.helpers[c.options.templateHelpers](),c.form.show().setControlStyle({"margin-top":"100px"})}var c=this;return this.form&&(this.form.hide(),delete this.form),void 0===c.options.templateUrl||void 0===c.options.templateId?void new MapExpress.Controls.MapControl(window.MapManager._map,{removalDelay:3e3}).setContent("<b>Не задано представление</b>").show():(this.form=new MapExpress.Controls.MapControl(this._mapManager._map,{titleText:"Базовые карты",position:"topRight"}),void this.form.setContentFromTemplate(c.options.templateUrl,c.options.templateId,a,b))}}),MapExpress.Tools.ShowFavoriteLayersCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button",templateUrl:"./templates/FavoriteLayers.html",templateId:"favoriteLayers"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a),c=L.DomUtil.create("img",!1,b);return c.setAttribute("src","images/layers.png"),b.setAttribute("title","Избранные слои"),b.setAttribute("id","ShowFavoriteLayersCommand"),b},activate:function(){function a(){window.refreshAllFavoriteLayersDivStyle(),(b.options.templateHelpers&&void 0!==b.options.templateHelpers||b.options.templateHelpers&&null!==b.options.templateHelpers)&&$.views.helpers[b.options.templateHelpers](),b.form.show()}var b=this;this.form&&(this.form.hide(),delete this.form);var c=this._mapManager.getMapModel().getFavoriteLayers();return c&&0!==c.length?(this.form=new MapExpress.Controls.MapControl(this._mapManager._map,{headerEnabled:!0,closeButtonEnabled:!0,position:"right"}),this.form.setTitle("Быстрый доступ к слоям"),void this.form.setContentFromTemplate(b.options.templateUrl,b.options.templateId,{favoriteLayers:c},a)):void new MapExpress.Controls.MapControl(window.MapManager._map,{removalDelay:3e3}).setContent("<b>Нет избранных слоев</b>").show()}}),MapExpress.Utils.GeoFormatConvertor=function(){var a={};return a.WKT=function(){this.numberRegexp=/[-+]?([0-9]*\.[0-9]+|[0-9]+)([eE][-+]?[0-9]+)?/,this.tuples=new RegExp("^"+this.numberRegexp.source+"\\s"+this.numberRegexp.source+"(\\s"+this.numberRegexp.source+")?")},a.WKT.prototype.toGeoJSON=function(a){function b(a){var b=p.substring(s).match(a);return b?(s+=b[0].length,b[0]):null}function c(a){return a&&q.match(/\d+/)&&(a.crs={type:"name",properties:{name:"urn:ogc:def:crs:EPSG::"+q}}),a}function d(){b(/^\s*/)}function e(){d();for(var a,c=0,e=[],f=[e],g=e;a===b(/^(\()/)||b(/^(\))/)||b(/^(\,)/)||b(r.tuples);){if("("===a)f.push(g),g=[],f[f.length-1].push(g),c++;else if(")"===a){if(0===g.length)return null;if(g=f.pop(),!g)return null;if(c--,0===c)break}else if(","===a)g=[],f[f.length-1].push(g);else{if(a.split(/\s/g).some(isNaN))return null;Array.prototype.push.apply(g,a.split(/\s/g).map(parseFloat))}d()}return 0!==c?null:e}function f(){for(var a,c,e=[];c===b(r.tuples)||b(/^(\,)/);)","===c?(e.push(a),a=[]):c.split(/\s/g).some(isNaN)||(a||(a=[]),Array.prototype.push.apply(a,c.split(/\s/g).map(parseFloat))),d();return a?(e.push(a),e.length?e:null):null}function g(){if(!b(/^(point)/i))return null;if(d(),!b(/^(\()/))return null;var a=f();return a?(d(),b(/^(\))/)?{type:"Point",coordinates:a[0]}:null):null}function h(){if(!b(/^(multipoint)/i))return null;d();var a=p.substring(p.indexOf("(")+1,p.length-1).replace(/\(/g,"").replace(/\)/g,"");p="MULTIPOINT ("+a+")";var c=e();return c?(d(),{type:"MultiPoint",coordinates:c}):null}function i(){if(!b(/^(multilinestring)/i))return null;d();var a=e();return a?(d(),{type:"MultiLineString",coordinates:a}):null}function j(){if(!b(/^(linestring)/i))return null;if(d(),!b(/^(\()/))return null;var a=f();return a&&b(/^(\))/)?{type:"LineString",coordinates:a}:null}function k(){if(!b(/^(polygon)/i))return null;d();var a=e();return a?{type:"Polygon",coordinates:a}:null}function l(){if(!b(/^(multipolygon)/i))return null;d();var a=e();return a?{type:"MultiPolygon",coordinates:a}:null}function m(){var a,c=[];if(!b(/^(geometrycollection)/i))return null;if(d(),!b(/^(\()/))return null;for(;a===n();)c.push(a),d(),b(/^(\,)/),d();return b(/^(\))/)?{type:"GeometryCollection",geometries:c}:null}function n(){return g()||j()||k()||h()||i()||l()||m()}var o=a.split(";"),p=o.pop(),q=(o.shift()||"").split("=").pop(),r=this,s=0;return c(n())},a.WKT.prototype.fromGeoJSON=function(a){function b(a){return 2===a.length?a[0]+" "+a[1]:3===a.length?a[0]+" "+a[1]+" "+a[2]:void 0}function c(a){return a.map(b).join(", ")}function d(a){return a.map(c).map(f).join(", ")}function e(a){return a.map(d).map(f).join(", ")}function f(a){return"("+a+")"}switch("Feature"===a.type&&(a=a.geometry),a.type){case"Point":return"POINT ("+b(a.coordinates)+")";case"LineString":return"LINESTRING ("+c(a.coordinates)+")";case"Polygon":return"POLYGON ("+d(a.coordinates)+")";case"MultiPoint":return"MULTIPOINT ("+c(a.coordinates)+")";case"MultiPolygon":return"MULTIPOLYGON ("+e(a.coordinates)+")";case"MultiLineString":return"MULTILINESTRING ("+d(a.coordinates)+")";case"GeometryCollection":return"GEOMETRYCOLLECTION ("+a.geometries.map(this.stringify).join(", ")+")";default:throw new Error("stringify requires a valid GeoJSON Feature or geometry object as input")}},a.CSV=function(){var a=this;this.dsv=new Function('dsv.version = "0.0.3";\n\ndsv.tsv = dsv("\\t");\ndsv.csv = dsv(",");\n\nfunction dsv(delimiter) {\n  var dsv = {},\n      reFormat = new RegExp("[\\"" + delimiter + "\\n]"),\n      delimiterCode = delimiter.charCodeAt(0);\n\n  dsv.parse = function(text, f) {\n    var o;\n    return dsv.parseRows(text, function(row, i) {\n      if (o) return o(row, i - 1);\n      var a = new Function("d", "return {" + row.map(function(name, i) {\n        return JSON.stringify(name) + ": d[" + i + "]";\n      }).join(",") + "}");\n      o = f ? function(row, i) { return f(a(row), i); } : a;\n    });\n  };\n\n  dsv.parseRows = function(text, f) {\n    var EOL = {}, // sentinel value for end-of-line\n        EOF = {}, // sentinel value for end-of-file\n        rows = [], // output rows\n        N = text.length,\n        I = 0, // current character index\n        n = 0, // the current line number\n        t, // the current token\n        eol; // is the current token followed by EOL?\n\n    function token() {\n      if (I >= N) return EOF; // special case: end of file\n      if (eol) return eol = false, EOL; // special case: end of line\n\n      // special case: quotes\n      var j = I;\n      if (text.charCodeAt(j) === 34) {\n        var i = j;\n        while (i++ < N) {\n          if (text.charCodeAt(i) === 34) {\n            if (text.charCodeAt(i + 1) !== 34) break;\n            ++i;\n          }\n        }\n        I = i + 2;\n        var c = text.charCodeAt(i + 1);\n        if (c === 13) {\n          eol = true;\n          if (text.charCodeAt(i + 2) === 10) ++I;\n        } else if (c === 10) {\n          eol = true;\n        }\n        return text.substring(j + 1, i).replace(/""/g, "\\"");\n      }\n\n      // common case: find next delimiter or newline\n      while (I < N) {\n        var c = text.charCodeAt(I++), k = 1;\n        if (c === 10) eol = true; // \\n\n        else if (c === 13) { eol = true; if (text.charCodeAt(I) === 10) ++I, ++k; } // \\r|\\r\\n\n        else if (c !== delimiterCode) continue;\n        return text.substring(j, I - k);\n      }\n\n      // special case: last token before EOF\n      return text.substring(j);\n    }\n\n    while ((t = token()) !== EOF) {\n      var a = [];\n      while (t !== EOL && t !== EOF) {\n        a.push(t);\n        t = token();\n      }\n      if (f && !(a = f(a, n++))) continue;\n      rows.push(a);\n    }\n\n    return rows;\n  };\n\n  dsv.format = function(rows) {\n    if (Array.isArray(rows[0])) return dsv.formatRows(rows); // deprecated; use formatRows\n    var fieldSet = {}, fields = [];\n\n    // Compute unique fields in order of discovery.\n    rows.forEach(function(row) {\n      for (var field in row) {\n        if (!(field in fieldSet)) {\n          fields.push(fieldSet[field] = field);\n        }\n      }\n    });\n\n    return [fields.map(formatValue).join(delimiter)].concat(rows.map(function(row) {\n      return fields.map(function(field) {\n        return formatValue(row[field]);\n      }).join(delimiter);\n    })).join("\\n");\n  };\n\n  dsv.formatRows = function(rows) {\n    return rows.map(formatRow).join("\\n");\n  };\n\n  function formatRow(row) {\n    return row.map(formatValue).join(delimiter);\n  }\n\n  function formatValue(text) {\n    return reFormat.test(text) ? "\\"" + text.replace(/\\"/g, "\\"\\"") + "\\"" : text;\n  }\n\n  return dsv;\n}\n;return dsv')(),
this.element=function(b,c){return a.search(b,c).val},this.formatPair=function(a){return this.format(a.lat,"lat")+" "+this.format(a.lon,"lon")},this.format=function(a,b){var c={lat:["N","S"],lon:["E","W"]}[b]||"",d=c[a>=0?0:1],e=Math.abs(a),f=Math.floor(e),g=e-f,h=60*g,i=Math.floor(h),j=Math.floor(60*(h-i));return f+"° "+(i?i+"' ":"")+(j?j+'" ':"")+d},this.search=function(a,b,c){if(b||(b="NSEW"),"string"!=typeof a)return{val:null,regex:c};c=c||/[\s\,]*([\-|\—|\―]?[0-9.]+)°? *(?:([0-9.]+)['’′‘] *)?(?:([0-9.]+)(?:''|"|”|″) *)?([NSEW])?/gi;var d=c.exec(a);return d?d[4]&&b.indexOf(d[4])===-1?{val:null,regex:c}:{val:((d[1]?parseFloat(d[1]):0)+(d[2]?parseFloat(d[2])/60:0)+(d[3]?parseFloat(d[3])/3600:0))*(d[4]&&"S"===d[4]||"W"===d[4]?-1:1),regex:c,raw:d[0],dim:d[4]}:{val:null,regex:c}},this.pair=function(b,c){b=b.trim();var d=a.search(b,c);if(null===d.val)return null;var e=a.search(b,c,d.regex);return null===e.val?null:d.raw+e.raw!==b?null:d.dim?a.swapdim(d.val,e.val,d.dim):[d.val,e.val]},this.swapdim=function(a,b,c){return"N"===c||"S"===c?[a,b]:"W"===c||"E"===c?[b,a]:void 0}},a.CSV.prototype.toGeoJSON=function(a,b){function c(a){return!!a.match(/(Lat)(itude)?/gi)}function d(a){return!!a.match(/(L)(on|ng)(gitude)?/i)}function e(a){return"object"==typeof a?Object.keys(a).length:0}function f(a){var b=[",",";","\t","|"],c=[];return b.forEach(function(b){var d=g.dsv(b).parse(a);if(d.length>=1){for(var f=e(d[0]),h=0;h<d.length;h++)if(e(d[h])!==f)return;c.push({delimiter:b,arity:Object.keys(d[0]).length})}}),c.length?c.sort(function(a,b){return b.arity-a.arity})[0].delimiter:null}var g=this,h=function(a,b){return a?a:b};void 0===b&&(b={}),h||(h=b,b={}),b.delimiter=b.delimiter||",";var i=b.latfield||"",j=b.lonfield||"",k=b.crs||"",l=[],m={type:"FeatureCollection",features:l};if(""!==k&&(m.crs={type:"name",properties:{name:k}}),"auto"===b.delimiter&&"string"==typeof a&&(b.delimiter=f(a),!b.delimiter))return h({type:"Error",message:"Could not autodetect delimiter"});var n="string"==typeof a?g.dsv(b.delimiter).parse(a):a;if(!n.length)return h(null,m);if(!i||!j){for(var o in n[0])!i&&c(o)&&(i=o),!j&&d(o)&&(j=o);if(!i||!j){var p=[];for(var q in n[0])p.push(q);return h({type:"Error",message:"Latitude and longitude fields not present",data:n,fields:p})}}for(var r=[],s=0;s<n.length;s++)if(void 0!==n[s][j]&&void 0!==n[s][j]){var t,u,v,w=n[s][j],x=n[s][i];v=g.element(w,"EW"),v&&(w=v),v=g.element(x,"NS"),v&&(x=v),t=parseFloat(w),u=parseFloat(x),isNaN(t)||isNaN(u)?r.push({message:"A row contained an invalid value for latitude or longitude",row:n[s]}):(b.includeLatLon||(delete n[s][j],delete n[s][i]),l.push({type:"Feature",properties:n[s],geometry:{type:"Point",coordinates:[parseFloat(t),parseFloat(u)]}}))}return m},a.CSV.prototype.toLine=function(a){for(var b=a.features,c={type:"Feature",geometry:{type:"LineString",coordinates:[]}},d=0;d<b.length;d++)c.geometry.coordinates.push(b[d].geometry.coordinates);return c.properties=b[0].properties,{type:"FeatureCollection",features:[c]}},a.CSV.prototype.toPolygon=function(a){for(var b=a.features,c={type:"Feature",geometry:{type:"Polygon",coordinates:[[]]}},d=0;d<b.length;d++)c.geometry.coordinates[0].push(b[d].geometry.coordinates);return c.properties=b[0].properties,{type:"FeatureCollection",features:[c]}},a.ESRI=function(){},a.ESRI.prototype.toGeoJSON=function(a){function b(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;d<e-1;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function c(a){var c,d,e,f,g,h,i;if(a){if((a.x&&"NaN"!==a.x||0===a.x)&&(a.y&&"NaN"!==a.y||0===a.y))f="Point",e=[a.x,a.y];else if(a.points&&a.points.length)f="MultiPoint",e=a.points;else if(a.paths&&a.paths.length)g=a.paths,1===g.length?(f="LineString",e=g[0]):(f="MultiLineString",e=g);else if(a.rings&&a.rings.length){for(h=[],g=a.rings,d=0;d<g.length;d++)i=g[d],b(i)?h.push([i]):h.length>0&&h[h.length-1].push(i);h.length>1?(e=h,f="MultiPolygon"):(e=h.pop(),f="Polygon")}return c=e&&f?{type:f,coordinates:e}:null}return c}function d(a){var b,d,e,f=null;if(a&&(f={type:"Feature"},a.geometry&&(f.geometry=c(a.geometry)),a.attributes)){d={},e=a.attributes;for(b in a.attributes)d[b]=a.attributes[b];f.properties=d}return f}var e,f,g,h;if(a)if(a.features||a.results)for(e={type:"FeatureCollection",features:[]},a.features?g=a.features:a.results?g=a.results:console.log("обратить внимание на входящий JSON"),f=0;f<g.length;f++)h=d(g[f]),h&&e.features.push(h);else e=a.geometry?d(a):c(a);return e},a.ESRI.prototype.fromGeoJSON=function(a){function b(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;d<e-1;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function c(a,b){var c=!1;return("esriGeometryPoint"!==a&&"esriGeometryMultipoint"!==a||"Point"!==b&&"MultiPoint"!==b)&&("esriGeometryPolyline"!==a||"LineString"!==b&&"MultiLineString"!==b)?"esriGeometryPolygon"!==a||"Polygon"!==b&&"MultiPolygon"!==b||(c=!0):c=!0,c}function d(a){var b,c;return"Point"===a?b="esriGeometryPoint":"MultiPoint"===a?(b="esriGeometryMultipoint",c="points"):"LineString"===a||"MultiLineString"===a?(b="esriGeometryPolyline",c="paths"):"Polygon"!==a&&"MultiPolygon"!==a||(b="esriGeometryPolygon",c="rings"),{type:b,geomHolder:c}}function e(a){var c,d,e,f=[];for(c=0,d=a.length;c<d;c++)e=a[c],0===c!==b(e)&&(e=e.reverse()),f.push(e);return f}function f(a){var b,c,d;if("MultiPoint"===a.type||"MultiLineString"===a.type)d=a.coordinates||[];else if("Point"===a.type||"LineString"===a.type)d=a.coordinates?[a.coordinates]:[];else if("Polygon"===a.type)d=[],a.coordinates&&(d=e(a.coordinates));else if("MultiPolygon"===a.type&&(d=[],a.coordinates))for(b=0,c=a.coordinates.length;b<c;b++)d.push(e(a.coordinates[b]));return d}function g(a){var b,e,g,h,i,j;if("GeometryCollection"===a.type){var k=a.geometries[0];for(g=[],e=d(k.type),h=0;h<a.geometries.length;h++)c(e.type,a.geometries[h].type)&&g.push(a.geometries[h])}else e=d(a.type),g=[a];if("esriGeometryPoint"===e.type&&g.length>1&&(e=d("MultiPoint")),b={spatialReference:{wkid:4326}},"esriGeometryPoint"===e.type)g[0]&&g[0].coordinates&&0!==g[0].coordinates.length?(b.x=g[0].coordinates[0],b.y=g[0].coordinates[1]):b.x=null;else for(b[e.geomHolder]=[],h=0;h<g.length;h++)for(j=f(g[h]),i=0;i<j.length;i++)b[e.geomHolder].push(j[i]);return b}function h(a){var b,c,d;if(a&&(b={},a.geometry&&(b.geometry=g(a.geometry)),a.properties)){d={};for(c in a.properties)d[c]=a.properties[c];b.attributes=d}return b}var i,j,k,l;if(a)if("FeatureCollection"===a.type)for(i={features:[]},k=a.features,j=0;j<k.length;j++)l=h(k[j]),l&&i.features.push(l);else i="Feature"===a.type?h(a):g(a);return i},a.XML=function(){},a.XML.prototype={okhash:function(a){if(!a||!a.length)return 0;for(var b=0,c=0;b<a.length;b++)c=(c<<5)-c+a.charCodeAt(b)|0;return c},get:function(a,b){return a.getElementsByTagName(b)},attr:function(a,b){return a.getAttribute(b)},attrf:function(a,b){return parseFloat(this.attr(a,b))},get1:function(a,b){var c=this.get(a,b);return c.length?c[0]:null},norm:function(a){return a.normalize&&a.normalize(),a},numarray:function(a){for(var b=0,c=[];b<a.length;b++)c[b]=parseFloat(a[b]);return c},clean:function(a){var b={};for(var c in a)a[c]&&(b[c]=a[c]);return b},nodeVal:function(a){return a&&this.norm(a),a&&a.firstChild&&a.firstChild.nodeValue||""},coord1:function(a){return this.numarray(a.replace(/\s*/g,"").split(","))},coord:function(a){for(var b=a.replace(/^\s*|\s*$/g,"").split(/\s+/),c=[],d=0;d<b.length;d++)c.push(this.coord1(b[d]));return c},coordPair:function(a){var b=[this.attrf(a,"lon"),this.attrf(a,"lat")],c=this.get1(a,"ele"),d=this.get1(a,"time");return c&&b.push(parseFloat(this.nodeVal(c))),{coordinates:b,time:d?this.nodeVal(d):null}},fc:function(){return{type:"FeatureCollection",features:[]}},serializer:function(){var a;return"undefined"!=typeof XMLSerializer&&(a=new XMLSerializer),a},xml2str:function(a){return void 0!==a.xml?a.xml:this.serializer.serializeToString(a)},parseXML:function(a){var b;try{if(window.DOMParser){var c=new DOMParser;b=c.parseFromString(a,"text/xml")}else b=new ActiveXObject("MSXML2.DOMDocument.3.0"),b.validateOnParse=!1,b.async=!1,b.loadXML(a)}catch(a){console.log(a)}return b},strip:function(a){return a.replace(/^\s*/,"").replace(/\s*$/,"")},toGeoJSON:function(){}},a.KML=function(){},a.KML.prototype=Object.create(a.XML.prototype),a.KML.prototype.constructor=a.KML,a.KML.prototype.toGeoJSON=function(b){function c(a){var b,c;return a=a||"","#"===a.substr(0,1)&&(a=a.substr(1)),6!==a.length&&3!==a.length||(b=a),8===a.length&&(c=parseInt(a.substr(0,2),16)/255,b=a.substr(2)),[b,isNaN(c)?void 0:c]}function d(a){return h.numarray(a.split(" "))}function e(a){var b=h.get(a,"coord","gx"),c=[],e=[];0===b.length&&(b=h.get(a,"gx:coord"));for(var f=0;f<b.length;f++)c.push(d(h.nodeVal(b[f])));for(var g=h.get(a,"when"),i=0;i<g.length;i++)e.push(h.nodeVal(g[i]));return{coords:c,times:e}}function f(a){var b,c,d,g,i,j=[],k=[];if(h.get1(a,"MultiGeometry"))return f(h.get1(a,"MultiGeometry"));if(h.get1(a,"MultiTrack"))return f(h.get1(a,"MultiTrack"));if(h.get1(a,"gx:MultiTrack"))return f(h.get1(a,"gx:MultiTrack"));for(d=0;d<l.length;d++)if(c=h.get(a,l[d]))for(g=0;g<c.length;g++)if(b=c[g],"Point"===l[d])j.push({type:"Point",coordinates:h.coord1(h.nodeVal(h.get1(b,"coordinates")))});else if("LineString"===l[d])j.push({type:"LineString",coordinates:h.coord(h.nodeVal(h.get1(b,"coordinates")))});else if("Polygon"===l[d]){var m=h.get(b,"LinearRing"),n=[];for(i=0;i<m.length;i++)n.push(h.coord(h.nodeVal(h.get1(m[i],"coordinates"))));j.push({type:"Polygon",coordinates:n})}else if("Track"===l[d]||"gx:Track"===l[d]){var o=e(b);j.push({type:"LineString",coordinates:o.coords}),o.times.length&&k.push(o.times)}return{geoms:j,coordTimes:k}}function g(a){var b,d=f(a),e={},g=h.nodeVal(h.get1(a,"name")),i=h.nodeVal(h.get1(a,"styleUrl")),j=h.nodeVal(h.get1(a,"description")),l=h.get1(a,"TimeSpan"),m=h.get1(a,"ExtendedData"),n=h.get1(a,"LineStyle"),o=h.get1(a,"PolyStyle");if(!d.geoms.length)return[];if(g&&(e.name=g),i&&k[i]&&(e.styleUrl=i,e.styleHash=k[i]),j&&(e.description=j),l){var p=h.nodeVal(h.get1(l,"begin")),q=h.nodeVal(h.get1(l,"end"));e.timespan={begin:p,end:q}}if(n){var r=c(h.nodeVal(h.get1(n,"color"))),s=r[0],t=r[1],u=parseFloat(h.nodeVal(h.get1(n,"width")));s&&(e.stroke=s),isNaN(t)||(e["stroke-opacity"]=t),isNaN(u)||(e["stroke-width"]=u)}if(o){var v=c(h.nodeVal(h.get1(o,"color"))),w=v[0],x=v[1],y=h.nodeVal(h.get1(o,"fill")),z=h.nodeVal(h.get1(o,"outline"));w&&(e.fill=w),isNaN(x)||(e["fill-opacity"]=x),y&&(e["fill-opacity"]="1"===y?1:0),z&&(e["stroke-opacity"]="1"===z?1:0)}if(m){var A=h.get(m,"Data"),B=h.get(m,"SimpleData");for(b=0;b<A.length;b++)e[A[b].getAttribute("name")]=h.nodeVal(h.get1(A[b],"value"));for(b=0;b<B.length;b++)e[B[b].getAttribute("name")]=h.nodeVal(B[b])}d.coordTimes.length&&(e.coordTimes=1===d.coordTimes.length?d.coordTimes[0]:d.coordTimes);var C={type:"Feature",geometry:1===d.geoms.length?d.geoms[0]:{type:"GeometryCollection",geometries:d.geoms},properties:e};return h.attr(a,"id")&&(C.id=h.attr(a,"id")),[C]}a.XML.prototype.toGeoJSON.apply();for(var h=this,i=h.fc(),j=h.parseXML(b),k={},l=["Polygon","LineString","Point","Track","gx:Track"],m=h.get(j,"Placemark"),n=h.get(j,"Style"),o=0;o<n.length;o++)k["#"+attr(n[o],"id")]=h.okhash(h.xml2str(n[o])).toString(16);for(var p=0;p<m.length;p++)i.features=i.features.concat(g(m[p]));return i},a.GPX=function(){},a.GPX.prototype=Object.create(a.XML.prototype),a.GPX.prototype.constructor=a.GPX,a.GPX.prototype.toGeoJSON=function(b){function c(a,b){var c=j.get(a,b),d=[],e=[],f=c.length;if(!(f<2)){for(var g=0;g<f;g++){var h=j.coordPair(c[g]);d.push(h.coordinates),h.time&&e.push(h.time)}return{line:d,times:e}}}function d(a){for(var b,d=j.get(a,"trkseg"),e=[],f=[],h=0;h<d.length;h++)b=c(d[h],"trkpt"),b.line&&e.push(b.line),b.times.length&&f.push(b.times);if(0!==e.length){var i=g(a);return f.length&&(i.coordTimes=1===e.length?f[0]:f),{type:"Feature",properties:i,geometry:{type:1===e.length?"LineString":"MultiLineString",coordinates:1===e.length?e[0]:e}}}}function e(a){var b=c(a,"rtept");if(b){for(var d=[],e=0;e<b.line.length;e++)3===b.line.length?d.push([b.line[e][0],b.line[e][1]]):d.push(b.line[e]);var f={type:"Feature",properties:g(a),geometry:{type:"LineString",coordinates:d}};return b.times.length&&(f.geometry.times=b.times),f}}function f(a){var b=g(a);return b.sym=j.nodeVal(j.get1(a,"sym")),{type:"Feature",properties:b,geometry:{type:"Point",coordinates:j.coordPair(a).coordinates}}}function g(a){var b,c=["name","desc","author","copyright","link","time","keywords"],d={};for(b=0;b<c.length;b++)d[c[b]]=j.nodeVal(j.get1(a,c[b]));return j.clean(d)}a.XML.prototype.toGeoJSON.apply();var h,i,j=this,k=j.parseXML(b),l=j.get(k,"trk"),m=j.get(k,"rte"),n=j.get(k,"wpt"),o=j.fc();for(h=0;h<l.length;h++)i=d(l[h]),i&&o.features.push(i);for(h=0;h<m.length;h++)i=e(m[h]),i&&o.features.push(i);for(h=0;h<n.length;h++)o.features.push(f(n[h]));return o},a.GML=function(){this.gmlns="http://www.opengis.net/gml",this.srs=null},a.GML.prototype=Object.create(a.XML.prototype),a.GML.prototype.constructor=a.GML,a.GML.prototype.toGeoJSON=function(b,c){a.XML.prototype.toGeoJSON.apply(),this.srs=c;var d=this.serializer().serializeToString(b),e=d.replace(/[\t\n\r]/g," ").replace(/\s+/g," "),f=this.parseXML(e),g=this.gmlns,h={features:[]},i=this.elementsNS(f.documentElement,g,"featureMembers");if(i.length>0)for(var j=i[0].childNodes,k=0;k<j.length;k++){var l=j[k];l.nodeType===document.ELEMENT_NODE&&h.features.push(this.elementPropertiesAsObject(l))}for(var m=["Polygon","LineString","Point"],n=["posList","coordinates","pos","coord"],o=[],p=[],q=0;q<h.features.length;q++)for(var r=0;r<m.length;r++){var s={};s.gmlGeom=this.findGeomTypes(h.features[q],m[r]),void 0!==s.gmlGeom&&(s.gmlGeom.length>1?s.type="Multi"+m[r]:s.type=m[r],o.push(s))}for(var t=0;t<o.length;t++)for(var u=0;u<n.length;u++){var v={};if(v.type=o[t].type,o[t].gmlGeom.length>1){v.coordinates=[];for(var w=0;w<o[t].gmlGeom.length;w++){var x=this.findCords(o[t].gmlGeom[w],n[u]);void 0!==x&&(o[t].gmlGeom[w].srsDimension&&(v.srsDimension=o[t].gmlGeom[w].srsDimension),v.coordinates.push(x))}}else o[t].gmlGeom[0].srsDimension&&(v.srsDimension=o[t].gmlGeom[0].srsDimension),v.coordinates=this.findCords(o[t],n[u]);if(void 0!==v.coordinates&&v.coordinates.length>0){var y,z;if("string"==typeof v.coordinates){v.coordinates=this.strip(v.coordinates),v.coordinates=v.coordinates.split(" ");var A=[];if(v.srsDimension&&"3"===v.srsDimension)for(y=0;y<v.coordinates.length;y+=3)z=y+1,"Point"!==v.type?A.push(this.swapCoordinates([Number(v.coordinates[y]),Number(v.coordinates[z])])):A.push(Number(v.coordinates[y]),Number(v.coordinates[z]));else for(y=0;y<v.coordinates.length/2;++y)z=2*y,"Point"!==v.type?A.push(this.swapCoordinates([Number(v.coordinates[z]),Number(v.coordinates[z+1])])):A.push(Number(v.coordinates[z]),Number(v.coordinates[z+1]));v.coordinates=A}else for(var B=0;B<v.coordinates.length;B++){v.coordinates[B]=this.strip(v.coordinates[B]),v.coordinates[B]=v.coordinates[B].split(" ");var C=[];if(v.srsDimension&&"3"===v.srsDimension)for(y=0;y<v.coordinates[B].length;y+=3)z=y+1,C.push(this.swapCoordinates([Number(v.coordinates[B][y]),Number(v.coordinates[B][z])]));else for(y=0;y<v.coordinates[B].length/2;++y)z=2*y,C.push(this.swapCoordinates([Number(v.coordinates[B][z]),Number(v.coordinates[B][z+1])]));v.coordinates[B]=C}p.push(v)}}for(var D={type:"FeatureCollection",features:[]},E=0;E<h.features.length;E++){var F={type:"Feature",properties:h.features[E],geometry:{type:p[E].type}};"MultiPolygon"===F.geometry.type||"Polygon"===F.geometry.type?F.geometry.coordinates=[p[E].coordinates]:F.geometry.coordinates=p[E].coordinates,D.features.push(F)}return D},a.GML.prototype.elementPropertiesAsObject=function(a){var b,c=a.childNodes;if(a.children.length>0){b={};for(var d=0;d<c.length;d++)if(a.attributes.length>0){b[c[d].localName]?b[c[d].localName+d]=this.elementPropertiesAsObject(c[d]):b[c[d].localName]=this.elementPropertiesAsObject(c[d]);for(var e=0;e<a.attributes.length;e++)b[a.attributes[e].localName]=a.attributes[e].value}else b[c[d].localName]?b[c[d].localName+d]=this.elementPropertiesAsObject(c[d]):b[c[d].localName]=this.elementPropertiesAsObject(c[d])}else if(a.attributes.length>0){for(var f=0;f<a.attributes.length;f++)b[a.attributes[f]]=a.attributes[f].value;b[a.localName]=a.innerHTML}else b=a.innerHTML;return b},a.GML.prototype.findGeomTypes=function(a,b){function c(a,b){for(var e in a)"object"==typeof a[e]&&(e===b?d.push(a[e]):c(a[e],b))}var d=[];if(c(a,b),0!==d.length)return d},a.GML.prototype.findCords=function(a,b){function c(a,b){for(var e in a)"object"==typeof a[e]?c(a[e],b):"string"==typeof a[e]&&e===b&&(d=a[e])}var d;return c(a,b),d},a.GML.prototype.elementsNS=function(a,b,c){var d=[],e=a.getAttribute("srsDimension");if(a.getElementsByTagNameNS)d=a.getElementsByTagNameNS(b,c);else for(var f,g,h=a.getElementsByTagName("*"),i=0,j=h.length;i<j;++i)f=h[i],g=f.prefix?f.prefix+":"+c:c,"*"!==c&&g!==f.nodeName||"*"!==b&&b!==f.namespaceURI||d.push(f);return"posList"===c?{dim:e,elements:d}:d},a.GML.prototype.swapCoordinates=function(a){var b;return b="EPSG:4326"===this.srs?[a[0],a[1]]:"EPSG:3857"===this.srs?L.Projection.SphericalMercator.unproject(new L.Point(a[0],a[1])):"EPSG:3395"===this.srs?L.Projection.Mercator.unproject(new L.Point(a[0],a[1])):[a[0],a[1]]},a.GML.prototype.fromGeoJSON=function(a,b,c,d){for(var e=this,f="http://www.opengis.net/gml",g=this._createXMLElement("gml:featureMembers",f,{}),h=0;h<a.features.length;h++)g.appendChild(e.createNodeFromGeoJSONFeature(a.features[h],b,c,d));return g},a.GML.prototype.createNodeFromGeoJSONFeature=function(a,b,c,d){console.log(a,b,c,d);var e="http://geoserver.ics.perm.ru",f=this._createXMLElement("osm_perm_region:"+c,e),g=this._createXMLElement("osm_perm_region:"+d,e,{});for(var h in a.properties)if("id"===h)f.setAttribute("gml:id",a.properties[h]);else{var i=this._createXMLElement(b+":"+h,e,{});i.textContent=a.properties[h],f.appendChild(i)}return g.appendChild(this.createGeometryNodeFromGeoJSONFeature(a.geometry)),f.appendChild(g),f},a.GML.prototype.createGeometryNodeFromGeoJSONFeature=function(a){var b,c,d="",e="http://www.opengis.net/gml",f=[];switch(a.type){case"Point":var g=this._createXMLElement("gml:Point ",e,{srsName:"EPSG:4326",srsDimension:"2"}),h=this._createXMLElement("gml:pos",e);h.textContent=a.coordinates.join(" "),d=g;break;case"MultiPoint":var i=this._createXMLElement("gml:MultiPoint",e,{srsDimension:"2",srsName:"EPSG:4326"}),j=this._createXMLElement("gml:pointMember",e);for(b=0;b<a.coordinates.length;b++){var g=this._createXMLElement("gml:Point",e,{srsDimension:"2"}),h=this._createXMLElement("gml:pos",e);h.textContent=a.coordinates[b].join(" "),g.appendChild(h),j.appendChild(g)}i.appendChild(j),d=i;break;case"LineString":var g=this._createXMLElement("gml:LineString",e,{srsName:"EPSG:4326",srsDimension:"2"}),h=this._createXMLElement("gml:posList",e);for(c=0;c<a.coordinates.length;c++)f=f.concat(a.coordinates[c]);h.textContent=f.join(" "),g.appendChild(h),d=g;break;case"MultiLineString":var i=this._createXMLElement("gml:MultiLineString",e,{srsName:"EPSG:4326",srsDimension:"2"}),j=this._createXMLElement("gml:lineStringMember",e);for(b=0;b<a.coordinates.length;b++){for(var g=this._createXMLElement("gml:LineString",e,{srsDimension:"2"}),h=this._createXMLElement("gml:posList",e),c=0;c<a.coordinates[b].length;c++)f=f.concat(a.coordinates[b][c]);h.textContent=f.join(" "),g.appendChild(h),j.appendChild(g),f=[]}i.appendChild(j),d=i;break;case"Polygon":var g=this._createXMLElement("gml:Polygon",e,{srsName:"EPSG:4326",srsDimension:"2"}),k=g.appendChild(this._createXMLElement("gml:exterior",e)),l=k.appendChild(this._createXMLElement("gml:LinearRing",e,{srsDimension:"2"})),h=this._createXMLElement("gml:posList",e);for(c=0;c<a.coordinates[0].length;c++)f=f.concat(a.coordinates[0][c]);h.textContent=f.join(" "),l.appendChild(h),d=g;break;case"MultiPolygon":var i=this._createXMLElement("gml:MultiPolygon",e,{srsName:"EPSG:4326",srsDimension:"2"}),j=this._createXMLElement("gml:polygonMember",e);for(b=0;b<a.coordinates[0].length;b++){var g=this._createXMLElement("gml:Polygon",e,{srsDimension:"2"}),k=g.appendChild(this._createXMLElement("gml:exterior",e)),l=k.appendChild(this._createXMLElement("gml:LinearRing",e,{srsDimension:"2"})),h=this._createXMLElement("gml:posList",e);for(c=0;c<a.coordinates[0][b].length;c++)f=f.concat(a.coordinates[0][b][c]);h.textContent=f.join(" "),l.appendChild(h),f=[],j.appendChild(g)}i.appendChild(j),d=i;break;case"GeometryCollection":}return d},a.GML.prototype._createXMLdoc=function(){var a=new DOMParser;return a.parseFromString("<root />","text/xml")},a.GML.prototype._createXMLElement=function(a,b,c){var d=this._createXMLdoc().createElementNS(b,a);if(void 0!==c)for(var e in c)d.setAttribute(e,c[e]);return d},{esri:new a.ESRI,wkt:new a.WKT,csv:new a.CSV,gml:new a.GML,gpx:new a.GPX,kml:new a.KML}}(),function(){"use strict";MapExpress.Utils.Promise.GetJSON=function(a){var b=$.Deferred();return $.getJSON(a).done(function(a){b.resolve(a)}).fail(function(a,c,d){b.reject(d)}),b.promise()}}(),function(){"use strict";MapExpress.Utils.Promise.Ajax=function(a,b){var c=$.Deferred();return $.ajax({url:a,success:function(a){c.resolve(a,b)},error:function(a){c.reject(a)}}),c.promise()}}(),function(){"use strict";MapExpress.Utils.Promise.AjaxSync=function(a,b){var c=$.Deferred();return setTimeout(function(){$.ajax({async:!1,url:a,success:function(a){c.resolve(a,b)},error:function(a){c.reject(a)}})},0),c.promise()}}(),function(){"use strict";MapExpress.Utils.Promise.GetJSONP=function(a,b,c){var d=$.Deferred();return $.ajax({url:a,type:"GET",data:b,dataType:"jsonp",jsonpCallback:c,success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise()}}(),function(){"use strict";MapExpress.Utils.Promise.Image=function(a,b){b=b||{};var c=new Image;b.crossOrigin&&(c.crossOrigin=b.crossOrigin,c.alt="");var d=$.Deferred();return c.onload=function(){d.resolve(c)},c.onabort=function(a){d.reject(c)},c.onerror=function(a){d.reject(c)},c.src=a,d.promise()}}(),void 0===jQuery.when.all&&(jQuery.when.all=function(a){var b=new jQuery.Deferred;return $.when.apply(jQuery,a).then(function(){b.resolve(Array.prototype.slice.call(arguments))},function(){b.fail(Array.prototype.slice.call(arguments))}),b});