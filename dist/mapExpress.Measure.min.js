L.MeasureLine=L.Polyline.extend({options:{className:"leaflet-interactive leaflet-measure-line"}}),L.MeasurePolygon=L.Polygon.extend({options:{className:"leaflet-interactive leaflet-measure-polygon"}}),L.MeasureVertex=L.Editable.VertexMarker.extend({options:{className:"leaflet-div-icon leaflet-editing-icon leaflet-measure-edge"},initialize:function(a,b,c,d){L.Editable.VertexMarker.prototype.initialize.call(this,a,b,c,d)},onAdd:function(a){L.Editable.VertexMarker.prototype.onAdd.call(this,a),this.on("mouseover",this.onMouseOver),this.on("mouseout",this.onMouseOut),this.on("drag",this.onVertexDrag),this.addMiddleMarkers()},onVertexDrag:function(a){this.editor.continueBackward?a.target.editor.tools.getMeasureLength(a):this.editor.addNewEmptyHole&&a.target.editor.tools.getMeasureArea(a)},onMouseOver:function(a){this.editor.continueBackward?a.target.editor.tools.getMeasureLength(a):this.editor.addNewEmptyHole&&a.target.editor.tools.getMeasureArea(a)},onMouseOut:function(a){this.editor.continueBackward?a.target.editor.tools.getMeasureLength(a):this.editor.addNewEmptyHole&&a.target.editor.tools.getMeasureArea(a)}}),L.MeasureMiddleVertex=L.Editable.MiddleMarker.extend({options:{className:"leaflet-div-icon leaflet-editing-icon leaflet-measure-middleEdge"},initialize:function(a,b,c,d,e,f){this.middle=f,L.Editable.MiddleMarker.prototype.initialize.call(this,a,b,c,d,e)},onAdd:function(a){L.Editable.MiddleMarker.prototype.onAdd.call(this,a),this.map=a,this.on("mouseover",this.calculateLength),this.on("mouseout",this.calculateLength)},computeLatLng:function(a){var b,c,d,e;return this.middle&&void 0!==this.middle.m?(d=this.editor.map.latLngToContainerPoint(this.middle.m).y,e=this.editor.map.latLngToContainerPoint(this.middle.m).x):(b=this.editor.map.latLngToContainerPoint(this.left.latlng),c=this.editor.map.latLngToContainerPoint(this.right.latlng),d=(b.y+c.y)/2,e=(b.x+c.x)/2),this.editor.map.containerPointToLatLng([e,d])},calculateLength:function(a){var b=[this.left.latlng,this.right.latlng],c=L.GeoUtil.lineLength(this.map,b),d=this.map.latLngToLayerPoint(this._latlng),e=L.GeoUtil.readableDistance(c),f=this.editor.options.editTools.options.labelStyle;"mouseover"===a.type?(d.newLabel("Длина сегмента: "+e,!0,"middle",null,f),this.layerPoint=d):void 0!==this.layerPoint&&this.layerPoint.removeLabel("middle")},onRemove:function(a){L.Editable.MiddleMarker.prototype.onRemove.call(this,a),void 0!==this.layerPoint&&this.layerPoint.removeLabel("middle")},onMouseDown:function(a){var b=L.DomUtil.getPosition(this._icon),c=this.editor.map.layerPointToLatLng(b);if(a={originalEvent:a,latlng:c},0!==this.options.opacity&&(L.Editable.makeCancellable(a),this.editor.onMiddleMarkerMouseDown(a),!a._cancelled)){this.latlngs.splice(this.index(),0,a.latlng),this.editor.refresh();var d=(this._icon,this.editor.addVertexMarker(a.latlng,this.latlngs));L.Draggable._dragging=!1,d.dragging._draggable._onDown(a.originalEvent),this["delete"]()}}}),L.MeasurablePathEditorInclude={addNonMiddleMarker:function(a,b,c,d){return new this.tools.options.middleMarkerClass(a,b,d,this,{},c)},onVertexDeleted:function(a){this.fireAndForward("editable:vertex:deleted",a);for(var b in this.editLayer._layers)this.editLayer._layers[b].middle&&this.editLayer._layers[b].remove()},onPathClick:function(){this.feature.on("click",function(a){var b=(a.layerPoint,this.feature.toGeoJSON());for(var c in this.editLayer._layers)this.editLayer._layers[c].middle&&this.editLayer._layers[c].remove();var d,e,f,g,h,i,j={},k={},l={m:a.latlng};if("LineString"===b.geometry.type||"MultiLineString"===b.geometry.type){for(var m=0;m<this.feature._rings.length;m++)for(var n=0;n<this.feature._rings[m].length-1;n++)if(i=[this.feature._rings[m][n],this.feature._rings[m][n+1]],j.x=a.layerPoint.x-this.feature._rings[m][n].x,j.y=a.layerPoint.y-this.feature._rings[m][n].y,k.x=a.layerPoint.x-this.feature._rings[m][n+1].x,k.y=a.layerPoint.y-this.feature._rings[m][n+1].y,d=j.x*k.x+j.y*k.y,e=L.LineUtil.pointToSegmentDistance(a.layerPoint,L.point(this.feature._rings[m][n].x,this.feature._rings[m][n].y),L.point(this.feature._rings[m][n+1].x,this.feature._rings[m][n+1].y)).toFixed(0),0>=d&&Number(e)<=1){for(h in this.editLayer._layers)this.editLayer._layers[h]._latlng.lat===this.feature._latlngs[n].lat&&this.editLayer._layers[h]._latlng.lng===this.feature._latlngs[n].lng&&(f=this.editLayer._layers[h]),this.editLayer._layers[h]._latlng.lat===this.feature._latlngs[n+1].lat&&this.editLayer._layers[h]._latlng.lng===this.feature._latlngs[n+1].lng&&(g=this.editLayer._layers[h]);this.addNonMiddleMarker(f,g,l,this.feature._latlngs)}}else if("Polygon"===b.geometry.type||"MultiPolygon"===b.geometry.type)for(var o=0;o<this.feature._rings.length;o++){for(var p=[],q=[],r=0;r<this.feature._rings[o].length;r++)p.push(this.feature._rings[o][r]),q.push(this.feature._latlngs[o][r]);p.push(this.feature._rings[o][0]),q.push(this.feature._latlngs[o][0]);for(var s=0;s<p.length-1;s++)if(i=[p[s],p[s+1]],j.x=a.layerPoint.x-p[s].x,j.y=a.layerPoint.y-p[s].y,k.x=a.layerPoint.x-p[s+1].x,k.y=a.layerPoint.y-p[s+1].y,d=j.x*k.x+j.y*k.y,e=L.LineUtil.pointToSegmentDistance(a.layerPoint,L.point(p[s].x,p[s].y),L.point(p[s+1].x,p[s+1].y)).toFixed(0),0>=d&&Number(e)<=1){for(h in this.editLayer._layers)this.editLayer._layers[h]._latlng.lat===q[s].lat&&this.editLayer._layers[h]._latlng.lng===q[s].lng&&(f=this.editLayer._layers[h]),this.editLayer._layers[h]._latlng.lat===q[s+1].lat&&this.editLayer._layers[h]._latlng.lng===q[s+1].lng&&(g=this.editLayer._layers[h]);this.addNonMiddleMarker(f,g,l,this.feature._latlngs[o])}}},this)},endDrawing:function(){this.tools.detachForwardLineGuide(),this.tools.detachBackwardLineGuide(),this._drawnLatLngs&&this._drawnLatLngs.length<this.MIN_VERTEX&&this.deleteShape(this._drawnLatLngs),L.Editable.BaseEditor.prototype.endDrawing.call(this),this.onPathClick(),delete this._drawnLatLngs}},L.MeasureablePolylineEditorClass=L.Editable.PolylineEditor.extend({includes:L.MeasurablePathEditorInclude}),L.MeasureablePolygonEditorClass=L.Editable.PolygonEditor.extend({includes:L.MeasurablePathEditorInclude}),L.Measurable=L.Editable.extend({options:{vertexMarkerClass:L.MeasureVertex,polylineClass:L.MeasureLine,polygonClass:L.MeasurePolygon,middleMarkerClass:L.MeasureMiddleVertex,polylineEditorClass:L.MeasureablePolylineEditorClass,polygonEditorClass:L.MeasureablePolygonEditorClass,lineGuideOptions:{color:"#006FB8"},skipMiddleMarkers:!0,labelStyle:{rec:{rx:1,ry:1,stroke:"#006FB8","stroke-width":"1px",fill:"white"},text:{fill:"#3d3d3d","fill-opacity":1,"text-anchor":"middle","font-size":"13px","font-family":"Roboto"}}},initialize:function(a,b){L.Editable.prototype.initialize.call(this,a),L.setOptions(this,b),a.options.polylineEditorClass=this.options.polylineEditorClass,a.options.polygonEditorClass=this.options.polygonEditorClass,a.measureTools=this,this.map=a,this.endedPoint={}},initBaseListeners:function(){var a=this;this.map.doubleClickZoom&&this.map.doubleClickZoom.disable(),this.map.touchZoom&&this.map.touchZoom.disable(),this.on("editable:drawing:commit editable:vertex:dragend editable:vertex:clicked",function(){a.layerPoint.removeLabel("vertex")}),this.on("editable:drawing:commit",function(){})},startPolyline:function(){var a=this;this.initBaseListeners(),this.on("editable:drawing:start",function(){a.on("editable:drawing:move",a.getMeasureLength)}),this.on("editable:drawing:commit",this._endPolyline,this),L.Editable.prototype.startPolyline.call(this)},_endPolyline:function(){var a=this;this.map.setZoom(10),this.off("editable:drawing:move",this.getMeasureLength),this.createEndedLabel(this,"Polyline"),this.featuresLayer.eachLayer(function(b){b.toGeoJSON&&b.toGeoJSON().geometry&&"LineString"===b.toGeoJSON().geometry.type&&b.on({mousemove:a.getMeasureLength,mouseover:a.getMeasureLength,mouseout:a.getMeasureLength})})},startPolygon:function(){var a=this;this.initBaseListeners(),this.on("editable:drawing:start",function(){a.on("editable:drawing:move",a.getMeasureArea)}),this.on("editable:drawing:commit",function(){a.off("editable:drawing:move",a.getMeasureArea),a.map.off("dblclick",a._dispatchDblick,this),a.createEndedLabel(this,"Polygon")}),L.Editable.prototype.startPolygon.call(this)},_dispatchDblick:function(){this._endPolyline()},getMeasureLength:function(a){var b=[];b[0]=a.latlng;var c,d,e;d=this.map?this.map:this._map,a.target.latlngs?c=a.target.latlngs:a.target._latlngs?c=a.target._latlngs:a.layer._defaultShape()&&(c=a.layer._defaultShape());var f=[];if("editable:drawing:move"===a.type)f=c.concat(b);else if(!a.target._icon&&"mouseover"===a.type||"mousemove"===a.type||"mouseout"!==a.type&&a.target._path)for(var g=1;g<a.target._parts[0].length;g++){var h=a.layerPoint,i=a.target._parts[0][g-1],j=a.target._parts[0][g],k=L.LineUtil.pointToSegmentDistance(h,i,j,!0);if(5>k)for(var l=1;l<c.length;l++)f=[c[g-1],c[g]]}else{for(var m,n=0;n<c.length;n++){a.latlng;c[n].lat===a.latlng.lat&&(m=n)}f=c.slice(0,m+1)}for(var o=0;o<f.length;o++)this.layerPoint&&this.layerPoint.removeLabel("vertex");if("mouseout"===a.type)return void this.layerPoint.removeLabel("vertex");var p=L.GeoUtil.readableDistance(L.GeoUtil.lineLength(d,f));this.layerPoint=d.latLngToLayerPoint(a.latlng);var q;if(e=a.target._path?"Длина сегмента: ":"Расстояние: ",q=void 0!==this.options&&void 0!==this.options.labelStyle?this.options.labelStyle:this.editor.options.editTools.options.labelStyle,void 0!==f[f.length-1])this.layerPoint.newLabel(e+p,!0,"vertex",null,q);else if(!f[f.length-1]&&f.length>1)this.layerPoint.newLabel(e+p,!0,"vertex",null,q);else if(void 0===f[f.length-1])return},getMeasureArea:function(a){var b=[];b[0]=a.latlng;var c,d;d=this.map?this.map:this._map,a.target.latlngs?c=a.target.latlngs:a.target._latlngs?c=a.target._latlngs[0]:a.layer._defaultShape()&&(c=a.layer._defaultShape());var e=[];e="editable:drawing:move"===a.type?c.concat(b):c;for(var f=0;f<e.length;f++)this.layerPoint&&this.layerPoint.removeLabel("vertex");if("mouseout"===a.type)return void this.layerPoint.removeLabel("vertex");var g=[L.GeoUtil.readableArea(L.GeoUtil.geodesicArea(e)),L.GeoUtil.readableDistance(L.GeoUtil.lineLength(d,e.concat(e[0])))],h=this.options.labelStyle;if(void 0!==e[e.length-1].__vertex)this.layerPoint=d.latLngToLayerPoint(a.latlng),this.layerPoint.newLabel(g,!0,"vertex",null,h);else if(!e[e.length-1].__vertex&&e.length>1)this.layerPoint=d.latLngToLayerPoint(a.latlng),this.layerPoint.newLabel(g,!0,"vertex",null,h);else if(void 0===e[e.length-1].__vertex)return;this.layerPoint.newLabel(g,!0,"vertex",null,h)},createEndedLabel:function(a,b){function c(a){var b,c=j.options.labelStyle;if("zoomend"!==a.type){var d=a.layer;if(b=d._leaflet_id,this.endedPoint.removeLabelById(b),"editable:vertex:dragstart"===a.type)return;g=a.layer._defaultShape(),h="Расстояние: "+L.GeoUtil.readableDistance(L.GeoUtil.lineLength(this.map,g));var e=$(".leaflet-map-pane").css("transform").replace("(",",").replace(")","").split(",");this.endedPoint=this.map.latLngToContainerPoint(g[g.length-1]),this.endedPoint.x=this.endedPoint.x-e[e.length-2],this.endedPoint.y=this.endedPoint.y-e[e.length-1],this.endedPoint.newLabel(h,!0,"endedPoint",b,c)}else this.map.eachLayer(function(a){if(a.labeled===!0&&a.toGeoJSON&&"LineString"===a.toGeoJSON().geometry.type){b=a._leaflet_id,j.endedPoint.removeLabelById(b),g=a._defaultShape(),h="Расстояние: "+L.GeoUtil.readableDistance(L.GeoUtil.lineLength(j.map,g));var d=$(".leaflet-map-pane").css("transform").replace("(",",").replace(")","").split(",");j.endedPoint=j.map.latLngToContainerPoint(g[g.length-1]),j.endedPoint.x=j.endedPoint.x-d[d.length-2],j.endedPoint.y=j.endedPoint.y-d[d.length-1],j.endedPoint.newLabel(h,!0,"endedPoint",b,c)}})}function d(a){var b={};for(var c in j.options.labelStyle)b[c]=j.options.labelStyle[c];b.forPolygon=!0,b.notVertex=!0;var d;if("zoomend"!==a.type){var e=a.layer;if(d=e._leaflet_id,this.endedPoint.removeLabelById(d),"editable:vertex:dragstart"===a.type)return;g=e._defaultShape();for(var f=[],k=0;k<g.length;k++)f.push(g[k]);f.push(g[0]),h=[i=L.GeoUtil.readableArea(L.GeoUtil.geodesicArea(f)),L.GeoUtil.readableDistance(L.GeoUtil.lineLength(this.map,f))];var l=$(".leaflet-map-pane").css("transform").replace("(",",").replace(")","").split(",");setTimeout(function(){j.endedPoint=j.map.latLngToContainerPoint(e.getCenter()),j.endedPoint.x=j.endedPoint.x-l[l.length-2],j.endedPoint.y=j.endedPoint.y-l[l.length-1],j.endedPoint.newLabel(h,!0,"endedPoint",d,b)},0)}else this.map.eachLayer(function(a){if(a.labeled===!0&&a.toGeoJSON&&"Polygon"===a.toGeoJSON().geometry.type){d=a._leaflet_id,j.endedPoint.removeLabelById(d),g=a._defaultShape();for(var c=[],e=0;e<g.length;e++)c.push(g[e]);c.push(g[0]),h=[i=L.GeoUtil.readableArea(L.GeoUtil.geodesicArea(c)),L.GeoUtil.readableDistance(L.GeoUtil.lineLength(j.map,c))];var f=$(".leaflet-map-pane").css("transform").replace("(",",").replace(")","").split(",");j.endedPoint=j.map.latLngToContainerPoint(a.getCenter()),j.endedPoint.x=j.endedPoint.x-f[f.length-2],j.endedPoint.y=j.endedPoint.y-f[f.length-1],j.endedPoint.newLabel(h,!0,"endedPoint",d,b)}})}function e(a){return"Polyline"===b?c.call(this,a):"Polygon"===b?d.call(this,a):void 0}function f(a){var b=a.layerPoint.x,c=a.layerPoint.y,d=this.endedPoint.rectangleRegion._groups[0][0].width.baseVal.value,g=this.endedPoint.rectangleRegion._groups[0][0].height.baseVal.value,h=this.endedPoint.rectangleRegion._groups[0][0].x.baseVal.value,i=this.endedPoint.rectangleRegion._groups[0][0].y.baseVal.value,j=this._pointIntersectionMath([b,c],[[h,i],[h+d,i],[h+d,i+g],[h,i+g]]);if(j===!0){var l=this;this.endedPoint.removeLabelById(k),this.map.eachLayer(function(a){a._leaflet_id.toString()===k.toString()&&(a.labeled=!1,l.layerPoint.removeLabel("vertex"),a.remove(),delete l.map.editTools.featuresLayer._layers[a._leaflet_id])}),this.map.off("zoomend",e,this),this.map.off("click",f,this),this.off("editable:vertex:dragstart editable:vertex:deleted editable:vertex:dragend",e)}}var g,h,i,j=this,k=a.featuresLayer._layers[Object.keys(a.featuresLayer._layers)[0]]._leaflet_id,l=$(".leaflet-map-pane").css("transform").replace("(",",").replace(")","").split(",");if(g=a.featuresLayer._layers[Object.keys(a.featuresLayer._layers)[0]]._defaultShape(),a.featuresLayer._layers[Object.keys(a.featuresLayer._layers)[0]].labeled=!0,"Polyline"===b)h="Расстояние: "+L.GeoUtil.readableDistance(L.GeoUtil.lineLength(this.map,g)),this.endedPoint=this.map.latLngToContainerPoint(g[g.length-1]);else if("Polygon"===b){for(var m=[],n=0;n<g.length;n++)m.push(g[n]);m.push(g[0]),h=[L.GeoUtil.readableArea(L.GeoUtil.geodesicArea(m)),L.GeoUtil.readableDistance(L.GeoUtil.lineLength(this.map,m))],this.endedPoint=this.map.latLngToContainerPoint(a.featuresLayer._layers[k].getCenter())}this.endedPoint.x=this.endedPoint.x-l[l.length-2],this.endedPoint.y=this.endedPoint.y-l[l.length-1];var o={};for(var p in j.options.labelStyle)o[p]=j.options.labelStyle[p];o.forPolygon=!0,o.notVertex=!0,this.endedPoint.newLabel(h,!0,"endedPoint",k,o),this.map.on("zoomend",e,this),this.map.on("click",f,this),this.on("editable:vertex:dragstart editable:vertex:deleted editable:vertex:dragend",e)},_pointIntersectionMath:function(a,b){for(var c=a[0],d=a[1],e=!1,f=0,g=b.length-1;f<b.length;g=f++){var h=b[f][0],i=b[f][1],j=b[g][0],k=b[g][1],l=i>d!=k>d&&(j-h)*(d-i)/(k-i)+h>c;l&&(e=!e)}return e}}),L.Point.prototype.newLabel=function(a,b,c,d,e){function f(a,b){a.each(function(){for(var a=d3.select(this),c=h.split("/").reverse(),d=!0,e=[],f=0,g=1.1,i=a.attr("x"),j=a.attr("y"),k=0,l=a.text(null).append("tspan").attr("x",i).attr("y",j).attr("dy",k+"em");d;)d=c.pop(),e.push(d),l.text(e.join(" ")),l.node().getComputedTextLength()>b&&(e.pop(),l.text(e.join("/")),e=[d],l=a.append("tspan").attr("x",i).attr("y",j).attr("dy",++f*g+k+"em").text(d))})}var g=this;if((0!==g.x||0!==g.y)&&void 0!==a){a.isArray||(a.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)});var h,i,j;a.isArray?(h="Площадь: "+a[0]+"/Периметр: "+a[1],e&&e.forPolygon&&e.forPolygon===!0&&void 0!==e.notVertex?(i=0,j=0):(i=80,j=30)):(h=a,e&&e.forPolyline&&e.forPolyline===!0?(i=0,j=0):(i=40,j=15));var k=d3.select("svg").append("g").attr("class","leaflet-measure-measurmentLabel"+c);(void 0!==d||null!==d)&&k.attr("id","measurmentLabel"+d);var l;b===!0&&(l=k.append("rect"));var m=k.append("text").attr("x",g.x+i).attr("y",g.y-j).attr("class","leaflet-measure-label-text").call(f,180);if(e.text)for(var n in e.text)m.style(n,e.text[n]);var o;if(null!==m.node()){if(o=m.node().getBBox(),b===!0){var p=o.width+6,q=o.height+2;if(l.attr("class","leaflet-measure-label-rectangle").attr("width",p+5).attr("height",q).attr("x",o.x-5).attr("y",o.y-1),e.rec)for(var r in e.rec)l.style(r,e.rec[r])}void 0!==d&&l.attr("id",d),this.rectangleRegion=l}}},L.Point.prototype.removeLabel=function(a){var b=$(".leaflet-measure-measurmentLabel"+a);b&&b.remove()},L.Point.prototype.removeLabelById=function(a){var b=$("#measurmentLabel"+a);b&&b.remove()},L.GeoUtil=L.extend(L.GeoUtil||{},{geodesicArea:function(a){var b,c,d=a.length,e=0,f=Math.PI/180;if(d>2){for(var g=0;d>g;g++)b=a[g],c=a[(g+1)%d],e+=(c.lng-b.lng)*f*(2+Math.sin(b.lat*f)+Math.sin(c.lat*f));e=e*L.Projection.SphericalMercator.R*L.Projection.SphericalMercator.R/2}return Math.abs(e)},readableArea:function(a){var b;return 1e4>a?b=L._("{area} м²",{area:a.toFixed(3)}):(a/=1e6,b=L._("{area} км²",{area:a.toFixed(3)})),b},readableDistance:function(a,b){var c;return c=a>1e4?L._("{distance} км",{distance:(a/1e3).toFixed(3)}):L._("{distance} м",{distance:(a/1).toFixed(2)})},lineLength:function(a,b){for(var c,d,e=0,f=0;f<b.length;f++)c=b[f],d&&(e+=a.distance(c,d)),d=c;return e}}),L._=L._||function(a,b){return L.Util.template(a,b)},MapExpress.Tools.LineMeasureCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a),c=L.DomUtil.create("img",!1,b);return c.setAttribute("src","images/rulers.png"),b.setAttribute("title","Измерение расстояний"),b.setAttribute("id","measureLenghtCommand"),b},activate:function(){this.measurable&&delete this.measurable,this.measurable=new L.Measurable(this._mapManager._map).startPolyline()}}),MapExpress.Tools.SqrtMeasureCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a),c=L.DomUtil.create("img",!1,b);return c.setAttribute("src","images/Polygon.png"),b.setAttribute("title","Измерение площади"),b.setAttribute("id","measureSqrtCommand"),b},activate:function(){this.measurable&&delete this.measurable,this.measurable=new L.Measurable(this._mapManager._map).startPolygon()}});