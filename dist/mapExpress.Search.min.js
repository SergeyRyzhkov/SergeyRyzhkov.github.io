MapExpress.Search.BaseSearchProvider=L.Class.extend({initialize:function(a,b){this.map=a,this.name=b},getName:function(a){return this.name},getDataByMask:function(a){},getDataByMaskAsynch:function(a){},processResult:function(a,b){function c(){this.resultLayer&&(MapManager._map.removeLayer(this.resultLayer),delete this.resultLayer)}if(c.call(this),"Point"===a.geojson.type){b={iconSize:[12,12],color:"blue"};var d=[];d[0]=a.geojson.coordinates[1],d[1]=a.geojson.coordinates[0],this.map.setView(d,17),this.resultLayer=MapManager.addPulseMarker(d,5e3,b)}else{var e=b.drawStyleOptions;this.resultLayer=L.geoJson(a.geojson,{style:e}).addTo(this.map),this.map.fitBounds(this.resultLayer.getBounds())}this.map.getZoom()>20&&this.map.setZoom(19),window.setTimeout(c.bind(this),5e3)}}),MapExpress.Search.CadastrSearchProviderPPK5=MapExpress.Search.BaseSearchProvider.extend({initialize:function(a,b){MapExpress.Search.BaseSearchProvider.prototype.initialize.call(this,a,b)},getDataByMaskAsynch:function(a){function b(){function b(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}var d={text:a,tolerance:"16391",limit:15,callback:"JQuery"+b()+b()},e=[];this[d.callback]=function(a){},$.ajax({url:"https://pkk5.rosreestr.ru/api/features/1?",type:"GET",data:d,dataType:"jsonp",jsonpCallback:d.callback,crossDomain:!0,success:function(a){a.features.length>0?($.each(a.features,function(a,b){var c=L.Projection.SphericalMercator.unproject(L.point(b.center.x,b.center.y));e.push({display_name:b.attrs.cn,type:"Feature",geojson:{type:"Point",coordinates:[c[Object.keys(c)[1]],c[Object.keys(c)[0]]]},properties:{cn:b.attrs.cn,address:b.attrs.address,id:b.attrs.id,extent:b.extent,sort:b.sort,type:b.type}})}),c.resolve(e)):c.resolve([])},error:function(a){c.reject(" Failed: "+a)}})}var c=$.Deferred();return b(),c.promise()}}),MapExpress.Search.GeojsonSearchProvider=MapExpress.Search.BaseSearchProvider.extend({initialize:function(a,b,c){MapExpress.Search.BaseSearchProvider.prototype.initialize.call(this,a,b),this.geojsonLayer=c.layer,this.attributeKey=c.attributeKey},getDataByMaskAsynch:function(a){function b(b,c){if(b.feature.properties[c].toString().toLowerCase().indexOf(a.toString().toLowerCase())>-1){b.feature.display_name=b.feature.properties[c],b.feature.geojson=b.feature.geometry,b.feature.leafletId=b._leaflet_id;for(var e=d.length-1;e>=0;e--)if(d[e].leafletId===b._leaflet_id)return;d.push(b.feature)}}var c=$.Deferred(),d=[],e=this;return setTimeout(function(){e.geojsonLayer.eachLayer(function(a){if("[object Array]"===Object.prototype.toString.call(e.attributeKey))for(var c=0;c<e.attributeKey.length;c++)a.feature.properties[e.attributeKey[c]]&&b.call(e,a,e.attributeKey[c]);else if(void 0===e.attributeKey)for(var d in a.feature.properties)a.feature.properties[d]&&b.call(e,a,d);else b.call(e,a,e.attributeKey)}),c.resolve(d)},0),c.promise()}}),MapExpress.Search.CadastrAddressSearchProvider=MapExpress.Search.BaseSearchProvider.extend({initialize:function(a,b){MapExpress.Search.BaseSearchProvider.prototype.initialize.call(this,a,b)},getDataByMaskAsynch:function(a){function b(){var b=this.getUrlOptions(a),d=[];$.ajax({url:"http://pkk5.rosreestr.ru/arcgis/rest/services/Address/gkn/GeocodeServer/findAddressCandidates?",type:"GET",data:b,dataType:"json",success:function(a){a.candidates.length>0?($.each(a.candidates,function(a,b){d.push({display_name:b.address,type:"Feature",geojson:{type:"Point",coordinates:[b.location.x,b.location.y]},properties:{attributes:b.attributes,extent:b.extent}})}),c.resolve(d)):c.resolve([])},error:function(){}})}var c=$.Deferred();return b(),c.promise()},getUrlOptions:function(a){return{Address:"",Postal:"",City:"",Province:"",Region:"",SingleLine:a,category:"",outFields:"*",maxLocations:100,outSR:"",searchExtent:"",location:"",distance:"",magicKey:"",f:"pjson"}}}),MapExpress.Search.GoogleSearchProvider=MapExpress.Search.BaseSearchProvider.extend({initialize:function(a,b){MapExpress.Search.BaseSearchProvider.prototype.initialize.call(this,a,b)},getDataByMaskAsynch:function(a){function b(){function b(a){return Object.keys(a.geometry.location).map(function(b){return a.geometry.location[b]}).reverse()}var d={address:a+"%",language:"ru",region:"ru",limit:24},e=[];$.ajax({url:"https://maps.googleapis.com/maps/api/geocode/json?",type:"GET",data:d,async:!1,dataType:"json",success:function(a){if(a.results.length>0){for(var d=0;d<a.results.length;d++)e.push({id:a.results[d].index,display_name:a.results[d].formatted_address,type:"Feature",geojson:{type:"Point",coordinates:b(a.results[d])},properties:{addresscomponents:a.results[d].addresscomponents,bounds:a.results[d].geometry.bounds,viewport:a.results[d].geometry.viewport,types:a.results[d].types,place_id:a.results[d].place_id}});c.resolve(e)}else c.resolve([])},error:function(a){c.reject(" Failed: "+a)}})}var c=$.Deferred();return b(),c.promise()}}),MapExpress.Search.OsmSearchProvider=MapExpress.Search.BaseSearchProvider.extend({initialize:function(a,b){MapExpress.Search.BaseSearchProvider.prototype.initialize.call(this,a,b)},getDataByMaskAsynch:function(a){function b(){var b={q:a+"%",format:"json",limit:15,addressdetails:1,polygon_geojson:1};$.ajax({url:"http://nominatim.openstreetmap.org/search.php?",type:"GET",data:b,dataType:"json",success:function(a){c.resolve(a)},error:function(a){c.reject(" Failed: "+a)}})}var c=$.Deferred();return b(),c.promise()}});var geoJSONAutoComplete=function(a){};geoJSONAutoComplete.prototype={initialize:function(a,b){this.options=a,this.activeSearchProvider=a.startProvider,void 0===a.drawStyleOptions&&(a.drawStyleOptions={color:"blue",weight:2,opacity:.65,fillColor:"red",fillOpacity:.2}),this.options.delay=300,this.options.limitToShowResults=25,this.features=[];var c=$(b.toString()).addClass("mapExpress-searchContainer");c.append('<input id="mapExpress-searchBox" class="mapExpress-searchBox" />'),c.append('<span class="mapExpress-divider"></span>'),c.append('<input id="mapExpress-clearButton" class="mapExpress-clearButton" type="submit" value=""/>'),c.append('<span class="mapExpress-divider"></span>'),c.append('<span class="mapExpress-searchServices"/>'),this.createSearchProviderList(),this.searchBoxManage()},createSearchProviderList:function(){for(var a,b,c=this,d=$(".mapExpress-searchServices").attr("title","Сервис поиска: "+this.activeSearchProvider.getName()),e=$("<ul/>").addClass("mapExpress-searchServicesList").appendTo(d).hide(),f=0;f<this.options.providers.length;f++)this.options.providers[f].getName()===this.activeSearchProvider.getName()?(b=$("<li/>").appendTo(e),a=$("<a />").addClass("mapExpress-activeSearchProvider").text(this.activeSearchProvider.getName()).appendTo(b)):(b=$("<li/>").appendTo(e),a=$("<a />").addClass("mapExpress-SearchProvider").text(this.options.providers[f].getName()).appendTo(b));return $(".mapExpress-searchServices").click(function(){$(".mapExpress-resultsDiv").hide(),e.is(":visible")?e.hide():e.show()}),$(e).click(function(a){if(a.stopPropagation(),"mapExpress-searchServicesList"!==$(a.target).attr("class"))if("mapExpress-SearchProvider"===$(a.target).attr("class")||"mapExpress-activeSearchProvider"===$(a.target).attr("class")){$(".mapExpress-activeSearchProvider").attr("class","mapExpress-SearchProvider"),$(a.target).attr("class","mapExpress-activeSearchProvider");for(var b=c.options.providers.length-1;b>=0;b--)c.options.providers[b].getName()===$(".mapExpress-activeSearchProvider").text()&&(c.activeSearchProvider=c.options.providers[b],$(".mapExpress-searchBox")[0].placeholder="Сервис поиска: "+c.activeSearchProvider.getName(),$(".mapExpress-searchServices").attr("title","Сервис поиска: "+c.activeSearchProvider.getName()));c.clearDivClick(),e.hide()}else e.hide()}),$(document).click(function(){e.is(":visible")&&e.hide()}),e.html()},searchBoxManage:function(){var a=$(".mapExpress-searchBox"),b=this;a[0].placeholder="Сервис поиска: "+b.activeSearchProvider.getName(),a.delayKeyup=function(a,b){var c=0;return $(this).keyup(function(d){13!==d.keyCode&&38!==d.keyCode&&40!==d.keyCode?(clearTimeout(c),c=setTimeout(function(){a(d)},b)):a(d)}),$(this)},a.value="",a.delayKeyup(function(c){switch(c.keyCode){case 13:b.getValuesAsGeoJson();break;default:a[0].value.length>0?b.getValuesAsGeoJson():b.clearDivClick()}},b.options.delay),a.focus(function(){void 0!==$(".mapExpress-resultsDiv")[0]&&($(".mapExpress-resultsDiv")[0].style.visibility="visible")}),a.blur(function(){void 0!==$(".mapExpress-resultsDiv")[0]&&window.setTimeout(function(){a.focus()},0)}),$("#mapExpress-clearButton").click(function(){b.clearDivClick()}),a.click(function(){b.features.length>0&&b.createDropDown(b.features)}),$(document).click(function(){$(".mapExpress-resultsDiv").is(":visible")&&$(".mapExpress-resultsDiv").hide()})},clearDivClick:function(){$(".mapExpress-resultsDiv").remove(),this.features=[],$(".mapExpress-searchBox")[0].value=""},getValuesAsGeoJson:function(){var a=this,b=$(".mapExpress-searchBox")[0].value;this.activeSearchProvider.getDataByMaskAsynch(b).then(function(b){a.features=b,b.length>0?a.createDropDown(b):a.processNoRecordsFoundOrError()},function(b){a.processNoRecordsFoundOrError()})},createDropDown:function(a){var b=this;$(".mapExpress-searchServicesList").hide(),$(".mapExpress-resultList").remove(),$(".mapExpress-resultsDiv").remove();for(var c=$(".mapExpress-searchContainer"),d=$("<div/>").addClass("mapExpress-resultsDiv").appendTo(c),e=$("<ul/>").addClass("mapExpress-resultList").appendTo(d),f=0;f<a.length;f++){if(f>b.options.limitToShowResults)return;var g=$("<li />").attr("id","mapExpress-listelement"+f).addClass("mapExpress-listelement").appendTo(e),h=$("<span />").addClass("mapExpress-content").appendTo(g);$("<img />").addClass("mapExpress-listElementContentImage").attr("src","images/"+a[f].geojson.type+".png").attr("align","middle").appendTo(h),$("<font />").addClass("mapExpress-listElementContentText").text(a[f].display_name).appendTo(h)}$(".mapExpress-listelement").click(function(a){if("mapExpress-listelement"===$(a.target).attr("class"))b.dropDownManage(a.target);else{if("content"!==$(a.target).attr("class")&&"mapExpress-listElementContentText"!==$(a.target).attr("class"))return;b.dropDownManage(a.currentTarget)}})},dropDownManage:function(a){var b=parseInt(a.id.substr(22));this.activeSearchProvider.processResult(this.features[b],this.options),$(".mapExpress-searchBox")[0].value=this.features[b].display_name,$(".mapExpress-resultsDiv").remove()},processNoRecordsFoundOrError:function(){$(".mapExpress-resultsDiv").remove();var a=$("<div/>").addClass("mapExpress-resultsDiv").appendTo($(".mapExpress-searchContainer")),b=$("<ul/>").addClass("mapExpress-resultList").appendTo(a),c=$("<li />").addClass("mapExpress-listelementError").appendTo(b),d=$("<span />").addClass("mapExpress-content").appendTo(c);$("<font />").addClass("mapExpress-listElementContentText").text("По вашему запросу ничего не найдено").appendTo(d)}},MapExpress.Search.YandexSearchProvider=MapExpress.Search.BaseSearchProvider.extend({initialize:function(a,b){MapExpress.Search.BaseSearchProvider.prototype.initialize.call(this,a,b)},getDataByMaskAsynch:function(a){function b(){var b={geocode:a+"%",format:"json",results:24},d=[];$.ajax({url:"https://geocode-maps.yandex.ru/1.x/?",type:"GET",data:b,async:!1,dataType:"json",success:function(a){if(a.response.GeoObjectCollection.featureMember.length>0){for(var b=0;b<a.response.GeoObjectCollection.featureMember.length;b++)d.push({id:a.response.GeoObjectCollection.featureMember[b].index,display_name:a.response.GeoObjectCollection.featureMember[b].GeoObject.metaDataProperty.GeocoderMetaData.text,type:"Feature",geojson:{type:"Point",coordinates:a.response.GeoObjectCollection.featureMember[b].GeoObject.Point.pos.split(" ")},properties:{bounds:a.response.GeoObjectCollection.featureMember[b].GeoObject.boundedBy.Envelope,descr:a.response.GeoObjectCollection.featureMember[b].GeoObject.description,metaData:a.response.GeoObjectCollection.featureMember[b].GeoObject.metaDataProperty.GeocoderMetaData,names:a.response.GeoObjectCollection.featureMember[b].GeoObject.name}});c.resolve(d)}else c.resolve([])},error:function(a){c.reject(" Failed: "+a)}})}var c=$.Deferred();return b(),c.promise()}});