MapExpress.Tools.LineEditCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a),c=L.DomUtil.create("img",!1,b);return c.setAttribute("src","images/rulers.png"),b.setAttribute("title","Создание линий"),b.setAttribute("id","lineEditCommand"),b},activate:function(){new MapExpress.Service.LayerEditorManager(this._mapManager._map).startPolyline()}}),MapExpress.Tools.PoligonEditCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a),c=L.DomUtil.create("img",!1,b);return c.setAttribute("src","images/Polygon.png"),b.setAttribute("title","Создание полигонов"),b.setAttribute("id","poligonEditCommand"),b},activate:function(){new MapExpress.Service.LayerEditorManager(this._mapManager._map).startPolygon()}}),MapExpress.Tools.MarkerEditCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a),c=L.DomUtil.create("img",!1,b);return c.setAttribute("src","images/Point.png"),b.setAttribute("title","Создание маркеров"),b.setAttribute("id","markerEditCommand"),b},activate:function(){new MapExpress.Service.LayerEditorManager(this._mapManager._map).startMarker()}}),MapExpress.Tools.SaveChangesCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button"},initialize:function(a,b){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,a,b),L.setOptions(this,b)},createContent:function(a){var b=L.DomUtil.create("button",this.options.buttonClassName,a),c=L.DomUtil.create("img",!1,b);return c.setAttribute("src","images/1-1.png"),b.setAttribute("title","Сохранить изменения"),b.setAttribute("id","saveChangesCommand"),b},activate:function(){new MapExpress.Service.LayerEditorManager(this._mapManager._map).saveChanges()}}),MapExpress.Service.LayerEditorBase=L.Class.extend({options:{},initialize:function(a,b){this.url=a,this.setOptions(b)},setOptions:function(a){L.setOptions(this,a)},insert:function(a,b,c){},update:function(a,b,c){},remove:function(a,b){},save:function(a){},updateLayer:function(){}}),MapExpress.Service.layerEditorBase=function(a){return new MapExpress.Service.LayerEditorBase(a)},MapExpress.Service.LayerEditorManager=L.Editable.extend({options:{},initialize:function(a,b,c,d,e){L.Editable.prototype.initialize.call(this,a,e),this.setOptions(e),this.map=a,this.layer=b,this.layerEditor=new MapExpress.Service.LayerEditorWFST,this.initializeListeners()},setOptions:function(a){L.setOptions(this,a)},initializeListeners:function(){var a=this;if(this.map.editTools){this.map.on("editable:drawing:start",this.beforeStartDrawing,this),this.map.on("editable:drawing:commit",this.saveChanges,this),this.redoBuffer=[];var b,c=90,d=function(a){if(a.keyCode===c){if(!this.editTools._drawingEditor)return;a.shiftKey?this.redoBuffer.length&&this.editTools._drawingEditor.push(this.redoBuffer.pop()):(b=this.editTools._drawingEditor.pop(),b&&this.redoBuffer.push(b))}};L.DomEvent.addListener(document,"keydown",d,this.map),this.map.on("editable:drawing:end",function(){this.redoBuffer=[]}),this.map.on("editable:editing",function(a){a.layer.setStyle({color:"DarkRed"})}),this.layer.eachLayer(function(b){b.on({dblclick:function(){b.editEnabled()===!0?(a.saveChanges(b),b.disableEdit()):(a.beforeStartDrawing(),b.enableEdit(),b.setStyle({color:"red",weight:3}),setTimeout(function(){b.setStyle({color:"#800000",weight:1.04})},5e3))}})})}},beforeStartDrawing:function(){this.map.doubleClickZoom.disable(),this.map.dragging.disable()},startPolyline:function(){this.map.editTools.startPolyline.call(this)},startPolygon:function(){this.map.editTools.startPolygon.call(this)},startMarker:function(){this.map.editTools.startMarker.call(this)},stopDrawing:function(){this.map.editTools.stopDrawing()},commitDrawing:function(){this.save()},insertFeature:function(a,b,c){var d=a;this.layerEditor.insert(d,b,c)},updateFeature:function(a,b,c){var d;this.layerEditor.update(d,b,c)},removeFeature:function(a,b){var c,d;this.layerEditor.remove(c,d)},saveChanges:function(a){this.map.doubleClickZoom.enable(),this.map.dragging.enable(),this.layerEditor.remove("perm_water_polygon","10","http://geoserver.ics.perm.ru/geoserver/ows?")},updateLayer:function(){this.layerEditor.updateLayer()}}),MapExpress.Service.layerEditorManager=function(a){return new MapExpress.Service.LayerEditorManager(a)},MapExpress.Service.LayerEditorWFST=MapExpress.Service.LayerEditorBase.extend({options:{},initialize:function(a,b){this.url=a,this.setOptions(b),this.gmlNS="http://www.opengis.net/gml",this.wfsNS="http://www.opengis.net/wfs",this.ogcNS="http://www.opengis.net/ogc",this.gmlConverter=MapExpress.Utils.GeoFormatConvertor.gml},setOptions:function(a){L.setOptions(this,a)},insert:function(a,b,c,d){var e=this._createTransactionNode(),f=this._createXMLElement("wfs:Insert",this.wfsNS);e.appendChild(f);var g=this.gmlConverter.createNodeFromGeoJSONFeature(b,"osm_perm_region","perm_water_polygon",c.geometryAttributeName);f.appendChild(g);var h=(new XMLSerializer).serializeToString(e);$.ajax({url:d,data:h,type:"POST",contentType:"text/plain;charset=UTF-8",dataType:"text",success:function(a){console.log(a)},error:function(a,b,c){console.log(a.status),console.log(c)}})},update:function(a,b,c,d){var e=this._createTransactionNode(),f=this._createXMLElement("wfs:Update",this.wfsNS,{typeName:"osm_perm_region:perm_water_polygon"}),g=this._findValueInFeature(b,c);"object"==typeof g&&(g=this.gmlConverter.createGeometryNodeFromGeoJSONFeature(g)),e.appendChild(f),f.appendChild(this._createWfsProperty(c,g)),f.appendChild(this._createFilter(b.properties.id));var h=(new XMLSerializer).serializeToString(e);console.log(e),$.ajax({url:d,data:h,type:"POST",contentType:"text/plain;charset=UTF-8",dataType:"text",success:function(a){console.log(a)},error:function(a,b,c){console.log(a.status),console.log(c)}})},remove:function(a,b,c){var d=this._createTransactionNode(),e=this._createXMLElement("wfs:Delete",this.wfsNS,{typeName:"osm_perm_region:perm_water_polygon"});e.appendChild(this._createFilter("perm_water_polygon.6537")),d.appendChild(e);var f=(new XMLSerializer).serializeToString(d);return $.ajax({url:c,data:f,type:"POST",contentType:"text/plain;charset=UTF-8",dataType:"text",success:function(a){console.log(a)},error:function(a,b,c){console.log(a.status),console.log(c)}}),d},_createXMLElement:function(a,b,c){var d=this._createXMLdoc().createElementNS(b,a);if(void 0!==c)for(var e in c)d.setAttribute(e,c[e]);return d},_createXMLdoc:function(){var a=new DOMParser;return a.parseFromString("<root />","text/xml")},_createTransactionNode:function(){var a=this._createXMLElement("wfs:Transaction",this.wfsNS,{service:"WFS",version:"1.1.0"});return a},_createFilter:function(a){var b=this._createXMLElement("ogc:Filter",this.ogcNS);return b.appendChild(this._createXMLElement("ogc:GmlObjectId",this.ogcNS,{"gml:id":a,"xmlns:gml":"http://www.opengis.net/gml"})),b},_createWfsProperty:function(a,b){var c=this._createXMLElement("wfs:Property",this.wfsNS),d=this._createXMLElement("wfs:Name",this.wfsNS);d.textContent="osm_perm_region:ogr_geometry";var e=this._createXMLElement("wfs:Value",this.wfsNS);return"[object Element]"===b.toString()?e.appendChild(b):e.textContent=b,c.appendChild(d),c.appendChild(e),c},_findValueInFeature:function(a,b){var c;for(var d in a)d===b?c=a[d]:"object"==typeof a[d]&&null!==a[d]&&this._findValueInFeature(a[d],b);return c},save:function(a){},updateLayer:function(){}}),MapExpress.Service.layerEditorWFST=function(a){return new MapExpress.Service.LayerEditorWFST(a)};