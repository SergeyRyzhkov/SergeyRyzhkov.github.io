MapExpress.Controls.GeometryCoordinatesEdit=MapExpress.Controls.OkCancelDialog.extend({initialize:function(e,t,a){this._map=e,L.setOptions(this,t),this.options.footerEnabled=!0,this.options.headerEnabled=!0,this.options.modal=!1,this._initLayout(),this._initButtonGroup(),MapExpress.Controls.MapControlUtils.addClassName(this._controlContent,"mapexpress-control-content_notify"),this._createDomElements(),this.activeCoordinatesSystem=null,this.options.projListUrl?this.projsListViaAjax():this.standartProjList(),this.points=[],this.holes=[],a&&(this.controller=a),this.activeGeomShow=null},standartProjList:function(){var e=[],t=9e5;for(var a in window.CAD.DEFAULTS.projections)e.push(new L.Proj.CRS("EPSG:"+t,window.CAD.DEFAULTS.projections[a])),t++;this.cordinateSystems=[L.CRS.EPSG3395,L.CRS.EPSG3857,L.CRS.EPSG4326].concat(e),this.activeCoordinatesSystem=null},projsListViaAjax:function(){var r=this;MapExpress.Utils.Promise.Ajax(this.options.projListUrl).then(function(e){r.cordinateSystems=[],r.activeCoordinatesSystem=null;for(var t=0;t<e.length;t++)r.cordinateSystems.push(new L.Proj.CRS("EPSG:"+e[t].srid,e[t].proj4text)),r.cordinateSystems[t].title=e[t].name;for(var a=$("mapexpress-avaliable-coordinates-system").children(),o=a.length-1;0<=o;o--)$(a[o]).remove();r.createCoodinatesSystemList(),r._initCRSContol()},function(e){console.warn("Не удалось получить список систем координат."),r.standartProjList(),r.createCoodinatesSystemList(),r._initCRSContol()})},createCoodinatesSystemList:function(){$("#mapexpress-avaliable-coordinates-system").parent().hide();for(var e=0;e<this.cordinateSystems.length;e++){var t=$("<li/>");t.attr("id",this.cordinateSystems[e].code),"EPSG:3395"!==this.cordinateSystems[e].code||this.cordinateSystems[e].title?"EPSG:3857"!==this.cordinateSystems[e].code||this.cordinateSystems[e].title?"EPSG:4326"!==this.cordinateSystems[e].code||this.cordinateSystems[e].title||(this.cordinateSystems[e].title="WGS 84"):this.cordinateSystems[e].title="Pseudo-Mercator Сферический Меркатор":this.cordinateSystems[e].title="World Mercator на сфероиде",t.html(this.cordinateSystems[e].title||this.cordinateSystems[e].projection._proj.title),$("#mapexpress-avaliable-coordinates-system").append(t)}},_createDomElements:function(){var t=this;MapExpress.Controls.MapControlUtils.generateTemplate(window.REALTY_MAP_SITE_ROOT+"/Map/templates/GeometryCoordinatesControl.html","GeometryCoordinatesControl",null,function(e){t.setContent(e),$(".mapexpress-geometry-coordinates-points").prepend($('<div class="mapexpress-geometry-coordinates-pane-name">Добавить точки</div>').hide()),$(".mapexpress-geometry-coordinates-holes-points").prepend($('<div class="mapexpress-geometry-coordinates-pane-name">Добавить кольцо</div>').show()),t.options.projListUrl||(t.createCoodinatesSystemList(),t._initCRSContol()),$(".mapexpress-geometry-coordinates-controller").parent().css("overflow","auto"),t._initAddButtonListeners(),t._initClearButtonListeners(),t._initShowButtonListeners(),t._initMapListeners()})},setActiveCRS:function(e){var t=this,a=$(".mapexpress-geometry-coordinates-controller");for(var o=this.cordinateSystems.length-1;0<=o;o--)this.cordinateSystems[o].code===e&&(this.activeCoordinatesSystem=this.cordinateSystems[o]);$("#mapexpress-active-coordinates-system").val(this.activeCoordinatesSystem.title||this.activeCoordinatesSystem.projection._proj.title),function(){for(var e=t.points.length-1;0<=e;e--)t.points[e].lat&&t.points[e].lng&&(t.points[e].projectx=t.activeCoordinatesSystem.project(t.points[e]).x,t.points[e].projecty=t.activeCoordinatesSystem.project(t.points[e]).y,a.find("#mapexpress-add-geometry-coordinates-points-"+t.points[e].id).find(".mapexpress-point-lat").val(t.points[e].projecty),a.find("#mapexpress-add-geometry-coordinates-points-"+t.points[e].id).find(".mapexpress-point-lng").val(t.points[e].projectx))}()},_initCRSContol:function(){var t=this,e=this._map.options.crs.code;this.setActiveCRS(e);for(var o=$("#mapexpress-avaliable-coordinates-system").find("li"),a=o.length-1;0<=a;a--)$(o[a]).html()===e&&$(o[a]).addClass("active");$("#mapexpress-active-coordinates-system").on("click",function(){$("#mapexpress-avaliable-coordinates-system").parent().show()}),$("#mapexpress-avaliable-coordinates-system").find("li").on("click",function(e){$("#mapexpress-avaliable-coordinates-system").find("li").removeClass("active"),t.setActiveCRS($(e.currentTarget).attr("id")),$(e.currentTarget).addClass("active"),$("#mapexpress-avaliable-coordinates-system").parent().hide()}),$(document).on("click",function(e){"mapexpress-active-coordinates-system"!==$(e.target).attr("id")&&"mapexpress-avaliable-coordinates-system_autocomplete"!==$(e.target).attr("id")&&$("#mapexpress-avaliable-coordinates-system").parent().hide()}),$("#mapexpress-avaliable-coordinates-system_autocomplete").on("input",function(e){var t=$(e.currentTarget).val();if($(o).show(),""!==t&&null!=t)for(var a=0;a<$(o).length;a++)-1===$(o[a]).html().toLowerCase().indexOf(t.toLowerCase())&&$(o[a]).hide()})},_initAddButtonListeners:function(){var m=this;function u(e){var t,a,o,r=$(e.target);if(!0==(a=(t=r).val(),o=!0,isNaN(Number(a))&&(console.warn("Значение должно быть числовое"),t.val(""),o=!1),!!o||(t.val(""),!1))){for(var i=r.parent().attr("id").replace("mapexpress-add-geometry-coordinates-points-",""),n=r.attr("class").replace("mapexpress-point-",""),s=m.points.length-1;0<=s;s--)m.points[s].id===i&&("lat"===n?m.points[s].projecty=r.val():m.points[s].projectx=r.val(),m.points[s].lat=m.activeCoordinatesSystem.unproject(new L.Point(m.points[s].projectx,m.points[s].projecty)).lat,m.points[s].lng=m.activeCoordinatesSystem.unproject(new L.Point(m.points[s].projectx,m.points[s].projecty)).lng,m.fire("point:update",m.points[s]),m._map.fire("point:update",m.points[s]));m._showGeometryOnChange()}}function g(e){var a=$(e.currentTarget),t=a.parent().attr("id").replace("mapexpress-add-geometry-coordinates-points-",""),o=$(".mapexpress-geometry-coordinates-controller");function r(){var e=a.parent().parent().children().length;if(a.parent().parent().hasClass("mapexpress-geometry-coordinates-points")){if(2===e)return!0}else if(a.parent().parent().hasClass("mapexpress-geometry-coordinates-holes-points")&&1===e)return!0;return!1}function i(){a.parent().parent();for(var e=1,t=0;t<m.points.length;t++)m.points[t].num=e,e++,$("#mapexpress-add-geometry-coordinates-points-"+m.points[t].id).find(".mapexpress-point-label").html(m.points[t].num);m.fire("points:change:nums",{points:m.points}),m._map.fire("points:change:nums",{points:m.points})}a.parent().find("input").removeClass("invalid-value");for(var n=m.points.length-1;0<=n;n--)if(m.points[n].id===t)if(r()){m.fire("point:remove",m.points[n]),m._map.fire("point:remove",m.points[n]),m.points[n].lat=null,m.points[n].lng=null,m.points[n].projectx=null,m.points[n].projecty=null;o.find("#mapexpress-add-geometry-coordinates-points-"+t).find(".mapexpress-point-lat").val(""),o.find("#mapexpress-add-geometry-coordinates-points-"+t).find(".mapexpress-point-lng").val("")}else m.fire("point:remove",m.points[n]),m._map.fire("point:remove",m.points[n]),m.points.splice(n,1),a.parent().remove(),i();m._showGeometryOnChange()}function y(e){e.stopPropagation();var o=$(e.currentTarget).parent().attr("id").replace("mapexpress-add-geometry-coordinates-points-","");$(m._map.getContainer()).addClass("something-should-happen");var r=$(".mapexpress-geometry-coordinates-controller");m._map.once("click",function(e){$(m._map.getContainer()).removeClass("something-should-happen");for(var t=m.points.length-1;0<=t;t--)if(m.points[t].id===o){m.points[t].lat=e.latlng.lat,m.points[t].lng=e.latlng.lng;var a=m.activeCoordinatesSystem.project(e.latlng);m.points[t].projectx=a.x,m.points[t].projecty=a.y,r.find("#mapexpress-add-geometry-coordinates-points-"+o).find(".mapexpress-point-lat").val(m.points[t].projecty),r.find("#mapexpress-add-geometry-coordinates-points-"+o).find(".mapexpress-point-lng").val(m.points[t].projectx)}m._showGeometryOnChange()},m)}function e(){var e,t=$(".mapexpress-geometry-coordinates-points"),a=$(".mapexpress-geometry-coordinates-holes-points"),o=null;t.hasClass("mapexpress-geometry-coordinates_deactive")?(e=a,o=1):e=t;var r=Math.floor(65536*(1+Math.random())).toString(16).substring(1),i=$("<div/>");i.attr("id","mapexpress-add-geometry-coordinates-points-"+r);var n=$('<div class="mapexpress-add-point-map"><i class="mdi mdi-map-marker-radius"></i></div>'),s=$('<span class="mapexpress-point-label"/>'),d=$('<input class="mapexpress-point-lng" placeholder="Долгота (Х)" />'),l=$('<input class= "mapexpress-point-lat" placeholder="Широта (Y)" />'),p=$('<div class="mapexpress-remove-point-map"><i class="mdi mdi-close"></i></div>');i.append(n).append(s).append(d).append(l).append(p),e.append(i),p.click(g),n.bind("click",m,y),d.on("input",u),l.on("input",u);var c={id:r,num:e.parent().find("div[id^='mapexpress-add-geometry-coordinates-points']").length,lat:null,lng:null,projectx:null,projecty:null,hole:o};s.html(c.num),m.points.push(c)}$("#add-point-icon").on("click",e),e()},_initShowButtonListeners:function(){var t=this;function a(e){"mapexpress-add-point-map-clear-all"!==$(e.currentTarget).find("i").attr("id")&&($(".mapexpress-add-point-map-show").find("div").removeClass("active"),$(e.currentTarget).addClass("active"),t.activeGeomShow=$(e.currentTarget).find("i").attr("id").replace("mapexpress-add-point-map-show-as-",""),t._showGeometryOnChange())}$(".mapexpress-add-point-map-show").find("div").each(function(e,t){$(t).on("click",a)}),$(".mapexpress-add-point-map-show").find("#mapexpress-add-point-map-show-as-linestring").parent().addClass("active"),this.activeGeomShow="linestring"},_showGeometryOnChange:function(){var e=this;if(e.points.length){var t=this.activeGeomShow,a=e.points.map(function(e){return!(""===e.lat||!e.lat)&&(!(""===e.lng||!e.lng)&&e)}).filter(function(e){return e||!1});if(a.length)switch(t){case"point":e.fire("geometry:mustbeenshown:as:point",{points:a}),e._map.fire("geometry:mustbeenshown:as:point",{points:a});break;case"linestring":1===a.length?(e.fire("geometry:mustbeenshown:as:point",{points:a}),e._map.fire("geometry:mustbeenshown:as:point",{points:a})):(e.fire("geometry:mustbeenshown:as:linestring",{points:a}),e._map.fire("geometry:mustbeenshown:as:linestring",{points:a}));break;case"polygon":1===a.length?(e.fire("geometry:mustbeenshown:as:point",{points:a}),e._map.fire("geometry:mustbeenshown:as:point",{points:a})):(e.fire("geometry:mustbeenshown:as:polygon",{points:a}),e._map.fire("geometry:mustbeenshown:as:polygon",{points:a}))}}},_initMapListeners:function(){this._map.on("geometry:change",this._updatePoint,this)},_updatePoint:function(e){for(var t=$(".mapexpress-geometry-coordinates-controller"),a=e.point.id,o=this.points.length-1;0<=o;o--)if(this.points[o].id===a){var r=this.activeCoordinatesSystem.project(e.point);t.find("#mapexpress-add-geometry-coordinates-points-"+a).find(".mapexpress-point-lat").val(r.y),t.find("#mapexpress-add-geometry-coordinates-points-"+a).find(".mapexpress-point-lng").val(r.x);this.points[o].lat=e.point.lat,this.points[o].lng=e.point.lng}},clearControl:function(){for(var e=this.points.length-1;0<=e;e--)0!==e?($("#mapexpress-add-geometry-coordinates-points-"+this.points[e].id).remove(),this.points.splice(e,1)):($("#mapexpress-add-geometry-coordinates-points-"+this.points[e].id).find(".mapexpress-point-lat").val(""),$("#mapexpress-add-geometry-coordinates-points-"+this.points[e].id).find(".mapexpress-point-lng").val(""),this.points[e].lat=null,this.points[e].lng=null,this.points[e].projectx=null,this.points[e].projecty=null);this.fire("geometry:remove"),this._map.fire("geometry:remove")},removeListeners:function(){this._map.off("geometry:change",this._updatePoint,this)},clearControlAndController:function(){this.clearControl(),$(".mapexpress-geometry-coordinates-controller").remove(),this.removeListeners(),this.controller.removeListeners(),delete this.controller},_initClearButtonListeners:function(){var e=this;$("#mapexpress-add-point-map-clear-all").on("click",function(){e.clearControl()})}}),MapExpress.Controls.OkCancelDialogCustom=MapExpress.Controls.OkCancelDialog.extend({initialize:function(e,t){this._map=e,L.setOptions(this,t),this.options.footerEnabled=!0,this.options.headerEnabled=!0,this._initLayout(),this._initButtonGroup(),MapExpress.Controls.MapControlUtils.addClassName(this._controlContent,"mapexpress-control-content_notify")}}),MapExpress.Tools.EdgCoordsChangeCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button",id:"EdgCoordsChangeCommand",title:"Редактирование координат узла",imageSrc:"images/redactirovanie_coordinat_uzla.png",destroySelectionsOnDeactivate:!0,okButtonText:"ОК",cancelButtonText:"Отмена"},initialize:function(e,t){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.options.selectionStyle=(new MapExpress.Tools.SelectionCommand).options.selectionStyle,this.activeCoordinatesSystem=null,this.options.projListUrl?this.projsListViaAjax():this.standartProjList()},standartProjList:function(){var e=[],t=9e5;for(var a in window.CAD.DEFAULTS.projections)e.push(new L.Proj.CRS("EPSG:"+t,window.CAD.DEFAULTS.projections[a])),t++;this.cordinateSystems=[L.CRS.EPSG3395,L.CRS.EPSG3857,L.CRS.EPSG4326].concat(e),this.activeCoordinatesSystem=null},projsListViaAjax:function(){var a=this;MapExpress.Utils.Promise.Ajax(this.options.projListUrl).then(function(e){a.cordinateSystems=[],a.activeCoordinatesSystem=null;for(var t=0;t<e.length;t++)a.cordinateSystems.push(new L.Proj.CRS("EPSG:"+e[t].srid,e[t].proj4text)),a.cordinateSystems[t].title=e[t].name},function(e){console.warn("Не удалось получить список систем координат."),a.standartProjList()})},createContent:function(e){var t=L.DomUtil.create("button",this.options.buttonClassName,e),a=L.DomUtil.create("img",!1,t);return a.setAttribute("src",this.options.imageSrc),a.style.width="24px",a.style.height="24px",t.setAttribute("title",this.options.title),t.setAttribute("id",this.options.id),t},activate:function(e){this._clearSelection(!1),MapExpress.Tools.SelectionCommand.prototype.activate.call(this),this._initListeners(),this._initOkCancelDialog(),MapExpress.Tools.BaseNetworkCommand.prototype._setSewerLayersVisible.call(this),MapExpress.Tools.BaseNetworkCommand.prototype._setWaterLayersVisible.call(this)},deactivate:function(){this._removeListeners(),this._featureWasDeselected(),this._cancelOkCancelDialog(),MapExpress.Tools.BaseMapCommand.prototype.deactivate.call(this)},_initOkCancelDialog:function(){var e=this;this.OkCancelDialog=new MapExpress.Controls.OkCancelDialogCustom(window.MapManager._map,{closeButtonEnabled:!1,modal:!1,position:"right",okButtonText:e.options.okButtonText||"ОК",cancelButtonText:e.options.cancelButtonText||"Отмена"}).setTitle(this.options.title).show(),this._createDomElements(),this.OkCancelDialog.onOK(function(){e._saveVertex(),e._clearSelection(!1)}),this.OkCancelDialog.onCancel(function(){e._clearSelection(!1),e.deactivate()})},_cancelOkCancelDialog:function(){this.OkCancelDialog&&this.OkCancelDialog.hide()},_onEscapePress:function(e){27===e.keyCode&&this.deactivate()},_clearSelection:function(e){e?e.clearSelection():this._mapManager.clearSelections()},_featureWasSelected:function(e){this._featureWasDeselected(),this.feature=e,this.jsonFeature={lat:e._latlng.lat,lng:e._latlng.lng,id:e._leaflet_id},this.updateDialog()},_featureWasDeselected:function(e){this.jsonFeature=null,this.feature=null,this.clearDialog()},_initListeners:function(){var o=this;L.DomEvent.on(this._mapManager._map.getContainer(),"keyup",this._onEscapePress,this),this.options.layerDescriptions.forEach(function(e,t){var a=window.MapManager._mapModel.getLayerById(e.layerId);a&&(a.on("mapexpress:selection:before:selected",o._clearSelection,o),a.on("mapexpress:selection:after:selected",o._featureWasSelected,o),a.on("mapexpress:selection:after:deselected",o._featureWasDeselected,o),a.mapLayer.on("mapexspress:layer:data:added",o._resetListeners,o))})},_removeListeners:function(){var o=this;L.DomEvent.off(this._mapManager._map.getContainer(),"keyup",this._onEscapePress,this),this.options.layerDescriptions.forEach(function(e,t){var a=window.MapManager._mapModel.getLayerById(e.layerId);a&&(a.off("mapexpress:selection:before:selected",o._clearSelection,o),a.off("mapexpress:selection:after:selected",o._featureWasSelected,o),a.off("mapexpress:selection:after:deselected",o._featureWasDeselected,o),a.mapLayer.off("mapexspress:layer:data:added",o._resetListeners,o))})},_resetListeners:function(){this._removeListeners(),this._initListeners()},onOK:function(e){this.onOkControlFunction=e},onCancel:function(e){this.onCancelControlFunction=e},_createDomElements:function(){var r=this;function e(e){var t,a,o;!0==(t=$(e.target),a=t.val(),o=!0,isNaN(Number(a))&&(console.warn("Значение должно быть числовое"),t.val(0),o=!1),!!o||(t.val(0),!1))&&r.updateDialog($(e.target))}this.OkCancelDialog.setContent('<div class="mapexpress-edg-coordinates-controller" style="width: 320px;height: 210px;overflow:auto;">\t<div class="mapexpress-geometry-coordinates-controller-header">    \t<div class="mapexpress-coordinates-systems">    \t    <input id="mapexpress-active-coordinates-system" readonly placeholder="Система координат"></input>\t\t\t<i class="mdi mdi-chevron-down material-icons mapexpress-change-active-coordinates-system" aria-hidden="true"></i>    \t    <div>    \t        <input id="mapexpress-avaliable-coordinates-system_autocomplete" placeholder="Поиск..."></input>    \t        <ul id="mapexpress-avaliable-coordinates-system"></ul>    \t    </div>    \t</div>\t</div>\t<div class="mapexpress-edg-edit-points">\t\t\t<input style="width: calc(50% - 16px);" class="mapexpress-edg-edit-point mapexpress-point-lng" placeholder="Долгота (Х)" />\t\t\t<input style="width: calc(50% - 16px);" class= "mapexpress-edg-edit-point mapexpress-point-lat" placeholder="Широта (Y)" />\t</div></div>'),this.createCoodinatesSystemList(),this._initCRSContol(),$(".mapexpress-edg-coordinates-controller").parent().css("overflow","auto"),$(".mapexpress-point-lng").on("input",e),$(".mapexpress-point-lat").on("input",e)},clearDialog:function(){$(".mapexpress-point-lng").removeClass("invalid-value").val(""),$(".mapexpress-point-lat").removeClass("invalid-value").val("")},updateDialog:function(e){if(this.jsonFeature){if(e){var t=e.attr("class").replace("mapexpress-point-","");0<t.indexOf("lat")?(this.jsonFeature.projecty=e.val(),this.jsonFeature.lat=this.activeCoordinatesSystem.unproject(L.point(this.jsonFeature.projectx,this.jsonFeature.projecty)).lat):0<t.indexOf("lng")&&(this.jsonFeature.projectx=e.val(),this.jsonFeature.lng=this.activeCoordinatesSystem.unproject(L.point(this.jsonFeature.projectx,this.jsonFeature.projecty)).lng)}else this.jsonFeature.projecty=this.activeCoordinatesSystem.project(L.latLng(this.jsonFeature.lat,this.jsonFeature.lng)).y,this.jsonFeature.projectx=this.activeCoordinatesSystem.project(L.latLng(this.jsonFeature.lat,this.jsonFeature.lng)).x,$(".mapexpress-point-lat").val(this.jsonFeature.projecty),$(".mapexpress-point-lng").val(this.jsonFeature.projectx);this.updateVertexGeometryOnMap()}},updateVertexGeometryOnMap:function(){this.jsonFeature&&(this.feature._latlng.lat=this.jsonFeature.lat,this.feature._latlng.lng=this.jsonFeature.lng,this.feature.redraw())},createCoodinatesSystemList:function(){$("#mapexpress-avaliable-coordinates-system").parent().hide();for(var e=0;e<this.cordinateSystems.length;e++){var t=$("<li/>");t.attr("id",this.cordinateSystems[e].code),"EPSG:3395"!==this.cordinateSystems[e].code||this.cordinateSystems[e].title?"EPSG:3857"!==this.cordinateSystems[e].code||this.cordinateSystems[e].title?"EPSG:4326"!==this.cordinateSystems[e].code||this.cordinateSystems[e].title||(this.cordinateSystems[e].title="WGS 84"):this.cordinateSystems[e].title="Pseudo-Mercator Сферический Меркатор":this.cordinateSystems[e].title="World Mercator на сфероиде",t.html(this.cordinateSystems[e].title||this.cordinateSystems[e].projection._proj.title),$("#mapexpress-avaliable-coordinates-system").append(t)}},setActiveCRS:function(e){for(var t=this.cordinateSystems.length-1;0<=t;t--)this.cordinateSystems[t].code===e&&(this.activeCoordinatesSystem=this.cordinateSystems[t]);$("#mapexpress-active-coordinates-system").val(this.activeCoordinatesSystem.title||this.activeCoordinatesSystem.projection._proj.title),this.jsonFeature&&this.jsonFeature.lat&&this.jsonFeature.lng&&(this.jsonFeature.projectx=this.activeCoordinatesSystem.project(L.latLng(this.jsonFeature.lat,this.jsonFeature.lng)).x,this.jsonFeature.projecty=this.activeCoordinatesSystem.project(L.latLng(this.jsonFeature.lat,this.jsonFeature.lng)).y,$(".mapexpress-point-lat").val(this.jsonFeature.projecty),$(".mapexpress-point-lng").val(this.jsonFeature.projectx))},_initCRSContol:function(){var t=this,e=this._mapManager._map.options.crs.code;this.setActiveCRS(e);for(var a=$("#mapexpress-avaliable-coordinates-system").find("li"),o=a.length-1;0<=o;o--)$(a[o]).html()===e&&$(a[o]).addClass("active");$("#mapexpress-active-coordinates-system").on("click",function(){$("#mapexpress-avaliable-coordinates-system").parent().show()}),$("#mapexpress-avaliable-coordinates-system").find("li").on("click",function(e){$("#mapexpress-avaliable-coordinates-system").find("li").removeClass("active"),t.setActiveCRS($(e.currentTarget).attr("id")),$(e.currentTarget).addClass("active"),$("#mapexpress-avaliable-coordinates-system").parent().hide()}),$(document).on("click",function(e){"mapexpress-active-coordinates-system"!==$(e.target).attr("id")&&"mapexpress-avaliable-coordinates-system_autocomplete"!==$(e.target).attr("id")&&$("#mapexpress-avaliable-coordinates-system").parent().hide()}),$("#mapexpress-avaliable-coordinates-system_autocomplete").on("input",function(e){var t=$(e.currentTarget).val();$("#mapexpress-avaliable-coordinates-system").find("li").show(),""!==t&&null!=t&&$("#mapexpress-avaliable-coordinates-system").find("li").each(function(e){-1===$(this).html().toLowerCase().indexOf(t.toLowerCase())&&$(this).hide()})})},_saveVertex:function(){var e,t=this;if(this.feature)if(this.jsonFeature)if(o(this.jsonFeature.lng))if(o(this.jsonFeature.lat)){try{e=t.feature.toGeoJSON()}catch(e){return void t._showWarn("Неверно заданы координаты точки")}if(e){var a=JSON.stringify(e);if(0===e.geometry.coordinates[0]||0===e.geometry.coordinates[1])new MapExpress.Controls.OkCancelDialogCustom(window.MapManager._map,{closeButtonEnabled:!1,modal:!1,position:"center",okButtonText:t.options.okButtonText||"ОК",cancelButtonText:t.options.cancelButtonText||"Отмена"}).setTitle(this.options.title).setContent("Точка имеет нулевую координату. Продолжить сохранение?").show().onOK(function(){this.continueSaving(e,a)},this);else this.continueSaving(e,a)}else this._showWarn("Неверно заданы координаты точки")}else t._showWarn("Неверно задана широта");else t._showWarn("Неверно задана долгота");else this._showWarn("Не выбран узел");else this._showWarn("Не выбран узел");function o(e){var t=!0;return isNaN(Number(e))&&(t=!1),""===e&&(t=!1),!!t}},continueSaving:function(a,o){var r=this;this._isMergeVertexEnabledAsync(a.properties.cl_net_category_id,o).then(function(e){if(!0===e){var t={id:a.properties.net_vertex_id,geoJSON:o};r._getMergedObjectAsync(t.id,t.geoJSON).then(function(e){e?(t.mergedObjects=e,r._sendPostAndRefreshLayers(window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/UpdateVertexGeometry",t),r._featureWasDeselected(),r._clearSelection(!1)):new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow("Операция перемещения отменена!"),r._refreshLayers()},function(e){r._featureWasDeselected(),r._refreshLayers(),r._clearSelection(!1),r._showEror("Внутренняя ошибка приложения !<br>"+e.message)})}else r._featureWasDeselected(),r._refreshLayers(),r._clearSelection(!1)})},_isMergeVertexEnabledAsync:function(e,t){return MapExpress.Tools.MoveVertexCommand.prototype._isMergeVertexEnabledAsync.call(this,e,t)},_getMergedObjectAsync:function(e,t){return MapExpress.Tools.MoveVertexCommand.prototype._getMergedObjectAsync.call(this,e,t)},_refreshLayers:function(){MapExpress.Tools.BaseNetworkCommand.prototype._refreshLayers.call(this)},_sendPostAndRefreshLayers:function(e,t,a){MapExpress.Tools.BaseNetworkCommand.prototype._sendPostAndRefreshLayers.call(this,e,t,a)},_showEror:function(e){MapExpress.Tools.BaseNetworkCommand.prototype._showEror.call(this,e)},_showWarn:function(e){MapExpress.Tools.BaseNetworkCommand.prototype._showWarn.call(this,e)}}),MapExpress.Tools.GeomCoordsEditCommand=MapExpress.Tools.BaseMapCommand.extend({options:{buttonClassName:"map-toolbar-button",templateUrl:"/templates/GeometryCoordinatesControl.html",templateId:"GeometryCoordinatesControl",id:"GeomCoordsEditCommand",title:"Редактирование",imageSrc:"images/legend.png"},initialize:function(e,t){MapExpress.Tools.BaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t)},createContent:function(e){var t=L.DomUtil.create("button",this.options.buttonClassName,e),a=L.DomUtil.create("img",!1,t);return a.setAttribute("src",this.options.imageSrc),a.style.width="24px",a.style.height="24px",t.setAttribute("title",this.options.title),t.setAttribute("id",this.options.id),t},activate:function(e){this.geometryCoordinatesEditControl&&(this.geometryCoordinatesEditControl.clearControlAndController(),this.geometryCoordinatesEditControl.hide(),this.geometryCoordinatesEditControl=void 0),this.controller=new MapExpress.GeomCoordsEditController(this._mapManager._map),this.geometryCoordinatesEditControl=new MapExpress.Controls.GeometryCoordinatesEdit(this._mapManager._map,{titleText:this.options.title,headerEnabled:!0,footerEnabled:!1,closeButtonEnabled:!0,position:"right",projListUrl:this.options.projListUrl||window.REALTY_MAP_SITE_ROOT+"/Map/Spatial/CoordSys"},this.controller),this.geometryCoordinatesEditControl.show(),this.onOkControlFunction&&this.geometryCoordinatesEditControl.onOK(this.onOkControlFunction,this.geometryCoordinatesEditControl),this.onCancelControlFunction&&this.geometryCoordinatesEditControl.onCancel(this.onCancelControlFunction,this.geometryCoordinatesEditControl),MapExpress.Tools.BaseNetworkCommand.prototype._setSewerLayersVisible.call(this),MapExpress.Tools.BaseNetworkCommand.prototype._setWaterLayersVisible.call(this)},deactivate:function(){this.geometryCoordinatesEditControl&&(this.geometryCoordinatesEditControl.clearControlAndController(),this.geometryCoordinatesEditControl.hide(),this.geometryCoordinatesEditControl=void 0)},onOK:function(e){this.onOkControlFunction=e},onCancel:function(e){this.onCancelControlFunction=e}}),L.GeomCoordsVertexMarker=L.Editable.VertexMarker.extend({options:{className:"leaflet-div-icon leaflet-editing-icon leaflet-geom-coords-edge"},initialize:function(e,t,a,o){L.Editable.VertexMarker.prototype.initialize.call(this,e,t,a,o)},onAdd:function(e){L.Editable.VertexMarker.prototype.onAdd.call(this,e),this.on("dragend",this.onDragendVertex),this.addMiddleMarkers()},onDragendVertex:function(e){e.target.editor.tools._firePointChangePosition(e.target)}}),MapExpress.GeomCoordsEditController=L.Editable.extend({options:{vertexMarkerClass:L.GeomCoordsVertexMarker,skipMiddleMarkers:!0},initialize:function(e,t){this.map=e,L.Editable.prototype.initialize.call(this,e),L.setOptions(this,t),this._initGeometryListeners(),this._initControlListeners()},_firePointChangePosition:function(e){var t={lat:e.getLatLng().lat,lng:e.getLatLng().lng,id:e.controllerId};this.fire("geometry:change",{point:t}),this.map.fire("geometry:change",{point:t})},_drawGeomateryAsPoint:function(e){var t=this;var a,o,r=e.points;t.featuresLayer.eachLayer(function(e){e.remove(),delete t.featuresLayer._layers[e._leaflet_id]});for(var i=0;i<r.length;i++)a=r[i],o=void 0,o=new L.Marker([a.lat,a.lng],{icon:L.divIcon({className:"leaflet-div-icon leaflet-editing-icon leaflet-geom-coords-edge"})}),t.featuresLayer.addLayer(o),o.controllerId=a.id,o.labelId=a.num,o.projecty=a.projecty,o.projectx=a.projectx,o.enableEdit(),o.on("dragend",function(e){t._firePointChangePosition(e.layer)})},_drawGeomateryAsLinestring:function(e){var d=this;if(d.featuresLayer.eachLayer(function(e){e.remove(),delete d.featuresLayer._layers[e._leaflet_id]}),e.points.length<2)console.warn("Линия должна иметь более 2 точек");else{for(var t=[],a=0;a<e.points.length;a++)null===e.points[a].hole&&t.push([e.points[a].lat,e.points[a].lng]);for(var o=[],r=0;r<e.points.length;r++)null!==e.points[r].hole&&o.push([e.points[r].lat,e.points[r].lng]);t.length<2?console.warn("Линия должна иметь более 2 точек"):o.length<2&&0!==o.length?console.warn("Линия должна иметь более 2 точек"):function(e,t){var a=d.createPolyline(e,d.options);d.featuresLayer.addLayer(a),a.toggleEdit();for(var o=a.getLatLngs(),r=o.length-1;0<=r;r--)for(var i=o[r],n=i.length-1;0<=n;n--)for(var s=t.length-1;0<=s;s--)Number(t[s].lat)===i[n].lat&&Number(t[s].lng)===i[n].lng&&(i[n].__vertex.controllerId=t[s].id,i[n].__vertex.labelId=t[s].num,i[n].__vertex.projectx=t[s].projectx,i[n].__vertex.projecty=t[s].projecty)}([t,o],e.points)}},_drawGeomateryAsPolygon:function(e){var d=this;if(d.featuresLayer.eachLayer(function(e){e.remove(),delete d.featuresLayer._layers[e._leaflet_id]}),e.points.length<3)console.warn("Полигон должен иметь более 3 точек");else{for(var t=[],a=0;a<e.points.length;a++)null===e.points[a].hole&&t.push([e.points[a].lat,e.points[a].lng]);for(var o=[],r=0;r<e.points.length;r++)null!==e.points[r].hole&&o.push([e.points[r].lat,e.points[r].lng]);t.length<3?console.warn("Полигон должен иметь более 3 точек"):o.length<3&&0!==o.length?console.warn("Кольцо должно иметь более 3 точек"):function(e,t){var a=d.createPolygon(e,d.options);d.featuresLayer.addLayer(a),a.toggleEdit();for(var o=a.getLatLngs(),r=o.length-1;0<=r;r--)for(var i=o[r],n=i.length-1;0<=n;n--)for(var s=t.length-1;0<=s;s--)Number(t[s].lat)===i[n].lat&&Number(t[s].lng)===i[n].lng&&(i[n].__vertex.controllerId=t[s].id,i[n].__vertex.labelId=t[s].num,i[n].__vertex.projectx=t[s].projectx,i[n].__vertex.projecty=t[s].projecty)}([t,o],e.points)}},_initGeometryListeners:function(){this.map.on("geometry:mustbeenshown:as:point",this._drawGeomateryAsPoint,this),this.map.on("geometry:mustbeenshown:as:linestring",this._drawGeomateryAsLinestring,this),this.map.on("geometry:mustbeenshown:as:polygon",this._drawGeomateryAsPolygon,this)},_removeGeometry:function(t){var a=this;a.featuresLayer.eachLayer(function(e){e.controllerId===t.id&&(e.remove(),delete a.featuresLayer._layers[e._leaflet_id])})},_updateNums:function(a){this.featuresLayer.eachLayer(function(e){for(var t=a.points.length-1;0<=t;t--)a.points[t].id===e.controllerId&&(e.labelId=a.points[t].num)})},_totalRemoveGeometry:function(){this.featuresLayer.eachLayer(function(e){e.remove()})},_initControlListeners:function(){this.map.on("point:remove",this._removeGeometry,this),this.map.on("geometry:remove",this._totalRemoveGeometry,this),this.map.on("points:change:nums",this._updateNums,this)},removeListeners:function(){this.map.off("point:remove",this._removeGeometry,this),this.map.off("geometry:remove",this._totalRemoveGeometry,this),this.map.off("points:change:nums",this._updateNums,this),this.map.off("geometry:mustbeenshown:as:point",this._drawGeomateryAsPoint,this),this.map.off("geometry:mustbeenshown:as:linestring",this._drawGeomateryAsLinestring,this),this.map.off("geometry:mustbeenshown:as:polygon",this._drawGeomateryAsPolygon,this)},toGeoJSON:function(){return this.featuresLayer.toGeoJSON()}}),MapExpress.Search.ToirSearchProviderEdge=MapExpress.Search.BaseSearchProvider.extend({initialize:function(e,t){MapExpress.Search.BaseSearchProvider.prototype.initialize.call(this,e,t)},getDataByMaskAsynch:function(e){var t,a=$.Deferred();return t={edgeId:e},$.ajax({url:window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/GetEdgeGeometry?",type:"GET",async:!0,data:t,success:function(e){e.display_name=e.properties.net_edg_id,a.resolve([e])},error:function(){a.reject()}}),a.promise()}}),MapExpress.Search.ToirSearchProviderConstruction=MapExpress.Search.BaseSearchProvider.extend({initialize:function(e,t){MapExpress.Search.BaseSearchProvider.prototype.initialize.call(this,e,t)},getDataByMaskAsynch:function(e){var t,a=$.Deferred();return t={constructionId:e},$.ajax({url:window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/GetConstructionGeometry?",type:"GET",async:!0,data:t,success:function(e){e.display_name=e.properties.net_vert_constr_id,a.resolve([e])},error:function(){a.reject()}}),a.promise()}}),MapExpress.Edit.InvestProjectEditor=MapExpress.Edit.BaseLayerEditor.extend({initialize:function(e,t){MapExpress.Edit.BaseLayerEditor.prototype.initialize.call(this,e,t),this.options.featureKeyFieldName="project_id"},onSaveAsFeatureCollection:function(e){if(e){var t=this,a=MapExpress.Utils.GeoJSONUtils.convertFeatureCollectionToMultiPolygon(e);if(!MapExpress.Utils.GeoJSONUtils.featureHasCoordinates(a))return void t._showEror("У границы имущественного комплекса нет координат !");var o=window.REALTY_MAP_SITE_ROOT+"/MapApi/CreateOrUpdateRealtyGeometry",r={schema:"brc_realty",table:"invest_project",keyColumn:"project_id",geomColumn:"project_geom"};r.itemId=window.brcRealtyObjectIdForMap,r.geoJSON=JSON.stringify(a),$.post(o,r).done(function(e){e?(new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow("Контур объекта сохранен в БД"),window.brcMapPosition.trySetPosition(),t.setEditableLayer(t.getEditableLayerModel().id)):t._showEror("Не удалось сохранить контур !")}).fail(function(e){t._showEror("Не удалось сохранить контур !"),window.brcMapPosition.trySetPosition(),t.setEditableLayer(t.getEditableLayerModel().id)})}},save:function(){this.saveChanges()},_showEror:function(e){new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e)}}),MapExpress.Tools.InvestProjectToolbar=MapExpress.Tools.MapToolbar.extend({initialize:function(e,t){MapExpress.Tools.MapToolbar.prototype.initialize.call(this,e,t),e._map.investProjectEditControl&&e._map.removeControl(e._map.investProjectEditControl),(e._map.investProjectEdit=this).investProjectEditor=new MapExpress.Edit.InvestProjectEditor(window.brcRealtyObjectIdForMap.toString(),t),this._addCommands()},_addCommands:function(){this.addCommand(new MapExpress.Tools.EditInvestProjectCommand(window.MapManager,!1,this.investProjectEditor)),this.addCommand(new MapExpress.Tools.CreateInvestProjectCommand(window.MapManager,!1,this.investProjectEditor)),this.addCommand(new MapExpress.Tools.SaveInvestProjectCommand(window.MapManager,!1,this.investProjectEditor))}}),MapExpress.Tools.EditInvestProjectCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/inputParams.png",title:"Редактирование контура",id:"editParcelCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.startEdit()},deactivate:function(){}}),MapExpress.Tools.CreateInvestProjectCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/focus_@2X.png",title:"Создание контура",id:"createParcelCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.startAddPolygon()},deactivate:function(){}}),MapExpress.Tools.SaveInvestProjectCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/start_@2X.png",title:"Сохранить",id:"saveParcelCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.save()}}),MapExpress.Tools.NetworkEditToolbar=MapExpress.Tools.MapToolbar.extend({initialize:function(e,t){MapExpress.Tools.MapToolbar.prototype.initialize.call(this,e,t),e._map.networkEditControl&&e._map.removeControl(e._map.networkEditControl),(e._map.networkEditControl=this)._addCommands()},_addCommands:function(){var e=window.realtySecurityManager.deleteWaterNetworkAllowed(),t=window.realtySecurityManager.deleteSewerNetworkAllowed(),a=window.realtySecurityManager.editWaterNetworkAllowed(),o=window.realtySecurityManager.editSewerNetworkAllowed(),r=window.realtySecurityManager.createSewerNetworkAllowed(),i=window.realtySecurityManager.createWaterNetworkAllowed();if(e||t||a||o){var n=[];n.push({layerId:"VERTEX",featureKeyFieldName:"net_vertex_id"}),n.push({layerId:"VERTEX_VS",featureKeyFieldName:"net_vertex_id"}),n.push({layerId:"EDG",featureKeyFieldName:"net_edg_id"}),n.push({layerId:"EDG_VS",featureKeyFieldName:"net_edg_id"}),this.addCommand(new MapExpress.Tools.SelectionCommand(window.MapManager,{layerDescriptions:n})),this.addCommand(new MapExpress.Tools.RemoveSelectionsCommand(window.MapManager))}if(r&&this.addCommand(new MapExpress.Tools.CreateSewerNetworkCommand(window.MapManager)),i&&this.addCommand(new MapExpress.Tools.CreateWaterNetworkCommand(window.MapManager)),(a||o)&&function(e){function n(e,t,a){$.ajax({type:"POST",url:e,data:t,success:function(e){e.statusCodeText,"Success"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow(e.responseText),"Warning"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showWarnWindow(e.responseText),"Error"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e.responseText),o()},error:function(e){new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow("Внутренняя ошибка приложения!"),o()},async:a})}function o(){!function(e){for(var t=e.length-1;0<=t;t--){var a=e[t],o=window.MapManager._mapModel.getLayerById(a);o&&o.mapLayer&&o.mapLayer._refreshData&&o.mapLayer._refreshData()}}(["VERTEX","EDG","VERTEX_VS","EDG_VS","EMERGENCY_VO","EMERGENCY_VS"])}function t(){this.clearControl()}var a=window.MapManager,r=new MapExpress.Tools.GeomCoordsEditCommand(a,{title:"Создание узлов и дуг системы водоотведения",id:"voEditcontrol",imageSrc:"./images/sozdanie_uzlov_i_dug_VO_po_coordinatam.png",projListUrl:window.REALTY_MAP_SITE_ROOT+"/Map/Spatial/CoordSys"});r.onOK(function(e,t){if(this.controller){for(var a=this.controller.toGeoJSON(),o=0;o<a.features.length;o++){var r={};if(("Point"===a.features[o].geometry.type||"MultiPoint"===a.features[o].geometry.type)&&"linestring"===this.activeGeomShow)return new MapExpress.Controls.MapControl(window.MapManager._map).showWarnWindow("Неверно задана геометрия объекта. Задана всего одна точка."),void this.clearControl();if("MultiLineString"===a.features[o].geometry.type)a.features[o].geometry.type="LineString",a.features[o].geometry.coordinates=a.features[o].geometry.coordinates[0],r.categoryId=1,r.geoJSON=JSON.stringify(a.features[o]),n(window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/CreateEdgeListFromLineString",r,!0);else if("LineString"===a.features[o].geometry.type)r.categoryId=1,r.geoJSON=JSON.stringify(a.features[o]),n(window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/CreateEdgeListFromLineString",r,!0);else if("Point"===a.features[o].geometry.type||"MultiPoint"===a.features[o].geometry.type){var i=L.latLng(a.features[o].geometry.coordinates[1],a.features[o].geometry.coordinates[0]);r.edgeId=MapExpress.Tools.BaseNetworkCommand.prototype.getEdgsIdByPoint.call(this,"EDG",i),r.geoJSON=JSON.stringify(a.features[o]),n(window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/CreateVertexOnEdge",r,!0)}this.clearControl()}a||new MapExpress.Controls.MapControl(window.MapManager._map).showWarnWindow("Неверно задана геометрия объекта"),a.features.length||new MapExpress.Controls.MapControl(window.MapManager._map).showWarnWindow("Нет корректных объектов для сохранения")}}),r.onCancel(t);var i=new MapExpress.Tools.GeomCoordsEditCommand(a,{title:"Создание узлов и дуг системы водоснабжения",id:"vsEditcontrol",imageSrc:"./images/sozdanie_uzlov_i_dug_VS_po_coordinatam.png",projListUrl:window.REALTY_MAP_SITE_ROOT+"/Map/Spatial/CoordSys"});i.onOK(function(e,t){if(this.controller){for(var a=this.controller.toGeoJSON(),o=0;o<a.features.length;o++){var r={};if(("Point"===a.features[o].geometry.type||"MultiPoint"===a.features[o].geometry.type)&&"linestring"===this.activeGeomShow)return new MapExpress.Controls.MapControl(window.MapManager._map).showWarnWindow("Неверно задана геометрия объекта. Задана всего одна точка."),void this.clearControl();if("MultiLineString"===a.features[o].geometry.type)a.features[o].geometry.type="LineString",a.features[o].geometry.coordinates=a.features[o].geometry.coordinates[0],r.categoryId=2,r.geoJSON=JSON.stringify(a.features[o]),n(window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/CreateEdgeListFromLineString",r,!0);else if("LineString"===a.features[o].geometry.type)r.categoryId=2,r.geoJSON=JSON.stringify(a.features[o]),n(window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/CreateEdgeListFromLineString",r,!0);else if("Point"===a.features[o].geometry.type||"MultiPoint"===a.features[o].geometry.type){var i=L.latLng(a.features[o].geometry.coordinates[1],a.features[o].geometry.coordinates[0]);r.edgeId=MapExpress.Tools.BaseNetworkCommand.prototype.getEdgsIdByPoint.call(this,"EDG_VS",i),r.geoJSON=JSON.stringify(a.features[o]),n(window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/CreateVertexOnEdge",r,!0)}this.clearControl()}a||new MapExpress.Controls.MapControl(window.MapManager._map).showWarnWindow("Неверно задана геометрия объекта"),a.features.length||new MapExpress.Controls.MapControl(window.MapManager._map).showWarnWindow("Нет корректных объектов для сохранения")}}),i.onCancel(t),e.addCommand(r),e.addCommand(i)}(this),(i||r)&&this.addCommand(new MapExpress.Tools.AddVertexCommand(window.MapManager)),(i||r)&&this.addCommand(new MapExpress.Tools.CreateVertexByDistance(window.MapManager)),(a||o)&&this.addCommand(new MapExpress.Tools.MoveVertexCommand(window.MapManager)),a||o){var s=[];s.push({layerId:"VERTEX",featureKeyFieldName:"net_vertex_id"}),s.push({layerId:"VERTEX_VS",featureKeyFieldName:"net_vertex_id"}),this.addCommand(new MapExpress.Tools.EdgCoordsChangeCommand(window.MapManager,{layerDescriptions:s,projListUrl:window.REALTY_MAP_SITE_ROOT+"/Map/Spatial/CoordSys"}))}(a||o)&&this.addCommand(new MapExpress.Tools.DissociateEdgesCommand(window.MapManager)),(e||t||a||o)&&this.addCommand(new MapExpress.Tools.DeleteNetworkElementsCommand(window.MapManager))}}),MapExpress.Tools.EmergencyRepairEditToolbar=MapExpress.Tools.MapToolbar.extend({initialize:function(e,t){MapExpress.Tools.MapToolbar.prototype.initialize.call(this,e,t),e._map.emergencyRepairEditControl&&e._map.removeControl(e._map.emergencyRepairEditControl),(e._map.emergencyRepairEditControl=this)._addCommands()},_addCommands:function(){var e=window.realtySecurityManager.editNetworkEmergencyAllowed();if(window.realtySecurityManager.createNetworkEmergencyAllowed()&&(this.addCommand(new MapExpress.Tools.AddEmergencyRepairCommand(window.MapManager)),this.addCommand(new MapExpress.Tools.AddEmergencyVORepairCommand(window.MapManager))),e&&this.addCommand(new MapExpress.Tools.MoveEmergencyRepairCommand(window.MapManager)),e){var t=[];t.push({layerId:"EMERGENCY_VO",featureKeyFieldName:"fault_id"}),t.push({layerId:"EMERGENCY_VS",featureKeyFieldName:"fault_id"}),this.addCommand(new MapExpress.Tools.ConnectFaultsWithNetElementsCommand(window.MapManager,{layerDescriptions:t,singleSelect:!0}))}}}),MapExpress.Tools.BaseNetworkCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({_sendPostAndRefreshLayers:function(e,t,a){var o=this;$.ajax({type:"POST",url:e,data:t,success:function(e){e.statusCodeText;"Success"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow(e.responseText);"Warning"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showWarnWindow(e.responseText);"Error"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e.responseText);o._refreshLayers()},error:function(e){o._showEror("Внутренняя ошибка приложения !"),o._refreshLayers(),console.log(e)},async:a})},getEdgsIdByPoint:function(e,t,a){var o=void 0===a?"net_edg_id":a,r=[],i=window.MapManager._mapModel.getLayerById(e);if(i&&i.mapLayer)for(var n in i.mapLayer._layers){var s=i.mapLayer._layers[n];"net_edg_id"===o?MapExpress.Mapping.GeoUtil.lineStringContainsPoint(s,t)&&r.push(s.feature.properties[o]):MapExpress.Mapping.GeoUtil.circleMarkerContainsPoint(s,t)&&r.push(s.feature.properties[o])}return r},getVertexsIdByPoint:function(e,t){return this.getEdgsIdByPoint(e,t,"net_vertex_id")},getConstractionsIdByPoint:function(e,t){return this.getEdgsIdByPoint(e,t,"net_vert_constr_id")},_refreshLayers:function(){!function(e){for(var t=e.length-1;0<=t;t--){var a=e[t],o=window.MapManager._mapModel.getLayerById(a);o&&o.mapLayer&&o.mapLayer._refreshData&&o.mapLayer._refreshData()}}(["VERTEX","EDG","VERTEX_VS","EDG_VS","EMERGENCY_VO","EMERGENCY_VS"])},_setWaterLayersVisible:function(){window.MapManager.setLayerVisible("Водоснабжение",!0);for(var e=["VERTEX_VS","EDG_VS"],t=e.length-1;0<=t;t--){var a=e[t];window.MapManager.setLayerVisible(a,!0)}},_setSewerLayersVisible:function(){window.MapManager.setLayerVisible("Водоотведение",!0);for(var e=["VERTEX","EDG"],t=e.length-1;0<=t;t--){var a=e[t];window.MapManager.setLayerVisible(a,!0)}},_setEmergencyLayersVisible:function(){window.MapManager.setLayerVisible("EMERGENCY_GROUP",!0);for(var e=["EMERGENCY_VO","EMERGENCY_VS"],t=e.length-1;0<=t;t--){var a=e[t];window.MapManager.setLayerVisible(a,!0)}},_showEror:function(e){new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e)},_showWarn:function(e){new MapExpress.Controls.MapControl(window.MapManager._map).showWarnWindow(e)}}),MapExpress.Tools.CreateSewerNetworkCommand=MapExpress.Tools.BaseNetworkCommand.extend({options:{imageSrc:"images/трубопроводПНГ.png",title:"Создать участок ВО",id:"createNetworkCommand",categoryId:1},initialize:function(e,t){MapExpress.Tools.BaseNetworkCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.editor=new MapExpress.Edit.BaseLayerEditor("EDG",{featureKeyFieldName:"net_edg_id",skipMiddleMarkers:!0,editFeatureStyle:{color:"#B18C46"}})},activate:function(){this.editor.clearEditLayer(),this.editor.startAddPolyline(),this.editor.off("mapexpress:edit:newfeatureadded",this._saveNetworkEdges,this),this.editor.on("mapexpress:edit:newfeatureadded",this._saveNetworkEdges,this),this._setSewerLayersVisible(),this._setWaterLayersVisible()},deactivate:function(){this.editor.stopEdit(),this.editor.off("mapexpress:edit:newfeatureadded",this._saveNetworkEdges,this)},_saveNetworkEdges:function(e){var t=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/CreateEdgeListFromLineString",a={};a.categoryId=this.options.categoryId,a.geoJSON=JSON.stringify(e.geoJSON),this.editor.clearEditLayer(),this._sendPostAndRefreshLayers(t,a),window.setTimeout(function(){this.deactivate(),this.activate()}.bind(this),0)}}),MapExpress.Tools.CreateWaterNetworkCommand=MapExpress.Tools.CreateSewerNetworkCommand.extend({options:{imageSrc:"images/трубопроводПНГСиний.png",title:"Создать участок ВС",id:"createNetworkCommand",categoryId:2},initialize:function(e,t){L.setOptions(this,t),this.editor=new MapExpress.Edit.BaseLayerEditor("EDG_VS",{featureKeyFieldName:"net_edg_id",skipMiddleMarkers:!0,editFeatureStyle:{color:"#006FB8"}})}}),MapExpress.Tools.MoveVertexCommand=MapExpress.Tools.BaseNetworkCommand.extend({options:{buttonClassName:"map-toolbar-button",imageSrc:"images/peremestit_uzel.png",title:"Переместить узел",id:"moveVertexCommand"},initialize:function(e,t){MapExpress.Tools.BaseNetworkCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerSewerEditor=new MapExpress.Edit.BaseLayerEditor("VERTEX",{featureKeyFieldName:"net_vertex_id",useEditFeatureOriginalStyle:!0}),this.layerSewerEditor.edgLayerId="EDG",this.layerWaterEditor=new MapExpress.Edit.BaseLayerEditor("VERTEX_VS",{featureKeyFieldName:"net_vertex_id",useEditFeatureOriginalStyle:!0}),this.layerWaterEditor.edgLayerId="EDG_VS"},activate:function(){this._setSewerLayersVisible(),this._setWaterLayersVisible(),this._activate(this.layerSewerEditor),this._activate(this.layerWaterEditor)},_activate:function(e){e.clearEditLayer(),e.startEdit(),e.off("mapexpress:edit:circleMarker:drag",this._moveVertexWithEdg),e.off("mapexpress:edit:circleMarker:dragend",this._saveVertex,this),e.on("mapexpress:edit:circleMarker:drag",this._moveVertexWithEdg),e._events["mapexpress:edit:circleMarker:dragend"]&&0<e._events["mapexpress:edit:circleMarker:dragend"].length||e.on("mapexpress:edit:circleMarker:dragend",this._saveVertex,this)},deactivate:function(){this._deactivate(this.layerSewerEditor),this._deactivate(this.layerWaterEditor)},_deactivate:function(e){e.stopEdit(),e.off("mapexpress:edit:circleMarker:drag",this._moveVertexWithEdg),e.off("mapexpress:edit:circleMarker:dragend",this._saveVertex,this)},_saveVertex:function(o){var r=this,i=o.circleMarker,n=JSON.stringify(i.toGeoJSON());this._isMergeVertexEnabledAsync(i.feature.properties.cl_net_category_id,n).then(function(e){!0===e?function(){var t=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/UpdateVertexGeometry",a={};a.id=i.feature.properties.net_vertex_id,a.geoJSON=n,this._getMergedObjectAsync(a.id,a.geoJSON).then(function(e){e?(a.mergedObjects=e,r._sendPostAndRefreshLayers(t,a)):(new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow("Операция перемещения отменена!"),r._refreshLayers()),o.editor.clearEditLayer()},function(e){o.editor.clearEditLayer(),r._refreshLayers(),r._showEror("Внутренняя ошибка приложения !<br>"+e.message)})}.bind(r)():(r._refreshLayers(),o.editor.clearEditLayer())})},_isMergeVertexEnabledAsync:function(e,t){var a=this,o=$.Deferred(),r=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/CheckVertexInPointInOtherCategory",i={};return i.geoJSON=t,i.networkCategoryId=e,$.ajax({type:"get",url:r,data:i,success:function(e){if("True"===e){var t=new MapExpress.Controls.OkCancelDialog(window.MapManager._map,{closeButtonEnabled:!1}).setTitle("Объединение узлов сети").setContent("Перемещаемый и целевой узлы относятся<span style='color: #CA483E'> к разным категориям сети </span><br>Продолжить объединение?").show();t.onOK(function(){o.resolve(!0)}),t.onCancel(function(){o.resolve(!1)})}else o.resolve(!0)},error:function(e){a._showEror("Внутренняя ошибка приложения !<br>"+e.message),o.resolve(!1)}}),o.promise()},_getMergedObjectAsync:function(e,t){var o=$.Deferred();return $.ajax({type:"get",url:window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/GetMergeObjectsUpdateVertexGeometry",data:{id:e,geoJSON:t},success:function(e){!0===e.MergeObjectsInd?$.ajax({type:"post",url:window.REALTY_MAP_SITE_ROOT+"/Network/Map/MergeObjects",data:{objects:e},success:function(e){try{!function(e){var t=new MapExpress.Controls.MapControl(window.MapManager._map,{headerEnabled:!0,closeButtonEnabled:!0,resizeable:!0}).setTitle("Объединение элементов сети").setContent(e).setContentStyle({padding:"0px",height:"100%"}).setControlStyle({height:"100%",width:"100%","font-size":"12px"}).show();function a(){o.resolve(null)}t.on("mapcontrol:remove:after",a,this),window.mergeObjects($(t._control),function(e){t.off("mapcontrol:remove:after",a,this),t.hide(),"Error"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e.responseText),"Success"===e.statusCodeText&&e.data&&new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow(e.responseText),o.resolve(e.data)})}(e)}catch(e){o.reject(e)}},error:function(e){o.reject(e)}}):o.resolve({})},error:function(e){o.reject(e)}}),o.promise()},_moveVertexWithEdg:function(e){var o=e.circleMarker;function t(e){var t=window.MapManager._mapModel.getLayerById(e);if(t&&t.mapLayer){var a=t.mapLayer;a&&a.eachLayer(function(e){if(e){var t=!1;o.feature.properties.net_vertex_id===e.feature.properties.vert_1_id&&(e._latlngs[0].lat=o._latlng.lat,e._latlngs[0].lng=o._latlng.lng,t=!0),o.feature.properties.net_vertex_id===e.feature.properties.vert_2_id&&(e._latlngs[1].lat=o._latlng.lat,e._latlngs[1].lng=o._latlng.lng,t=!0),t&&e.redraw()}})}}o.bringToFront(),t("EDG_VS"),t("EDG")}}),MapExpress.Tools.AddVertexCommand=MapExpress.Tools.BaseNetworkCommand.extend({options:{imageSrc:"images/Врезка.gif",title:"Создать узел",id:"addVertexCommand"},initialize:function(e,t,a){MapExpress.Tools.BaseNetworkCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerSewerEditor=new MapExpress.Edit.BaseLayerEditor("VERTEX",{featureKeyFieldName:"net_vertex_id"}),this.layerSewerEditor.edgLayerId="EDG",this.layerWaterEditor=new MapExpress.Edit.BaseLayerEditor("VERTEX_VS",{featureKeyFieldName:"net_vertex_id"}),this.layerWaterEditor.edgLayerId="EDG_VS"},activate:function(){this._setSewerLayersVisible(),this._setWaterLayersVisible(),this._activate(this.layerSewerEditor),this._activate(this.layerWaterEditor)},_activate:function(e){e.clearEditLayer(),e.startAddCircleMarker(),e.off("mapexpress:edit:newfeatureadded",this._tryAddVertex,this),e.on("mapexpress:edit:newfeatureadded",this._tryAddVertex,this)},deactivate:function(){this._deactivate(this.layerSewerEditor),this._deactivate(this.layerWaterEditor)},_deactivate:function(e){e.stopEdit(),e.off("mapexpress:edit:newfeatureadded",this._tryAddVertex,this)},_tryAddVertex:function(e){var t=e.layer._latlng,a=this._getEdgsIdByPoint(e.editor,t);if(a&&0<a.length){var o=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/CreateVertexOnEdge",r={};r.edgeId=a[0],r.geoJSON=JSON.stringify(e.layer.toGeoJSON()),this._sendPostAndRefreshLayers(o,r)}window.setTimeout(function(){this.deactivate(),this.activate()}.bind(this),0)},_getEdgsIdByPoint:function(e,t){return this.getEdgsIdByPoint(e.edgLayerId,t)}}),MapExpress.Tools.DeleteNetworkElementsCommand=MapExpress.Tools.BaseNetworkCommand.extend({options:{imageSrc:"images/trash_@2X.png",title:"Удалить выбранные элементы сети",id:"deleteVertexCommand"},initialize:function(e,t,a){MapExpress.Tools.BaseNetworkCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t)},activate:function(){var a=this,o=[],e=this._mapManager.getSelection("EDG");e&&(o=e.getSelections());var t=this._mapManager.getSelection("EDG_VS");t&&(o=o.concat(t.getSelections()));var r=[],i=this._mapManager.getSelection("VERTEX");i&&(r=i.getSelections());var n=this._mapManager.getSelection("VERTEX_VS");(n&&(r=r.concat(n.getSelections())),0<o.length||0<r.length)?new MapExpress.Controls.OkCancelDialog(window.MapManager._map).setTitle("Удаление элементов сети").setContent("Удалить выбранные элементы инженерной сети ?").show().onOK(function(){for(var e=o.length-1;0<=e;e--){var t=o[e];this._delete("DeleteEdge",t.feature.properties.net_edg_id)}r.forEach(function(t){a._getMergedObjectAsync(t.toGeoJSON().properties.net_vertex_id,JSON.stringify(t.toGeoJSON())).then(function(e){e?a._delete("DeleteVertex",t.feature.properties.net_vertex_id,e):(new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow("Операция удаления отменена!"),a._refreshLayers())})}),this._mapManager.clearSelections()},this):this._showWarn("Не выбраны элементы инженерной сети!")},_delete:function(e,t,a){var o=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/"+e,r={};r.id=t,a&&(r.mergedObjects=a),this._sendPostAndRefreshLayers(o,r,!1)},_getMergedObjectAsync:function(t,e){var a=this,o=$.Deferred();return $.ajax({type:"get",url:window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/GetMergeObjectsDeleteVertex",data:{id:t,geoJSON:e},success:function(e){!0===e.MergeObjectsInd?$.ajax({type:"post",url:window.REALTY_MAP_SITE_ROOT+"/Network/Map/MergeObjects",data:{objects:e},success:function(e){try{!function(e){var t=new MapExpress.Controls.MapControl(window.MapManager._map,{headerEnabled:!0,closeButtonEnabled:!0,resizeable:!0}).setTitle("Объединение элементов сети").setContent(e).setContentStyle({padding:"0px",height:"100%"}).setControlStyle({height:"100%",width:"100%","font-size":"12px"}).show();function a(){o.resolve(null)}t.on("mapcontrol:remove:after",a,this),window.mergeObjects($(t._control),function(e){t.off("mapcontrol:remove:after",a,this),t.hide(),"Error"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e.responseText),"Success"===e.statusCodeText&&e.data&&new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow(e.responseText),o.resolve(e.data)})}(e)}catch(e){o.reject(e)}},error:function(e){o.reject(e)}}):(a._delete("DeleteVertex",t),o.resolve({}))},error:function(e){o.reject(e)}}),o.promise()}}),MapExpress.Tools.DissociateEdgesCommand=MapExpress.Tools.BaseNetworkCommand.extend({options:{imageSrc:"images/razedinit_uzli.png",title:"Разъединить узлы",id:"dissociateedgescommand"},initialize:function(e,t,a){MapExpress.Tools.BaseNetworkCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t)},activate:function(){var a=[],e=this._mapManager.getSelection("VERTEX");e&&(a=e.getSelections());var t=this._mapManager.getSelection("VERTEX_VS");(t&&(a=a.concat(t.getSelections())),0<a.length)?new MapExpress.Controls.OkCancelDialog(window.MapManager._map).setTitle("Разъединить узлы?").setContent("Разъединить узлы ?").show().onOK(function(){for(var e=a.length-1;0<=e;e--){var t=a[e];this._dissociateEdges(t.feature.properties.net_vert_constr_id)}this._mapManager.clearSelections()},this):this._showWarn("Не выбраны узлы инженерной сети!")},_dissociateEdges:function(e){var t=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/DissociateEdges",a={};a.constructionId=e,this._sendPostAndRefreshLayers(t,a,!1)}}),MapExpress.Tools.AddEmergencyRepairCommand=MapExpress.Tools.BaseNetworkCommand.extend({options:{imageSrc:"images/sozdat_mesto_provedenia_rabot_VS.png",title:"Создать место проведения работ ВС",id:"addemergencyrepaircommand",networkCategory:2},initialize:function(e,t){MapExpress.Tools.BaseNetworkCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerWaterEmergencyRepairEditor=new MapExpress.Edit.BaseLayerEditor("EMERGENCY_VS",{featureKeyFieldName:"fault_id"})},activate:function(){this._setWaterLayersVisible(),this._setEmergencyLayersVisible(),this._activate(this.layerWaterEmergencyRepairEditor)},_activate:function(e){e.clearEditLayer(),e.startAddCircleMarker(),e.off("mapexpress:edit:newfeatureadded",this._tryAddEmergencyRepair,this),e.on("mapexpress:edit:newfeatureadded",this._tryAddEmergencyRepair,this)},deactivate:function(){this._deactivate(this.layerWaterEmergencyRepairEditor)},_deactivate:function(e){e.stopEdit(),e.off("mapexpress:edit:newfeatureadded",this._tryAddEmergencyRepair,this)},_getEdgIdsByPoint:function(e){var t=[],a=this.getEdgsIdByPoint("EDG",e),o=this.getEdgsIdByPoint("EDG_VS",e);return a&&(t=t.concat(a)),o&&(t=t.concat(o)),t},_getConstractionsIdByPoint:function(e){var t=[],a=this.getConstractionsIdByPoint("VERTEX",e),o=this.getConstractionsIdByPoint("VERTEX_VS",e);return a&&(t=t.concat(a)),o&&(t=t.concat(o)),t},_tryAddEmergencyRepair:function(e){var i=this;this.deactivate();var n=e.layer._latlng,t=window.REALTY_MAP_SITE_ROOT+"/Network/EmergencyRepair/FaultCard",s=JSON.stringify(e.layer.toGeoJSON()),a={};a.itemId=0,a.networkCategory=this.options.networkCategory,$.post(t,a).done(function(e){!function(e){var t=new MapExpress.Controls.MapPopupControl(i._mapManager._map,{headerEnabled:!0,closeButtonEnabled:!0,resizeable:!0,className:"mapexpress-layer-info-control",destroyOnClose:!1}).setTitle("Создание места проведения работ на участке сети").setContent(e).setControlStyle({background:"#FFF"}).setContentStyle({"font-size":"12px",padding:"0px",overflow:"hidden"}).setLatLngPosition(n);MapExpress.Controls.MapControlUtils.addClassName(t._control,"override-leaflet-color"),t.on("mapcontrol:remove:before",function(){try{window.destroyControls($(t._control),function(){t&&t.destroy()})}catch(e){t&&t.destroy()}});var a=i._getEdgIdsByPoint(n),o=i._getConstractionsIdByPoint(n),r={};r.selector=$(t._control),r.callback=function(e){"Success"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow(e.responseText);"Error"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e.responseText);i._refreshLayers(),t.hide(),window.MapManager.identifyWindow&&window.MapManager.identifyWindow.hide()},r.selector.find("#geoJSON").val(s),r.faultObjects={edgeIds:a,constructionIds:o},window.emergencyRepairCardInit(r),t.show()}(e)}).fail(function(e){i._showEror("Не удалось создать место проведения работ ВС<br>"+e.message),i.deactivate(),i._refreshLayers()})}}),MapExpress.Tools.AddEmergencyVORepairCommand=MapExpress.Tools.AddEmergencyRepairCommand.extend({options:{imageSrc:"images/sozdat_mesto_provedenia_rabot_VO.png",title:"Создать место проведения работ ВО",id:"addemergencyrepaircommandvo",networkCategory:1},initialize:function(e,t){MapExpress.Tools.AddEmergencyRepairCommand.prototype.initialize.call(this,e,this.options),this.layerWaterEmergencyRepairEditor=new MapExpress.Edit.BaseLayerEditor("EMERGENCY_VO",{featureKeyFieldName:"fault_id"})},activate:function(){this._setSewerLayersVisible(),this._setEmergencyLayersVisible(),this._activate(this.layerWaterEmergencyRepairEditor)}}),MapExpress.Tools.MoveEmergencyRepairCommand=MapExpress.Tools.AddEmergencyRepairCommand.extend({options:{imageSrc:"images/peremestit_mesto_provedenie_rabot.png",title:"Переместить место проведения работ",id:"moveemergencyrepaircommand"},initialize:function(e,t){MapExpress.Tools.AddEmergencyRepairCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerWaterEmergencyRepairEditor=new MapExpress.Edit.BaseLayerEditor("EMERGENCY_VS",{featureKeyFieldName:"fault_id",useEditFeatureOriginalStyle:!0}),this.layerSewerEmergencyRepairEditor=new MapExpress.Edit.BaseLayerEditor("EMERGENCY_VO",{featureKeyFieldName:"fault_id",useEditFeatureOriginalStyle:!0})},activate:function(){this._setSewerLayersVisible(),this._setWaterLayersVisible(),this._setEmergencyLayersVisible(),this._activate(this.layerWaterEmergencyRepairEditor),this._activate(this.layerSewerEmergencyRepairEditor)},_activate:function(e){e.clearEditLayer(),e.startEdit(),e.off("mapexpress:edit:circleMarker:dragend",this._saveEmergencyRepair,this),e._events&&e._events["mapexpress:edit:circleMarker:dragend"]&&0<e._events["mapexpress:edit:circleMarker:dragend"].length||e.on("mapexpress:edit:circleMarker:dragend",this._saveEmergencyRepair,this)},deactivate:function(){this._deactivate(this.layerWaterEmergencyRepairEditor),this._deactivate(this.layerSewerEmergencyRepairEditor)},_deactivate:function(e){e.stopEdit(),e.off("mapexpress:edit:circleMarker:dragend",this._saveEmergencyRepair,this)},_saveEmergencyRepair:function(e){var t=e.circleMarker,a=JSON.stringify(t.toGeoJSON());e.editor.clearEditLayer();var o=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/ChangeFaultPosition",r=(e.circleMarker._latlng,{});r.fault_id=t.feature.properties.fault_id,r.geoJSON=a,this._sendPostAndRefreshLayers(o,r,!1)}}),MapExpress.Tools.CreateVertexByDistance=MapExpress.Tools.BaseNetworkCommand.extend({options:{imageSrc:"images/sozdat_usel_na_rasstoianii_ot_uzla.png",title:"Создать узел на расстоянии от узла",id:"createvertexbydistance"},initialize:function(e,t,a){MapExpress.Tools.BaseNetworkCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t)},activate:function(){var e=[],t=this._mapManager.getSelection("EDG");t&&(e=t.getSelections());var a=this._mapManager.getSelection("EDG_VS");if(a&&(e=e.concat(a.getSelections())),1<e.length)this._showWarn("Выбрано более одной дуги !");else{var o=[],r=this._mapManager.getSelection("VERTEX");r&&(o=r.getSelections());var i=this._mapManager.getSelection("VERTEX_VS");if(i&&(o=o.concat(i.getSelections())),1<o.length)this._showWarn("Выбрано более одного узла !");else if(0!==e.length&&0!==o.length){var s=o[0],d=e[0];if(s.feature.properties.net_vertex_id===d.feature.properties.vert_1_id||s.feature.properties.net_vertex_id===d.feature.properties.vert_2_id){var l,n=new MapExpress.Controls.OkCancelDialog(window.MapManager._map).setTitle("Создание узла").setContent('<div class="mapexpress-edg-coordinates-controller" style="height: 48px;">\t\t<input style="width: calc(100% - 16px);" class="mapexpress-vertex-distance-input" placeholder="Дистанция (м)" /></div>').show();$(".mapexpress-vertex-distance-input").on("input",function(e){isNaN(Number($(e.target).val()))?$(e.target).val(""):Number($(e.target).val())<0?$(e.target).val(-1*Number($(e.target).val())):l=Number($(e.target).val())}),n.onOK(function(){var e,t;if(""!==l&&l&&!isNaN(Number(l)))if(l<.5)this._showWarn("Расстояние не может быть менее 50 см!");else if(s.feature.properties.net_vertex_id===d.feature.properties.vert_1_id?(e=d._latlngs[0],t=d._latlngs[1]):(e=d._latlngs[1],t=d._latlngs[0]),e.distanceTo(t)-.5<l)this._showWarn("Расстояние не может быть больше, чем длина дуги минус 50 см!");else{var a=L.CRS.EPSG3857.project(e),o=L.CRS.EPSG3857.project(t),r=l/e.distanceTo(t),i={x:a.x+(o.x-a.x)*r,y:a.y+(o.y-a.y)*r},n=L.CRS.EPSG3857.unproject(L.point(i.x,i.y));this._tryAddVertex(L.marker(n),d)}else this._showWarn("Неверно задано расстояние!")},this),n.onCancel(function(){this._mapManager.clearSelections()},this)}else this._showWarn("Узел не принадлежит указанной дуге !")}else this._showWarn("Не выбран узел и (или) дуга !")}},_tryAddVertex:function(e,t){var a=this._getEdgsIdByPoint(t,e._latlng);if(a&&0<a.length){var o={edgeId:a[0],geoJSON:JSON.stringify(e.toGeoJSON())};this._sendPostAndRefreshLayers(window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/CreateVertexOnEdge",o)}this._mapManager.clearSelections()},_getEdgsIdByPoint:function(e,t){var a;return 1===e.feature.properties.cl_net_category_id?a="EDG":2===e.feature.properties.cl_net_category_id&&(a="EDG_VS"),this.getEdgsIdByPoint(a,t)}}),MapExpress.Tools.RemoveSelectionsCommand=MapExpress.Tools.BaseNetworkCommand.extend({options:{imageSrc:"images/cancel_@2X.png",title:"Отменить выбор",id:"remove-selections-command"},activate:function(){window.MapManager.clearSelections()}}),MapExpress.Edit.ParcelEditor=MapExpress.Edit.BaseLayerEditor.extend({initialize:function(e,t){MapExpress.Edit.BaseLayerEditor.prototype.initialize.call(this,e,t),this.options.featureKeyFieldName="asset_id",this.options.draggable=!0},onSaveAsFeatureCollection:function(e){if(e){var t=this,a=MapExpress.Utils.GeoJSONUtils.convertFeatureCollectionToMultiPolygon(e);if(!MapExpress.Utils.GeoJSONUtils.featureHasCoordinates(a))return void t._showEror("У геометрии нет координат !");var o=window.REALTY_MAP_SITE_ROOT+"/MapApi/CreateOrUpdateRealtyGeometry",r={schema:"brc_realty",table:"realty",keyColumn:"asset_id",geomColumn:"realty_geom"};r.itemId=window.brcRealtyObjectIdForMap,r.geoJSON=JSON.stringify(a),$.post(o,r).done(function(e){e?(new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow("Контур объекта сохранен в БД"),window.MapManager.refreshMap(),t._removeTempLayer(),t.clearEditLayer(),window.MapManager.clearSelections()):(t._showEror("Не удалось сохранить контур !"),t._removeTempLayer())}).fail(function(e){t._showEror("Не удалось сохранить контур !"),window.MapManager.refreshMap(),t.clearEditLayer(),window.MapManager.clearSelections(),t._removeTempLayer()})}this.clearEditLayer()},save:function(){this.saveChanges()},startEdit:function(){window.MapManager.clearSelections();var e=window.brcRealtyObjectIdForMap,t="tempEditLayer"+e;this._removeTempLayer(),this._createTempEditLayer(t,e),this.setEditableLayer(t),MapExpress.Edit.BaseLayerEditor.prototype.startEdit.call(this)},_createTempEditLayer:function(e,t){var a=window.brcMap.options.findByIdUrlTemplate,o=L.Util.template(a,{id:t}),r=new MapExpress.Service.GeoJSONProvider(o);this.currentLayer=new MapExpress.Layers.GeoJSONServiceLayer(r,{fillOpacity:0,opacity:0,weight:0,stroke:!1,featureMinPixelSize:!1}),this.currentLayer.options.dynamicData=!1,this.currentLayer.id=e;var i=new MapExpress.Mapping.LayerModel(e);i.mapLayer=this.currentLayer,i.options.showOnTOC=!1,window.MapManager.getMapModel().addLayer(i),window.MapManager.setLayerVisible(e,!0),this.currentLayer.bringToFront()},_removeTempLayer:function(){this.currentLayer&&(window.MapManager.getMapModel().removeLayerById(this.currentLayer.id),this.currentLayer._map&&window.MapManager._map.removeLayer(this.currentLayer)),this.currentLayer=!1},_showEror:function(e){new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e)}}),MapExpress.Tools.EditParcelToolbar=MapExpress.Tools.MapToolbar.extend({initialize:function(e,t){MapExpress.Tools.MapToolbar.prototype.initialize.call(this,e,t),e._map.parcelEditControl&&e._map.removeControl(e._map.parcelEditControl),(e._map.parcelEditControl=this)._addComands()},_addComands:function(){this.parcelEditor=new MapExpress.Edit.ParcelEditor,this.addCommand(new MapExpress.Tools.EditParcelCommand(window.MapManager,!1,this.parcelEditor)),this.addCommand(new MapExpress.Tools.CreateParcelCommand(window.MapManager,!1,this.parcelEditor)),this.addCommand(new MapExpress.Tools.CreateParcelFromFileCommand(window.MapManager,!1,this.parcelEditor)),this.addCommand(new MapExpress.Tools.SaveParcelCommand(window.MapManager,!1,this.parcelEditor)),this.addCommand(new MapExpress.Tools.DeleteParcelCommand(window.MapManager,!1,this.parcelEditor))}}),MapExpress.Tools.EditParcelCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/inputParams.png",title:"Редактирование контура",id:"editParcelCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.startEdit()}}),MapExpress.Tools.CreateParcelCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/focus_@2X.png",title:"Создание контура",id:"createParcelCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.startAddPolygon()}}),MapExpress.Tools.CreateParcelFromFileCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/addlayer.png",title:"Добавить контур из файла",id:"createComplexFromFileCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.addEditGeoJsonLayerFromFile()}}),MapExpress.Tools.SaveParcelCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/start_@2X.png",title:"Сохранить",id:"saveParcelCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.save()}}),MapExpress.Tools.DeleteParcelCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/trash_@2X.png",title:"Удалить",id:"deleteParcelCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){var e=this;new MapExpress.Controls.OkCancelDialog(window.MapManager._map,{closeButtonEnabled:!1}).setTitle("Удаление!").setContent("Контур объекта будет физически удален из БД! <br> Продолжить?").show().onOK(function(){e._delete()})},_delete:function(){var t=this.layerEditor,e=window.REALTY_MAP_SITE_ROOT+"/Spatial/DeleteGeometry",a={schema:"brc_realty",entityName:"realty",primaryPropertyName:"asset_id",geomColumn:"realty_geom"};a.id=window.brcRealtyObjectIdForMap,$.post(e,a).done(function(e){e?(new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow("Контур объекта удален из в БД"),window.MapManager.refreshMap(),window.MapManager.clearSelections()):(t._showEror("Не удалось удалить контур из БД !"),t._removeTempLayer())}).fail(function(e){t._showEror("Не удалось удалить контур !"),window.MapManager.refreshMap(),window.MapManager.clearSelections()})}}),MapExpress.Mapping.MapManager.prototype.__getSelection=function(t){var e=this._findIndex(this.selections,function(e){return e._layerId===t});return-1<e&&this.selections[e]},MapExpress.Tools.ConnectFaultsWithNetElementsCommand=MapExpress.Tools.BaseNetworkCommand.extend({options:{imageSrc:"images/ustanovit_sviaz_avarii_s_elementame_seti.png",title:"Установить связь аварии с элементами сети",id:"connect-objects-to-fault"},initialize:function(e,t){MapExpress.Tools.BaseNetworkCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.options.selectionStyle=(new MapExpress.Tools.SelectionCommand).options.selectionStyle,this._mapManager.clearSelections(),this.clearControl()},activate:function(){if(this._setSewerLayersVisible(),this._setWaterLayersVisible(),this._setEmergencyLayersVisible(),this.options.layerDescriptions&&0<this.options.layerDescriptions.length)for(var e=this.options.layerDescriptions.length-1;0<=e;e--)if(this.options.layerDescriptions[e].layerId&&this.options.layerDescriptions[e].featureKeyFieldName){var t=this._mapManager.getSelection(this.options.layerDescriptions[e].layerId,this.options);t&&(t.options.featureKeyFieldName=this.options.layerDescriptions[e].featureKeyFieldName,t.options.selectionStyle=this.options.selectionStyle)}this.constructionsLayerDescriptions=[],this.constructionsLayerDescriptions.push({layerId:"VERTEX",featureKeyFieldName:"net_vertex_id"}),this.constructionsLayerDescriptions.push({layerId:"VERTEX_VS",featureKeyFieldName:"net_vertex_id"}),this.constructionsLayerDescriptions.push({layerId:"EDG",featureKeyFieldName:"net_edg_id"}),this.constructionsLayerDescriptions.push({layerId:"EDG_VS",featureKeyFieldName:"net_edg_id"}),this._initFaultListeners(),this._initOkCancelDialog(),this._initConstructionListeners()},deactivate:function(){$("#mapexpress-connection-fault-elements").remove(),this.OkCancelDialog&&this.OkCancelDialog.hide(),MapExpress.Tools.BaseMapCommand.prototype.deactivate.call(this)},_rememberSelectedFeatureLayer:function(e){this.actualSelectionLayer=e._layerId},_checkForAlreadySelectedInAnotherLayerAndToggle:function(){var a=this;this.options.layerDescriptions.forEach(function(e){var t=a._mapManager.__getSelection(e.layerId,a.options);a.actualSelectionLayer&&a.actualSelectionLayer!==t._layerId&&t.clearSelection()})},_faultWasSelected:function(e){this._faultWasDeselected(!1),this._checkForAlreadySelectedInAnotherLayerAndToggle(),this.feature=e,this.updateDialog()},_faultWasSelectedMapMove:function(){this.updateDialog(!0)},_faultWasDeselected:function(e){this.clearControl(),this.clearDialog();var t=this;setTimeout(function(){t.feature||$(t._createFaultDomElement(!1)).appendTo($(".mapexpress-edg-coordinates-controller__fault"))},200)},clearControl:function(){if(this.previousFeature=this.feature,this.feature=null,this.vertexIds=[],this.armsId=[],this.edgeIds=[],this.fault_id=null,this.constructionsLayerDescriptions){var a=this;this.constructionsLayerDescriptions.forEach(function(e){var t=a._mapManager.__getSelection(e.layerId);t&&t.clearSelection()})}},_initFaultListeners:function(){var o=this;L.DomEvent.on(this._mapManager._map.getContainer(),"keyup",this._onEscapePress,this),this.options.layerDescriptions.forEach(function(e,t){var a=window.MapManager._mapModel.getLayerById(e.layerId);a&&(a.on("mapexpress:selection:manual:before:selected",o._rememberSelectedFeatureLayer,o),a.on("mapexpress:selection:manual:after:selected",o._faultWasSelected,o),a.on("mapexpress:selection:map:after:selected",o._faultWasSelectedMapMove,o),a.on("mapexpress:selection:manual:after:deselected",o._faultWasDeselected,o),a.mapLayer.on("mapexspress:layer:data:added",o._resetFaultListeners,o))})},_removeFaultListeners:function(){var o=this;L.DomEvent.off(this._mapManager._map.getContainer(),"keyup",this._onEscapePress,this),this.options.layerDescriptions.forEach(function(e,t){var a=window.MapManager._mapModel.getLayerById(e.layerId);a&&(a.off("mapexpress:selection:manual:before:selected",o._rememberSelectedFeatureLayer,o),a.off("mapexpress:selection:manual:after:selected",o._faultWasSelected,o),a.off("mapexpress:selection:map:after:selected",o._faultWasSelectedMapMove,o),a.off("mapexpress:selection:manual:after:deselected",o._faultWasDeselected,o),a.mapLayer.off("mapexspress:layer:data:added",o._resetFaultListeners,o))})},_resetFaultListeners:function(){this._removeFaultListeners(),this._initFaultListeners()},_constructionWasSelected:function(e){this.feature&&this._addConstructionElementToControl(e)},_constructionWasDeselected:function(e){this._removeConstructionElementFromControl(e),this.justToogle=!1},_initConstructionListeners:function(){var o=this;this.constructionsLayerDescriptions.forEach(function(e,t){var a=window.MapManager._mapModel.getLayerById(e.layerId);a&&(a.on("mapexpress:selection:manual:after:selected",o._constructionWasSelected,o),a.on("mapexpress:selection:manual:after:deselected",o._constructionWasDeselected,o),a.mapLayer.on("mapexspress:layer:data:added",o._resetConstructionListeners,o))})},_removeConstructionListeners:function(){var o=this;this.constructionsLayerDescriptions.forEach(function(e,t){var a=window.MapManager._mapModel.getLayerById(e.layerId);a&&(a.off("mapexpress:selection:manual:after:selected",o._constructionWasSelected,o),a.off("mapexpress:selection:manual:after:deselected",o._constructionWasDeselected,o),a.mapLayer.off("mapexspress:layer:data:added",o._resetConstructionListeners,o))})},_resetConstructionListeners:function(){this._removeConstructionListeners(),this._initConstructionListeners(),this._resetSelections()},_onEscapePress:function(e){27===e.keyCode&&(this._mapManager.clearSelections(),this.deactivate())},_initOkCancelDialog:function(){this.OkCancelDialog=new MapExpress.Controls.OkCancelDialogCustom(window.MapManager._map,{closeButtonEnabled:!1,modal:!1,position:"right",okButtonText:this.options.okButtonText||"ОК",cancelButtonText:this.options.cancelButtonText||"Отмена"}).setTitle(this.options.title).show(),this._createDomElements(),this.OkCancelDialog.onOK(function(){this._saveVertex(),this.deactivate(),this.clearControl(),this._mapManager.clearSelections()},this),this.OkCancelDialog.onCancel(function(){this.deactivate(),this.clearControl(),this._mapManager.clearSelections()},this),$(this._createFaultDomElement(!1)).appendTo($(".mapexpress-edg-coordinates-controller__fault")),$("#mapexpress-connection-fault-elements").parent().css("overflow","auto")},_createDomElements:function(){this.OkCancelDialog.setContent('<div id="mapexpress-connection-fault-elements" class="mapexpress-edg-coordinates-controller" style="overflow:hidden;display: flex;flex-direction: column;justify-content: start;min-height: 98px;">   <div class="mapexpress-edg-coordinates-controller__fault"></div>   <div class="mapexpress-edg-coordinates-controller__constructions">\t\t<div class="armature-spacer"></div>\t</div></div>')},_createFaultDomElement:function(e){return e?'<div><label id="connection-fault-id'+e.FaultId+'" class="mapexpress-point-lng connection-fault-element_label"> Авария №'+e.FaultId+"</label></div>":'<div><label id="connection-fault-id" class="connection-fault-element_label mapexpress-point-lng">Выберите место аварии</label></div>'},_createEdgDomElement:function(e){return'<div style="display: flex;flex-direction:row;justify-content:start;"><i class="mdi mdi-checkbox-marked connection-fault-element-toggler" id="connection-edg-toggler-id-'+(e.Id||e.net_edg_id)+'" style="cursor: pointer;padding:0 4px ;"></i><label class="connection-fault-element_label" id="connection-edg-id-'+(e.Id||e.net_edg_id)+'"> Дуга № '+(e.Id||e.net_edg_id)+"; Материал: "+(e.Material||e.material)+"; &#x2205: "+(e.DiameterInt||e.net_edg_diameter_int)+"/"+(e.DiameterExt||e.net_edg_diameter_ext)+"; Год прокладки: "+(e.WorkDate||e.net_edg_work_date)+"</label></div>"},_createVertexDomElement:function(e){return'<div style="display: flex;flex-direction:row;justify-content:start;"><i class="mdi mdi-checkbox-marked connection-fault-element-toggler" id="connection-vertex-toggler-id-'+(e.Id||e.net_vertex_id)+'"style="cursor: pointer;padding:0 4px ;"></i><label class="connection-fault-element_label" id="connection-vertex-id-'+(e.Id||e.net_vertex_id)+'"> Узел № '+(e.Id||e.net_vertex_id)+"; Тип сооружения: "+(e.ConstructionCategory||e.cl_net_vert_category_name)+"</label></div>"},_createArmatureDomElement:function(e,t){return t?'<div style="display: flex;flex-direction:row;justify-content:start;padding:0 16px;" class="construction-element-not-active"><i class="mdi mdi-checkbox-blank-outline connection-fault-element-toggler" id="connection-armature-toggler-id-'+e.Id+'" style="cursor: pointer;padding:0 4px ;"></i><label class="connection-fault-element_label" id="connection-armature-id-'+e.Id+'"> Арматура № '+e.Id+"; Категория: "+e.Category+"; тип: "+e.Type+"</label></div>":'<div style="display: flex;flex-direction:row;justify-content:start;padding:0 16px;"><i class="mdi mdi-checkbox-marked connection-fault-element-toggler" id="connection-armature-toggler-id-'+e.Id+'" style="cursor: pointer;padding:0 4px ;"></i><label class="connection-fault-element_label" id="connection-armature-id-'+e.Id+'"> Арматура № '+e.Id+"; Категория: "+e.Category+"; тип: "+e.Type+"</label></div>"},getFaultData:function(){var e=this.feature.feature.properties.fault_id;return new Promise(function(t,a){$.ajax({type:"get",url:window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/GetFaultObjects?faultId="+e,success:function(e){t(e)},error:function(e){a(e)}})})},updateDialog:function(e){var t=this;t.feature&&(e||this.getFaultData().then(function(e){$(t._createFaultDomElement(e)).appendTo($(".mapexpress-edg-coordinates-controller__fault")),t.fault_id=e.FaultId,t.addDataToSelections(e)}))},addDataToSelections:function(r){var i=this;this.constructionsLayerDescriptions.forEach(function(e){var t={};for(var a in i.options)"singleSelect"!==a&&(t[a]=i.options[a]);t.singleSelect=!1;var o=i._mapManager.getSelection(e.layerId,t);o._layerId===e.layerId&&o._layerModel.mapLayer.eachLayer(function(t){"EDG_VS"!==o._layerId&&"EDG"!==o._layerId||r.EdgeList.forEach(function(e){t.feature.properties.net_edg_id===e.Id&&o.addSelection(t,!1)}),"VERTEX_VS"!==o._layerId&&"VERTEX"!==o._layerId||r.VertexList.forEach(function(e){t.feature.properties.net_vertex_id===e.Id&&o.addSelection(t,!1)})})}),r.EdgeList.forEach(function(e){$(i._createEdgDomElement(e)).insertBefore($(".armature-spacer")),i.edgeIds.push(e.Id)}),r.VertexList.forEach(function(e){$(i._createVertexDomElement(e)).insertBefore($(".armature-spacer")),i.vertexIds.push(e.ConstructionId)}),r.ArmatureList.forEach(function(e){-1!==i.armsId.indexOf(e.Id)||$("#connection-armature-id-"+e.Id).length||(0<$("#connection-vertex-id-"+e.VertexId).length?$(i._createArmatureDomElement(e)).insertAfter($("#connection-vertex-id-"+e.VertexId).parent()):$(i._createArmatureDomElement(e)).insertAfter($(".armature-spacer")),i.armsId.push(e.Id))}),r.VertexList.forEach(function(t){i._getConstructionInfoWithArma(t.ConstructionId).then(function(e){e.forEach(function(e){-1!==i.armsId.indexOf(e.Id)||$("#connection-armature-id-"+e.Id).length||($(i._createArmatureDomElement(e,!0)).insertAfter($("#connection-vertex-id-"+t.Id).parent()),i._resetTogglersListeners())})})}),i.faultData=r,i._resetTogglersListeners()},_resetSelections:function(){var o=this;o.faultData&&(o.constructionsLayerDescriptions.forEach(function(e){var a=o._mapManager.__getSelection(e.layerId);a&&a._layerId===e.layerId&&a._layerModel.mapLayer.eachLayer(function(t){"EDG_VS"!==a._layerId&&"EDG"!==a._layerId||o.edgeIds.forEach(function(e){t.feature.properties.net_edg_id!==e||a.isLayerSelected(t)||a.addSelection(t,!1)}),"VERTEX_VS"!==a._layerId&&"VERTEX"!==a._layerId||o.vertexIds.forEach(function(e){t.feature.properties.net_vert_constr_id!==e||a.isLayerSelected(t)||a.addSelection(t,!1)})})}),o.options.layerDescriptions.forEach(function(e){var t=o._mapManager.__getSelection(e.layerId);t&&o.faultData&&t._layerModel.mapLayer.eachLayer(function(e){e.feature.properties.fault_id!==o.faultData.FaultId||t.isLayerSelected(e)||t.addSelection(e,!1)})}))},_initTogglersListeners:function(e){var a=this;$(".connection-fault-element-toggler").each(function(e,t){L.DomEvent.on(t,"click",a.toggleSelection,a)})},_removeTogglersListeners:function(e){var a=this;$(".connection-fault-element-toggler").each(function(e,t){L.DomEvent.off(t,"click",a.toggleSelection,a)})},_resetTogglersListeners:function(){this._removeTogglersListeners(),this._initTogglersListeners()},toggleSelection:function(e){var r,i=this,t=$(e.target).attr("id").split("-"),n=t[1],s=t[4];if($(e.target).removeClass("mdi-checkbox-blank-outline"),$(e.target).removeClass("mdi-checkbox-marked"),$(e.target).parent().hasClass("construction-element-not-active")?($(e.target).parent().removeClass("construction-element-not-active"),$(e.target).addClass("mdi-checkbox-marked"),r=!0):($(e.target).parent().addClass("construction-element-not-active"),$(e.target).addClass("mdi-checkbox-blank-outline"),r=!1),"armature"!==n)this.constructionsLayerDescriptions.forEach(function(e){var o=i._mapManager.__getSelection(e.layerId);o._layerId===e.layerId&&o._layerModel.mapLayer.eachLayer(function(e){if("edg"===n&&("EDG_VS"===o._layerId||"EDG"===o._layerId)&&e.feature.properties.net_edg_id===Number(s))if(r)o.isLayerSelected(e)||o.addSelection(e,!1),-1===i.edgeIds.indexOf(e.feature.properties.net_edg_id)&&i.edgeIds.push(e.feature.properties.net_edg_id);else{o.removeSelection(e,!0);for(var t=i.edgeIds.length-1;0<=t;t--)i.edgeIds[t]===e.feature.properties.net_edg_id&&i.edgeIds.splice(t,1)}if("vertex"===n&&("VERTEX_VS"===o._layerId||"VERTEX"===o._layerId)&&e.feature.properties.net_vertex_id===Number(s))if(r)o.isLayerSelected(e)||o.addSelection(e,!1),-1===i.vertexIds.indexOf(e.feature.properties.net_vert_constr_id)&&i.vertexIds.push(e.feature.properties.net_vert_constr_id);else{o.removeSelection(e,!0);for(var a=i.vertexIds.length-1;0<=a;a--)i.vertexIds[a]===e.feature.properties.net_vert_constr_id&&i.vertexIds.splice(a,1)}})});else if("armature"===n)if(r)this.armsId.push(Number(s));else for(var a=this.armsId.length-1;0<=a;a--)this.armsId[a]===Number(s)&&this.armsId.splice(a,1)},clearDialog:function(){$(".mapexpress-edg-coordinates-controller__constructions").empty(),$(".mapexpress-edg-coordinates-controller__fault").empty(),$(".mapexpress-edg-coordinates-controller__constructions").append('<div class="armature-spacer"></div>')},_getConstructionInfoWithArma:function(e){return new Promise(function(t,a){$.ajax({type:"get",url:window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/GetArmatureFaultObjects?constrId="+e,success:function(e){t(e)},error:function(e){a(e)}})})},_addConstructionElementToControl:function(t){var a=this;if("EDG_VS"===t.target.id||"EDG"===t.target.id)$("#connection-edg-id-"+t.feature.properties.net_edg_id).length||$(a._createEdgDomElement(t.feature.properties)).insertBefore($(".armature-spacer")),-1===a.edgeIds.indexOf(t.feature.properties.net_edg_id)&&a.edgeIds.push(t.feature.properties.net_edg_id),a._resetTogglersListeners();else if("VERTEX_VS"===t.target.id||"VERTEX"===t.target.id){var e;if(!$("connection-edg-id-"+t.feature.properties.net_vertex_id).length)$("#connection-vertex-id-"+t.feature.properties.net_vertex_id).length?((e=$("#connection-vertex-id-"+t.feature.properties.net_vertex_id).parent()).removeClass("construction-element-not-active"),e.find(".connection-fault-element-toggler").removeClass("mdi-checkbox-blank-outline").addClass("mdi-checkbox-marked")):e=$(a._createVertexDomElement(t.feature.properties)),e.insertBefore($(".armature-spacer")),a.vertexIds.push(t.feature.properties.net_vert_constr_id),this._getConstructionInfoWithArma(t.feature.properties.net_vert_constr_id).then(function(e){e.forEach(function(e){-1!==a.armsId.indexOf(e.Id)||$("#connection-armature-id-"+e.Id).length?$("#connection-armature-id-"+e.Id).parent().insertAfter($("#connection-vertex-id-"+t.feature.properties.net_vertex_id).parent()):($(a._createArmatureDomElement(e,!0)).insertAfter($("#connection-vertex-id-"+t.feature.properties.net_vertex_id).parent()),a._resetTogglersListeners())})});a._resetTogglersListeners()}else this._showWarn("Элемент не принадлежит слоям сети!")},_removeConstructionElementFromControl:function(t){if("EDG_VS"===t.target.id||"EDG"===t.target.id){$("#connection-edg-id-"+t.feature.properties.net_edg_id).parent().remove();for(var e=this.edgeIds.length-1;0<=e;e--)this.edgeIds[e]===t.feature.properties.net_edg_id&&this.edgeIds.splice(e,1)}else if("VERTEX_VS"===t.target.id||"VERTEX"===t.target.id){this._getConstructionInfoWithArma(t.feature.properties.net_vert_constr_id).then(function(e){e.forEach(function(e){Number(e.VertexId)===Number(t.feature.properties.net_vertex_id)&&$("#connection-armature-id-"+e.Id).parent().insertAfter(".armature-spacer")})}),$("#connection-vertex-id-"+t.feature.properties.net_vertex_id).parent().remove();for(var a=this.vertexIds.length-1;0<=a;a--)this.vertexIds[a]===t.feature.properties.net_vert_constr_id&&this.vertexIds.splice(a,1)}this._resetTogglersListeners()},_saveVertex:function(){var o=this,e={fault_id:o.fault_id,edgeIds:o.edgeIds,constrIds:o.vertexIds,armIds:o.armsId};return new Promise(function(t,a){$.ajax({type:"POST",url:window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/CreateFaultObjects",data:e,success:function(e){e.statusCodeText;"Success"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow(e.responseText);"Warning"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showWarnWindow(e.responseText);"Error"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e.responseText);t(e)},error:function(e){o._showEror("Внутренняя ошибка приложения!"),a(e)},async:!0})})}});var brcMap=function(){var u={findByIdUrlTemplate:"/MapApi/RealtySpatialItemById?schema=brc_realty&table=realty&keyColumn=asset_id&geomColumn=realty_geom&itemId={id}",allParcelsUrlTemplate:"/MapApi/RealtySpatialItems?schema=brc_realty&table=geo_parcel_view&keyColumn=id&geomColumn=geom&bbox={xMin},{yMin},{xMax},{yMax}",allBuildingsUrlTemplate:"/MapApi/RealtySpatialItems?schema=brc_realty&table=geo_building_view&keyColumn=id&geomColumn=geom&bbox={xMin},{yMin},{xMax},{yMax}",allObjectBoundsUrl:"/MapApi/GetLayerBounds?schema=brc_realty&table=realty&geomColumn=realty_geom",allParcelEncumUrlTemplate:"/MapApi/RealtySpatialItems?schema=brc_realty&table=geo_parcel_encum_view&keyColumn=encum_id&geomColumn=geom&bbox={xMin},{yMin},{xMax},{yMax}",allBuildingEncumUrlTemplate:"/MapApi/RealtySpatialItems?schema=brc_realty&table=geo_building_encum_view&keyColumn=encum_id&geomColumn=geom&bbox={xMin},{yMin},{xMax},{yMax}",createOrUpdateRealtyGeometryUrl:"/MapApi/CreateOrUpdateRealtyGeometry",rosreestrCheckContour:"/MapApi/RealtySpatialItems?schema=brc_roscheck&table=input_query&keyColumn=input_query_id&geomColumn=input_query_geom&bbox={xMin},{yMin},{xMax},{yMax}",parcelStyle:{color:"darkRed"},buildingStyle:{color:"darkBlue"},rosreestrCheckContourStyle:{color:"darkGreen"}};function t(){var e,t,a,o,r=window.MapManager,i=window.MapManager._map,n=window.realtySecurityManager.anyActionNetworkAllowed()||window.realtySecurityManager.anyActionNetworkEmergencyAllowed();i.addControl((e=window.MapManager,(t=new MapExpress.Tools.MapToolbar(e,{position:"topleft"})).addCommand(new MapExpress.Tools.ShowLayerControlMapCommandExt(e)),t.addControlFromTemplate("templates/realtySearch.html","searchId"),t)),"egrn"===window.brcRealtyObjectNameForMap&&window.realtySecurityManager.createEgrnOrderAllowed()&&(a=window.MapManager,o=new MapExpress.Tools.OrderToolbar(a,{position:"topleft",style:"clear:right"}),window.MapManager._map.addControl(o));var s,d,l,p=n?"topleft":"topright";i.addControl((s=p,d=window.MapManager,(l=new MapExpress.Tools.MapToolbar(d,{position:s,style:"clear:right"})).addCommand(new MapExpress.Tools.IdentifyMapCommand(d)),l.addCommand(new MapExpress.Tools.LineMeasureCommand(d)),l.addCommand(new MapExpress.Tools.SqrtMeasureCommand(d)),l.addCommand(new MapExpress.Tools.MapExportCommand(d)),l.addCommand(new MapExpress.Tools.SelectorBaseMapsCommand(d)),l)),i.addControl(function(){var e=new MapExpress.Controls.MapStatusbarControl(window.MapManager);e.addSection(new MapExpress.Controls.ZoomStandartStatusbarSection(window.MapManager)),e.addSection(new MapExpress.Controls.CoordinatesStandartStatusbarSection(window.MapManager)),e.addSection(new MapExpress.Controls.CurrentToolStatusbarSection(window.MapManager));var t=new MapExpress.Controls.AttibutionStandartStatusbarSection(window.MapManager);return t.options.attibution.push({href:"http://leafletjs.com",prefix:"Leaflet"}),t.options.attibution.push({href:"https://openstreetmap.org",prefix:"© OpenStreetMap"}),t.options.attibution.push({href:"https://pkk5.rosreestr.ru",prefix:"Публичная кадастрвоая карта"}),e.addSection(t),window.MapManager.mapStatusBar=e}()),n&&(window.brcIntitializeMapToc.addNetworkLayerGroups(),function(){if(window.realtySecurityManager.anyActionNetworkAllowed()){var e=new MapExpress.Tools.NetworkEditToolbar(window.MapManager,{position:"topright"});window.MapManager._map.addControl(e)}}(),function(){if(window.realtySecurityManager.anyActionNetworkEmergencyAllowed()){var e=new MapExpress.Tools.EmergencyRepairEditToolbar(window.MapManager,{position:"topright"});window.MapManager._map.addControl(e)}}(),function(){for(var e=window.MapManager._mapModel.getLayerById("Водоотведение").getAllLayers(),t=window.MapManager._mapModel.getLayerById("Водоснабжение").getAllLayers(),a=window.MapManager._mapModel.getLayerById("EMERGENCY_GROUP").getAllLayers(),o=e.concat(t).concat(a),r=o.length-1;0<=r;r--){var i=o[r];i.mapLayer&&MapExpress.Utils.legendUtils.addLegendItemToLayer(i.mapLayer,{minZoom:0,maxZoom:24})}}()),function(){var e=window.MapManager.getMapModel(),t=e.getFavoriteLayers(),a=e.getLayerById("Водоотведение"),o=e.getLayerById("Водоснабжение"),r=e.getLayerById("EMERGENCY_GROUP");a&&t.push(a);o&&t.push(o);r&&t.push(r);t.push(e.getLayerById("fe7e98bd-481c-4bdb-a574-c2dc2a4ce769")),t.push(e.getLayerById("3d40fc51-42d0-4040-96fb-0ca16c1cfb57")),t.push(e.getLayerById("b1623da6-d2ea-4ed3-8998-888c7ca2671b"));var i=window.MapManager.getMapModel().getFirstLayerByOptionValue("displayName","Ломоносовский район");if(i&&i.hasChildren())for(var n=i.getAllLayers(),s=0;s<n.length;s++){var d=n[s];t.push(d)}}(),MapExpress.Utils.CadastreUtils.replaceRosreestrIdentifyFunc(),L.control.zoom({position:"topleft"}).addTo(i),window.brcIntitializeMapToc.allParcelsUrlTemplate=u.allParcelsUrlTemplate,window.brcIntitializeMapToc.allBuildingsUrlTemplate=u.allBuildingsUrlTemplate,window.brcIntitializeMapToc.layerGroupName=u.layerGroupName,window.brcIntitializeMapToc.parcelStyle=u.parcelStyle,window.brcIntitializeMapToc.buildingStyle=u.buildingStyle,window.brcIntitializeMapToc.assetsComplexInfoUrl=u.assetsComplexInfoUrl,window.brcIntitializeMapToc.rosreestrCheckContour=u.rosreestrCheckContour,window.brcIntitializeMapToc.rosreestrCheckContourStyle=u.rosreestrCheckContourStyle,window.brcIntitializeMapToc.allBuildingEncumUrlTemplate=u.allBuildingEncumUrlTemplate,window.brcIntitializeMapToc.allParcelEncumUrlTemplate=u.allParcelEncumUrlTemplate,window.MapManager.usedGeoServer()?m():function(){if(window.brcRealtyObjectIdForMap&&"asset_complex"===window.brcRealtyObjectNameForMap)return window.brcIntitializeMapToc.addComplexLayers(window.brcRealtyObjectIdForMap,m);if(!window.brcRealtyObjectNameForMap)return window.brcIntitializeMapToc.addAllComplex(m);if(window.brcRealtyObjectNameForMap&&window.brcRealtyAssetComplexIdForMap&&"undefined"!==window.brcRealtyAssetComplexIdForMap&&"asset_complex"===window.brcRealtyObjectNameForMap)return window.brcIntitializeMapToc.addComplexLayers(window.brcRealtyAssetComplexIdForMap,m);window.brcIntitializeMapToc.addAllComplex(m)}(),MapExpress.Tools.IdentifyMapCommand.maxHeightMinus=.25,MapExpress.Tools.IdentifyMapCommand.maxWidthMinus=.6,MapExpress.Tools.IdentifyMapCommand.showFloatWindow=!1,r.rememberMapStateInLocalStorageBeforeLeave();var c=!window.brcRealtyObjectNameForMap||"undefined"===window.brcRealtyObjectNameForMap||""===window.brcRealtyObjectNameForMap||void 0===window.brcRealtyObjectNameForMap;function m(){if(window.brcRealtyObjectNameForMap&&window.brcRealtyAssetComplexIdForMap&&"undefined"!==window.brcRealtyAssetComplexIdForMap&&"asset_complex"===window.brcRealtyObjectNameForMap&&(window.MapManager.usedGeoServer()||window.MapManager.setLayerVisible("REALTY_COMLEX"+window.brcRealtyAssetComplexIdForMap,!0),window.realtySecurityManager.editAssetsComlexAllowed())){var e=new MapExpress.Tools.PkkForAssetComplexToolbar(window.MapManager,{position:"topright"});i.addControl(e)}if(window.brcRealtyObjectIdForMap&&"parcel"===window.brcRealtyObjectNameForMap&&window.realtySecurityManager.editParcelAllowed()){var t=new MapExpress.Tools.EditParcelToolbar(window.MapManager,{position:"topright"});i.addControl(t)}if(window.brcRealtyObjectIdForMap&&"building"===window.brcRealtyObjectNameForMap&&window.realtySecurityManager.editBuildingAllowed()){var a=new MapExpress.Tools.EditParcelToolbar(window.MapManager,{position:"topright"});i.addControl(a)}if(window.brcRealtyObjectIdForMap&&"invest_project"===window.brcRealtyObjectNameForMap){var o=window.MapManager._mapModel.getLayerById(window.brcRealtyObjectIdForMap.toString());o&&o.mapLayer.once("mapexspress:layer:data:added",function(e){if(window.realtySecurityManager.editInvestProjectAllowed()){var t=new MapExpress.Tools.InvestProjectToolbar(window.MapManager,{position:"topright"});i.addControl(t)}})}window.brcMapPosition.allObjectBoundsUrl=u.allObjectBoundsUrl,window.brcMapPosition.findByIdUrlTemplate=u.findByIdUrlTemplate,window.brcMapPosition.trySetPosition()}r.recallMapStateFromLocalStorage(c)}return MapExpress.Tools.ShowLayerControlMapCommandExt=MapExpress.Tools.ShowLayerControlMapCommand.extend({createContent:function(e){var t=MapExpress.Tools.ShowLayerControlMapCommand.prototype.createContent.call(this,e);MapExpress.Controls.MapControlUtils.setStyle(t,"float:left");var a=L.DomUtil.create("span","divider1",e);return MapExpress.Controls.MapControlUtils.setStyle(a,"float:left"),t}}),{initialize:function(e){MapExpress.Mapping.MapInitializerHelper.initializeFromURL(e,"map_model.json",t)},options:u}}(),brcIntitializeMapToc=function(){var e={},p={};function a(o,r,i,n){MapExpress.Utils.Promise.GetJSON(p.assetsComplexInfoUrl).then(function(e){if(e&&L.Util.isArray(e))for(var t=e.length-1;0<=t;t--){var a=e[t];i&&i!==a.id||s(o,a.id,a.name,a.bounds,n)}r&&"function"==typeof r&&r(o)},function(e){new MapExpress.Controls.MapControl(window.MapManager._map,{removalDelay:4e3}).setContent("Не удалось получить данные по комплексам!<br>"+e).show()})}function s(e,t,a,o,r){var i=new MapExpress.Mapping.LayerModel("REALTY_COMLEX"+t,{displayName:a});e.addLayer(i);var n=c(i,window.REALTY_MAP_SITE_ROOT+"/MapApi/GetAssetComplexCountour?itemId="+t,"Граница","LOKS_CONTOUR"+t,p.rosreestrCheckContourStyle,3,!1),s=c(i,p.allBuildingsUrlTemplate+"&where=asset_complex_id="+t,"Здания и сооружения","LOKS_ZIS"+t,p.buildingStyle,1,!0);s.mapLayer.options.minZoom=12;var d=c(i,p.allParcelsUrlTemplate+"&where=asset_complex_id="+t,"Земельные участки","LOKS_ZU"+t,p.parcelStyle,2,!0);d.mapLayer.options.minZoom=12,m(n),m(s),m(d);function l(e,r){e.on("mapexspress:layermodel:visiblechanged",function(e){var t,a,o;a=e.id,o=r,(t=e).id===a&&t.mapLayer.options.visible&&o&&L.Util.isArray(o)&&window.MapManager._map.fitBounds(o)})}r&&(l(i,o),l(n,o))}function c(e,t,a,o,r,i,n){var s=new MapExpress.Service.GeoJSONProvider(t),d=new MapExpress.Layers.GeoJSONServiceLayer(s);d.options.queryable=n,d.options.maxZoom=23,d.options.minZoom=8,d.options.visibleIndex=i,d.id=o;var l=new MapExpress.Mapping.LayerModel(o);return l.options.displayName=a,l.options.type="overlay",l.mapLayer=d,e.addLayer(l),r&&(r.overrideStyle=!0,l.mapLayer.styles=[r]),l}function m(e){e&&e.mapLayer&&MapExpress.Utils.legendUtils.addLegendItemToLayer(e.mapLayer,{minZoom:0,maxZoom:24})}return e.addAllComplex=function(e){var t=new MapExpress.Mapping.LayerModel(p.layerGroupName,{displayName:p.layerGroupName});window.MapManager.getMapModel().addLayer(t),a(t,e,!1,!0)},e.addComplexLayers=function(e,t){a(window.MapManager.getMapModel(),t,e,!0)},e.addNetworkLayerGroups=function(){var e,t;!function(){var e=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/NetworkEdgeItems?bbox={xMin},{yMin},{xMax},{yMax}&where=cl_net_category_id=2",t=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/NetworkVertexItems?bbox={xMin},{yMin},{xMax},{yMax}&where=cl_net_category_id=2",a=new MapExpress.Mapping.LayerModel("Водоснабжение",{displayName:"Водоснабжение"});window.MapManager.getMapModel().addLayer(a),c(a,t,"Узлы сети ВС","VERTEX_VS",null,0,!0).mapLayer.options.minZoom=12;var o=c(a,e,"Участки сети ВС","EDG_VS",{weight:3,color:"#006FB8","stroke-width":3,"stroke-opacity":1,"stroke-linecap":"round","stroke-linejoin":"round",minZoom:1,maxZoom:24},4,!0);o.mapLayer.options.minZoom=12,o.mapLayer.options.featureMinPixelSize=0}(),function(){var e=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/NetworkEdgeItems?bbox={xMin},{yMin},{xMax},{yMax}&where=cl_net_category_id=1",t=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/NetworkVertexItems?bbox={xMin},{yMin},{xMax},{yMax}&where=cl_net_category_id=1",a=new MapExpress.Mapping.LayerModel("Водоотведение",{displayName:"Водоотведение"});window.MapManager.getMapModel().addLayer(a),c(a,t,"Узлы сети ВО","VERTEX",null,0,!0).mapLayer.options.minZoom=12;var o=c(a,e,"Участки сети ВО","EDG",{weight:3,color:"#B18C46","stroke-width":3,"stroke-opacity":1,"stroke-linecap":"round","stroke-linejoin":"round",minZoom:1,maxZoom:24},3,!0);o.mapLayer.options.minZoom=12,o.mapLayer.options.featureMinPixelSize=0}(),e=window.REALTY_MAP_SITE_ROOT+"/MapApi/RealtySpatialItems?schema=brc_vodo&bbox={xMin},{yMin},{xMax},{yMax}&table=gis_fault_short_info_v&keyColumn=fault_geo_id&geomColumn=fault_geo_coordinate&where=cl_net_category_id=",t=new MapExpress.Mapping.LayerModel("EMERGENCY_GROUP",{displayName:"Плановые и аварийные работы"}),window.MapManager.getMapModel().addLayer(t),c(t,e+"2","Места проведения работ ВС","EMERGENCY_VS",{fillColor:"#006FB8",color:"DarkRed",radius:6,fillOpacity:.5,weight:2},0,!0).mapLayer.options.minZoom=12,c(t,e+"1","Места проведения работ ВО","EMERGENCY_VO",{fillColor:"#B18C46",color:"DarkRed",radius:6,fillOpacity:.5,weight:2},0,!0).mapLayer.options.minZoom=12,window.networkInfoTool.initIdentitfyFunc()},p=e}(),networkInfoTool={initIdentitfyFunc:function(){var e=window.MapManager._mapModel.getLayerById("EDG");e.mapLayer._dataPovider.getFeatureInfoAsync=n(e.mapLayer,"net_edg_id","/Network/NetworkEdge/NetworkEdgeCard"),e.mapLayer._dataPovider.afterRenderFeatureInfoContentCallback=s;var t=window.MapManager._mapModel.getLayerById("EDG_VS");t.mapLayer._dataPovider.getFeatureInfoAsync=n(t.mapLayer,"net_edg_id","/Network/NetworkEdge/NetworkEdgeCard"),t.mapLayer._dataPovider.afterRenderFeatureInfoContentCallback=s;var a=window.MapManager._mapModel.getLayerById("VERTEX");a.mapLayer._dataPovider.getFeatureInfoAsync=n(a.mapLayer,"net_vertex_id","/Network/NetworkVertexConstruction/NetworkVertexCard"),a.mapLayer._dataPovider.afterRenderFeatureInfoContentCallback=d;var o=window.MapManager._mapModel.getLayerById("VERTEX_VS");o.mapLayer._dataPovider.getFeatureInfoAsync=n(o.mapLayer,"net_vertex_id","/Network/NetworkVertexConstruction/NetworkVertexCard"),o.mapLayer._dataPovider.afterRenderFeatureInfoContentCallback=d;var r=window.MapManager._mapModel.getLayerById("EMERGENCY_VO");r.mapLayer._dataPovider.getFeatureInfoAsync=n(r.mapLayer,"fault_id","/Network/EmergencyRepair/FaultCard"),r.mapLayer._dataPovider.afterRenderFeatureInfoContentCallback=l;var i=window.MapManager._mapModel.getLayerById("EMERGENCY_VS");function n(l,p,c){return function(e,t,a,o,r){var i=$.Deferred(),n=[],s=window.MapManager._map.containerPointToLayerPoint(t);return l._getFeaturesAtPoint(e,s,a,o,r).then(function(e){if(e&&e.length&&0<e.length)for(var t=e.length-1;0<=t;t--)n.push(d(e[t]));else i.reject()},function(e){i.reject()}),$.when.apply($,n).done(function(){var e=[];if(arguments&&0<arguments.length)for(var t=0;t<arguments.length;t++){var a=arguments[t];a&&e.push(a)}i.resolve(e)}),i.promise();function d(e){var t=$.Deferred(),a=window.REALTY_MAP_SITE_ROOT+c,o={};return o.itemId=e.properties[p],$.post(a,o).done(function(e){t.resolve(e)}),t.promise()}}}function s(e){var t={};t.selector=e.identifiedResultDivSelector,t.callback=p,c(t.selector),m(t.selector),u(),window.edgeCardInit(t)}function d(e){var t={};t.selector=e.identifiedResultDivSelector,t.callback=p,c(t.selector),m(t.selector),u(),window.vertexCardInit(t)}function l(e){var t={};t.selector=e.identifiedResultDivSelector,t.callback=p,c(t.selector),m(t.selector),u(),window.emergencyRepairCardInit(t)}function p(e){e.statusCodeText,"Success"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow(e.responseText),"Error"===e.statusCodeText&&new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e.responseText)}function c(e){e&&(e.css("font-size","12px"),e.addClass("override-leaflet-color"));var t=e.find(".mapexpress-layer-info-data-wrapper");t&&t.addClass("override-leaflet-color")}function m(e){window.MapManager.identifyWindow&&(window.MapManager.identifyWindow.options.destroyOnClose=!1),window.MapManager.on("mapexpress:identifytool:beforewindowclose",function(){try{window.MapManager.identifyWindow&&window.MapManager.identifyWindow._control&&window.destroyControls($(window.MapManager.identifyWindow._control),function(){window.MapManager.identifyWindow&&(window.MapManager.identifyWindow.options.destroyOnClose=!0,window.MapManager.identifyWindow.destroy())})}catch(e){window.MapManager.identifyWindow&&(window.MapManager.identifyWindow.options.destroyOnClose=!0,window.MapManager.identifyWindow.destroy()),console.log(e)}})}function u(){window.MapManager.on("mapexpress:identifytool:tabpageclicked",function(e){var t=e.find("[data-role=tabstrip]");t&&t.data("kendoTabStrip")&&t.data("kendoTabStrip").resize()})}i.mapLayer._dataPovider.getFeatureInfoAsync=n(i.mapLayer,"fault_id","/Network/EmergencyRepair/FaultCard"),i.mapLayer._dataPovider.afterRenderFeatureInfoContentCallback=l}};MapExpress.Tools.CreateOrderByGeometryEditor=MapExpress.Edit.BaseLayerEditor.extend({initialize:function(e,t){MapExpress.Edit.BaseLayerEditor.prototype.initialize.call(this,e,t),this.options.featureKeyFieldName="asset_complex_id"},onSaveAsFeatureCollection:function(e){if(window.MapManager._map.bufferTools){var t=window.MapManager._map.bufferTools.createBufferResult();e.features.push(t.bufferGeoJSON),e.features.push(t.lineStringGeoJSON),this.bufferLineStringCommand&&this.bufferLineStringCommand.clearCommandAndControl()}if(MapExpress.Utils.GeoJSONUtils.featureHasCoordinates(e)){var a=[],o=new MapExpress.Controls.OkCancelDialog(window.MapManager._map).setTitle("Типы кадастровых объектов").setContent('   <div style="display: flex;flex-direction: column;justify-content: center;">        <ul class="mapexpress-order-list-types">            <li class="mapexpress-order-list-types--item">                <span style="color:#757575;">Кадастровые кварталы</span>&nbsp&nbsp&nbsp                <div class="document-status-container">                   <label class="document-status-switch">                        <input type="checkbox" id="mapexpress-order-list-types--item_2" /><div></div>                   </label>               </div>           </li>            <li class="mapexpress-order-list-types--item">                <span style="color:#757575;">Земельные участки</span>&nbsp&nbsp&nbsp                <div class="document-status-container">                   <label class="document-status-switch">                        <input type="checkbox" id="mapexpress-order-list-types--item_1" /><div></div>                   </label>               </div>           </li>            <li class="mapexpress-order-list-types--item">                <span style="color:#757575;">Объекты капитального строительства</span>&nbsp&nbsp&nbsp                <div class="document-status-container">                   <label class="document-status-switch">                        <input type="checkbox" id="mapexpress-order-list-types--item_5" /><div></div>                   </label>               </div>           </li>        </ul>    </div>').show();$(".mapexpress-order-list-types").find("input").each(function(e,t){$(t).on("change",function(e){var t=$(this).attr("id").replace("mapexpress-order-list-types--item_","");-1<a.indexOf(t)?e.target.checked||a.splice(a.indexOf(t),1):e.target.checked&&a.push(t)})});o.onOK(function(){a.length&&MapExpress.Service.OrderManager.addObject2OrderByGeometry(e,a)})}else this._showErrorWindow("Контур не имееет координат !")},save:function(){this.saveChanges()},_showErrorWindow:function(e,t){new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e),t&&console.log(t)}}),MapExpress.Edit.OrderVertexMarker=L.Editable.VertexMarker.extend({options:{draggable:!0,className:"leaflet-div-icon leaflet-vertex-icon mapexpress-order-edge"},initialize:function(e,t,a,o){L.Editable.VertexMarker.prototype.initialize.call(this,e,t,a,o)}}),MapExpress.Edit.OrderMiddleMarker=L.Editable.MiddleMarker.extend({options:{draggable:!0,className:"leaflet-div-icon leaflet-middle-icon mapexpress-order-middle-edge"},initialize:function(e,t,a,o,r){L.Editable.MiddleMarker.prototype.initialize.call(this,e,t,a,o,r)}}),MapExpress.Tools.OrderToolbar=MapExpress.Tools.MapToolbar.extend({initialize:function(e,t){MapExpress.Tools.MapToolbar.prototype.initialize.call(this,e,t),e._map.editComplexToolbar&&e._map.removeControl(e._map.editComplexToolbar),(e._map.editComplexToolbar=this).addCommand(new MapExpress.Tools.AddOksToOrderCommand(window.MapManager)),this.addCommand(new MapExpress.Tools.AddParcelToOrderCommand(window.MapManager)),this.addCommand(new MapExpress.Tools.AddKvartalToOrderCommand(window.MapManager)),this.layerEditor=new MapExpress.Tools.CreateOrderByGeometryEditor(!1,{editFeatureStyle:{color:"#006fb8",weight:2,fillOpacity:.2},vertexMarkerClass:MapExpress.Edit.OrderVertexMarker,middleMarkerClass:MapExpress.Edit.OrderMiddleMarker}),this.addCommand(new MapExpress.Tools.CreateOrderFromGeometryCommand(window.MapManager,!1,this.layerEditor));var a=new MapExpress.Tools.BufferLineStringCommand(window.MapManager,{bufferZoneStart:5,bufferZoneRange:{min:.5,max:100},bufferZoneStep:1});this.addCommand(new MapExpress.Tools.SaveOrderFromFileCommand(window.MapManager,!1,this.layerEditor)),this.layerEditor.bufferLineStringCommand=a,this.addCommand(a),this.addCommand(new MapExpress.Tools.SaveOrderFromGeometryCommand(window.MapManager,!1,this.layerEditor))}}),MapExpress.Tools.CreateOrderFromGeometryCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/focus_@2X.png",title:"Создать контур",id:"createorderfromgeometrycommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.startAddPolygon()}}),MapExpress.Tools.SaveOrderFromGeometryCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/start_@2X.png",title:"Начать формирование ...",id:"saveOrderFromGeometryCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.save()}}),MapExpress.Tools.SaveOrderFromFileCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/addlayer.png",title:"Добавить контур из файла",id:"createComplexFromFileCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.addEditGeoJsonLayerFromFile()}}),MapExpress.Tools.AddObjectToOrderCommand=MapExpress.Tools.MapClickBaseMapCommand.extend({_afterClick:function(){}}),MapExpress.Tools.AddParcelToOrderCommand=MapExpress.Tools.AddObjectToOrderCommand.extend({options:{buttonText:"ЗУ",title:"Добавить земельный участок к заказу",id:"addParcelToOrder"},onClick:function(e){MapExpress.Service.OrderManager.addParcel2OrderFromMap(e.latlng),this._afterClick()}}),MapExpress.Tools.AddOksToOrderCommand=MapExpress.Tools.AddObjectToOrderCommand.extend({options:{buttonText:"ОКС",title:"Добавить здание(сооружение) к заказу",id:"addOksToOrder"},onClick:function(e){MapExpress.Service.OrderManager.addOks2OrderFromMap(e.latlng),this._afterClick()}}),MapExpress.Tools.AddKvartalToOrderCommand=MapExpress.Tools.AddObjectToOrderCommand.extend({options:{buttonText:"КК",title:"Добавить кадастровый квартал к заказу",id:"addKvartallToOrder"},onClick:function(e){MapExpress.Service.OrderManager.addKvartal2OrderFromMap(e.latlng),this._afterClick()}}),MapExpress.Tools.RemoveSelectionsCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/cancel_@2X.png",title:"Отменить выбор",id:"remove-selections-command"},activate:function(){window.MapManager.clearSelections()}}),MapExpress.Tools.ExcludeFromOrder=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/cancel_@2X.png",title:"Исключить из заказа",id:"exclude-from-order-command"},activate:function(){var e=this,t=window.MapManager.__getSelection("PKK_PARCELS_"+window.orderGroupId),a=window.MapManager.__getSelection("PKK_OKS_"+window.orderGroupId);if(t||a){var o=t.getSelections(),r=a.getSelections();if(o.length||r.length)new MapExpress.Controls.OkCancelDialog(window.MapManager._map).setTitle("Исключение из заказа").setContent("<label> Исключить из заказа выбранные объекты? </label>").show().onOK(function(){e.excludeObjects(o,r)});else new MapExpress.Controls.MapControl(window.MapManager._map).showWarnWindow("Не выбраны элементы!")}else new MapExpress.Controls.MapControl(window.MapManager._map).showWarnWindow("Не выбраны элементы!")},excludeObjects:function(e,t){var a=this,o=e.map(function(e){return e.feature.properties.cadastral_id}),r=t.map(function(e){return e.feature.properties.cadastral_id}),i=[].concat(o).concat(r),n=JSON.stringify({cadIds:i});$.ajax({type:"post",url:window.REALTY_MAP_SITE_ROOT+"/Order/RemoveCadNums",contentType:"application/json",data:n,success:function(){new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow("Успешно исключены из заказа"),window.MapManager.clearSelections(),a._refreshLayers()},error:function(){new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow("Ошибка при исключении из заказа"),a._refreshLayers()}})},_refreshLayers:function(){for(var e=["PKK_PARCELS_"+window.orderGroupId,"PKK_OKS_"+window.orderGroupId],t=e.length-1;0<=t;t--){var a=e[t],o=window.MapManager._mapModel.getLayerById(a);o&&o.mapLayer&&o.mapLayer._refreshData&&o.mapLayer._refreshData()}}}),MapExpress.Service.OrderManager={addObject2OrderByGeometry:function(e,t){var a=window.REALTY_MAP_SITE_ROOT+"/Estate/Rosreestr/CreateOrderFromGeometry",o={};o.geoJson=JSON.stringify(e),o.updateAttributes=!0,o.updateGeometry=!1,o.useCache=!0,o.types=t||[1],this._sendPost(a,o,"Формирование перечня объектов поставлено в очередь!")},addParcel2OrderFromMap:function(e){this._addObject2OrderFromMap(e,MapExpress.Utils.CadastreUtils.cadastreObjectType.PARCEL)},addOks2OrderFromMap:function(e){this._addObject2OrderFromMap(e,MapExpress.Utils.CadastreUtils.cadastreObjectType.OKS)},addKvartal2OrderFromMap:function(e){this._addObject2OrderFromMap(e,MapExpress.Utils.CadastreUtils.cadastreObjectType.KVARTAL)},_addObject2OrderFromMap:function(e,i){var n=this,s=window.REALTY_MAP_SITE_ROOT+"/Estate/Rosreestr/AddCadNumToOrder";MapExpress.Utils.CadastreUtils._getCadastreFeaturesByLatLngAsyn(e,i).then(function(e){if(e&&0<e.length){e=e[0];var t={};if(t.cadNums=[e.attrs.cn],e.center&&e.center.x&&e.center.y){var a=L.CRS.EPSG3857.unproject(L.point(e.center.x,e.center.y),window.MapManager._map.getZoom()),o={type:"Feature",geometry:{type:"Point",coordinates:[a.lng,a.lat]}};t.point=JSON.stringify(o)}n._sendPost(s,t,(r=e.attrs.cn,MapExpress.Utils.CadastreUtils.getObjectPrintNameByType(i)+" №: "+r+" добавлен в заказ"))}else n._showWarningWindow("На карте ПКК не удалось найти "+MapExpress.Utils.CadastreUtils.getObjectPrintNameByType(i)+" !");var r},function(e){n._showErrorWindow("Ошибка приложения !",e)})},_sendPost:function(e,t,a){var o=this;$.post(e,t).done(function(e){"error"===e.type?o._showErrorWindow(e.message):new MapExpress.Controls.MapControl(window.MapManager._map).setTitle(e.message).showNotifyWindow(a,1500)}).fail(function(e){o._showErrorWindow("Ошибка приложения !",e)})},_showErrorWindow:function(e,t){new MapExpress.Controls.MapControl(window.MapManager._map,{position:"bottomRight"}).showErrorWindow(e),t&&console.log(t)},_showWarningWindow:function(e,t){new MapExpress.Controls.MapControl(window.MapManager._map,{position:"bottomRight"}).showWarnWindow(e),t&&console.log(t)}},MapExpress.Edit.PkkForAssetComplexEditor=MapExpress.Edit.BaseLayerEditor.extend({initialize:function(e,t){MapExpress.Edit.BaseLayerEditor.prototype.initialize.call(this,e,t),this.options.featureKeyFieldName="external_query_id"},onSaveAsFeatureCollection:function(e){var a=this;if(a.modal&&(a.modal.hide(),delete a.modal),window.MapManager._map.bufferTools){var t=window.MapManager._map.bufferTools.createBufferResult();e.features.push(t.bufferGeoJSON),e.features.push(t.lineStringGeoJSON),this.bufferLineStringCommand&&this.bufferLineStringCommand.clearCommandAndControl()}if(MapExpress.Utils.GeoJSONUtils.featureHasCoordinates(e)){var o=window.REALTY_MAP_SITE_ROOT+"/estate/AssetComplex/ModalCreateComplexFromPkk",r={};r.newComplexFromPkkContour=JSON.stringify(e),$.post(o,r).done(function(e){a.modal=new MapExpress.Controls.MapControl(window.MapManager._map,{headerEnabled:!0,resizeable:!0}).setContent(e).setTitle("Формирование комплекса по контуру").show();var t={};t.initModalCreateComplexFromPkkCallback=i,t.assetComplexId=window.brcRealtyObjectIdForMap,window.initModalCreateComplexFromPkk(t)}).fail(function(e){a._showEror("Не удалось выполнить запрос !"),console.log(e)})}else a._showEror("У геометрии нет координат !");function i(){this.modal&&(this.modal.hide(),delete this.modal),new MapExpress.Controls.MapControl(window.MapManager._map,{removalDelay:2500,headerEnabled:!0}).setContent("<br> Задание формирования комплекса по контуру поставлено в очередь <br> Прогресс формирования отображается в журнале <br><br>").setTitle("Формирование комплекса по контуру").show()}},save:function(){this.saveChanges()},_showEror:function(e){new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e)}}),MapExpress.Tools.PkkForAssetComplexToolbar=MapExpress.Tools.MapToolbar.extend({initialize:function(e,t){MapExpress.Tools.MapToolbar.prototype.initialize.call(this,e,t),e._map.editComplexToolbar&&e._map.removeControl(e._map.editComplexToolbar),(e._map.editComplexToolbar=this).pkkForAssetComplexEditor=new MapExpress.Edit.PkkForAssetComplexEditor("LOKS_CONTOUR"+window.brcRealtyObjectIdForMap,t),this._addCommands()},_addCommands:function(){this.addCommand(new MapExpress.Tools.UpdateComplexFromPkkCommand(window.MapManager,!1,this.pkkForAssetComplexEditor)),this.addCommand(new MapExpress.Tools.CreateComplexFromPkkCommand(window.MapManager,!1,this.pkkForAssetComplexEditor)),this.addCommand(new MapExpress.Tools.CreateComplexFromFileCommand(window.MapManager,!1,this.pkkForAssetComplexEditor)),this.addCommand(new MapExpress.Tools.SaveComplexFromPkkCommand(window.MapManager,!1,this.pkkForAssetComplexEditor))}}),MapExpress.Tools.UpdateComplexFromPkkCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/inputParams.png",title:"Редактирование контура",id:"saveComplexFromPkkCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.startEdit()},deactivate:function(){}}),MapExpress.Tools.CreateComplexFromPkkCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/focus_@2X.png",title:"Создание контура",id:"createComplexFromPkkCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.startAddPolygon()},deactivate:function(){}}),MapExpress.Tools.CreateComplexFromFileCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/addlayer.png",title:"Добавить контур из файла",id:"createComplexFromFileCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.addEditGeoJsonLayerFromFile()},deactivate:function(){}}),MapExpress.Tools.SaveComplexFromPkkCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/start_@2X.png",title:"Начать формирование ...",id:"saveComplexFromPkkCommand"},initialize:function(e,t,a){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,t),L.setOptions(this,t),this.layerEditor=a},activate:function(){this.layerEditor.save()}}),MapExpress.Mapping.Selection.RealtyPositionSelection=MapExpress.Mapping.Selection.extend({featureOnClick:function(e){this.destroySelection()}});var brcMapPosition=function(){var e={};function s(e,t,a,o){window.MapManager.clearSelections();var r=L.Util.template(e,{id:t});window.MapManager.usedGeoServer()?window.MapManager.selectFeatureByQueryFromUrl(r,a,o,t):window.MapManager.setFeaturePositionAndSelect(r,window.MapManager._mapModel.getLayerById(a).mapLayer,o,t)}return e.trySetPosition=function(){if(window.brcRealtyObjectIdForMap&&null!==window.brcRealtyObjectIdForMap&&"undefined"!==window.brcRealtyObjectIdForMap)switch(window.brcRealtyObjectNameForMap){case"parcel":s(this.findByIdUrlTemplate,window.brcRealtyObjectIdForMap,"LOKS_ZU"+window.brcRealtyAssetComplexIdForMap,"asset_id");break;case"building":s(this.findByIdUrlTemplate,window.brcRealtyObjectIdForMap,"LOKS_ZIS"+window.brcRealtyAssetComplexIdForMap,"asset_id");break;case"asset_complex":window.MapManager.usedGeoServer()?(n=window.brcRealtyObjectIdForMap,MapExpress.Utils.Promise.GetJSON(window.brcMap.options.assetsComplexInfoUrl).then(function(e){if(e&&L.Util.isArray(e))for(var t=e.length-1;0<=t;t--){var a=e[t];n&&n!==a.id||a.bounds&&L.Util.isArray(a.bounds)&&window.MapManager._map.fitBounds(a.bounds)}},function(e){new MapExpress.Controls.MapControl(window.MapManager._map,{removalDelay:4e3}).setContent("Не удалось получить данные по комплексам!<br>"+e).show()})):window.MapManager.setLayerVisible("LOKS_CONTOUR"+window.brcRealtyObjectIdForMap,!0);break;case"emergency_repair":r=window.brcRealtyObjectIdForMap,i=window.REALTY_MAP_SITE_ROOT+"/MapApi/RealtySpatialItemById?schema=brc_vodo&table=gis_fault_short_info_v&keyColumn=fault_id&geomColumn=fault_geo_coordinate&itemId={id}","VO"===window.brcNetworkCategoryForMap?s(i,r,"EMERGENCY_VO","fault_id"):s(i,r,"EMERGENCY_VS","fault_id");break;case"network_vertex":a=window.brcRealtyObjectIdForMap,o=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/GetConstructionGeometry?constructionId={id}","VO"===window.brcNetworkCategoryForMap?s(o,a,"VERTEX","net_vert_constr_id"):s(o,a,"VERTEX_VS","net_vert_constr_id");break;case"network_edge":e=window.brcRealtyObjectIdForMap,t=window.REALTY_MAP_SITE_ROOT+"/ToirMapApi/GetEdgeGeometry?edgeId={id}","VO"===window.brcNetworkCategoryForMap?s(t,e,"EDG","net_edg_id"):s(t,e,"EDG_VS","net_edg_id");break;case"invest_project":window.brcRealtyObjectIdForMap}var e,t,a,o,r,i,n;!window.brcRealtyObjectNameForMap||window.brcRealtyObjectNameForMap},e}(),realtySecurityManager=function(){var r={urlTemplate:"/Map/Main/ChechPermission?SecurityObjectIdentityId={securityObjectIdentityId}&RightTypeIdentityId={rightTypeIdentityId}",parcelObjectId:31,oksObjectId:32,complexObjectId:12,investProjectId:157,edgWaterObjectId:73,edgSewerObjectId:72,networkEmergency:33,createRightTypeId:2,editRightTypeId:9,deleteRightTypeId:10,essetComplexCountor:178,egrnTypeId:184,egrnRightTypeId:11};function e(e,t){var a=!1,o=window.REALTY_MAP_SITE_ROOT+L.Util.template(r.urlTemplate,{securityObjectIdentityId:e,rightTypeIdentityId:t});return $.ajax({url:o,type:"GET",async:!1}).done(function(e){a="true"===e}).fail(function(){new MapExpress.Controls.MapControl(window.MapManager._map,{removalDelay:2e3}).setContent("Не удалось определить права доступа !").show(),a=!1}),a}function t(){return e(r.edgWaterObjectId,r.createRightTypeId)}function a(){return e(r.edgSewerObjectId,r.createRightTypeId)}function o(){return e(r.edgWaterObjectId,r.editRightTypeId)}function i(){return e(r.edgSewerObjectId,r.editRightTypeId)}function n(){return e(r.edgWaterObjectId,r.deleteRightTypeId)}function s(){return e(r.edgSewerObjectId,r.deleteRightTypeId)}function d(){return e(r.networkEmergency,r.createRightTypeId)}function l(){return e(r.networkEmergency,r.editRightTypeId)}return{editAssetsComlexAllowed:function(){return e(r.essetComplexCountor,r.editRightTypeId)},editParcelAllowed:function(){return e(r.parcelObjectId,r.editRightTypeId)},editBuildingAllowed:function(){return e(r.oksObjectId,r.editRightTypeId)},editInvestProjectAllowed:function(){return e(r.investProjectId,r.editRightTypeId)},anyActionNetworkAllowed:function(){return t()||a()||o()||i()||n()||s()},createWaterNetworkAllowed:t,createSewerNetworkAllowed:a,editWaterNetworkAllowed:o,editSewerNetworkAllowed:i,deleteWaterNetworkAllowed:n,deleteSewerNetworkAllowed:s,createNetworkEmergencyAllowed:d,editNetworkEmergencyAllowed:l,anyActionNetworkEmergencyAllowed:function(){return d()||l()},createEgrnOrderAllowed:function(){return e(r.egrnTypeId,r.egrnRightTypeId)}}}();