BaltrosPkk={Controls:{},Service:{},Geo:{},Layers:{},Utils:{Promise:{}},Mapping:{},Tools:{},Styles:{},Search:{},Edit:{}},window.BaltrosPkk=BaltrosPkk,BaltrosPkk.Mapping.MapInitializer={initialize:function(e){MapExpress.Mapping.MapInitializerHelper.initializeFromURL(e,"map_model.json",function(){var e=window.MapManager,a=window.MapManager._map;(function(){var e=window.MapManager.getMapModel().getLayersByOptionValue("displayName","Публичная кадастровая карта");if(e&&0<e.length){var a=[];window.MapManager.getMapModel()._fillAllLayers(e[0],a);for(var t=0;t<a.length;t++){var o=a[t];if(o.mapLayer&&o.mapLayer._dataPovider){if("Земельные участки"===o.options.displayName){o.mapLayer._dataPovider.getFeatureInfoAsync=r,window.MapManager._mapModel._favoriteLayers.push(o),BaltrosPkk.Mapping.LegendManager.addPkkParcelLegend(o.mapLayer);continue}if("ОКС"===o.options.displayName){o.mapLayer._dataPovider.getFeatureInfoAsync=i,window.MapManager._mapModel._favoriteLayers.push(o),BaltrosPkk.Mapping.LegendManager.addPkkOksLegend(o.mapLayer);continue}if("ЗОУИТ"===o.options.displayName){o.mapLayer._dataPovider.getFeatureInfoAsync=n,window.MapManager._mapModel._favoriteLayers.push(o),BaltrosPkk.Mapping.LegendManager.addPkkZouitLegend(o.mapLayer);continue}if("Кадастровые кварталы"===o.options.displayName){o.mapLayer._dataPovider.getFeatureInfoAsync=p;continue}if("Кадастровые районы"===o.options.displayName){o.mapLayer._dataPovider.getFeatureInfoAsync=d;continue}if("Кадастровые округа"===o.options.displayName){o.mapLayer._dataPovider.getFeatureInfoAsync=l;continue}o.mapLayer._dataPovider.getFeatureInfoAsync=s}}}function s(e,a,t,o,s){return null}function r(e,a,t,o,s){return MapExpress.Utils.CadastreUtils.getObjectListGeoJSONByLatLngAsyn(e,MapExpress.Utils.CadastreUtils.cadastreObjectType.PARCEL)}function i(e,a,t,o,s){return MapExpress.Utils.CadastreUtils.getObjectListGeoJSONByLatLngAsyn(e,MapExpress.Utils.CadastreUtils.cadastreObjectType.OKS)}function n(e,a,t,o,s){return MapExpress.Utils.CadastreUtils.getObjectListGeoJSONByLatLngAsyn(e,MapExpress.Utils.CadastreUtils.cadastreObjectType.ZOUT)}function p(e,a,t,o,s){return MapExpress.Utils.CadastreUtils.getObjectListGeoJSONByLatLngAsyn(e,MapExpress.Utils.CadastreUtils.cadastreObjectType.KVARTAL)}function d(e,a,t,o,s){return MapExpress.Utils.CadastreUtils.getObjectListGeoJSONByLatLngAsyn(e,MapExpress.Utils.CadastreUtils.cadastreObjectType.RAION)}function l(e,a,t,o,s){return MapExpress.Utils.CadastreUtils.getObjectListGeoJSONByLatLngAsyn(e,MapExpress.Utils.CadastreUtils.cadastreObjectType.OKRUG)}})(),function(){var e=window.MapManager.getMapModel().getFavoriteLayers(),a=window.MapManager.getMapModel().getFirstLayerByOptionValue("displayName","Сохраняемые строения"),t=window.MapManager.getMapModel().getFirstLayerByOptionValue("displayName","Сносимые строения");t&&t.mapLayer&&(BaltrosPkk.Mapping.LegendManager.addBuildingTrashLegend(t.mapLayer),e.push(t));a&&a.mapLayer&&(BaltrosPkk.Mapping.LegendManager.addBuildingSaveLegend(a.mapLayer),e.push(a))}(),a.addControl((t=window.MapManager,o=new MapExpress.Tools.MapToolbar(t,{position:"topleft"}),o.addCommand(new MapExpress.Tools.ShowLayerControlMapCommandExt(t)),o.addControlFromTemplate("templates/tula_tbo_search.html","searchId"),o)),a.addControl(function(){var e=window.MapManager,a=new MapExpress.Tools.MapToolbar(e,{position:"topright"});a.addCommand(new MapExpress.Tools.IdentifyMapCommand(e)),a.addCommand(new MapExpress.Tools.LineMeasureCommand(e)),a.addCommand(new MapExpress.Tools.SqrtMeasureCommand(e)),a.addCommand(new MapExpress.Tools.CoordinatesRunnerCommand(e)),a.addCommand(new MapExpress.Tools.MapExportCommand(e,{showProjList:!1})),a.addCommand(new MapExpress.Tools.ShowFavoriteLayersCommand(e)),a.addCommand(new MapExpress.Tools.SelectorBaseMapsCommand(e));var t=new MapExpress.Tools.ShowLegendCommand(e);return a.addCommand(t),t.activate(),a}()),a.addControl(function(){var e=new MapExpress.Controls.MapStatusbarControl(window.MapManager);e.addSection(new MapExpress.Controls.ZoomStandartStatusbarSection(window.MapManager)),e.addSection(new MapExpress.Controls.CoordinatesStandartStatusbarSection(window.MapManager)),e.addSection(new MapExpress.Controls.CurrentToolStatusbarSection(window.MapManager));var a=new MapExpress.Controls.AttibutionStandartStatusbarSection(window.MapManager);return a.options.attibution.push({href:"http://leafletjs.com",prefix:"Leaflet"}),a.options.attibution.push({href:"https://openstreetmap.org",prefix:"© OpenStreetMap"}),a.options.attibution.push({href:"https: //www.google.ru",prefix:"© Google"}),a.options.attibution.push({href:"https://pkk5.rosreestr.ru",prefix:"Публичная кадастрвоая карта"}),e.addSection(a),window.MapManager.mapStatusBar=e}()),L.control.zoom({position:"topleft"}).addTo(a),MapExpress.Tools.IdentifyMapCommand.maxHeightMinus=.35,MapExpress.Tools.IdentifyMapCommand.maxWidthMinus=.6,MapExpress.Tools.IdentifyMapCommand.showFloatWindow=!1,e.refreshMap();var t,o}),MapExpress.Tools.ShowLayerControlMapCommandExt=MapExpress.Tools.ShowLayerControlMapCommand.extend({createContent:function(e){var a=MapExpress.Tools.ShowLayerControlMapCommand.prototype.createContent.call(this,e);MapExpress.Controls.MapControlUtils.setStyle(a,"float:left");var t=L.DomUtil.create("span","divider1",e);return MapExpress.Controls.MapControlUtils.setStyle(t,"float:left"),a}})}},BaltrosPkk.Mapping.LegendManager={addPkkParcelLegend:function(e){MapExpress.Utils.legendUtils.addLegendItemToLayer(e,{legendTemplate:'<svg width="48" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 24"><rect fill="#ffffff" stroke-width="3" x="0" y="0" width="48" height="24" stroke-dasharray="none" stroke="#f28383" opacity="1" fill-opacity="1" stroke-opacity="1"></rect></svg>',templateType:"svg",maxZoom:24,minZoom:0})},addPkkOksLegend:function(e){MapExpress.Utils.legendUtils.addLegendItemToLayer(e,{legendTemplate:'<svg width="48" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 24"><rect fill="#ffbebe" stroke-width="3" x="0" y="0" width="48" height="24" stroke="#ffbebe"  opacity="1" fill-opacity="1" stroke-opacity="1"></rect></svg>',templateType:"svg",maxZoom:24,minZoom:0})},addPkkZouitLegend:function(e){MapExpress.Utils.legendUtils.addLegendItemToLayer(e,{legendTemplate:'<svg width="48" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 24"><rect fill="#92d17b" stroke-width="3" x="0" y="0" width="48" height="24" stroke="#92d17b"  opacity="1" fill-opacity="0.5" stroke-opacity="1"></rect></svg>',templateType:"svg",maxZoom:24,minZoom:0})},addBuildingSaveLegend:function(e){MapExpress.Utils.legendUtils.addLegendItemToLayer(e,{legendTemplate:'<svg width="48" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 24"><rect fill="#bed2ff" stroke-width="3" x="0" y="0" width="48" height="24" stroke="#0080C0"  opacity="1" fill-opacity="1" stroke-opacity="1"></rect></svg>',templateType:"svg",maxZoom:24,minZoom:0})},addBuildingTrashLegend:function(e){MapExpress.Utils.legendUtils.addLegendItemToLayer(e,{legendTemplate:'<svg width="48" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 24"><rect fill="#fff5b4" stroke-width="3" x="0" y="0" width="48" height="24" stroke="#FFA579"  opacity="1" fill-opacity="1" stroke-opacity="1"></rect></svg>',templateType:"svg",maxZoom:24,minZoom:0})},addProjectBorderLegend:function(e){MapExpress.Utils.legendUtils.addLegendItemToLayer(e,{legendTemplate:'<svg width="48" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 42 24"><line x1="0" y1="12" x2="48" y2="12" stroke-width="2" fill-opacity="0.1" stroke-opacity="1" fill="#D56A00" stroke="#D56A00" stroke-linecap="round" stroke-linejoin="round" min-zoom="1" max-zoom="24" override-style="true"></line></svg>',templateType:"svg",maxZoom:24,minZoom:0})}},MapExpress.Edit.ParcelEditor=MapExpress.Edit.BaseLayerEditor.extend({initialize:function(e,a){MapExpress.Edit.BaseLayerEditor.prototype.initialize.call(this,e,a),this.options.featureKeyFieldName="objectid",this.options.draggable=!0,window.REALTY_MAP_SITE_ROOT="http://realty.npobaltros.ru"},onSaveAsFeatureCollection:function(e){if(e){var a=this,t=MapExpress.Utils.GeoJSONUtils.convertFeatureCollectionToMultiPolygon(e);if(!MapExpress.Utils.GeoJSONUtils.featureHasCoordinates(t))return void a._showEror("У геометрии нет координат !");var o=window.REALTY_MAP_SITE_ROOT+"/MapApi/CreateOrUpdateRealtyGeometry",s={schema:"rsn_sokolov",table:"border_project",keyColumn:"objectid",geomColumn:"geom",itemId:1};s.geoJSON=JSON.stringify(t),$.post(o,s).done(function(e){e?(new MapExpress.Controls.MapControl(window.MapManager._map).showNotifyWindow("Контур объекта сохранен в БД"),window.MapManager.refreshMap(),a.clearEditLayer(),window.MapManager.clearSelections()):a._showEror("Не удалось сохранить контур !")}).fail(function(e){a._showEror("Не удалось сохранить контур !"),window.MapManager.refreshMap(),a.clearEditLayer(),window.MapManager.clearSelections()})}this.clearEditLayer()},save:function(){this.saveChanges()},_showEror:function(e){new MapExpress.Controls.MapControl(window.MapManager._map).showErrorWindow(e)}}),MapExpress.Tools.EditParcelToolbar=MapExpress.Tools.MapToolbar.extend({initialize:function(e,a){MapExpress.Tools.MapToolbar.prototype.initialize.call(this,e,a),e._map.parcelEditControl&&e._map.removeControl(e._map.parcelEditControl),(e._map.parcelEditControl=this)._addComands()},_addComands:function(){this.parcelEditor=new MapExpress.Edit.ParcelEditor("75a75472-4cc3-4fcf-a312-69e51462bd6a"),this.addCommand(new MapExpress.Tools.EditParcelCommand(window.MapManager,!1,this.parcelEditor)),this.addCommand(new MapExpress.Tools.SaveParcelCommand(window.MapManager,!1,this.parcelEditor))}}),MapExpress.Tools.EditParcelCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/inputParams.png",title:"Редактирование контура",id:"editParcelCommand"},initialize:function(e,a,t){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,a),L.setOptions(this,a),this.layerEditor=t},activate:function(){this.layerEditor.startEdit()}}),MapExpress.Tools.SaveParcelCommand=MapExpress.Tools.ButtonBaseMapCommand.extend({options:{imageSrc:"images/start_@2X.png",title:"Сохранить",id:"saveParcelCommand"},initialize:function(e,a,t){MapExpress.Tools.ButtonBaseMapCommand.prototype.initialize.call(this,e,a),L.setOptions(this,a),this.layerEditor=t},activate:function(){this.layerEditor.save()}});